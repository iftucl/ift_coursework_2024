

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>django.db.models.sql.compiler &mdash; Coursework Two 1.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../../../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../../../../_static/graphviz.css?v=4ae1632d" />

  
      <script src="../../../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../../../_static/documentation_options.js?v=f2a433a1"></script>
      <script src="../../../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../../../index.html" class="icon icon-home">
            Coursework Two
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../installation_guide.html">Installation Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../usage_instructions.html">Usage Instructions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../architecture_overview.html">Architecture Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../autoapi/index.html">API Reference</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../../index.html">Coursework Two</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../../../index.html">Module code</a></li>
          <li class="breadcrumb-item"><a href="../../../../django.html">django</a></li>
          <li class="breadcrumb-item"><a href="../../../db.html">django.db</a></li>
      <li class="breadcrumb-item active">django.db.models.sql.compiler</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for django.db.models.sql.compiler</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span><span class="w"> </span><span class="nn">collections</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">functools</span><span class="w"> </span><span class="kn">import</span> <span class="n">partial</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">itertools</span><span class="w"> </span><span class="kn">import</span> <span class="n">chain</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">django.core.exceptions</span><span class="w"> </span><span class="kn">import</span> <span class="n">EmptyResultSet</span><span class="p">,</span> <span class="n">FieldError</span><span class="p">,</span> <span class="n">FullResultSet</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.db</span><span class="w"> </span><span class="kn">import</span> <span class="n">DatabaseError</span><span class="p">,</span> <span class="n">NotSupportedError</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.db.models.constants</span><span class="w"> </span><span class="kn">import</span> <span class="n">LOOKUP_SEP</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.db.models.expressions</span><span class="w"> </span><span class="kn">import</span> <span class="n">F</span><span class="p">,</span> <span class="n">OrderBy</span><span class="p">,</span> <span class="n">RawSQL</span><span class="p">,</span> <span class="n">Ref</span><span class="p">,</span> <span class="n">Value</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.db.models.functions</span><span class="w"> </span><span class="kn">import</span> <span class="n">Cast</span><span class="p">,</span> <span class="n">Random</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.db.models.lookups</span><span class="w"> </span><span class="kn">import</span> <span class="n">Lookup</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.db.models.query_utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">select_related_descend</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.db.models.sql.constants</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">CURSOR</span><span class="p">,</span>
    <span class="n">GET_ITERATOR_CHUNK_SIZE</span><span class="p">,</span>
    <span class="n">MULTI</span><span class="p">,</span>
    <span class="n">NO_RESULTS</span><span class="p">,</span>
    <span class="n">ORDER_DIR</span><span class="p">,</span>
    <span class="n">SINGLE</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.db.models.sql.query</span><span class="w"> </span><span class="kn">import</span> <span class="n">Query</span><span class="p">,</span> <span class="n">get_order_dir</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.db.models.sql.where</span><span class="w"> </span><span class="kn">import</span> <span class="n">AND</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.db.transaction</span><span class="w"> </span><span class="kn">import</span> <span class="n">TransactionManagementError</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.utils.functional</span><span class="w"> </span><span class="kn">import</span> <span class="n">cached_property</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.utils.hashable</span><span class="w"> </span><span class="kn">import</span> <span class="n">make_hashable</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.utils.regex_helper</span><span class="w"> </span><span class="kn">import</span> <span class="n">_lazy_re_compile</span>


<div class="viewcode-block" id="PositionRef">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/compiler/index.html#django.db.models.sql.compiler.PositionRef">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">PositionRef</span><span class="p">(</span><span class="n">Ref</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ordinal</span><span class="p">,</span> <span class="n">refs</span><span class="p">,</span> <span class="n">source</span><span class="p">):</span>
<div class="viewcode-block" id="PositionRef.ordinal">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/compiler/index.html#django.db.models.sql.compiler.PositionRef.ordinal">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">ordinal</span> <span class="o">=</span> <span class="n">ordinal</span></div>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">refs</span><span class="p">,</span> <span class="n">source</span><span class="p">)</span>

<div class="viewcode-block" id="PositionRef.as_sql">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/compiler/index.html#django.db.models.sql.compiler.PositionRef.as_sql">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">as_sql</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">compiler</span><span class="p">,</span> <span class="n">connection</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ordinal</span><span class="p">),</span> <span class="p">()</span></div>
</div>



<div class="viewcode-block" id="SQLCompiler">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/compiler/index.html#django.db.models.sql.compiler.SQLCompiler">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">SQLCompiler</span><span class="p">:</span>
    <span class="c1"># Multiline ordering SQL clause may appear from RawSQL.</span>
<div class="viewcode-block" id="SQLCompiler.ordering_parts">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/compiler/index.html#django.db.models.sql.compiler.SQLCompiler.ordering_parts">[docs]</a>
    <span class="n">ordering_parts</span> <span class="o">=</span> <span class="n">_lazy_re_compile</span><span class="p">(</span>
        <span class="sa">r</span><span class="s2">&quot;^(.*)\s(?:ASC|DESC).*&quot;</span><span class="p">,</span>
        <span class="n">re</span><span class="o">.</span><span class="n">MULTILINE</span> <span class="o">|</span> <span class="n">re</span><span class="o">.</span><span class="n">DOTALL</span><span class="p">,</span>
    <span class="p">)</span></div>


    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">connection</span><span class="p">,</span> <span class="n">using</span><span class="p">,</span> <span class="n">elide_empty</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<div class="viewcode-block" id="SQLCompiler.query">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/compiler/index.html#django.db.models.sql.compiler.SQLCompiler.query">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">query</span> <span class="o">=</span> <span class="n">query</span></div>

<div class="viewcode-block" id="SQLCompiler.connection">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/compiler/index.html#django.db.models.sql.compiler.SQLCompiler.connection">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">connection</span> <span class="o">=</span> <span class="n">connection</span></div>

<div class="viewcode-block" id="SQLCompiler.using">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/compiler/index.html#django.db.models.sql.compiler.SQLCompiler.using">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">using</span> <span class="o">=</span> <span class="n">using</span></div>

        <span class="c1"># Some queries, e.g. coalesced aggregation, need to be executed even if</span>
        <span class="c1"># they would return an empty result set.</span>
<div class="viewcode-block" id="SQLCompiler.elide_empty">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/compiler/index.html#django.db.models.sql.compiler.SQLCompiler.elide_empty">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">elide_empty</span> <span class="o">=</span> <span class="n">elide_empty</span></div>

<div class="viewcode-block" id="SQLCompiler.quote_cache">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/compiler/index.html#django.db.models.sql.compiler.SQLCompiler.quote_cache">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">quote_cache</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;*&quot;</span><span class="p">:</span> <span class="s2">&quot;*&quot;</span><span class="p">}</span></div>

        <span class="c1"># The select, klass_info, and annotations are needed by QuerySet.iterator()</span>
        <span class="c1"># these are set as a side-effect of executing the query. Note that we calculate</span>
        <span class="c1"># separately a list of extra select columns needed for grammatical correctness</span>
        <span class="c1"># of the query, but these columns are not included in self.select.</span>
<div class="viewcode-block" id="SQLCompiler.select">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/compiler/index.html#django.db.models.sql.compiler.SQLCompiler.select">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">select</span> <span class="o">=</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="SQLCompiler.annotation_col_map">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/compiler/index.html#django.db.models.sql.compiler.SQLCompiler.annotation_col_map">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">annotation_col_map</span> <span class="o">=</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="SQLCompiler.klass_info">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/compiler/index.html#django.db.models.sql.compiler.SQLCompiler.klass_info">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">klass_info</span> <span class="o">=</span> <span class="kc">None</span></div>

        <span class="bp">self</span><span class="o">.</span><span class="n">_meta_ordering</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;&lt;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__qualname__</span><span class="si">}</span><span class="s2"> &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;model=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="vm">__qualname__</span><span class="si">}</span><span class="s2"> &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;connection=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="si">!r}</span><span class="s2"> using=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">using</span><span class="si">!r}</span><span class="s2">&gt;&quot;</span>
        <span class="p">)</span>

<div class="viewcode-block" id="SQLCompiler.setup_query">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/compiler/index.html#django.db.models.sql.compiler.SQLCompiler.setup_query">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">setup_query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">with_col_aliases</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">alias_refcount</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">alias_map</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">get_initial_alias</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">select</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">klass_info</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">annotation_col_map</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_select</span><span class="p">(</span>
            <span class="n">with_col_aliases</span><span class="o">=</span><span class="n">with_col_aliases</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">col_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">select</span><span class="p">)</span></div>


<div class="viewcode-block" id="SQLCompiler.pre_sql_setup">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/compiler/index.html#django.db.models.sql.compiler.SQLCompiler.pre_sql_setup">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">pre_sql_setup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">with_col_aliases</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Do any necessary class setup immediately prior to producing SQL. This</span>
<span class="sd">        is for things that can&#39;t necessarily be done in __init__ because we</span>
<span class="sd">        might not have all the pieces in place at that time.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setup_query</span><span class="p">(</span><span class="n">with_col_aliases</span><span class="o">=</span><span class="n">with_col_aliases</span><span class="p">)</span>
        <span class="n">order_by</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_order_by</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">where</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">having</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">qualify</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">where</span><span class="o">.</span><span class="n">split_having_qualify</span><span class="p">(</span>
            <span class="n">must_group_by</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">group_by</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="p">)</span>
        <span class="n">extra_select</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_extra_select</span><span class="p">(</span><span class="n">order_by</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">select</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">has_extra_select</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">extra_select</span><span class="p">)</span>
        <span class="n">group_by</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_group_by</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">select</span> <span class="o">+</span> <span class="n">extra_select</span><span class="p">,</span> <span class="n">order_by</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">extra_select</span><span class="p">,</span> <span class="n">order_by</span><span class="p">,</span> <span class="n">group_by</span></div>


<div class="viewcode-block" id="SQLCompiler.get_group_by">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/compiler/index.html#django.db.models.sql.compiler.SQLCompiler.get_group_by">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_group_by</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">select</span><span class="p">,</span> <span class="n">order_by</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a list of 2-tuples of form (sql, params).</span>

<span class="sd">        The logic of what exactly the GROUP BY clause contains is hard</span>
<span class="sd">        to describe in other words than &quot;if it passes the test suite,</span>
<span class="sd">        then it is correct&quot;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Some examples:</span>
        <span class="c1">#     SomeModel.objects.annotate(Count(&#39;somecol&#39;))</span>
        <span class="c1">#     GROUP BY: all fields of the model</span>
        <span class="c1">#</span>
        <span class="c1">#    SomeModel.objects.values(&#39;name&#39;).annotate(Count(&#39;somecol&#39;))</span>
        <span class="c1">#    GROUP BY: name</span>
        <span class="c1">#</span>
        <span class="c1">#    SomeModel.objects.annotate(Count(&#39;somecol&#39;)).values(&#39;name&#39;)</span>
        <span class="c1">#    GROUP BY: all cols of the model</span>
        <span class="c1">#</span>
        <span class="c1">#    SomeModel.objects.values(&#39;name&#39;, &#39;pk&#39;)</span>
        <span class="c1">#    .annotate(Count(&#39;somecol&#39;)).values(&#39;pk&#39;)</span>
        <span class="c1">#    GROUP BY: name, pk</span>
        <span class="c1">#</span>
        <span class="c1">#    SomeModel.objects.values(&#39;name&#39;).annotate(Count(&#39;somecol&#39;)).values(&#39;pk&#39;)</span>
        <span class="c1">#    GROUP BY: name, pk</span>
        <span class="c1">#</span>
        <span class="c1"># In fact, the self.query.group_by is the minimal set to GROUP BY. It</span>
        <span class="c1"># can&#39;t be ever restricted to a smaller set, but additional columns in</span>
        <span class="c1"># HAVING, ORDER BY, and SELECT clauses are added to it. Unfortunately</span>
        <span class="c1"># the end result is that it is impossible to force the query to have</span>
        <span class="c1"># a chosen GROUP BY clause - you can almost do this by using the form:</span>
        <span class="c1">#     .values(*wanted_cols).annotate(AnAggregate())</span>
        <span class="c1"># but any later annotations, extra selects, values calls that</span>
        <span class="c1"># refer some column outside of the wanted_cols, order_by, or even</span>
        <span class="c1"># filter calls can alter the GROUP BY clause.</span>

        <span class="c1"># The query.group_by is either None (no GROUP BY at all), True</span>
        <span class="c1"># (group by select fields), or a list of expressions to be added</span>
        <span class="c1"># to the group by.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">group_by</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>
        <span class="n">expressions</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">group_by_refs</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">group_by</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">True</span><span class="p">:</span>
            <span class="c1"># If the group by is set to a list (by .values() call most likely),</span>
            <span class="c1"># then we need to add everything in it to the GROUP BY clause.</span>
            <span class="c1"># Backwards compatibility hack for setting query.group_by. Remove</span>
            <span class="c1"># when we have public API way of forcing the GROUP BY clause.</span>
            <span class="c1"># Converts string references to expressions.</span>
            <span class="k">for</span> <span class="n">expr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">group_by</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="s2">&quot;as_sql&quot;</span><span class="p">):</span>
                    <span class="n">expr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">resolve_ref</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">Ref</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">expr</span><span class="o">.</span><span class="n">refs</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">group_by_refs</span><span class="p">:</span>
                        <span class="n">group_by_refs</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">refs</span><span class="p">)</span>
                        <span class="n">expressions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">source</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">expressions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span>
        <span class="c1"># Note that even if the group_by is set, it is only the minimal</span>
        <span class="c1"># set to group by. So, we need to add cols in select, order_by, and</span>
        <span class="c1"># having into the select in any case.</span>
        <span class="n">selected_expr_indices</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">alias</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">select</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">alias</span><span class="p">:</span>
                <span class="n">selected_expr_indices</span><span class="p">[</span><span class="n">expr</span><span class="p">]</span> <span class="o">=</span> <span class="n">index</span>
            <span class="c1"># Skip members of the select clause that are already explicitly</span>
            <span class="c1"># grouped against.</span>
            <span class="k">if</span> <span class="n">alias</span> <span class="ow">in</span> <span class="n">group_by_refs</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">expressions</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">get_group_by_cols</span><span class="p">())</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta_ordering</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">expr</span><span class="p">,</span> <span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">is_ref</span><span class="p">)</span> <span class="ow">in</span> <span class="n">order_by</span><span class="p">:</span>
                <span class="c1"># Skip references to the SELECT clause, as all expressions in</span>
                <span class="c1"># the SELECT clause are already part of the GROUP BY.</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">is_ref</span><span class="p">:</span>
                    <span class="n">expressions</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">get_group_by_cols</span><span class="p">())</span>
        <span class="n">having_group_by</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">having</span><span class="o">.</span><span class="n">get_group_by_cols</span><span class="p">()</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">having</span> <span class="k">else</span> <span class="p">()</span>
        <span class="k">for</span> <span class="n">expr</span> <span class="ow">in</span> <span class="n">having_group_by</span><span class="p">:</span>
            <span class="n">expressions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">seen</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">expressions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">collapse_group_by</span><span class="p">(</span><span class="n">expressions</span><span class="p">,</span> <span class="n">having_group_by</span><span class="p">)</span>

        <span class="n">allows_group_by_select_index</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">allows_group_by_select_index</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">expr</span> <span class="ow">in</span> <span class="n">expressions</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">sql</span><span class="p">,</span> <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span>
            <span class="k">except</span> <span class="p">(</span><span class="n">EmptyResultSet</span><span class="p">,</span> <span class="n">FullResultSet</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="n">allows_group_by_select_index</span>
                <span class="ow">and</span> <span class="p">(</span><span class="n">select_index</span> <span class="o">:=</span> <span class="n">selected_expr_indices</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">expr</span><span class="p">))</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="p">):</span>
                <span class="n">sql</span><span class="p">,</span> <span class="n">params</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">select_index</span><span class="p">),</span> <span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">sql</span><span class="p">,</span> <span class="n">params</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">select_format</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sql</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
            <span class="n">params_hash</span> <span class="o">=</span> <span class="n">make_hashable</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="n">params_hash</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">seen</span><span class="p">:</span>
                <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">sql</span><span class="p">,</span> <span class="n">params</span><span class="p">))</span>
                <span class="n">seen</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">sql</span><span class="p">,</span> <span class="n">params_hash</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">result</span></div>


<div class="viewcode-block" id="SQLCompiler.collapse_group_by">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/compiler/index.html#django.db.models.sql.compiler.SQLCompiler.collapse_group_by">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">collapse_group_by</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expressions</span><span class="p">,</span> <span class="n">having</span><span class="p">):</span>
        <span class="c1"># If the database supports group by functional dependence reduction,</span>
        <span class="c1"># then the expressions can be reduced to the set of selected table</span>
        <span class="c1"># primary keys as all other columns are functionally dependent on them.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">allows_group_by_selected_pks</span><span class="p">:</span>
            <span class="c1"># Filter out all expressions associated with a table&#39;s primary key</span>
            <span class="c1"># present in the grouped columns. This is done by identifying all</span>
            <span class="c1"># tables that have their primary key included in the grouped</span>
            <span class="c1"># columns and removing non-primary key columns referring to them.</span>
            <span class="c1"># Unmanaged models are excluded because they could be representing</span>
            <span class="c1"># database views on which the optimization might not be allowed.</span>
            <span class="n">pks</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">expr</span>
                <span class="k">for</span> <span class="n">expr</span> <span class="ow">in</span> <span class="n">expressions</span>
                <span class="k">if</span> <span class="p">(</span>
                    <span class="nb">hasattr</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="s2">&quot;target&quot;</span><span class="p">)</span>
                    <span class="ow">and</span> <span class="n">expr</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">primary_key</span>
                    <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">allows_group_by_selected_pks_on_model</span><span class="p">(</span>
                        <span class="n">expr</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">model</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="p">}</span>
            <span class="n">aliases</span> <span class="o">=</span> <span class="p">{</span><span class="n">expr</span><span class="o">.</span><span class="n">alias</span> <span class="k">for</span> <span class="n">expr</span> <span class="ow">in</span> <span class="n">pks</span><span class="p">}</span>
            <span class="n">expressions</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">expr</span>
                <span class="k">for</span> <span class="n">expr</span> <span class="ow">in</span> <span class="n">expressions</span>
                <span class="k">if</span> <span class="n">expr</span> <span class="ow">in</span> <span class="n">pks</span>
                <span class="ow">or</span> <span class="n">expr</span> <span class="ow">in</span> <span class="n">having</span>
                <span class="ow">or</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="s2">&quot;alias&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">aliases</span>
            <span class="p">]</span>
        <span class="k">return</span> <span class="n">expressions</span></div>


<div class="viewcode-block" id="SQLCompiler.get_select">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/compiler/index.html#django.db.models.sql.compiler.SQLCompiler.get_select">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_select</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">with_col_aliases</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return three values:</span>
<span class="sd">        - a list of 3-tuples of (expression, (sql, params), alias)</span>
<span class="sd">        - a klass_info structure,</span>
<span class="sd">        - a dictionary of annotations</span>

<span class="sd">        The (sql, params) is what the expression will produce, and alias is the</span>
<span class="sd">        &quot;AS alias&quot; for the column (possibly None).</span>

<span class="sd">        The klass_info structure contains the following information:</span>
<span class="sd">        - The base model of the query.</span>
<span class="sd">        - Which columns for that model are present in the query (by</span>
<span class="sd">          position of the select clause).</span>
<span class="sd">        - related_klass_infos: [f, klass_info] to descent into</span>

<span class="sd">        The annotations is a dictionary of {&#39;attname&#39;: column position} values.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">select</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">klass_info</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">annotations</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">select_idx</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">alias</span><span class="p">,</span> <span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">extra_select</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">annotations</span><span class="p">[</span><span class="n">alias</span><span class="p">]</span> <span class="o">=</span> <span class="n">select_idx</span>
            <span class="n">select</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">RawSQL</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="n">params</span><span class="p">),</span> <span class="n">alias</span><span class="p">))</span>
            <span class="n">select_idx</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">select</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">default_cols</span><span class="p">)</span>
        <span class="n">select_mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">get_select_mask</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">default_cols</span><span class="p">:</span>
            <span class="n">cols</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_default_columns</span><span class="p">(</span><span class="n">select_mask</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># self.query.select is a special case. These columns never go to</span>
            <span class="c1"># any model.</span>
            <span class="n">cols</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">select</span>
        <span class="k">if</span> <span class="n">cols</span><span class="p">:</span>
            <span class="n">select_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">:</span>
                <span class="n">select_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">select_idx</span><span class="p">)</span>
                <span class="n">select</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">col</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
                <span class="n">select_idx</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">klass_info</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;model&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
                <span class="s2">&quot;select_fields&quot;</span><span class="p">:</span> <span class="n">select_list</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="k">for</span> <span class="n">alias</span><span class="p">,</span> <span class="n">annotation</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">annotation_select</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">annotations</span><span class="p">[</span><span class="n">alias</span><span class="p">]</span> <span class="o">=</span> <span class="n">select_idx</span>
            <span class="n">select</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">annotation</span><span class="p">,</span> <span class="n">alias</span><span class="p">))</span>
            <span class="n">select_idx</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">select_related</span><span class="p">:</span>
            <span class="n">related_klass_infos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_related_selections</span><span class="p">(</span><span class="n">select</span><span class="p">,</span> <span class="n">select_mask</span><span class="p">)</span>
            <span class="n">klass_info</span><span class="p">[</span><span class="s2">&quot;related_klass_infos&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">related_klass_infos</span>

            <span class="k">def</span><span class="w"> </span><span class="nf">get_select_from_parent</span><span class="p">(</span><span class="n">klass_info</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">ki</span> <span class="ow">in</span> <span class="n">klass_info</span><span class="p">[</span><span class="s2">&quot;related_klass_infos&quot;</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="n">ki</span><span class="p">[</span><span class="s2">&quot;from_parent&quot;</span><span class="p">]:</span>
                        <span class="n">ki</span><span class="p">[</span><span class="s2">&quot;select_fields&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="n">klass_info</span><span class="p">[</span><span class="s2">&quot;select_fields&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">ki</span><span class="p">[</span><span class="s2">&quot;select_fields&quot;</span><span class="p">]</span>
                        <span class="p">)</span>
                    <span class="n">get_select_from_parent</span><span class="p">(</span><span class="n">ki</span><span class="p">)</span>

            <span class="n">get_select_from_parent</span><span class="p">(</span><span class="n">klass_info</span><span class="p">)</span>

        <span class="n">ret</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">col_idx</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">col</span><span class="p">,</span> <span class="n">alias</span> <span class="ow">in</span> <span class="n">select</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">sql</span><span class="p">,</span> <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">EmptyResultSet</span><span class="p">:</span>
                <span class="n">empty_result_set_value</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span>
                    <span class="n">col</span><span class="p">,</span> <span class="s2">&quot;empty_result_set_value&quot;</span><span class="p">,</span> <span class="bp">NotImplemented</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">empty_result_set_value</span> <span class="ow">is</span> <span class="bp">NotImplemented</span><span class="p">:</span>
                    <span class="c1"># Select a predicate that&#39;s always False.</span>
                    <span class="n">sql</span><span class="p">,</span> <span class="n">params</span> <span class="o">=</span> <span class="s2">&quot;0&quot;</span><span class="p">,</span> <span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">sql</span><span class="p">,</span> <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">Value</span><span class="p">(</span><span class="n">empty_result_set_value</span><span class="p">))</span>
            <span class="k">except</span> <span class="n">FullResultSet</span><span class="p">:</span>
                <span class="n">sql</span><span class="p">,</span> <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">Value</span><span class="p">(</span><span class="kc">True</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">sql</span><span class="p">,</span> <span class="n">params</span> <span class="o">=</span> <span class="n">col</span><span class="o">.</span><span class="n">select_format</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sql</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">alias</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">with_col_aliases</span><span class="p">:</span>
                <span class="n">alias</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;col</span><span class="si">{</span><span class="n">col_idx</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">col_idx</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">ret</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">col</span><span class="p">,</span> <span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="n">params</span><span class="p">),</span> <span class="n">alias</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">ret</span><span class="p">,</span> <span class="n">klass_info</span><span class="p">,</span> <span class="n">annotations</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_order_by_pairs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">extra_order_by</span><span class="p">:</span>
            <span class="n">ordering</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">extra_order_by</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">default_ordering</span><span class="p">:</span>
            <span class="n">ordering</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">order_by</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">order_by</span><span class="p">:</span>
            <span class="n">ordering</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">order_by</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">meta</span> <span class="o">:=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">get_meta</span><span class="p">())</span> <span class="ow">and</span> <span class="n">meta</span><span class="o">.</span><span class="n">ordering</span><span class="p">:</span>
            <span class="n">ordering</span> <span class="o">=</span> <span class="n">meta</span><span class="o">.</span><span class="n">ordering</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_meta_ordering</span> <span class="o">=</span> <span class="n">ordering</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ordering</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">standard_ordering</span><span class="p">:</span>
            <span class="n">default_order</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">ORDER_DIR</span><span class="p">[</span><span class="s2">&quot;ASC&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">default_order</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">ORDER_DIR</span><span class="p">[</span><span class="s2">&quot;DESC&quot;</span><span class="p">]</span>

        <span class="n">selected_exprs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># Avoid computing `selected_exprs` if there is no `ordering` as it&#39;s</span>
        <span class="c1"># relatively expensive.</span>
        <span class="k">if</span> <span class="n">ordering</span> <span class="ow">and</span> <span class="p">(</span><span class="n">select</span> <span class="o">:=</span> <span class="bp">self</span><span class="o">.</span><span class="n">select</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">ordinal</span><span class="p">,</span> <span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">alias</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">select</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">pos_expr</span> <span class="o">=</span> <span class="n">PositionRef</span><span class="p">(</span><span class="n">ordinal</span><span class="p">,</span> <span class="n">alias</span><span class="p">,</span> <span class="n">expr</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">alias</span><span class="p">:</span>
                    <span class="n">selected_exprs</span><span class="p">[</span><span class="n">alias</span><span class="p">]</span> <span class="o">=</span> <span class="n">pos_expr</span>
                <span class="n">selected_exprs</span><span class="p">[</span><span class="n">expr</span><span class="p">]</span> <span class="o">=</span> <span class="n">pos_expr</span>

        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">ordering</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="s2">&quot;resolve_expression&quot;</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">Value</span><span class="p">):</span>
                    <span class="c1"># output_field must be resolved for constants.</span>
                    <span class="n">field</span> <span class="o">=</span> <span class="n">Cast</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">field</span><span class="o">.</span><span class="n">output_field</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">OrderBy</span><span class="p">):</span>
                    <span class="n">field</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">asc</span><span class="p">()</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">standard_ordering</span><span class="p">:</span>
                    <span class="n">field</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                    <span class="n">field</span><span class="o">.</span><span class="n">reverse_ordering</span><span class="p">()</span>
                <span class="n">select_ref</span> <span class="o">=</span> <span class="n">selected_exprs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">expression</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">select_ref</span> <span class="ow">or</span> <span class="p">(</span>
                    <span class="nb">isinstance</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">expression</span><span class="p">,</span> <span class="n">F</span><span class="p">)</span>
                    <span class="ow">and</span> <span class="p">(</span><span class="n">select_ref</span> <span class="o">:=</span> <span class="n">selected_exprs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">expression</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
                <span class="p">):</span>
                    <span class="c1"># Emulation of NULLS (FIRST|LAST) cannot be combined with</span>
                    <span class="c1"># the usage of ordering by position.</span>
                    <span class="k">if</span> <span class="p">(</span>
                        <span class="n">field</span><span class="o">.</span><span class="n">nulls_first</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">field</span><span class="o">.</span><span class="n">nulls_last</span> <span class="ow">is</span> <span class="kc">None</span>
                    <span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">supports_order_by_nulls_modifier</span><span class="p">:</span>
                        <span class="n">field</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                        <span class="n">field</span><span class="o">.</span><span class="n">expression</span> <span class="o">=</span> <span class="n">select_ref</span>
                    <span class="c1"># Alias collisions are not possible when dealing with</span>
                    <span class="c1"># combined queries so fallback to it if emulation of NULLS</span>
                    <span class="c1"># handling is required.</span>
                    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">combinator</span><span class="p">:</span>
                        <span class="n">field</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                        <span class="n">field</span><span class="o">.</span><span class="n">expression</span> <span class="o">=</span> <span class="n">Ref</span><span class="p">(</span><span class="n">select_ref</span><span class="o">.</span><span class="n">refs</span><span class="p">,</span> <span class="n">select_ref</span><span class="o">.</span><span class="n">source</span><span class="p">)</span>
                <span class="k">yield</span> <span class="n">field</span><span class="p">,</span> <span class="n">select_ref</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">field</span> <span class="o">==</span> <span class="s2">&quot;?&quot;</span><span class="p">:</span>  <span class="c1"># random</span>
                <span class="k">yield</span> <span class="n">OrderBy</span><span class="p">(</span><span class="n">Random</span><span class="p">()),</span> <span class="kc">False</span>
                <span class="k">continue</span>

            <span class="n">col</span><span class="p">,</span> <span class="n">order</span> <span class="o">=</span> <span class="n">get_order_dir</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">default_order</span><span class="p">)</span>
            <span class="n">descending</span> <span class="o">=</span> <span class="n">order</span> <span class="o">==</span> <span class="s2">&quot;DESC&quot;</span>

            <span class="k">if</span> <span class="n">select_ref</span> <span class="o">:=</span> <span class="n">selected_exprs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">col</span><span class="p">):</span>
                <span class="c1"># Reference to expression in SELECT clause</span>
                <span class="k">yield</span> <span class="p">(</span>
                    <span class="n">OrderBy</span><span class="p">(</span>
                        <span class="n">select_ref</span><span class="p">,</span>
                        <span class="n">descending</span><span class="o">=</span><span class="n">descending</span><span class="p">,</span>
                    <span class="p">),</span>
                    <span class="kc">True</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">annotations</span><span class="p">:</span>
                <span class="c1"># References to an expression which is masked out of the SELECT</span>
                <span class="c1"># clause.</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">combinator</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">select</span><span class="p">:</span>
                    <span class="c1"># Don&#39;t use the resolved annotation because other</span>
                    <span class="c1"># combinated queries might define it differently.</span>
                    <span class="n">expr</span> <span class="o">=</span> <span class="n">F</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">expr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">annotations</span><span class="p">[</span><span class="n">col</span><span class="p">]</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">Value</span><span class="p">):</span>
                        <span class="c1"># output_field must be resolved for constants.</span>
                        <span class="n">expr</span> <span class="o">=</span> <span class="n">Cast</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">expr</span><span class="o">.</span><span class="n">output_field</span><span class="p">)</span>
                <span class="k">yield</span> <span class="n">OrderBy</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">descending</span><span class="o">=</span><span class="n">descending</span><span class="p">),</span> <span class="kc">False</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="s2">&quot;.&quot;</span> <span class="ow">in</span> <span class="n">field</span><span class="p">:</span>
                <span class="c1"># This came in through an extra(order_by=...) addition. Pass it</span>
                <span class="c1"># on verbatim.</span>
                <span class="n">table</span><span class="p">,</span> <span class="n">col</span> <span class="o">=</span> <span class="n">col</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="k">yield</span> <span class="p">(</span>
                    <span class="n">OrderBy</span><span class="p">(</span>
                        <span class="n">RawSQL</span><span class="p">(</span>
                            <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">.</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">quote_name_unless_alias</span><span class="p">(</span><span class="n">table</span><span class="p">),</span> <span class="n">col</span><span class="p">),</span> <span class="p">[]</span>
                        <span class="p">),</span>
                        <span class="n">descending</span><span class="o">=</span><span class="n">descending</span><span class="p">,</span>
                    <span class="p">),</span>
                    <span class="kc">False</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">extra</span> <span class="ow">and</span> <span class="n">col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">extra</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">extra_select</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="p">(</span>
                        <span class="n">OrderBy</span><span class="p">(</span>
                            <span class="n">Ref</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">RawSQL</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">extra</span><span class="p">[</span><span class="n">col</span><span class="p">])),</span>
                            <span class="n">descending</span><span class="o">=</span><span class="n">descending</span><span class="p">,</span>
                        <span class="p">),</span>
                        <span class="kc">True</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="p">(</span>
                        <span class="n">OrderBy</span><span class="p">(</span><span class="n">RawSQL</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">extra</span><span class="p">[</span><span class="n">col</span><span class="p">]),</span> <span class="n">descending</span><span class="o">=</span><span class="n">descending</span><span class="p">),</span>
                        <span class="kc">False</span><span class="p">,</span>
                    <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">combinator</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">select</span><span class="p">:</span>
                    <span class="c1"># Don&#39;t use the first model&#39;s field because other</span>
                    <span class="c1"># combinated queries might define it differently.</span>
                    <span class="k">yield</span> <span class="n">OrderBy</span><span class="p">(</span><span class="n">F</span><span class="p">(</span><span class="n">col</span><span class="p">),</span> <span class="n">descending</span><span class="o">=</span><span class="n">descending</span><span class="p">),</span> <span class="kc">False</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># &#39;col&#39; is of the form &#39;field&#39; or &#39;field1__field2&#39; or</span>
                    <span class="c1"># &#39;-field1__field2__field&#39;, etc.</span>
                    <span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_ordering_name</span><span class="p">(</span>
                        <span class="n">field</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">get_meta</span><span class="p">(),</span>
                        <span class="n">default_order</span><span class="o">=</span><span class="n">default_order</span><span class="p">,</span>
                    <span class="p">)</span>

<div class="viewcode-block" id="SQLCompiler.get_order_by">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/compiler/index.html#django.db.models.sql.compiler.SQLCompiler.get_order_by">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_order_by</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a list of 2-tuples of the form (expr, (sql, params, is_ref)) for</span>
<span class="sd">        the ORDER BY clause.</span>

<span class="sd">        The order_by clause can alter the select clause (for example it can add</span>
<span class="sd">        aliases to clauses that do not yet have one, or it can add totally new</span>
<span class="sd">        select clauses).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">seen</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">expr</span><span class="p">,</span> <span class="n">is_ref</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_order_by_pairs</span><span class="p">():</span>
            <span class="n">resolved</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">resolve_expression</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">,</span> <span class="n">allow_joins</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">reuse</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">is_ref</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">combinator</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">select</span><span class="p">:</span>
                <span class="n">src</span> <span class="o">=</span> <span class="n">resolved</span><span class="o">.</span><span class="n">expression</span>
                <span class="n">expr_src</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">expression</span>
                <span class="k">for</span> <span class="n">sel_expr</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">col_alias</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">select</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">src</span> <span class="o">==</span> <span class="n">sel_expr</span><span class="p">:</span>
                        <span class="c1"># When values() is used the exact alias must be used to</span>
                        <span class="c1"># reference annotations.</span>
                        <span class="k">if</span> <span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">has_select_fields</span>
                            <span class="ow">and</span> <span class="n">col_alias</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">annotation_select</span>
                            <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span>
                                <span class="nb">isinstance</span><span class="p">(</span><span class="n">expr_src</span><span class="p">,</span> <span class="n">F</span><span class="p">)</span> <span class="ow">and</span> <span class="n">col_alias</span> <span class="o">==</span> <span class="n">expr_src</span><span class="o">.</span><span class="n">name</span>
                            <span class="p">)</span>
                        <span class="p">):</span>
                            <span class="k">continue</span>
                        <span class="n">resolved</span><span class="o">.</span><span class="n">set_source_expressions</span><span class="p">(</span>
                            <span class="p">[</span><span class="n">Ref</span><span class="p">(</span><span class="n">col_alias</span> <span class="k">if</span> <span class="n">col_alias</span> <span class="k">else</span> <span class="n">src</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">column</span><span class="p">,</span> <span class="n">src</span><span class="p">)]</span>
                        <span class="p">)</span>
                        <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Add column used in ORDER BY clause to the selected</span>
                    <span class="c1"># columns and to each combined query.</span>
                    <span class="n">order_by_idx</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">select</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
                    <span class="n">col_alias</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;__orderbycol</span><span class="si">{</span><span class="n">order_by_idx</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">combined_queries</span><span class="p">:</span>
                        <span class="c1"># If fields were explicitly selected through values()</span>
                        <span class="c1"># combined queries cannot be augmented.</span>
                        <span class="k">if</span> <span class="n">q</span><span class="o">.</span><span class="n">has_select_fields</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="n">DatabaseError</span><span class="p">(</span>
                                <span class="s2">&quot;ORDER BY term does not match any column in &quot;</span>
                                <span class="s2">&quot;the result set.&quot;</span>
                            <span class="p">)</span>
                        <span class="n">q</span><span class="o">.</span><span class="n">add_annotation</span><span class="p">(</span><span class="n">expr_src</span><span class="p">,</span> <span class="n">col_alias</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">add_select_col</span><span class="p">(</span><span class="n">resolved</span><span class="p">,</span> <span class="n">col_alias</span><span class="p">)</span>
                    <span class="n">resolved</span><span class="o">.</span><span class="n">set_source_expressions</span><span class="p">([</span><span class="n">Ref</span><span class="p">(</span><span class="n">col_alias</span><span class="p">,</span> <span class="n">src</span><span class="p">)])</span>
            <span class="n">sql</span><span class="p">,</span> <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">resolved</span><span class="p">)</span>
            <span class="c1"># Don&#39;t add the same column twice, but the order direction is</span>
            <span class="c1"># not taken into account so we strip it. When this entire method</span>
            <span class="c1"># is refactored into expressions, then we can check each part as we</span>
            <span class="c1"># generate it.</span>
            <span class="n">without_ordering</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ordering_parts</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">sql</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">params_hash</span> <span class="o">=</span> <span class="n">make_hashable</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">without_ordering</span><span class="p">,</span> <span class="n">params_hash</span><span class="p">)</span> <span class="ow">in</span> <span class="n">seen</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">seen</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">without_ordering</span><span class="p">,</span> <span class="n">params_hash</span><span class="p">))</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">resolved</span><span class="p">,</span> <span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">is_ref</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">result</span></div>


<div class="viewcode-block" id="SQLCompiler.get_extra_select">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/compiler/index.html#django.db.models.sql.compiler.SQLCompiler.get_extra_select">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_extra_select</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order_by</span><span class="p">,</span> <span class="n">select</span><span class="p">):</span>
        <span class="n">extra_select</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">distinct</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">distinct_fields</span><span class="p">:</span>
            <span class="n">select_sql</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">select</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">expr</span><span class="p">,</span> <span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">is_ref</span><span class="p">)</span> <span class="ow">in</span> <span class="n">order_by</span><span class="p">:</span>
                <span class="n">without_ordering</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ordering_parts</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">sql</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">is_ref</span> <span class="ow">and</span> <span class="p">(</span><span class="n">without_ordering</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">select_sql</span><span class="p">:</span>
                    <span class="n">extra_select</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">expr</span><span class="p">,</span> <span class="p">(</span><span class="n">without_ordering</span><span class="p">,</span> <span class="n">params</span><span class="p">),</span> <span class="kc">None</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">extra_select</span></div>


<div class="viewcode-block" id="SQLCompiler.quote_name_unless_alias">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/compiler/index.html#django.db.models.sql.compiler.SQLCompiler.quote_name_unless_alias">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">quote_name_unless_alias</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A wrapper around connection.ops.quote_name that doesn&#39;t quote aliases</span>
<span class="sd">        for table names. This avoids problems with some SQL dialects that treat</span>
<span class="sd">        quoted strings specially (e.g. PostgreSQL).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">quote_cache</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">quote_cache</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="p">(</span><span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">alias_map</span> <span class="ow">and</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">table_map</span><span class="p">)</span>
            <span class="ow">or</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">extra_select</span>
            <span class="ow">or</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">external_aliases</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                <span class="ow">and</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">table_map</span>
            <span class="p">)</span>
        <span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">quote_cache</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">name</span>
            <span class="k">return</span> <span class="n">name</span>
        <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">quote_name</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">quote_cache</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">r</span>
        <span class="k">return</span> <span class="n">r</span></div>


<div class="viewcode-block" id="SQLCompiler.compile">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/compiler/index.html#django.db.models.sql.compiler.SQLCompiler.compile">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">compile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="n">vendor_impl</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s2">&quot;as_&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">vendor</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">vendor_impl</span><span class="p">:</span>
            <span class="n">sql</span><span class="p">,</span> <span class="n">params</span> <span class="o">=</span> <span class="n">vendor_impl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sql</span><span class="p">,</span> <span class="n">params</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">as_sql</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">sql</span><span class="p">,</span> <span class="n">params</span></div>


<div class="viewcode-block" id="SQLCompiler.get_combinator_sql">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/compiler/index.html#django.db.models.sql.compiler.SQLCompiler.get_combinator_sql">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_combinator_sql</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">combinator</span><span class="p">,</span> <span class="nb">all</span><span class="p">):</span>
        <span class="n">features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">features</span>
        <span class="n">compilers</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">query</span><span class="o">.</span><span class="n">get_compiler</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">using</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">elide_empty</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">query</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">combined_queries</span>
        <span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">features</span><span class="o">.</span><span class="n">supports_slicing_ordering_in_compound</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">compiler</span> <span class="ow">in</span> <span class="n">compilers</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">compiler</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">is_sliced</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">DatabaseError</span><span class="p">(</span>
                        <span class="s2">&quot;LIMIT/OFFSET not allowed in subqueries of compound statements.&quot;</span>
                    <span class="p">)</span>
                <span class="k">if</span> <span class="n">compiler</span><span class="o">.</span><span class="n">get_order_by</span><span class="p">():</span>
                    <span class="k">raise</span> <span class="n">DatabaseError</span><span class="p">(</span>
                        <span class="s2">&quot;ORDER BY not allowed in subqueries of compound statements.&quot;</span>
                    <span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">is_sliced</span> <span class="ow">and</span> <span class="n">combinator</span> <span class="o">==</span> <span class="s2">&quot;union&quot;</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">compiler</span> <span class="ow">in</span> <span class="n">compilers</span><span class="p">:</span>
                <span class="c1"># A sliced union cannot have its parts elided as some of them</span>
                <span class="c1"># might be sliced as well and in the event where only a single</span>
                <span class="c1"># part produces a non-empty resultset it might be impossible to</span>
                <span class="c1"># generate valid SQL.</span>
                <span class="n">compiler</span><span class="o">.</span><span class="n">elide_empty</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">parts</span> <span class="o">=</span> <span class="p">()</span>
        <span class="k">for</span> <span class="n">compiler</span> <span class="ow">in</span> <span class="n">compilers</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># If the columns list is limited, then all combined queries</span>
                <span class="c1"># must have the same columns list. Set the selects defined on</span>
                <span class="c1"># the query on all combined queries, if not already set.</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">compiler</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">values_select</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">values_select</span><span class="p">:</span>
                    <span class="n">compiler</span><span class="o">.</span><span class="n">query</span> <span class="o">=</span> <span class="n">compiler</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
                    <span class="n">compiler</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">set_values</span><span class="p">(</span>
                        <span class="p">(</span>
                            <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">extra_select</span><span class="p">,</span>
                            <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">values_select</span><span class="p">,</span>
                            <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">annotation_select</span><span class="p">,</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
                <span class="n">part_sql</span><span class="p">,</span> <span class="n">part_args</span> <span class="o">=</span> <span class="n">compiler</span><span class="o">.</span><span class="n">as_sql</span><span class="p">(</span><span class="n">with_col_aliases</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">compiler</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">combinator</span><span class="p">:</span>
                    <span class="c1"># Wrap in a subquery if wrapping in parentheses isn&#39;t</span>
                    <span class="c1"># supported.</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">features</span><span class="o">.</span><span class="n">supports_parentheses_in_compound</span><span class="p">:</span>
                        <span class="n">part_sql</span> <span class="o">=</span> <span class="s2">&quot;SELECT * FROM (</span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">part_sql</span><span class="p">)</span>
                    <span class="c1"># Add parentheses when combining with compound query if not</span>
                    <span class="c1"># already added for all compound queries.</span>
                    <span class="k">elif</span> <span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">subquery</span>
                        <span class="ow">or</span> <span class="ow">not</span> <span class="n">features</span><span class="o">.</span><span class="n">supports_slicing_ordering_in_compound</span>
                    <span class="p">):</span>
                        <span class="n">part_sql</span> <span class="o">=</span> <span class="s2">&quot;(</span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">part_sql</span><span class="p">)</span>
                <span class="k">elif</span> <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">subquery</span>
                    <span class="ow">and</span> <span class="n">features</span><span class="o">.</span><span class="n">supports_slicing_ordering_in_compound</span>
                <span class="p">):</span>
                    <span class="n">part_sql</span> <span class="o">=</span> <span class="s2">&quot;(</span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">part_sql</span><span class="p">)</span>
                <span class="n">parts</span> <span class="o">+=</span> <span class="p">((</span><span class="n">part_sql</span><span class="p">,</span> <span class="n">part_args</span><span class="p">),)</span>
            <span class="k">except</span> <span class="n">EmptyResultSet</span><span class="p">:</span>
                <span class="c1"># Omit the empty queryset with UNION and with DIFFERENCE if the</span>
                <span class="c1"># first queryset is nonempty.</span>
                <span class="k">if</span> <span class="n">combinator</span> <span class="o">==</span> <span class="s2">&quot;union&quot;</span> <span class="ow">or</span> <span class="p">(</span><span class="n">combinator</span> <span class="o">==</span> <span class="s2">&quot;difference&quot;</span> <span class="ow">and</span> <span class="n">parts</span><span class="p">):</span>
                    <span class="k">continue</span>
                <span class="k">raise</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">parts</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">EmptyResultSet</span>
        <span class="n">combinator_sql</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">set_operators</span><span class="p">[</span><span class="n">combinator</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">all</span> <span class="ow">and</span> <span class="n">combinator</span> <span class="o">==</span> <span class="s2">&quot;union&quot;</span><span class="p">:</span>
            <span class="n">combinator_sql</span> <span class="o">+=</span> <span class="s2">&quot; ALL&quot;</span>
        <span class="n">braces</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">subquery</span> <span class="ow">and</span> <span class="n">features</span><span class="o">.</span><span class="n">supports_slicing_ordering_in_compound</span><span class="p">:</span>
            <span class="n">braces</span> <span class="o">=</span> <span class="s2">&quot;(</span><span class="si">{}</span><span class="s2">)&quot;</span>
        <span class="n">sql_parts</span><span class="p">,</span> <span class="n">args_parts</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span>
            <span class="o">*</span><span class="p">((</span><span class="n">braces</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sql</span><span class="p">),</span> <span class="n">args</span><span class="p">)</span> <span class="k">for</span> <span class="n">sql</span><span class="p">,</span> <span class="n">args</span> <span class="ow">in</span> <span class="n">parts</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot; </span><span class="si">{}</span><span class="s2"> &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">combinator_sql</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sql_parts</span><span class="p">)]</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">args_parts</span><span class="p">:</span>
            <span class="n">params</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">part</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span><span class="p">,</span> <span class="n">params</span></div>


<div class="viewcode-block" id="SQLCompiler.get_qualify_sql">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/compiler/index.html#django.db.models.sql.compiler.SQLCompiler.get_qualify_sql">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_qualify_sql</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">where_parts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">where</span><span class="p">:</span>
            <span class="n">where_parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">where</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">having</span><span class="p">:</span>
            <span class="n">where_parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">having</span><span class="p">)</span>
        <span class="n">inner_query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
        <span class="n">inner_query</span><span class="o">.</span><span class="n">subquery</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">inner_query</span><span class="o">.</span><span class="n">where</span> <span class="o">=</span> <span class="n">inner_query</span><span class="o">.</span><span class="n">where</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="n">where_parts</span><span class="p">)</span>
        <span class="c1"># Augment the inner query with any window function references that</span>
        <span class="c1"># might have been masked via values() and alias(). If any masked</span>
        <span class="c1"># aliases are added they&#39;ll be masked again to avoid fetching</span>
        <span class="c1"># the data in the `if qual_aliases` branch below.</span>
        <span class="n">select</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">expr</span><span class="p">:</span> <span class="n">alias</span> <span class="k">for</span> <span class="n">expr</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">alias</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_select</span><span class="p">(</span><span class="n">with_col_aliases</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="p">}</span>
        <span class="n">select_aliases</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">select</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="n">qual_aliases</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">replacements</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">collect_replacements</span><span class="p">(</span><span class="n">expressions</span><span class="p">):</span>
            <span class="k">while</span> <span class="n">expressions</span><span class="p">:</span>
                <span class="n">expr</span> <span class="o">=</span> <span class="n">expressions</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">expr</span> <span class="ow">in</span> <span class="n">replacements</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">elif</span> <span class="n">select_alias</span> <span class="o">:=</span> <span class="n">select</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">expr</span><span class="p">):</span>
                    <span class="n">replacements</span><span class="p">[</span><span class="n">expr</span><span class="p">]</span> <span class="o">=</span> <span class="n">select_alias</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">Lookup</span><span class="p">):</span>
                    <span class="n">expressions</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">get_source_expressions</span><span class="p">())</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">Ref</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">expr</span><span class="o">.</span><span class="n">refs</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">select_aliases</span><span class="p">:</span>
                        <span class="n">expressions</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">get_source_expressions</span><span class="p">())</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">num_qual_alias</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">qual_aliases</span><span class="p">)</span>
                    <span class="n">select_alias</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;qual</span><span class="si">{</span><span class="n">num_qual_alias</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="n">qual_aliases</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">select_alias</span><span class="p">)</span>
                    <span class="n">inner_query</span><span class="o">.</span><span class="n">add_annotation</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">select_alias</span><span class="p">)</span>
                    <span class="n">replacements</span><span class="p">[</span><span class="n">expr</span><span class="p">]</span> <span class="o">=</span> <span class="n">select_alias</span>

        <span class="n">collect_replacements</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qualify</span><span class="o">.</span><span class="n">leaves</span><span class="p">()))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qualify</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">qualify</span><span class="o">.</span><span class="n">replace_expressions</span><span class="p">(</span>
            <span class="p">{</span><span class="n">expr</span><span class="p">:</span> <span class="n">Ref</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="n">expr</span><span class="p">)</span> <span class="k">for</span> <span class="n">expr</span><span class="p">,</span> <span class="n">alias</span> <span class="ow">in</span> <span class="n">replacements</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
        <span class="p">)</span>
        <span class="n">order_by</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">order_by_expr</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_order_by</span><span class="p">():</span>
            <span class="n">collect_replacements</span><span class="p">(</span><span class="n">order_by_expr</span><span class="o">.</span><span class="n">get_source_expressions</span><span class="p">())</span>
            <span class="n">order_by</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">order_by_expr</span><span class="o">.</span><span class="n">replace_expressions</span><span class="p">(</span>
                    <span class="p">{</span><span class="n">expr</span><span class="p">:</span> <span class="n">Ref</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="n">expr</span><span class="p">)</span> <span class="k">for</span> <span class="n">expr</span><span class="p">,</span> <span class="n">alias</span> <span class="ow">in</span> <span class="n">replacements</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="n">inner_query_compiler</span> <span class="o">=</span> <span class="n">inner_query</span><span class="o">.</span><span class="n">get_compiler</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">using</span><span class="p">,</span> <span class="n">connection</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="p">,</span> <span class="n">elide_empty</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">elide_empty</span>
        <span class="p">)</span>
        <span class="n">inner_sql</span><span class="p">,</span> <span class="n">inner_params</span> <span class="o">=</span> <span class="n">inner_query_compiler</span><span class="o">.</span><span class="n">as_sql</span><span class="p">(</span>
            <span class="c1"># The limits must be applied to the outer query to avoid pruning</span>
            <span class="c1"># results too eagerly.</span>
            <span class="n">with_limits</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="c1"># Force unique aliasing of selected columns to avoid collisions</span>
            <span class="c1"># and make rhs predicates referencing easier.</span>
            <span class="n">with_col_aliases</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">qualify_sql</span><span class="p">,</span> <span class="n">qualify_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qualify</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;SELECT * FROM (&quot;</span><span class="p">,</span>
            <span class="n">inner_sql</span><span class="p">,</span>
            <span class="s2">&quot;)&quot;</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">quote_name</span><span class="p">(</span><span class="s2">&quot;qualify&quot;</span><span class="p">),</span>
            <span class="s2">&quot;WHERE&quot;</span><span class="p">,</span>
            <span class="n">qualify_sql</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="k">if</span> <span class="n">qual_aliases</span><span class="p">:</span>
            <span class="c1"># If some select aliases were unmasked for filtering purposes they</span>
            <span class="c1"># must be masked back.</span>
            <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">quote_name</span><span class="p">(</span><span class="n">alias</span><span class="p">)</span> <span class="k">for</span> <span class="n">alias</span> <span class="ow">in</span> <span class="n">select</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>
            <span class="n">result</span> <span class="o">=</span> <span class="p">[</span>
                <span class="s2">&quot;SELECT&quot;</span><span class="p">,</span>
                <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cols</span><span class="p">),</span>
                <span class="s2">&quot;FROM (&quot;</span><span class="p">,</span>
                <span class="o">*</span><span class="n">result</span><span class="p">,</span>
                <span class="s2">&quot;)&quot;</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">quote_name</span><span class="p">(</span><span class="s2">&quot;qualify_mask&quot;</span><span class="p">),</span>
            <span class="p">]</span>
        <span class="n">params</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">inner_params</span><span class="p">)</span> <span class="o">+</span> <span class="n">qualify_params</span>
        <span class="c1"># As the SQL spec is unclear on whether or not derived tables</span>
        <span class="c1"># ordering must propagate it has to be explicitly repeated on the</span>
        <span class="c1"># outer-most query to ensure it&#39;s preserved.</span>
        <span class="k">if</span> <span class="n">order_by</span><span class="p">:</span>
            <span class="n">ordering_sqls</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">ordering</span> <span class="ow">in</span> <span class="n">order_by</span><span class="p">:</span>
                <span class="n">ordering_sql</span><span class="p">,</span> <span class="n">ordering_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">ordering</span><span class="p">)</span>
                <span class="n">ordering_sqls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ordering_sql</span><span class="p">)</span>
                <span class="n">params</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">ordering_params</span><span class="p">)</span>
            <span class="n">result</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s2">&quot;ORDER BY&quot;</span><span class="p">,</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ordering_sqls</span><span class="p">)])</span>
        <span class="k">return</span> <span class="n">result</span><span class="p">,</span> <span class="n">params</span></div>


<div class="viewcode-block" id="SQLCompiler.as_sql">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/compiler/index.html#django.db.models.sql.compiler.SQLCompiler.as_sql">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">as_sql</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">with_limits</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">with_col_aliases</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create the SQL for this query. Return the SQL string and list of</span>
<span class="sd">        parameters.</span>

<span class="sd">        If &#39;with_limits&#39; is False, any limit/offset information is not included</span>
<span class="sd">        in the query.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">refcounts_before</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">alias_refcount</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">combinator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">combinator</span>
            <span class="n">extra_select</span><span class="p">,</span> <span class="n">order_by</span><span class="p">,</span> <span class="n">group_by</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre_sql_setup</span><span class="p">(</span>
                <span class="n">with_col_aliases</span><span class="o">=</span><span class="n">with_col_aliases</span> <span class="ow">or</span> <span class="nb">bool</span><span class="p">(</span><span class="n">combinator</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="n">for_update_part</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="c1"># Is a LIMIT/OFFSET clause needed?</span>
            <span class="n">with_limit_offset</span> <span class="o">=</span> <span class="n">with_limits</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">is_sliced</span>
            <span class="n">combinator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">combinator</span>
            <span class="n">features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">features</span>
            <span class="k">if</span> <span class="n">combinator</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">features</span><span class="p">,</span> <span class="s2">&quot;supports_select_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">combinator</span><span class="p">)):</span>
                    <span class="k">raise</span> <span class="n">NotSupportedError</span><span class="p">(</span>
                        <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> is not supported on this database backend.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">combinator</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
                <span class="n">result</span><span class="p">,</span> <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_combinator_sql</span><span class="p">(</span>
                    <span class="n">combinator</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">combinator_all</span>
                <span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">qualify</span><span class="p">:</span>
                <span class="n">result</span><span class="p">,</span> <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_qualify_sql</span><span class="p">()</span>
                <span class="n">order_by</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">distinct_fields</span><span class="p">,</span> <span class="n">distinct_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_distinct</span><span class="p">()</span>
                <span class="c1"># This must come after &#39;select&#39;, &#39;ordering&#39;, and &#39;distinct&#39;</span>
                <span class="c1"># (see docstring of get_from_clause() for details).</span>
                <span class="n">from_</span><span class="p">,</span> <span class="n">f_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_from_clause</span><span class="p">()</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">where</span><span class="p">,</span> <span class="n">w_params</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">where</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">where</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="p">[])</span>
                    <span class="p">)</span>
                <span class="k">except</span> <span class="n">EmptyResultSet</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">elide_empty</span><span class="p">:</span>
                        <span class="k">raise</span>
                    <span class="c1"># Use a predicate that&#39;s always False.</span>
                    <span class="n">where</span><span class="p">,</span> <span class="n">w_params</span> <span class="o">=</span> <span class="s2">&quot;0 = 1&quot;</span><span class="p">,</span> <span class="p">[]</span>
                <span class="k">except</span> <span class="n">FullResultSet</span><span class="p">:</span>
                    <span class="n">where</span><span class="p">,</span> <span class="n">w_params</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="p">[]</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">having</span><span class="p">,</span> <span class="n">h_params</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">having</span><span class="p">)</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">having</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                        <span class="k">else</span> <span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="p">[])</span>
                    <span class="p">)</span>
                <span class="k">except</span> <span class="n">FullResultSet</span><span class="p">:</span>
                    <span class="n">having</span><span class="p">,</span> <span class="n">h_params</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="p">[]</span>
                <span class="n">result</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;SELECT&quot;</span><span class="p">]</span>
                <span class="n">params</span> <span class="o">=</span> <span class="p">[]</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">distinct</span><span class="p">:</span>
                    <span class="n">distinct_result</span><span class="p">,</span> <span class="n">distinct_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">distinct_sql</span><span class="p">(</span>
                        <span class="n">distinct_fields</span><span class="p">,</span>
                        <span class="n">distinct_params</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="n">result</span> <span class="o">+=</span> <span class="n">distinct_result</span>
                    <span class="n">params</span> <span class="o">+=</span> <span class="n">distinct_params</span>

                <span class="n">out_cols</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="p">(</span><span class="n">s_sql</span><span class="p">,</span> <span class="n">s_params</span><span class="p">),</span> <span class="n">alias</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">select</span> <span class="o">+</span> <span class="n">extra_select</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">alias</span><span class="p">:</span>
                        <span class="n">s_sql</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> AS </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">s_sql</span><span class="p">,</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">quote_name</span><span class="p">(</span><span class="n">alias</span><span class="p">),</span>
                        <span class="p">)</span>
                    <span class="n">params</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">s_params</span><span class="p">)</span>
                    <span class="n">out_cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s_sql</span><span class="p">)</span>

                <span class="n">result</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_cols</span><span class="p">)]</span>
                <span class="k">if</span> <span class="n">from_</span><span class="p">:</span>
                    <span class="n">result</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;FROM&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">from_</span><span class="p">]</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">bare_select_suffix</span><span class="p">:</span>
                    <span class="n">result</span> <span class="o">+=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">bare_select_suffix</span><span class="p">]</span>
                <span class="n">params</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">f_params</span><span class="p">)</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">select_for_update</span> <span class="ow">and</span> <span class="n">features</span><span class="o">.</span><span class="n">has_select_for_update</span><span class="p">:</span>
                    <span class="k">if</span> <span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">get_autocommit</span><span class="p">()</span>
                        <span class="c1"># Don&#39;t raise an exception when database doesn&#39;t</span>
                        <span class="c1"># support transactions, as it&#39;s a noop.</span>
                        <span class="ow">and</span> <span class="n">features</span><span class="o">.</span><span class="n">supports_transactions</span>
                    <span class="p">):</span>
                        <span class="k">raise</span> <span class="n">TransactionManagementError</span><span class="p">(</span>
                            <span class="s2">&quot;select_for_update cannot be used outside of a transaction.&quot;</span>
                        <span class="p">)</span>

                    <span class="k">if</span> <span class="p">(</span>
                        <span class="n">with_limit_offset</span>
                        <span class="ow">and</span> <span class="ow">not</span> <span class="n">features</span><span class="o">.</span><span class="n">supports_select_for_update_with_limit</span>
                    <span class="p">):</span>
                        <span class="k">raise</span> <span class="n">NotSupportedError</span><span class="p">(</span>
                            <span class="s2">&quot;LIMIT/OFFSET is not supported with &quot;</span>
                            <span class="s2">&quot;select_for_update on this database backend.&quot;</span>
                        <span class="p">)</span>
                    <span class="n">nowait</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">select_for_update_nowait</span>
                    <span class="n">skip_locked</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">select_for_update_skip_locked</span>
                    <span class="n">of</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">select_for_update_of</span>
                    <span class="n">no_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">select_for_no_key_update</span>
                    <span class="c1"># If it&#39;s a NOWAIT/SKIP LOCKED/OF/NO KEY query but the</span>
                    <span class="c1"># backend doesn&#39;t support it, raise NotSupportedError to</span>
                    <span class="c1"># prevent a possible deadlock.</span>
                    <span class="k">if</span> <span class="n">nowait</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">features</span><span class="o">.</span><span class="n">has_select_for_update_nowait</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">NotSupportedError</span><span class="p">(</span>
                            <span class="s2">&quot;NOWAIT is not supported on this database backend.&quot;</span>
                        <span class="p">)</span>
                    <span class="k">elif</span> <span class="n">skip_locked</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">features</span><span class="o">.</span><span class="n">has_select_for_update_skip_locked</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">NotSupportedError</span><span class="p">(</span>
                            <span class="s2">&quot;SKIP LOCKED is not supported on this database backend.&quot;</span>
                        <span class="p">)</span>
                    <span class="k">elif</span> <span class="n">of</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">features</span><span class="o">.</span><span class="n">has_select_for_update_of</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">NotSupportedError</span><span class="p">(</span>
                            <span class="s2">&quot;FOR UPDATE OF is not supported on this database backend.&quot;</span>
                        <span class="p">)</span>
                    <span class="k">elif</span> <span class="n">no_key</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">features</span><span class="o">.</span><span class="n">has_select_for_no_key_update</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">NotSupportedError</span><span class="p">(</span>
                            <span class="s2">&quot;FOR NO KEY UPDATE is not supported on this &quot;</span>
                            <span class="s2">&quot;database backend.&quot;</span>
                        <span class="p">)</span>
                    <span class="n">for_update_part</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">for_update_sql</span><span class="p">(</span>
                        <span class="n">nowait</span><span class="o">=</span><span class="n">nowait</span><span class="p">,</span>
                        <span class="n">skip_locked</span><span class="o">=</span><span class="n">skip_locked</span><span class="p">,</span>
                        <span class="n">of</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_select_for_update_of_arguments</span><span class="p">(),</span>
                        <span class="n">no_key</span><span class="o">=</span><span class="n">no_key</span><span class="p">,</span>
                    <span class="p">)</span>

                <span class="k">if</span> <span class="n">for_update_part</span> <span class="ow">and</span> <span class="n">features</span><span class="o">.</span><span class="n">for_update_after_from</span><span class="p">:</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">for_update_part</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">where</span><span class="p">:</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;WHERE </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">where</span><span class="p">)</span>
                    <span class="n">params</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">w_params</span><span class="p">)</span>

                <span class="n">grouping</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">g_sql</span><span class="p">,</span> <span class="n">g_params</span> <span class="ow">in</span> <span class="n">group_by</span><span class="p">:</span>
                    <span class="n">grouping</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">g_sql</span><span class="p">)</span>
                    <span class="n">params</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">g_params</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">grouping</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">distinct_fields</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                            <span class="s2">&quot;annotate() + distinct(fields) is not implemented.&quot;</span>
                        <span class="p">)</span>
                    <span class="n">order_by</span> <span class="o">=</span> <span class="n">order_by</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">force_no_ordering</span><span class="p">()</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;GROUP BY </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">grouping</span><span class="p">))</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta_ordering</span><span class="p">:</span>
                        <span class="n">order_by</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="n">having</span><span class="p">:</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;HAVING </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">having</span><span class="p">)</span>
                    <span class="n">params</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">h_params</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">explain_info</span><span class="p">:</span>
                <span class="n">result</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span>
                    <span class="mi">0</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">explain_query_prefix</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">explain_info</span><span class="o">.</span><span class="n">format</span><span class="p">,</span>
                        <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">explain_info</span><span class="o">.</span><span class="n">options</span><span class="p">,</span>
                    <span class="p">),</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="n">order_by</span><span class="p">:</span>
                <span class="n">ordering</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="p">(</span><span class="n">o_sql</span><span class="p">,</span> <span class="n">o_params</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="ow">in</span> <span class="n">order_by</span><span class="p">:</span>
                    <span class="n">ordering</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">o_sql</span><span class="p">)</span>
                    <span class="n">params</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">o_params</span><span class="p">)</span>
                <span class="n">order_by_sql</span> <span class="o">=</span> <span class="s2">&quot;ORDER BY </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ordering</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">combinator</span> <span class="ow">and</span> <span class="n">features</span><span class="o">.</span><span class="n">requires_compound_order_by_subquery</span><span class="p">:</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;SELECT * FROM (&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">result</span><span class="p">,</span> <span class="s2">&quot;)&quot;</span><span class="p">,</span> <span class="n">order_by_sql</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">order_by_sql</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">with_limit_offset</span><span class="p">:</span>
                <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">limit_offset_sql</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">low_mark</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">high_mark</span>
                    <span class="p">)</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="n">for_update_part</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">features</span><span class="o">.</span><span class="n">for_update_after_from</span><span class="p">:</span>
                <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">for_update_part</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">subquery</span> <span class="ow">and</span> <span class="n">extra_select</span><span class="p">:</span>
                <span class="c1"># If the query is used as a subquery, the extra selects would</span>
                <span class="c1"># result in more columns than the left-hand side expression is</span>
                <span class="c1"># expecting. This can happen when a subquery uses a combination</span>
                <span class="c1"># of order_by() and distinct(), forcing the ordering expressions</span>
                <span class="c1"># to be selected as well. Wrap the query in another subquery</span>
                <span class="c1"># to exclude extraneous selects.</span>
                <span class="n">sub_selects</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">sub_params</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="p">(</span><span class="n">select</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">alias</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">select</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">alias</span><span class="p">:</span>
                        <span class="n">sub_selects</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">.</span><span class="si">%s</span><span class="s2">&quot;</span>
                            <span class="o">%</span> <span class="p">(</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">quote_name</span><span class="p">(</span><span class="s2">&quot;subquery&quot;</span><span class="p">),</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">quote_name</span><span class="p">(</span><span class="n">alias</span><span class="p">),</span>
                            <span class="p">)</span>
                        <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">select_clone</span> <span class="o">=</span> <span class="n">select</span><span class="o">.</span><span class="n">relabeled_clone</span><span class="p">(</span>
                            <span class="p">{</span><span class="n">select</span><span class="o">.</span><span class="n">alias</span><span class="p">:</span> <span class="s2">&quot;subquery&quot;</span><span class="p">}</span>
                        <span class="p">)</span>
                        <span class="n">subselect</span><span class="p">,</span> <span class="n">subparams</span> <span class="o">=</span> <span class="n">select_clone</span><span class="o">.</span><span class="n">as_sql</span><span class="p">(</span>
                            <span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span>
                        <span class="p">)</span>
                        <span class="n">sub_selects</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">subselect</span><span class="p">)</span>
                        <span class="n">sub_params</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">subparams</span><span class="p">)</span>
                <span class="k">return</span> <span class="s2">&quot;SELECT </span><span class="si">%s</span><span class="s2"> FROM (</span><span class="si">%s</span><span class="s2">) subquery&quot;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sub_selects</span><span class="p">),</span>
                    <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">result</span><span class="p">),</span>
                <span class="p">),</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">sub_params</span> <span class="o">+</span> <span class="n">params</span><span class="p">)</span>

            <span class="k">return</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">result</span><span class="p">),</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="c1"># Finally do cleanup - get rid of the joins we created above.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">reset_refcounts</span><span class="p">(</span><span class="n">refcounts_before</span><span class="p">)</span></div>


<div class="viewcode-block" id="SQLCompiler.get_default_columns">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/compiler/index.html#django.db.models.sql.compiler.SQLCompiler.get_default_columns">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_default_columns</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">select_mask</span><span class="p">,</span> <span class="n">start_alias</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">opts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">from_parent</span><span class="o">=</span><span class="kc">None</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute the default columns for selecting every field in the base</span>
<span class="sd">        model. Will sometimes be called to pull in related models (e.g. via</span>
<span class="sd">        select_related), in which case &quot;opts&quot; and &quot;start_alias&quot; will be given</span>
<span class="sd">        to provide a starting point for the traversal.</span>

<span class="sd">        Return a list of strings, quoted appropriately for use in SQL</span>
<span class="sd">        directly, as well as a set of aliases used in the select statement (if</span>
<span class="sd">        &#39;as_pairs&#39; is True, return a list of (alias, col_name) pairs instead</span>
<span class="sd">        of strings as the first component and None as the second component).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">opts</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">opts</span> <span class="o">:=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">get_meta</span><span class="p">())</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">result</span>
        <span class="n">start_alias</span> <span class="o">=</span> <span class="n">start_alias</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">get_initial_alias</span><span class="p">()</span>
        <span class="c1"># The &#39;seen_models&#39; is used to optimize checking the needed parent</span>
        <span class="c1"># alias for a given field. This also includes None -&gt; start_alias to</span>
        <span class="c1"># be used by local fields.</span>
        <span class="n">seen_models</span> <span class="o">=</span> <span class="p">{</span><span class="kc">None</span><span class="p">:</span> <span class="n">start_alias</span><span class="p">}</span>

        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">opts</span><span class="o">.</span><span class="n">concrete_fields</span><span class="p">:</span>
            <span class="n">model</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">concrete_model</span>
            <span class="c1"># A proxy model will have a different model and concrete_model. We</span>
            <span class="c1"># will assign None if the field belongs to this model.</span>
            <span class="k">if</span> <span class="n">model</span> <span class="o">==</span> <span class="n">opts</span><span class="o">.</span><span class="n">model</span><span class="p">:</span>
                <span class="n">model</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="n">from_parent</span>
                <span class="ow">and</span> <span class="n">model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                <span class="ow">and</span> <span class="nb">issubclass</span><span class="p">(</span>
                    <span class="n">from_parent</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">concrete_model</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">concrete_model</span>
                <span class="p">)</span>
            <span class="p">):</span>
                <span class="c1"># Avoid loading data for already loaded parents.</span>
                <span class="c1"># We end up here in the case select_related() resolution</span>
                <span class="c1"># proceeds from parent model to child model. In that case the</span>
                <span class="c1"># parent model data is already present in the SELECT clause,</span>
                <span class="c1"># and we want to avoid reloading the same data again.</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">select_mask</span> <span class="ow">and</span> <span class="n">field</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">select_mask</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">alias</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">join_parent_model</span><span class="p">(</span><span class="n">opts</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">start_alias</span><span class="p">,</span> <span class="n">seen_models</span><span class="p">)</span>
            <span class="n">column</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">get_col</span><span class="p">(</span><span class="n">alias</span><span class="p">)</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">column</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span></div>


<div class="viewcode-block" id="SQLCompiler.get_distinct">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/compiler/index.html#django.db.models.sql.compiler.SQLCompiler.get_distinct">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_distinct</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a quoted list of fields to use in DISTINCT ON part of the query.</span>

<span class="sd">        This method can alter the tables in the query, and thus it must be</span>
<span class="sd">        called before get_from_clause().</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">opts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">get_meta</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">distinct_fields</span><span class="p">:</span>
            <span class="n">parts</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">LOOKUP_SEP</span><span class="p">)</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">targets</span><span class="p">,</span> <span class="n">alias</span><span class="p">,</span> <span class="n">joins</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">transform_function</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_setup_joins</span><span class="p">(</span>
                <span class="n">parts</span><span class="p">,</span> <span class="n">opts</span><span class="p">,</span> <span class="kc">None</span>
            <span class="p">)</span>
            <span class="n">targets</span><span class="p">,</span> <span class="n">alias</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">trim_joins</span><span class="p">(</span><span class="n">targets</span><span class="p">,</span> <span class="n">joins</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">target</span> <span class="ow">in</span> <span class="n">targets</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">annotation_select</span><span class="p">:</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">quote_name</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">r</span><span class="p">,</span> <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">transform_function</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">alias</span><span class="p">))</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
                    <span class="n">params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span><span class="p">,</span> <span class="n">params</span></div>


<div class="viewcode-block" id="SQLCompiler.find_ordering_name">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/compiler/index.html#django.db.models.sql.compiler.SQLCompiler.find_ordering_name">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">find_ordering_name</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">opts</span><span class="p">,</span> <span class="n">alias</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">default_order</span><span class="o">=</span><span class="s2">&quot;ASC&quot;</span><span class="p">,</span> <span class="n">already_seen</span><span class="o">=</span><span class="kc">None</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the table alias (the name might be ambiguous, the alias will</span>
<span class="sd">        not be) and column name for ordering by the given &#39;name&#39; parameter.</span>
<span class="sd">        The &#39;name&#39; is of the form &#39;field1__field2__...__fieldN&#39;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">name</span><span class="p">,</span> <span class="n">order</span> <span class="o">=</span> <span class="n">get_order_dir</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">default_order</span><span class="p">)</span>
        <span class="n">descending</span> <span class="o">=</span> <span class="n">order</span> <span class="o">==</span> <span class="s2">&quot;DESC&quot;</span>
        <span class="n">pieces</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">LOOKUP_SEP</span><span class="p">)</span>
        <span class="p">(</span>
            <span class="n">field</span><span class="p">,</span>
            <span class="n">targets</span><span class="p">,</span>
            <span class="n">alias</span><span class="p">,</span>
            <span class="n">joins</span><span class="p">,</span>
            <span class="n">path</span><span class="p">,</span>
            <span class="n">opts</span><span class="p">,</span>
            <span class="n">transform_function</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_setup_joins</span><span class="p">(</span><span class="n">pieces</span><span class="p">,</span> <span class="n">opts</span><span class="p">,</span> <span class="n">alias</span><span class="p">)</span>

        <span class="c1"># If we get to this point and the field is a relation to another model,</span>
        <span class="c1"># append the default ordering for that model unless it is the pk</span>
        <span class="c1"># shortcut or the attribute name of the field that is specified or</span>
        <span class="c1"># there are transforms to process.</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">field</span><span class="o">.</span><span class="n">is_relation</span>
            <span class="ow">and</span> <span class="n">opts</span><span class="o">.</span><span class="n">ordering</span>
            <span class="ow">and</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="s2">&quot;attname&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="o">!=</span> <span class="n">pieces</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="ow">and</span> <span class="n">name</span> <span class="o">!=</span> <span class="s2">&quot;pk&quot;</span>
            <span class="ow">and</span> <span class="ow">not</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">transform_function</span><span class="p">,</span> <span class="s2">&quot;has_transforms&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="c1"># Firstly, avoid infinite loops.</span>
            <span class="n">already_seen</span> <span class="o">=</span> <span class="n">already_seen</span> <span class="ow">or</span> <span class="nb">set</span><span class="p">()</span>
            <span class="n">join_tuple</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span>
                <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">alias_map</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="s2">&quot;join_cols&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">joins</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">join_tuple</span> <span class="ow">in</span> <span class="n">already_seen</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">FieldError</span><span class="p">(</span><span class="s2">&quot;Infinite loop caused by ordering.&quot;</span><span class="p">)</span>
            <span class="n">already_seen</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">join_tuple</span><span class="p">)</span>

            <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">opts</span><span class="o">.</span><span class="n">ordering</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="s2">&quot;resolve_expression&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span>
                    <span class="n">item</span><span class="p">,</span> <span class="n">OrderBy</span>
                <span class="p">):</span>
                    <span class="n">item</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">desc</span><span class="p">()</span> <span class="k">if</span> <span class="n">descending</span> <span class="k">else</span> <span class="n">item</span><span class="o">.</span><span class="n">asc</span><span class="p">()</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">OrderBy</span><span class="p">):</span>
                    <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">prefix_references</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}{</span><span class="n">LOOKUP_SEP</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">),</span> <span class="kc">False</span><span class="p">)</span>
                    <span class="p">)</span>
                    <span class="k">continue</span>
                <span class="n">results</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
                    <span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">prefix_references</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}{</span><span class="n">LOOKUP_SEP</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">),</span> <span class="n">is_ref</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">expr</span><span class="p">,</span> <span class="n">is_ref</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_ordering_name</span><span class="p">(</span>
                        <span class="n">item</span><span class="p">,</span> <span class="n">opts</span><span class="p">,</span> <span class="n">alias</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="n">already_seen</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="k">return</span> <span class="n">results</span>
        <span class="n">targets</span><span class="p">,</span> <span class="n">alias</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">trim_joins</span><span class="p">(</span><span class="n">targets</span><span class="p">,</span> <span class="n">joins</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="p">(</span><span class="n">OrderBy</span><span class="p">(</span><span class="n">transform_function</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">alias</span><span class="p">),</span> <span class="n">descending</span><span class="o">=</span><span class="n">descending</span><span class="p">),</span> <span class="kc">False</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">targets</span>
        <span class="p">]</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_setup_joins</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pieces</span><span class="p">,</span> <span class="n">opts</span><span class="p">,</span> <span class="n">alias</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Helper method for get_order_by() and get_distinct().</span>

<span class="sd">        get_ordering() and get_distinct() must produce same target columns on</span>
<span class="sd">        same input, as the prefixes of get_ordering() and get_distinct() must</span>
<span class="sd">        match. Executing SQL where this is not true is an error.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">alias</span> <span class="o">=</span> <span class="n">alias</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">get_initial_alias</span><span class="p">()</span>
        <span class="n">field</span><span class="p">,</span> <span class="n">targets</span><span class="p">,</span> <span class="n">opts</span><span class="p">,</span> <span class="n">joins</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">transform_function</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">setup_joins</span><span class="p">(</span>
            <span class="n">pieces</span><span class="p">,</span> <span class="n">opts</span><span class="p">,</span> <span class="n">alias</span>
        <span class="p">)</span>
        <span class="n">alias</span> <span class="o">=</span> <span class="n">joins</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">field</span><span class="p">,</span> <span class="n">targets</span><span class="p">,</span> <span class="n">alias</span><span class="p">,</span> <span class="n">joins</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">opts</span><span class="p">,</span> <span class="n">transform_function</span>

<div class="viewcode-block" id="SQLCompiler.get_from_clause">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/compiler/index.html#django.db.models.sql.compiler.SQLCompiler.get_from_clause">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_from_clause</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a list of strings that are joined together to go after the</span>
<span class="sd">        &quot;FROM&quot; part of the query, as well as a list any extra parameters that</span>
<span class="sd">        need to be included. Subclasses, can override this to create a</span>
<span class="sd">        from-clause via a &quot;select&quot;.</span>

<span class="sd">        This should only be called after any SQL construction methods that</span>
<span class="sd">        might change the tables that are needed. This means the select columns,</span>
<span class="sd">        ordering, and distinct must be done first.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">alias</span> <span class="ow">in</span> <span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">alias_map</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">alias_refcount</span><span class="p">[</span><span class="n">alias</span><span class="p">]:</span>
                <span class="k">continue</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">from_clause</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">alias_map</span><span class="p">[</span><span class="n">alias</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="c1"># Extra tables can end up in self.tables, but not in the</span>
                <span class="c1"># alias_map if they aren&#39;t in a join. That&#39;s OK. We skip them.</span>
                <span class="k">continue</span>
            <span class="n">clause_sql</span><span class="p">,</span> <span class="n">clause_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">from_clause</span><span class="p">)</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">clause_sql</span><span class="p">)</span>
            <span class="n">params</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">clause_params</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">extra_tables</span><span class="p">:</span>
            <span class="n">alias</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">table_alias</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
            <span class="c1"># Only add the alias if it&#39;s not already present (the table_alias()</span>
            <span class="c1"># call increments the refcount, so an alias refcount of one means</span>
            <span class="c1"># this is the only reference).</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="n">alias</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">alias_map</span>
                <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">alias_refcount</span><span class="p">[</span><span class="n">alias</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span>
            <span class="p">):</span>
                <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;, </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">quote_name_unless_alias</span><span class="p">(</span><span class="n">alias</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">result</span><span class="p">,</span> <span class="n">params</span></div>


<div class="viewcode-block" id="SQLCompiler.get_related_selections">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/compiler/index.html#django.db.models.sql.compiler.SQLCompiler.get_related_selections">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_related_selections</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">select</span><span class="p">,</span>
        <span class="n">select_mask</span><span class="p">,</span>
        <span class="n">opts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">root_alias</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">cur_depth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">requested</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">restricted</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fill in the information needed for a select_related query. The current</span>
<span class="sd">        depth is measured as the number of connections away from the root model</span>
<span class="sd">        (for example, cur_depth=1 means we are looking at models with direct</span>
<span class="sd">        connections to the root model).</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">_get_field_choices</span><span class="p">():</span>
            <span class="n">direct_choices</span> <span class="o">=</span> <span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">opts</span><span class="o">.</span><span class="n">fields</span> <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">is_relation</span><span class="p">)</span>
            <span class="n">reverse_choices</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">f</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">related_query_name</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">opts</span><span class="o">.</span><span class="n">related_objects</span>
                <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">unique</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">chain</span><span class="p">(</span>
                <span class="n">direct_choices</span><span class="p">,</span> <span class="n">reverse_choices</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">_filtered_relations</span>
            <span class="p">)</span>

        <span class="n">related_klass_infos</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">restricted</span> <span class="ow">and</span> <span class="n">cur_depth</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">max_depth</span><span class="p">:</span>
            <span class="c1"># We&#39;ve recursed far enough; bail out.</span>
            <span class="k">return</span> <span class="n">related_klass_infos</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">opts</span><span class="p">:</span>
            <span class="n">opts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">get_meta</span><span class="p">()</span>
            <span class="n">root_alias</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">get_initial_alias</span><span class="p">()</span>

        <span class="c1"># Setup for the case when only particular related fields should be</span>
        <span class="c1"># included in the related selection.</span>
        <span class="n">fields_found</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">requested</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">restricted</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">select_related</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">restricted</span><span class="p">:</span>
                <span class="n">requested</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">select_related</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">get_related_klass_infos</span><span class="p">(</span><span class="n">klass_info</span><span class="p">,</span> <span class="n">related_klass_infos</span><span class="p">):</span>
            <span class="n">klass_info</span><span class="p">[</span><span class="s2">&quot;related_klass_infos&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">related_klass_infos</span>

        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">opts</span><span class="o">.</span><span class="n">fields</span><span class="p">:</span>
            <span class="n">fields_found</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">restricted</span><span class="p">:</span>
                <span class="nb">next</span> <span class="o">=</span> <span class="n">requested</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="p">{})</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">f</span><span class="o">.</span><span class="n">is_relation</span><span class="p">:</span>
                    <span class="c1"># If a non-related field is used like a relation,</span>
                    <span class="c1"># or if a single non-relational field is given.</span>
                    <span class="k">if</span> <span class="nb">next</span> <span class="ow">or</span> <span class="n">f</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">requested</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">FieldError</span><span class="p">(</span>
                            <span class="s2">&quot;Non-relational field given in select_related: &#39;</span><span class="si">%s</span><span class="s2">&#39;. &quot;</span>
                            <span class="s2">&quot;Choices are: </span><span class="si">%s</span><span class="s2">&quot;</span>
                            <span class="o">%</span> <span class="p">(</span>
                                <span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                                <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">_get_field_choices</span><span class="p">())</span> <span class="ow">or</span> <span class="s2">&quot;(none)&quot;</span><span class="p">,</span>
                            <span class="p">)</span>
                        <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">next</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">select_related_descend</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">restricted</span><span class="p">,</span> <span class="n">requested</span><span class="p">,</span> <span class="n">select_mask</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="n">related_select_mask</span> <span class="o">=</span> <span class="n">select_mask</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{}</span>
            <span class="n">klass_info</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;model&quot;</span><span class="p">:</span> <span class="n">f</span><span class="o">.</span><span class="n">remote_field</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
                <span class="s2">&quot;field&quot;</span><span class="p">:</span> <span class="n">f</span><span class="p">,</span>
                <span class="s2">&quot;reverse&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s2">&quot;local_setter&quot;</span><span class="p">:</span> <span class="n">f</span><span class="o">.</span><span class="n">set_cached_value</span><span class="p">,</span>
                <span class="s2">&quot;remote_setter&quot;</span><span class="p">:</span> <span class="n">f</span><span class="o">.</span><span class="n">remote_field</span><span class="o">.</span><span class="n">set_cached_value</span>
                <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">unique</span>
                <span class="k">else</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s2">&quot;from_parent&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="n">related_klass_infos</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">klass_info</span><span class="p">)</span>
            <span class="n">select_fields</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">joins</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">setup_joins</span><span class="p">([</span><span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">],</span> <span class="n">opts</span><span class="p">,</span> <span class="n">root_alias</span><span class="p">)</span>
            <span class="n">alias</span> <span class="o">=</span> <span class="n">joins</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">columns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_default_columns</span><span class="p">(</span>
                <span class="n">related_select_mask</span><span class="p">,</span> <span class="n">start_alias</span><span class="o">=</span><span class="n">alias</span><span class="p">,</span> <span class="n">opts</span><span class="o">=</span><span class="n">f</span><span class="o">.</span><span class="n">remote_field</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_meta</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">:</span>
                <span class="n">select_fields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">select</span><span class="p">))</span>
                <span class="n">select</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">col</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
            <span class="n">klass_info</span><span class="p">[</span><span class="s2">&quot;select_fields&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">select_fields</span>
            <span class="n">next_klass_infos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_related_selections</span><span class="p">(</span>
                <span class="n">select</span><span class="p">,</span>
                <span class="n">related_select_mask</span><span class="p">,</span>
                <span class="n">f</span><span class="o">.</span><span class="n">remote_field</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="p">,</span>
                <span class="n">alias</span><span class="p">,</span>
                <span class="n">cur_depth</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                <span class="nb">next</span><span class="p">,</span>
                <span class="n">restricted</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">get_related_klass_infos</span><span class="p">(</span><span class="n">klass_info</span><span class="p">,</span> <span class="n">next_klass_infos</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">restricted</span><span class="p">:</span>
            <span class="n">related_fields</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">(</span><span class="n">o</span><span class="o">.</span><span class="n">field</span><span class="p">,</span> <span class="n">o</span><span class="o">.</span><span class="n">related_model</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">opts</span><span class="o">.</span><span class="n">related_objects</span>
                <span class="k">if</span> <span class="n">o</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">unique</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">o</span><span class="o">.</span><span class="n">many_to_many</span>
            <span class="p">]</span>
            <span class="k">for</span> <span class="n">related_field</span><span class="p">,</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">related_fields</span><span class="p">:</span>
                <span class="n">related_select_mask</span> <span class="o">=</span> <span class="n">select_mask</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">related_field</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{}</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">select_related_descend</span><span class="p">(</span>
                    <span class="n">related_field</span><span class="p">,</span>
                    <span class="n">restricted</span><span class="p">,</span>
                    <span class="n">requested</span><span class="p">,</span>
                    <span class="n">related_select_mask</span><span class="p">,</span>
                    <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="p">):</span>
                    <span class="k">continue</span>

                <span class="n">related_field_name</span> <span class="o">=</span> <span class="n">related_field</span><span class="o">.</span><span class="n">related_query_name</span><span class="p">()</span>
                <span class="n">fields_found</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">related_field_name</span><span class="p">)</span>

                <span class="n">join_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">setup_joins</span><span class="p">(</span>
                    <span class="p">[</span><span class="n">related_field_name</span><span class="p">],</span> <span class="n">opts</span><span class="p">,</span> <span class="n">root_alias</span>
                <span class="p">)</span>
                <span class="n">alias</span> <span class="o">=</span> <span class="n">join_info</span><span class="o">.</span><span class="n">joins</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">from_parent</span> <span class="o">=</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">opts</span><span class="o">.</span><span class="n">model</span><span class="p">)</span> <span class="ow">and</span> <span class="n">model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">opts</span><span class="o">.</span><span class="n">model</span>
                <span class="n">klass_info</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;model&quot;</span><span class="p">:</span> <span class="n">model</span><span class="p">,</span>
                    <span class="s2">&quot;field&quot;</span><span class="p">:</span> <span class="n">related_field</span><span class="p">,</span>
                    <span class="s2">&quot;reverse&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                    <span class="s2">&quot;local_setter&quot;</span><span class="p">:</span> <span class="n">related_field</span><span class="o">.</span><span class="n">remote_field</span><span class="o">.</span><span class="n">set_cached_value</span><span class="p">,</span>
                    <span class="s2">&quot;remote_setter&quot;</span><span class="p">:</span> <span class="n">related_field</span><span class="o">.</span><span class="n">set_cached_value</span><span class="p">,</span>
                    <span class="s2">&quot;from_parent&quot;</span><span class="p">:</span> <span class="n">from_parent</span><span class="p">,</span>
                <span class="p">}</span>
                <span class="n">related_klass_infos</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">klass_info</span><span class="p">)</span>
                <span class="n">select_fields</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">columns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_default_columns</span><span class="p">(</span>
                    <span class="n">related_select_mask</span><span class="p">,</span>
                    <span class="n">start_alias</span><span class="o">=</span><span class="n">alias</span><span class="p">,</span>
                    <span class="n">opts</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="p">,</span>
                    <span class="n">from_parent</span><span class="o">=</span><span class="n">opts</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">:</span>
                    <span class="n">select_fields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">select</span><span class="p">))</span>
                    <span class="n">select</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">col</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
                <span class="n">klass_info</span><span class="p">[</span><span class="s2">&quot;select_fields&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">select_fields</span>
                <span class="nb">next</span> <span class="o">=</span> <span class="n">requested</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">related_field</span><span class="o">.</span><span class="n">related_query_name</span><span class="p">(),</span> <span class="p">{})</span>
                <span class="n">next_klass_infos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_related_selections</span><span class="p">(</span>
                    <span class="n">select</span><span class="p">,</span>
                    <span class="n">related_select_mask</span><span class="p">,</span>
                    <span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="p">,</span>
                    <span class="n">alias</span><span class="p">,</span>
                    <span class="n">cur_depth</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                    <span class="nb">next</span><span class="p">,</span>
                    <span class="n">restricted</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">get_related_klass_infos</span><span class="p">(</span><span class="n">klass_info</span><span class="p">,</span> <span class="n">next_klass_infos</span><span class="p">)</span>

            <span class="k">def</span><span class="w"> </span><span class="nf">local_setter</span><span class="p">(</span><span class="n">final_field</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">from_obj</span><span class="p">):</span>
                <span class="c1"># Set a reverse fk object when relation is non-empty.</span>
                <span class="k">if</span> <span class="n">from_obj</span><span class="p">:</span>
                    <span class="n">final_field</span><span class="o">.</span><span class="n">remote_field</span><span class="o">.</span><span class="n">set_cached_value</span><span class="p">(</span><span class="n">from_obj</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span>

            <span class="k">def</span><span class="w"> </span><span class="nf">local_setter_noop</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">from_obj</span><span class="p">):</span>
                <span class="k">pass</span>

            <span class="k">def</span><span class="w"> </span><span class="nf">remote_setter</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">from_obj</span><span class="p">):</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="n">from_obj</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">requested</span><span class="p">):</span>
                <span class="c1"># Filtered relations work only on the topmost level.</span>
                <span class="k">if</span> <span class="n">cur_depth</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">_filtered_relations</span><span class="p">:</span>
                    <span class="n">fields_found</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                    <span class="n">final_field</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">join_opts</span><span class="p">,</span> <span class="n">joins</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">setup_joins</span><span class="p">(</span>
                        <span class="p">[</span><span class="n">name</span><span class="p">],</span> <span class="n">opts</span><span class="p">,</span> <span class="n">root_alias</span>
                    <span class="p">)</span>
                    <span class="n">model</span> <span class="o">=</span> <span class="n">join_opts</span><span class="o">.</span><span class="n">model</span>
                    <span class="n">alias</span> <span class="o">=</span> <span class="n">joins</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">from_parent</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="nb">issubclass</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">opts</span><span class="o">.</span><span class="n">model</span><span class="p">)</span> <span class="ow">and</span> <span class="n">model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">opts</span><span class="o">.</span><span class="n">model</span>
                    <span class="p">)</span>
                    <span class="n">klass_info</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s2">&quot;model&quot;</span><span class="p">:</span> <span class="n">model</span><span class="p">,</span>
                        <span class="s2">&quot;field&quot;</span><span class="p">:</span> <span class="n">final_field</span><span class="p">,</span>
                        <span class="s2">&quot;reverse&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                        <span class="s2">&quot;local_setter&quot;</span><span class="p">:</span> <span class="p">(</span>
                            <span class="n">partial</span><span class="p">(</span><span class="n">local_setter</span><span class="p">,</span> <span class="n">final_field</span><span class="p">)</span>
                            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">joins</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">2</span>
                            <span class="k">else</span> <span class="n">local_setter_noop</span>
                        <span class="p">),</span>
                        <span class="s2">&quot;remote_setter&quot;</span><span class="p">:</span> <span class="n">partial</span><span class="p">(</span><span class="n">remote_setter</span><span class="p">,</span> <span class="n">name</span><span class="p">),</span>
                        <span class="s2">&quot;from_parent&quot;</span><span class="p">:</span> <span class="n">from_parent</span><span class="p">,</span>
                    <span class="p">}</span>
                    <span class="n">related_klass_infos</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">klass_info</span><span class="p">)</span>
                    <span class="n">select_fields</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">field_select_mask</span> <span class="o">=</span> <span class="n">select_mask</span><span class="o">.</span><span class="n">get</span><span class="p">((</span><span class="n">name</span><span class="p">,</span> <span class="n">final_field</span><span class="p">))</span> <span class="ow">or</span> <span class="p">{}</span>
                    <span class="n">columns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_default_columns</span><span class="p">(</span>
                        <span class="n">field_select_mask</span><span class="p">,</span>
                        <span class="n">start_alias</span><span class="o">=</span><span class="n">alias</span><span class="p">,</span>
                        <span class="n">opts</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="p">,</span>
                        <span class="n">from_parent</span><span class="o">=</span><span class="n">opts</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">:</span>
                        <span class="n">select_fields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">select</span><span class="p">))</span>
                        <span class="n">select</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">col</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
                    <span class="n">klass_info</span><span class="p">[</span><span class="s2">&quot;select_fields&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">select_fields</span>
                    <span class="n">next_requested</span> <span class="o">=</span> <span class="n">requested</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="p">{})</span>
                    <span class="n">next_klass_infos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_related_selections</span><span class="p">(</span>
                        <span class="n">select</span><span class="p">,</span>
                        <span class="n">field_select_mask</span><span class="p">,</span>
                        <span class="n">opts</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="p">,</span>
                        <span class="n">root_alias</span><span class="o">=</span><span class="n">alias</span><span class="p">,</span>
                        <span class="n">cur_depth</span><span class="o">=</span><span class="n">cur_depth</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                        <span class="n">requested</span><span class="o">=</span><span class="n">next_requested</span><span class="p">,</span>
                        <span class="n">restricted</span><span class="o">=</span><span class="n">restricted</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="n">get_related_klass_infos</span><span class="p">(</span><span class="n">klass_info</span><span class="p">,</span> <span class="n">next_klass_infos</span><span class="p">)</span>
            <span class="n">fields_not_found</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">requested</span><span class="p">)</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">fields_found</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">fields_not_found</span><span class="p">:</span>
                <span class="n">invalid_fields</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;&#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">fields_not_found</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">FieldError</span><span class="p">(</span>
                    <span class="s2">&quot;Invalid field name(s) given in select_related: </span><span class="si">%s</span><span class="s2">. &quot;</span>
                    <span class="s2">&quot;Choices are: </span><span class="si">%s</span><span class="s2">&quot;</span>
                    <span class="o">%</span> <span class="p">(</span>
                        <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">invalid_fields</span><span class="p">),</span>
                        <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">_get_field_choices</span><span class="p">())</span> <span class="ow">or</span> <span class="s2">&quot;(none)&quot;</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="p">)</span>
        <span class="k">return</span> <span class="n">related_klass_infos</span></div>


<div class="viewcode-block" id="SQLCompiler.get_select_for_update_of_arguments">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/compiler/index.html#django.db.models.sql.compiler.SQLCompiler.get_select_for_update_of_arguments">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_select_for_update_of_arguments</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a quoted list of arguments for the SELECT FOR UPDATE OF part of</span>
<span class="sd">        the query.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">_get_parent_klass_info</span><span class="p">(</span><span class="n">klass_info</span><span class="p">):</span>
            <span class="n">concrete_model</span> <span class="o">=</span> <span class="n">klass_info</span><span class="p">[</span><span class="s2">&quot;model&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">concrete_model</span>
            <span class="k">for</span> <span class="n">parent_model</span><span class="p">,</span> <span class="n">parent_link</span> <span class="ow">in</span> <span class="n">concrete_model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">parents</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">parent_list</span> <span class="o">=</span> <span class="n">parent_model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">get_parent_list</span><span class="p">()</span>
                <span class="k">yield</span> <span class="p">{</span>
                    <span class="s2">&quot;model&quot;</span><span class="p">:</span> <span class="n">parent_model</span><span class="p">,</span>
                    <span class="s2">&quot;field&quot;</span><span class="p">:</span> <span class="n">parent_link</span><span class="p">,</span>
                    <span class="s2">&quot;reverse&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                    <span class="s2">&quot;select_fields&quot;</span><span class="p">:</span> <span class="p">[</span>
                        <span class="n">select_index</span>
                        <span class="k">for</span> <span class="n">select_index</span> <span class="ow">in</span> <span class="n">klass_info</span><span class="p">[</span><span class="s2">&quot;select_fields&quot;</span><span class="p">]</span>
                        <span class="c1"># Selected columns from a model or its parents.</span>
                        <span class="k">if</span> <span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">select</span><span class="p">[</span><span class="n">select_index</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">model</span> <span class="o">==</span> <span class="n">parent_model</span>
                            <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">select</span><span class="p">[</span><span class="n">select_index</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">model</span> <span class="ow">in</span> <span class="n">parent_list</span>
                        <span class="p">)</span>
                    <span class="p">],</span>
                <span class="p">}</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">_get_first_selected_col_from_model</span><span class="p">(</span><span class="n">klass_info</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Find the first selected column from a model. If it doesn&#39;t exist,</span>
<span class="sd">            don&#39;t lock a model.</span>

<span class="sd">            select_fields is filled recursively, so it also contains fields</span>
<span class="sd">            from the parent models.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">concrete_model</span> <span class="o">=</span> <span class="n">klass_info</span><span class="p">[</span><span class="s2">&quot;model&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">concrete_model</span>
            <span class="k">for</span> <span class="n">select_index</span> <span class="ow">in</span> <span class="n">klass_info</span><span class="p">[</span><span class="s2">&quot;select_fields&quot;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">select</span><span class="p">[</span><span class="n">select_index</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">model</span> <span class="o">==</span> <span class="n">concrete_model</span><span class="p">:</span>
                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">select</span><span class="p">[</span><span class="n">select_index</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">_get_field_choices</span><span class="p">():</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Yield all allowed field paths in breadth-first search order.&quot;&quot;&quot;</span>
            <span class="n">queue</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">deque</span><span class="p">([(</span><span class="kc">None</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">klass_info</span><span class="p">)])</span>
            <span class="k">while</span> <span class="n">queue</span><span class="p">:</span>
                <span class="n">parent_path</span><span class="p">,</span> <span class="n">klass_info</span> <span class="o">=</span> <span class="n">queue</span><span class="o">.</span><span class="n">popleft</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">parent_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">path</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">yield</span> <span class="s2">&quot;self&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">field</span> <span class="o">=</span> <span class="n">klass_info</span><span class="p">[</span><span class="s2">&quot;field&quot;</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">klass_info</span><span class="p">[</span><span class="s2">&quot;reverse&quot;</span><span class="p">]:</span>
                        <span class="n">field</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">remote_field</span>
                    <span class="n">path</span> <span class="o">=</span> <span class="n">parent_path</span> <span class="o">+</span> <span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
                    <span class="k">yield</span> <span class="n">LOOKUP_SEP</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
                <span class="n">queue</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
                    <span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">klass_info</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">klass_info</span> <span class="ow">in</span> <span class="n">_get_parent_klass_info</span><span class="p">(</span><span class="n">klass_info</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="n">queue</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
                    <span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">klass_info</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">klass_info</span> <span class="ow">in</span> <span class="n">klass_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;related_klass_infos&quot;</span><span class="p">,</span> <span class="p">[])</span>
                <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">klass_info</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">invalid_names</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">select_for_update_of</span><span class="p">:</span>
            <span class="n">klass_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">klass_info</span>
            <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;self&quot;</span><span class="p">:</span>
                <span class="n">col</span> <span class="o">=</span> <span class="n">_get_first_selected_col_from_model</span><span class="p">(</span><span class="n">klass_info</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">LOOKUP_SEP</span><span class="p">):</span>
                    <span class="n">klass_infos</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="o">*</span><span class="n">klass_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;related_klass_infos&quot;</span><span class="p">,</span> <span class="p">[]),</span>
                        <span class="o">*</span><span class="n">_get_parent_klass_info</span><span class="p">(</span><span class="n">klass_info</span><span class="p">),</span>
                    <span class="p">)</span>
                    <span class="k">for</span> <span class="n">related_klass_info</span> <span class="ow">in</span> <span class="n">klass_infos</span><span class="p">:</span>
                        <span class="n">field</span> <span class="o">=</span> <span class="n">related_klass_info</span><span class="p">[</span><span class="s2">&quot;field&quot;</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">related_klass_info</span><span class="p">[</span><span class="s2">&quot;reverse&quot;</span><span class="p">]:</span>
                            <span class="n">field</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">remote_field</span>
                        <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">part</span><span class="p">:</span>
                            <span class="n">klass_info</span> <span class="o">=</span> <span class="n">related_klass_info</span>
                            <span class="k">break</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">klass_info</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="k">break</span>
                <span class="k">if</span> <span class="n">klass_info</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">invalid_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                    <span class="k">continue</span>
                <span class="n">col</span> <span class="o">=</span> <span class="n">_get_first_selected_col_from_model</span><span class="p">(</span><span class="n">klass_info</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">col</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">select_for_update_of_column</span><span class="p">:</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">col</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">quote_name_unless_alias</span><span class="p">(</span><span class="n">col</span><span class="o">.</span><span class="n">alias</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">invalid_names</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">FieldError</span><span class="p">(</span>
                <span class="s2">&quot;Invalid field name(s) given in select_for_update(of=(...)): </span><span class="si">%s</span><span class="s2">. &quot;</span>
                <span class="s2">&quot;Only relational fields followed in the query are allowed. &quot;</span>
                <span class="s2">&quot;Choices are: </span><span class="si">%s</span><span class="s2">.&quot;</span>
                <span class="o">%</span> <span class="p">(</span>
                    <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">invalid_names</span><span class="p">),</span>
                    <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">_get_field_choices</span><span class="p">()),</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span></div>


<div class="viewcode-block" id="SQLCompiler.get_converters">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/compiler/index.html#django.db.models.sql.compiler.SQLCompiler.get_converters">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_converters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expressions</span><span class="p">):</span>
        <span class="n">converters</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">expression</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">expressions</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">expression</span><span class="p">:</span>
                <span class="n">backend_converters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">get_db_converters</span><span class="p">(</span><span class="n">expression</span><span class="p">)</span>
                <span class="n">field_converters</span> <span class="o">=</span> <span class="n">expression</span><span class="o">.</span><span class="n">get_db_converters</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">backend_converters</span> <span class="ow">or</span> <span class="n">field_converters</span><span class="p">:</span>
                    <span class="n">converters</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">backend_converters</span> <span class="o">+</span> <span class="n">field_converters</span><span class="p">,</span> <span class="n">expression</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">converters</span></div>


<div class="viewcode-block" id="SQLCompiler.apply_converters">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/compiler/index.html#django.db.models.sql.compiler.SQLCompiler.apply_converters">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">apply_converters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rows</span><span class="p">,</span> <span class="n">converters</span><span class="p">):</span>
        <span class="n">connection</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span>
        <span class="n">converters</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">converters</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">map</span><span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="n">rows</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">pos</span><span class="p">,</span> <span class="p">(</span><span class="n">convs</span><span class="p">,</span> <span class="n">expression</span><span class="p">)</span> <span class="ow">in</span> <span class="n">converters</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">converter</span> <span class="ow">in</span> <span class="n">convs</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">converter</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">expression</span><span class="p">,</span> <span class="n">connection</span><span class="p">)</span>
                <span class="n">row</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
            <span class="k">yield</span> <span class="n">row</span></div>


<div class="viewcode-block" id="SQLCompiler.results_iter">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/compiler/index.html#django.db.models.sql.compiler.SQLCompiler.results_iter">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">results_iter</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">results</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">tuple_expected</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">chunked_fetch</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">chunk_size</span><span class="o">=</span><span class="n">GET_ITERATOR_CHUNK_SIZE</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return an iterator over the results from executing this query.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">results</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute_sql</span><span class="p">(</span>
                <span class="n">MULTI</span><span class="p">,</span> <span class="n">chunked_fetch</span><span class="o">=</span><span class="n">chunked_fetch</span><span class="p">,</span> <span class="n">chunk_size</span><span class="o">=</span><span class="n">chunk_size</span>
            <span class="p">)</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">select</span><span class="p">[</span><span class="mi">0</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">col_count</span><span class="p">]]</span>
        <span class="n">converters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_converters</span><span class="p">(</span><span class="n">fields</span><span class="p">)</span>
        <span class="n">rows</span> <span class="o">=</span> <span class="n">chain</span><span class="o">.</span><span class="n">from_iterable</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">converters</span><span class="p">:</span>
            <span class="n">rows</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_converters</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span> <span class="n">converters</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">tuple_expected</span><span class="p">:</span>
                <span class="n">rows</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="n">rows</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">rows</span></div>


<div class="viewcode-block" id="SQLCompiler.has_results">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/compiler/index.html#django.db.models.sql.compiler.SQLCompiler.has_results">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">has_results</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Backends (e.g. NoSQL) can override this in order to use optimized</span>
<span class="sd">        versions of &quot;query has any results.&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">execute_sql</span><span class="p">(</span><span class="n">SINGLE</span><span class="p">))</span></div>


<div class="viewcode-block" id="SQLCompiler.execute_sql">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/compiler/index.html#django.db.models.sql.compiler.SQLCompiler.execute_sql">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">execute_sql</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">result_type</span><span class="o">=</span><span class="n">MULTI</span><span class="p">,</span> <span class="n">chunked_fetch</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">chunk_size</span><span class="o">=</span><span class="n">GET_ITERATOR_CHUNK_SIZE</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run the query against the database and return the result(s). The</span>
<span class="sd">        return value is a single data item if result_type is SINGLE, or an</span>
<span class="sd">        iterator over the results if the result_type is MULTI.</span>

<span class="sd">        result_type is either MULTI (use fetchmany() to retrieve all rows),</span>
<span class="sd">        SINGLE (only retrieve a single row), or None. In this last case, the</span>
<span class="sd">        cursor is returned if any query is executed, since it&#39;s used by</span>
<span class="sd">        subclasses such as InsertQuery). It&#39;s possible, however, that no query</span>
<span class="sd">        is needed, as the filters describe an empty set. In that case, None is</span>
<span class="sd">        returned, to avoid any unnecessary database interaction.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">result_type</span> <span class="o">=</span> <span class="n">result_type</span> <span class="ow">or</span> <span class="n">NO_RESULTS</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">sql</span><span class="p">,</span> <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">as_sql</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">sql</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">EmptyResultSet</span>
        <span class="k">except</span> <span class="n">EmptyResultSet</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">result_type</span> <span class="o">==</span> <span class="n">MULTI</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">iter</span><span class="p">([])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span>
        <span class="k">if</span> <span class="n">chunked_fetch</span><span class="p">:</span>
            <span class="n">cursor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">chunked_cursor</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cursor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="c1"># Might fail for server-side cursors (e.g. connection closed)</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">raise</span>

        <span class="k">if</span> <span class="n">result_type</span> <span class="o">==</span> <span class="n">CURSOR</span><span class="p">:</span>
            <span class="c1"># Give the caller the cursor to process and close.</span>
            <span class="k">return</span> <span class="n">cursor</span>
        <span class="k">if</span> <span class="n">result_type</span> <span class="o">==</span> <span class="n">SINGLE</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">val</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">val</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">val</span><span class="p">[</span><span class="mi">0</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">col_count</span><span class="p">]</span>
                <span class="k">return</span> <span class="n">val</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="c1"># done with the cursor</span>
                <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">result_type</span> <span class="o">==</span> <span class="n">NO_RESULTS</span><span class="p">:</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">return</span>

        <span class="n">result</span> <span class="o">=</span> <span class="n">cursor_iter</span><span class="p">(</span>
            <span class="n">cursor</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">empty_fetchmany_value</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">col_count</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_extra_select</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">chunk_size</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">chunked_fetch</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">can_use_chunked_reads</span><span class="p">:</span>
            <span class="c1"># If we are using non-chunked reads, we return the same data</span>
            <span class="c1"># structure as normally, but ensure it is all read into memory</span>
            <span class="c1"># before going any further. Use chunked_fetch if requested,</span>
            <span class="c1"># unless the database doesn&#39;t support it.</span>
            <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span></div>


<div class="viewcode-block" id="SQLCompiler.as_subquery_condition">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/compiler/index.html#django.db.models.sql.compiler.SQLCompiler.as_subquery_condition">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">as_subquery_condition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">alias</span><span class="p">,</span> <span class="n">columns</span><span class="p">,</span> <span class="n">compiler</span><span class="p">):</span>
        <span class="n">qn</span> <span class="o">=</span> <span class="n">compiler</span><span class="o">.</span><span class="n">quote_name_unless_alias</span>
        <span class="n">qn2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">quote_name</span>

        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">select_col</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">select</span><span class="p">):</span>
            <span class="n">lhs_sql</span><span class="p">,</span> <span class="n">lhs_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">select_col</span><span class="p">)</span>
            <span class="n">rhs</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">.</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">qn</span><span class="p">(</span><span class="n">alias</span><span class="p">),</span> <span class="n">qn2</span><span class="p">(</span><span class="n">columns</span><span class="p">[</span><span class="n">index</span><span class="p">]))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">where</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">RawSQL</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> = </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">lhs_sql</span><span class="p">,</span> <span class="n">rhs</span><span class="p">),</span> <span class="n">lhs_params</span><span class="p">),</span> <span class="n">AND</span><span class="p">)</span>

        <span class="n">sql</span><span class="p">,</span> <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">as_sql</span><span class="p">()</span>
        <span class="k">return</span> <span class="s2">&quot;EXISTS (</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="n">sql</span><span class="p">,</span> <span class="n">params</span></div>


<div class="viewcode-block" id="SQLCompiler.explain_query">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/compiler/index.html#django.db.models.sql.compiler.SQLCompiler.explain_query">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">explain_query</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">execute_sql</span><span class="p">())</span>
        <span class="c1"># Some backends return 1 item tuples with strings, and others return</span>
        <span class="c1"># tuples with integers and strings. Flatten them out into strings.</span>
        <span class="n">format_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">explain_info</span><span class="o">.</span><span class="n">format</span>
        <span class="n">output_formatter</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span> <span class="k">if</span> <span class="n">format_</span> <span class="ow">and</span> <span class="n">format_</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;json&quot;</span> <span class="k">else</span> <span class="nb">str</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">yield</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_formatter</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">row</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">row</span></div>
</div>



<div class="viewcode-block" id="SQLInsertCompiler">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/compiler/index.html#django.db.models.sql.compiler.SQLInsertCompiler">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">SQLInsertCompiler</span><span class="p">(</span><span class="n">SQLCompiler</span><span class="p">):</span>
<div class="viewcode-block" id="SQLInsertCompiler.returning_fields">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/compiler/index.html#django.db.models.sql.compiler.SQLInsertCompiler.returning_fields">[docs]</a>
    <span class="n">returning_fields</span> <span class="o">=</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="SQLInsertCompiler.returning_params">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/compiler/index.html#django.db.models.sql.compiler.SQLInsertCompiler.returning_params">[docs]</a>
    <span class="n">returning_params</span> <span class="o">=</span> <span class="p">()</span></div>


<div class="viewcode-block" id="SQLInsertCompiler.field_as_sql">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/compiler/index.html#django.db.models.sql.compiler.SQLInsertCompiler.field_as_sql">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">field_as_sql</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Take a field and a value intended to be saved on that field, and</span>
<span class="sd">        return placeholder SQL and accompanying params. Check for raw values,</span>
<span class="sd">        expressions, and fields with get_placeholder() defined in that order.</span>

<span class="sd">        When field is None, consider the value raw and use it as the</span>
<span class="sd">        placeholder, with no corresponding parameters returned.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">field</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># A field value of None means the value is raw.</span>
            <span class="n">sql</span><span class="p">,</span> <span class="n">params</span> <span class="o">=</span> <span class="n">val</span><span class="p">,</span> <span class="p">[]</span>
        <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="s2">&quot;as_sql&quot;</span><span class="p">):</span>
            <span class="c1"># This is an expression, let&#39;s compile it.</span>
            <span class="n">sql</span><span class="p">,</span> <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="s2">&quot;get_placeholder&quot;</span><span class="p">):</span>
            <span class="c1"># Some fields (e.g. geo fields) need special munging before</span>
            <span class="c1"># they can be inserted.</span>
            <span class="n">sql</span><span class="p">,</span> <span class="n">params</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">get_placeholder</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="p">),</span> <span class="p">[</span><span class="n">val</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Return the common case for the placeholder</span>
            <span class="n">sql</span><span class="p">,</span> <span class="n">params</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">val</span><span class="p">]</span>

        <span class="c1"># The following hook is only used by Oracle Spatial, which sometimes</span>
        <span class="c1"># needs to yield &#39;NULL&#39; and [] as its placeholder and params instead</span>
        <span class="c1"># of &#39;%s&#39; and [None]. The &#39;NULL&#39; placeholder is produced earlier by</span>
        <span class="c1"># OracleOperations.get_geom_placeholder(). The following line removes</span>
        <span class="c1"># the corresponding None parameter. See ticket #10888.</span>
        <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">modify_insert_params</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">sql</span><span class="p">,</span> <span class="n">params</span></div>


<div class="viewcode-block" id="SQLInsertCompiler.prepare_value">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/compiler/index.html#django.db.models.sql.compiler.SQLInsertCompiler.prepare_value">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">prepare_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Prepare a value to be used in a query by resolving it if it is an</span>
<span class="sd">        expression and otherwise calling the field&#39;s get_db_prep_save().</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="s2">&quot;resolve_expression&quot;</span><span class="p">):</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">resolve_expression</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">,</span> <span class="n">allow_joins</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">for_save</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>
            <span class="c1"># Don&#39;t allow values containing Col expressions. They refer to</span>
            <span class="c1"># existing columns on a row, but in the case of insert the row</span>
            <span class="c1"># doesn&#39;t exist yet.</span>
            <span class="k">if</span> <span class="n">value</span><span class="o">.</span><span class="n">contains_column_references</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s1">&#39;Failed to insert expression &quot;</span><span class="si">%s</span><span class="s1">&quot; on </span><span class="si">%s</span><span class="s1">. F() expressions &#39;</span>
                    <span class="s2">&quot;can only be used to update, not to insert.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">field</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="n">value</span><span class="o">.</span><span class="n">contains_aggregate</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">FieldError</span><span class="p">(</span>
                    <span class="s2">&quot;Aggregate functions are not allowed in this query &quot;</span>
                    <span class="s2">&quot;(</span><span class="si">%s</span><span class="s2">=</span><span class="si">%r</span><span class="s2">).&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="n">value</span><span class="o">.</span><span class="n">contains_over_clause</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">FieldError</span><span class="p">(</span>
                    <span class="s2">&quot;Window expressions are not allowed in this query (</span><span class="si">%s</span><span class="s2">=</span><span class="si">%r</span><span class="s2">).&quot;</span>
                    <span class="o">%</span> <span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
                <span class="p">)</span>
        <span class="k">return</span> <span class="n">field</span><span class="o">.</span><span class="n">get_db_prep_save</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">connection</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="p">)</span></div>


<div class="viewcode-block" id="SQLInsertCompiler.pre_save_val">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/compiler/index.html#django.db.models.sql.compiler.SQLInsertCompiler.pre_save_val">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">pre_save_val</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the given field&#39;s value off the given obj. pre_save() is used for</span>
<span class="sd">        things like auto_now on DateTimeField. Skip it if this is a raw query.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">raw</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">field</span><span class="o">.</span><span class="n">attname</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">field</span><span class="o">.</span><span class="n">pre_save</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">add</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>


<div class="viewcode-block" id="SQLInsertCompiler.assemble_as_sql">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/compiler/index.html#django.db.models.sql.compiler.SQLInsertCompiler.assemble_as_sql">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">assemble_as_sql</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">value_rows</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Take a sequence of N fields and a sequence of M rows of values, and</span>
<span class="sd">        generate placeholder SQL and parameters for each field and value.</span>
<span class="sd">        Return a pair containing:</span>
<span class="sd">         * a sequence of M rows of N SQL placeholder strings, and</span>
<span class="sd">         * a sequence of M rows of corresponding parameter values.</span>

<span class="sd">        Each placeholder string may contain any number of &#39;%s&#39; interpolation</span>
<span class="sd">        strings, and each parameter row will contain exactly as many params</span>
<span class="sd">        as the total number of &#39;%s&#39;s in the corresponding placeholder row.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">value_rows</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[],</span> <span class="p">[]</span>

        <span class="c1"># list of (sql, [params]) tuples for each object to be saved</span>
        <span class="c1"># Shape: [n_objs][n_fields][2]</span>
        <span class="n">rows_of_fields_as_sql</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">field_as_sql</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">field</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">fields</span><span class="p">,</span> <span class="n">row</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">value_rows</span>
        <span class="p">)</span>

        <span class="c1"># tuple like ([sqls], [[params]s]) for each object to be saved</span>
        <span class="c1"># Shape: [n_objs][2][n_fields]</span>
        <span class="n">sql_and_param_pair_rows</span> <span class="o">=</span> <span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">row</span><span class="p">)</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows_of_fields_as_sql</span><span class="p">)</span>

        <span class="c1"># Extract separate lists for placeholders and params.</span>
        <span class="c1"># Each of these has shape [n_objs][n_fields]</span>
        <span class="n">placeholder_rows</span><span class="p">,</span> <span class="n">param_rows</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">sql_and_param_pair_rows</span><span class="p">)</span>

        <span class="c1"># Params for each field are still lists, and need to be flattened.</span>
        <span class="n">param_rows</span> <span class="o">=</span> <span class="p">[[</span><span class="n">p</span> <span class="k">for</span> <span class="n">ps</span> <span class="ow">in</span> <span class="n">row</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">ps</span><span class="p">]</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">param_rows</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">placeholder_rows</span><span class="p">,</span> <span class="n">param_rows</span></div>


<div class="viewcode-block" id="SQLInsertCompiler.as_sql">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/compiler/index.html#django.db.models.sql.compiler.SQLInsertCompiler.as_sql">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">as_sql</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># We don&#39;t need quote_name_unless_alias() here, since these are all</span>
        <span class="c1"># going to be column names (so we can avoid the extra overhead).</span>
        <span class="n">qn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">quote_name</span>
        <span class="n">opts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">get_meta</span><span class="p">()</span>
        <span class="n">insert_statement</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">insert_statement</span><span class="p">(</span>
            <span class="n">on_conflict</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">on_conflict</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">insert_statement</span><span class="p">,</span> <span class="n">qn</span><span class="p">(</span><span class="n">opts</span><span class="o">.</span><span class="n">db_table</span><span class="p">))]</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">fields</span> <span class="ow">or</span> <span class="p">[</span><span class="n">opts</span><span class="o">.</span><span class="n">pk</span><span class="p">]</span>
        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;(</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">qn</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">column</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">fields</span><span class="p">:</span>
            <span class="n">value_rows</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">[</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">prepare_value</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre_save_val</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">obj</span><span class="p">))</span>
                    <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">fields</span>
                <span class="p">]</span>
                <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">objs</span>
            <span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># An empty object.</span>
            <span class="n">value_rows</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">pk_default_value</span><span class="p">()]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">objs</span>
            <span class="p">]</span>
            <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span>

        <span class="c1"># Currently the backends just accept values when generating bulk</span>
        <span class="c1"># queries and generate their own placeholders. Doing that isn&#39;t</span>
        <span class="c1"># necessary and it should be possible to use placeholders and</span>
        <span class="c1"># expressions in bulk inserts too.</span>
        <span class="n">can_bulk</span> <span class="o">=</span> <span class="p">(</span>
            <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">returning_fields</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">has_bulk_insert</span>
        <span class="p">)</span>

        <span class="n">placeholder_rows</span><span class="p">,</span> <span class="n">param_rows</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">assemble_as_sql</span><span class="p">(</span><span class="n">fields</span><span class="p">,</span> <span class="n">value_rows</span><span class="p">)</span>

        <span class="n">on_conflict_suffix_sql</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">on_conflict_suffix_sql</span><span class="p">(</span>
            <span class="n">fields</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">on_conflict</span><span class="p">,</span>
            <span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">column</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">update_fields</span><span class="p">),</span>
            <span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">column</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">unique_fields</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">returning_fields</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">can_return_columns_from_insert</span>
        <span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">can_return_rows_from_bulk_insert</span><span class="p">:</span>
                <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">bulk_insert_sql</span><span class="p">(</span><span class="n">fields</span><span class="p">,</span> <span class="n">placeholder_rows</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="n">params</span> <span class="o">=</span> <span class="n">param_rows</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;VALUES (</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">placeholder_rows</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
                <span class="n">params</span> <span class="o">=</span> <span class="p">[</span><span class="n">param_rows</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
            <span class="k">if</span> <span class="n">on_conflict_suffix_sql</span><span class="p">:</span>
                <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">on_conflict_suffix_sql</span><span class="p">)</span>
            <span class="c1"># Skip empty r_sql to allow subclasses to customize behavior for</span>
            <span class="c1"># 3rd party backends. Refs #19096.</span>
            <span class="n">r_sql</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">returning_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">return_insert_columns</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">returning_fields</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">r_sql</span><span class="p">:</span>
                <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r_sql</span><span class="p">)</span>
                <span class="n">params</span> <span class="o">+=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">returning_params</span><span class="p">]</span>
            <span class="k">return</span> <span class="p">[(</span><span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">result</span><span class="p">),</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">chain</span><span class="o">.</span><span class="n">from_iterable</span><span class="p">(</span><span class="n">params</span><span class="p">)))]</span>

        <span class="k">if</span> <span class="n">can_bulk</span><span class="p">:</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">bulk_insert_sql</span><span class="p">(</span><span class="n">fields</span><span class="p">,</span> <span class="n">placeholder_rows</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">on_conflict_suffix_sql</span><span class="p">:</span>
                <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">on_conflict_suffix_sql</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">[(</span><span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">result</span><span class="p">),</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">p</span> <span class="k">for</span> <span class="n">ps</span> <span class="ow">in</span> <span class="n">param_rows</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">ps</span><span class="p">))]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">on_conflict_suffix_sql</span><span class="p">:</span>
                <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">on_conflict_suffix_sql</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">[</span>
                <span class="p">(</span><span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">result</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;VALUES (</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">p</span><span class="p">)]),</span> <span class="n">vals</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">p</span><span class="p">,</span> <span class="n">vals</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">placeholder_rows</span><span class="p">,</span> <span class="n">param_rows</span><span class="p">)</span>
            <span class="p">]</span></div>


<div class="viewcode-block" id="SQLInsertCompiler.execute_sql">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/compiler/index.html#django.db.models.sql.compiler.SQLInsertCompiler.execute_sql">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">execute_sql</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">returning_fields</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="p">(</span>
            <span class="n">returning_fields</span>
            <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">objs</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span>
            <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">can_return_rows_from_bulk_insert</span>
        <span class="p">)</span>
        <span class="n">opts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">get_meta</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">returning_fields</span> <span class="o">=</span> <span class="n">returning_fields</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span> <span class="k">as</span> <span class="n">cursor</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">sql</span><span class="p">,</span> <span class="n">params</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">as_sql</span><span class="p">():</span>
                <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">returning_fields</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">can_return_rows_from_bulk_insert</span>
                <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">objs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span>
            <span class="p">):</span>
                <span class="n">rows</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">fetch_returned_insert_rows</span><span class="p">(</span><span class="n">cursor</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">can_return_columns_from_insert</span><span class="p">:</span>
                <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">objs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
                <span class="n">rows</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">fetch_returned_insert_columns</span><span class="p">(</span>
                        <span class="n">cursor</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">returning_params</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">rows</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">last_insert_id</span><span class="p">(</span>
                            <span class="n">cursor</span><span class="p">,</span>
                            <span class="n">opts</span><span class="o">.</span><span class="n">db_table</span><span class="p">,</span>
                            <span class="n">opts</span><span class="o">.</span><span class="n">pk</span><span class="o">.</span><span class="n">column</span><span class="p">,</span>
                        <span class="p">),</span>
                    <span class="p">)</span>
                <span class="p">]</span>
        <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">get_col</span><span class="p">(</span><span class="n">opts</span><span class="o">.</span><span class="n">db_table</span><span class="p">)</span> <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">returning_fields</span><span class="p">]</span>
        <span class="n">converters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_converters</span><span class="p">(</span><span class="n">cols</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">converters</span><span class="p">:</span>
            <span class="n">rows</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">apply_converters</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span> <span class="n">converters</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">rows</span></div>
</div>



<div class="viewcode-block" id="SQLDeleteCompiler">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/compiler/index.html#django.db.models.sql.compiler.SQLDeleteCompiler">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">SQLDeleteCompiler</span><span class="p">(</span><span class="n">SQLCompiler</span><span class="p">):</span>
    <span class="nd">@cached_property</span>
<div class="viewcode-block" id="SQLDeleteCompiler.single_alias">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/compiler/index.html#django.db.models.sql.compiler.SQLDeleteCompiler.single_alias">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">single_alias</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Ensure base table is in aliases.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">get_initial_alias</span><span class="p">()</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">alias_refcount</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">alias_map</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span></div>


    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_expr_refs_base_model</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="n">base_model</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">Query</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">expr</span><span class="o">.</span><span class="n">model</span> <span class="o">==</span> <span class="n">base_model</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="s2">&quot;get_source_expressions&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="nb">any</span><span class="p">(</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">_expr_refs_base_model</span><span class="p">(</span><span class="n">source_expr</span><span class="p">,</span> <span class="n">base_model</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">source_expr</span> <span class="ow">in</span> <span class="n">expr</span><span class="o">.</span><span class="n">get_source_expressions</span><span class="p">()</span>
        <span class="p">)</span>

    <span class="nd">@cached_property</span>
<div class="viewcode-block" id="SQLDeleteCompiler.contains_self_reference_subquery">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/compiler/index.html#django.db.models.sql.compiler.SQLDeleteCompiler.contains_self_reference_subquery">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">contains_self_reference_subquery</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">any</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_expr_refs_base_model</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">model</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">expr</span> <span class="ow">in</span> <span class="n">chain</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">annotations</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">where</span><span class="o">.</span><span class="n">children</span>
            <span class="p">)</span>
        <span class="p">)</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_as_sql</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">):</span>
        <span class="n">delete</span> <span class="o">=</span> <span class="s2">&quot;DELETE FROM </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">quote_name_unless_alias</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">base_table</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">where</span><span class="p">,</span> <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">where</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">FullResultSet</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">delete</span><span class="p">,</span> <span class="p">()</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">delete</span><span class="si">}</span><span class="s2"> WHERE </span><span class="si">{</span><span class="n">where</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>

<div class="viewcode-block" id="SQLDeleteCompiler.as_sql">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/compiler/index.html#django.db.models.sql.compiler.SQLDeleteCompiler.as_sql">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">as_sql</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create the SQL for this query. Return the SQL string and list of</span>
<span class="sd">        parameters.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">single_alias</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">contains_self_reference_subquery</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_as_sql</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">)</span>
        <span class="n">innerq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
        <span class="n">innerq</span><span class="o">.</span><span class="vm">__class__</span> <span class="o">=</span> <span class="n">Query</span>
        <span class="n">innerq</span><span class="o">.</span><span class="n">clear_select_clause</span><span class="p">()</span>
        <span class="n">pk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">pk</span>
        <span class="n">innerq</span><span class="o">.</span><span class="n">select</span> <span class="o">=</span> <span class="p">[</span><span class="n">pk</span><span class="o">.</span><span class="n">get_col</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">get_initial_alias</span><span class="p">())]</span>
        <span class="n">outerq</span> <span class="o">=</span> <span class="n">Query</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">model</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">update_can_self_select</span><span class="p">:</span>
            <span class="c1"># Force the materialization of the inner query to allow reference</span>
            <span class="c1"># to the target table on MySQL.</span>
            <span class="n">sql</span><span class="p">,</span> <span class="n">params</span> <span class="o">=</span> <span class="n">innerq</span><span class="o">.</span><span class="n">get_compiler</span><span class="p">(</span><span class="n">connection</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="p">)</span><span class="o">.</span><span class="n">as_sql</span><span class="p">()</span>
            <span class="n">innerq</span> <span class="o">=</span> <span class="n">RawSQL</span><span class="p">(</span><span class="s2">&quot;SELECT * FROM (</span><span class="si">%s</span><span class="s2">) subquery&quot;</span> <span class="o">%</span> <span class="n">sql</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
        <span class="n">outerq</span><span class="o">.</span><span class="n">add_filter</span><span class="p">(</span><span class="s2">&quot;pk__in&quot;</span><span class="p">,</span> <span class="n">innerq</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_as_sql</span><span class="p">(</span><span class="n">outerq</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="SQLUpdateCompiler">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/compiler/index.html#django.db.models.sql.compiler.SQLUpdateCompiler">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">SQLUpdateCompiler</span><span class="p">(</span><span class="n">SQLCompiler</span><span class="p">):</span>
<div class="viewcode-block" id="SQLUpdateCompiler.as_sql">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/compiler/index.html#django.db.models.sql.compiler.SQLUpdateCompiler.as_sql">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">as_sql</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create the SQL for this query. Return the SQL string and list of</span>
<span class="sd">        parameters.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pre_sql_setup</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">values</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="p">()</span>
        <span class="n">qn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">quote_name_unless_alias</span>
        <span class="n">values</span><span class="p">,</span> <span class="n">update_params</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">field</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">values</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="s2">&quot;resolve_expression&quot;</span><span class="p">):</span>
                <span class="n">val</span> <span class="o">=</span> <span class="n">val</span><span class="o">.</span><span class="n">resolve_expression</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">,</span> <span class="n">allow_joins</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">for_save</span><span class="o">=</span><span class="kc">True</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">val</span><span class="o">.</span><span class="n">contains_aggregate</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">FieldError</span><span class="p">(</span>
                        <span class="s2">&quot;Aggregate functions are not allowed in this query &quot;</span>
                        <span class="s2">&quot;(</span><span class="si">%s</span><span class="s2">=</span><span class="si">%r</span><span class="s2">).&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
                    <span class="p">)</span>
                <span class="k">if</span> <span class="n">val</span><span class="o">.</span><span class="n">contains_over_clause</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">FieldError</span><span class="p">(</span>
                        <span class="s2">&quot;Window expressions are not allowed in this query &quot;</span>
                        <span class="s2">&quot;(</span><span class="si">%s</span><span class="s2">=</span><span class="si">%r</span><span class="s2">).&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
                    <span class="p">)</span>
            <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="s2">&quot;prepare_database_save&quot;</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">remote_field</span><span class="p">:</span>
                    <span class="n">val</span> <span class="o">=</span> <span class="n">val</span><span class="o">.</span><span class="n">prepare_database_save</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                        <span class="s2">&quot;Tried to update field </span><span class="si">%s</span><span class="s2"> with a model instance, </span><span class="si">%r</span><span class="s2">. &quot;</span>
                        <span class="s2">&quot;Use a value compatible with </span><span class="si">%s</span><span class="s2">.&quot;</span>
                        <span class="o">%</span> <span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">field</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
                    <span class="p">)</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">get_db_prep_save</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">connection</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="p">)</span>

            <span class="c1"># Getting the placeholder for the field.</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="s2">&quot;get_placeholder&quot;</span><span class="p">):</span>
                <span class="n">placeholder</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">get_placeholder</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">placeholder</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">column</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="s2">&quot;as_sql&quot;</span><span class="p">):</span>
                <span class="n">sql</span><span class="p">,</span> <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
                <span class="n">values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> = </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">qn</span><span class="p">(</span><span class="n">name</span><span class="p">),</span> <span class="n">placeholder</span> <span class="o">%</span> <span class="n">sql</span><span class="p">))</span>
                <span class="n">update_params</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> = </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">qn</span><span class="p">(</span><span class="n">name</span><span class="p">),</span> <span class="n">placeholder</span><span class="p">))</span>
                <span class="n">update_params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> = NULL&quot;</span> <span class="o">%</span> <span class="n">qn</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
        <span class="n">table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">base_table</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;UPDATE </span><span class="si">%s</span><span class="s2"> SET&quot;</span> <span class="o">%</span> <span class="n">qn</span><span class="p">(</span><span class="n">table</span><span class="p">),</span>
            <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">values</span><span class="p">),</span>
        <span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">where</span><span class="p">,</span> <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">where</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">FullResultSet</span><span class="p">:</span>
            <span class="n">params</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;WHERE </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">where</span><span class="p">)</span>
        <span class="k">return</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">result</span><span class="p">),</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">update_params</span> <span class="o">+</span> <span class="n">params</span><span class="p">)</span></div>


<div class="viewcode-block" id="SQLUpdateCompiler.execute_sql">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/compiler/index.html#django.db.models.sql.compiler.SQLUpdateCompiler.execute_sql">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">execute_sql</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">result_type</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Execute the specified update. Return the number of rows affected by</span>
<span class="sd">        the primary update query. The &quot;primary update query&quot; is the first</span>
<span class="sd">        non-empty query that is executed. Row counts for any subsequent,</span>
<span class="sd">        related queries are not available.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">execute_sql</span><span class="p">(</span><span class="n">result_type</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">rows</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">rowcount</span> <span class="k">if</span> <span class="n">cursor</span> <span class="k">else</span> <span class="mi">0</span>
            <span class="n">is_empty</span> <span class="o">=</span> <span class="n">cursor</span> <span class="ow">is</span> <span class="kc">None</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">cursor</span><span class="p">:</span>
                <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">query</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">get_related_updates</span><span class="p">():</span>
            <span class="n">aux_rows</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">get_compiler</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">using</span><span class="p">)</span><span class="o">.</span><span class="n">execute_sql</span><span class="p">(</span><span class="n">result_type</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">is_empty</span> <span class="ow">and</span> <span class="n">aux_rows</span><span class="p">:</span>
                <span class="n">rows</span> <span class="o">=</span> <span class="n">aux_rows</span>
                <span class="n">is_empty</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="n">rows</span></div>


<div class="viewcode-block" id="SQLUpdateCompiler.pre_sql_setup">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/compiler/index.html#django.db.models.sql.compiler.SQLUpdateCompiler.pre_sql_setup">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">pre_sql_setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        If the update depends on results from other tables, munge the &quot;where&quot;</span>
<span class="sd">        conditions to match the format required for (portable) SQL updates.</span>

<span class="sd">        If multiple updates are required, pull out the id values to update at</span>
<span class="sd">        this point so that they don&#39;t change as a result of the progressive</span>
<span class="sd">        updates.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">refcounts_before</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">alias_refcount</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="c1"># Ensure base table is in the query</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">get_initial_alias</span><span class="p">()</span>
        <span class="n">count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">count_active_tables</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">related_updates</span> <span class="ow">and</span> <span class="n">count</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">chain</span><span class="p">(</span><span class="n">klass</span><span class="o">=</span><span class="n">Query</span><span class="p">)</span>
        <span class="n">query</span><span class="o">.</span><span class="n">select_related</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">query</span><span class="o">.</span><span class="n">clear_ordering</span><span class="p">(</span><span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">query</span><span class="o">.</span><span class="n">extra</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">query</span><span class="o">.</span><span class="n">select</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">meta</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">get_meta</span><span class="p">()</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="n">meta</span><span class="o">.</span><span class="n">pk</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
        <span class="n">related_ids_index</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">related</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">related_updates</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">all</span><span class="p">(</span>
                <span class="n">path</span><span class="o">.</span><span class="n">join_field</span><span class="o">.</span><span class="n">primary_key</span> <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">meta</span><span class="o">.</span><span class="n">get_path_to_parent</span><span class="p">(</span><span class="n">related</span><span class="p">)</span>
            <span class="p">):</span>
                <span class="c1"># If a primary key chain exists to the targeted related update,</span>
                <span class="c1"># then the meta.pk value can be used for it.</span>
                <span class="n">related_ids_index</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">related</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># This branch will only be reached when updating a field of an</span>
                <span class="c1"># ancestor that is not part of the primary key chain of a MTI</span>
                <span class="c1"># tree.</span>
                <span class="n">related_ids_index</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">related</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">fields</span><span class="p">)))</span>
                <span class="n">fields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">related</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">pk</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="n">query</span><span class="o">.</span><span class="n">add_fields</span><span class="p">(</span><span class="n">fields</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">pre_sql_setup</span><span class="p">()</span>

        <span class="n">must_pre_select</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">count</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">update_can_self_select</span>
        <span class="p">)</span>

        <span class="c1"># Now we adjust the current query: reset the where clause and get rid</span>
        <span class="c1"># of all the tables we don&#39;t need (since they&#39;re in the sub-select).</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">clear_where</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">related_updates</span> <span class="ow">or</span> <span class="n">must_pre_select</span><span class="p">:</span>
            <span class="c1"># Either we&#39;re using the idents in multiple update queries (so</span>
            <span class="c1"># don&#39;t want them to change), or the db backend doesn&#39;t support</span>
            <span class="c1"># selecting from the updating table (e.g. MySQL).</span>
            <span class="n">idents</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">related_ids</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">rows</span> <span class="ow">in</span> <span class="n">query</span><span class="o">.</span><span class="n">get_compiler</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">using</span><span class="p">)</span><span class="o">.</span><span class="n">execute_sql</span><span class="p">(</span><span class="n">MULTI</span><span class="p">):</span>
                <span class="n">idents</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">parent</span><span class="p">,</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">related_ids_index</span><span class="p">:</span>
                    <span class="n">related_ids</span><span class="p">[</span><span class="n">parent</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">add_filter</span><span class="p">(</span><span class="s2">&quot;pk__in&quot;</span><span class="p">,</span> <span class="n">idents</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">related_ids</span> <span class="o">=</span> <span class="n">related_ids</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># The fast path. Filters and updates in one query.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">add_filter</span><span class="p">(</span><span class="s2">&quot;pk__in&quot;</span><span class="p">,</span> <span class="n">query</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">reset_refcounts</span><span class="p">(</span><span class="n">refcounts_before</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="SQLAggregateCompiler">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/compiler/index.html#django.db.models.sql.compiler.SQLAggregateCompiler">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">SQLAggregateCompiler</span><span class="p">(</span><span class="n">SQLCompiler</span><span class="p">):</span>
<div class="viewcode-block" id="SQLAggregateCompiler.as_sql">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/compiler/index.html#django.db.models.sql.compiler.SQLAggregateCompiler.as_sql">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">as_sql</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create the SQL for this query. Return the SQL string and list of</span>
<span class="sd">        parameters.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">sql</span><span class="p">,</span> <span class="n">params</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">annotation</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">annotation_select</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">ann_sql</span><span class="p">,</span> <span class="n">ann_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">annotation</span><span class="p">)</span>
            <span class="n">ann_sql</span><span class="p">,</span> <span class="n">ann_params</span> <span class="o">=</span> <span class="n">annotation</span><span class="o">.</span><span class="n">select_format</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ann_sql</span><span class="p">,</span> <span class="n">ann_params</span><span class="p">)</span>
            <span class="n">sql</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ann_sql</span><span class="p">)</span>
            <span class="n">params</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">ann_params</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">col_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">annotation_select</span><span class="p">)</span>
        <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
        <span class="n">params</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>

        <span class="n">inner_query_sql</span><span class="p">,</span> <span class="n">inner_query_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">inner_query</span><span class="o">.</span><span class="n">get_compiler</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">using</span><span class="p">,</span>
            <span class="n">elide_empty</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">elide_empty</span><span class="p">,</span>
        <span class="p">)</span><span class="o">.</span><span class="n">as_sql</span><span class="p">(</span><span class="n">with_col_aliases</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;SELECT </span><span class="si">%s</span><span class="s2"> FROM (</span><span class="si">%s</span><span class="s2">) subquery&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="n">inner_query_sql</span><span class="p">)</span>
        <span class="n">params</span> <span class="o">+=</span> <span class="n">inner_query_params</span>
        <span class="k">return</span> <span class="n">sql</span><span class="p">,</span> <span class="n">params</span></div>
</div>



<div class="viewcode-block" id="cursor_iter">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/compiler/index.html#django.db.models.sql.compiler.cursor_iter">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">cursor_iter</span><span class="p">(</span><span class="n">cursor</span><span class="p">,</span> <span class="n">sentinel</span><span class="p">,</span> <span class="n">col_count</span><span class="p">,</span> <span class="n">itersize</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Yield blocks of rows from a cursor and ensure the cursor is closed when</span>
<span class="sd">    done.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">rows</span> <span class="ow">in</span> <span class="nb">iter</span><span class="p">((</span><span class="k">lambda</span><span class="p">:</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchmany</span><span class="p">(</span><span class="n">itersize</span><span class="p">)),</span> <span class="n">sentinel</span><span class="p">):</span>
            <span class="k">yield</span> <span class="n">rows</span> <span class="k">if</span> <span class="n">col_count</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">[</span><span class="n">r</span><span class="p">[:</span><span class="n">col_count</span><span class="p">]</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">]</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright .</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>