

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>django.db.models.sql.query &mdash; Coursework Two 1.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../../../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../../../../_static/graphviz.css?v=4ae1632d" />

  
      <script src="../../../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../../../_static/documentation_options.js?v=f2a433a1"></script>
      <script src="../../../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../../../index.html" class="icon icon-home">
            Coursework Two
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../installation_guide.html">Installation Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../usage_instructions.html">Usage Instructions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../architecture_overview.html">Architecture Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../autoapi/index.html">API Reference</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../../index.html">Coursework Two</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../../../index.html">Module code</a></li>
          <li class="breadcrumb-item"><a href="../../../../django.html">django</a></li>
          <li class="breadcrumb-item"><a href="../../../db.html">django.db</a></li>
      <li class="breadcrumb-item active">django.db.models.sql.query</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for django.db.models.sql.query</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Create SQL statements for QuerySets.</span>

<span class="sd">The code in here encapsulates all of the SQL construction so that QuerySets</span>
<span class="sd">themselves do not have to (and could be backed by things other than SQL</span>
<span class="sd">databases). The abstraction barrier only works one way: this module has to know</span>
<span class="sd">all about the internals of models in order to get the information it needs.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">copy</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">difflib</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">functools</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">collections</span><span class="w"> </span><span class="kn">import</span> <span class="n">Counter</span><span class="p">,</span> <span class="n">namedtuple</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">collections.abc</span><span class="w"> </span><span class="kn">import</span> <span class="n">Iterator</span><span class="p">,</span> <span class="n">Mapping</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">itertools</span><span class="w"> </span><span class="kn">import</span> <span class="n">chain</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">product</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">string</span><span class="w"> </span><span class="kn">import</span> <span class="n">ascii_uppercase</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">django.core.exceptions</span><span class="w"> </span><span class="kn">import</span> <span class="n">FieldDoesNotExist</span><span class="p">,</span> <span class="n">FieldError</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.db</span><span class="w"> </span><span class="kn">import</span> <span class="n">DEFAULT_DB_ALIAS</span><span class="p">,</span> <span class="n">NotSupportedError</span><span class="p">,</span> <span class="n">connections</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.db.models.aggregates</span><span class="w"> </span><span class="kn">import</span> <span class="n">Count</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.db.models.constants</span><span class="w"> </span><span class="kn">import</span> <span class="n">LOOKUP_SEP</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.db.models.expressions</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">BaseExpression</span><span class="p">,</span>
    <span class="n">Col</span><span class="p">,</span>
    <span class="n">Exists</span><span class="p">,</span>
    <span class="n">F</span><span class="p">,</span>
    <span class="n">OuterRef</span><span class="p">,</span>
    <span class="n">Ref</span><span class="p">,</span>
    <span class="n">ResolvedOuterRef</span><span class="p">,</span>
    <span class="n">Value</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.db.models.fields</span><span class="w"> </span><span class="kn">import</span> <span class="n">Field</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.db.models.fields.related_lookups</span><span class="w"> </span><span class="kn">import</span> <span class="n">MultiColSource</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.db.models.lookups</span><span class="w"> </span><span class="kn">import</span> <span class="n">Lookup</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.db.models.query_utils</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">Q</span><span class="p">,</span>
    <span class="n">check_rel_lookup_compatibility</span><span class="p">,</span>
    <span class="n">refs_expression</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.db.models.sql.constants</span><span class="w"> </span><span class="kn">import</span> <span class="n">INNER</span><span class="p">,</span> <span class="n">LOUTER</span><span class="p">,</span> <span class="n">ORDER_DIR</span><span class="p">,</span> <span class="n">SINGLE</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.db.models.sql.datastructures</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseTable</span><span class="p">,</span> <span class="n">Empty</span><span class="p">,</span> <span class="n">Join</span><span class="p">,</span> <span class="n">MultiJoin</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.db.models.sql.where</span><span class="w"> </span><span class="kn">import</span> <span class="n">AND</span><span class="p">,</span> <span class="n">OR</span><span class="p">,</span> <span class="n">ExtraWhere</span><span class="p">,</span> <span class="n">NothingNode</span><span class="p">,</span> <span class="n">WhereNode</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.utils.functional</span><span class="w"> </span><span class="kn">import</span> <span class="n">cached_property</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.utils.regex_helper</span><span class="w"> </span><span class="kn">import</span> <span class="n">_lazy_re_compile</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.utils.tree</span><span class="w"> </span><span class="kn">import</span> <span class="n">Node</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Query&quot;</span><span class="p">,</span> <span class="s2">&quot;RawQuery&quot;</span><span class="p">]</span>

<span class="c1"># Quotation marks (&#39;&quot;`[]), whitespace characters, semicolons, or inline</span>
<span class="c1"># SQL comments are forbidden in column aliases.</span>
<span class="n">FORBIDDEN_ALIAS_PATTERN</span> <span class="o">=</span> <span class="n">_lazy_re_compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;[&#39;`</span><span class="se">\&quot;</span><span class="s2">\]\[;\s]|--|/\*|\*/&quot;</span><span class="p">)</span>

<span class="c1"># Inspired from</span>
<span class="c1"># https://www.postgresql.org/docs/current/sql-syntax-lexical.html#SQL-SYNTAX-IDENTIFIERS</span>
<span class="n">EXPLAIN_OPTIONS_PATTERN</span> <span class="o">=</span> <span class="n">_lazy_re_compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;[\w\-]+&quot;</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">get_field_names_from_opts</span><span class="p">(</span><span class="n">opts</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">opts</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">return</span> <span class="nb">set</span><span class="p">(</span>
        <span class="n">chain</span><span class="o">.</span><span class="n">from_iterable</span><span class="p">(</span>
            <span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">attname</span><span class="p">)</span> <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">concrete</span> <span class="k">else</span> <span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">,)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">opts</span><span class="o">.</span><span class="n">get_fields</span><span class="p">()</span>
        <span class="p">)</span>
    <span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">get_children_from_q</span><span class="p">(</span><span class="n">q</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">q</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">Node</span><span class="p">):</span>
            <span class="k">yield from</span> <span class="n">get_children_from_q</span><span class="p">(</span><span class="n">child</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">child</span>


<span class="n">JoinInfo</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span>
    <span class="s2">&quot;JoinInfo&quot;</span><span class="p">,</span>
    <span class="p">(</span><span class="s2">&quot;final_field&quot;</span><span class="p">,</span> <span class="s2">&quot;targets&quot;</span><span class="p">,</span> <span class="s2">&quot;opts&quot;</span><span class="p">,</span> <span class="s2">&quot;joins&quot;</span><span class="p">,</span> <span class="s2">&quot;path&quot;</span><span class="p">,</span> <span class="s2">&quot;transform_function&quot;</span><span class="p">),</span>
<span class="p">)</span>


<div class="viewcode-block" id="RawQuery">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/query/index.html#django.db.models.sql.query.RawQuery">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">RawQuery</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A single raw SQL query.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sql</span><span class="p">,</span> <span class="n">using</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="p">()):</span>
<div class="viewcode-block" id="RawQuery.params">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/query/index.html#django.db.models.sql.query.RawQuery.params">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="n">params</span></div>

<div class="viewcode-block" id="RawQuery.sql">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/query/index.html#django.db.models.sql.query.RawQuery.sql">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">sql</span> <span class="o">=</span> <span class="n">sql</span></div>

<div class="viewcode-block" id="RawQuery.using">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/query/index.html#django.db.models.sql.query.RawQuery.using">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">using</span> <span class="o">=</span> <span class="n">using</span></div>

<div class="viewcode-block" id="RawQuery.cursor">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/query/index.html#django.db.models.sql.query.RawQuery.cursor">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span> <span class="o">=</span> <span class="kc">None</span></div>


        <span class="c1"># Mirror some properties of a normal query so that</span>
        <span class="c1"># the compiler can be used to process results.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">low_mark</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">high_mark</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">None</span>  <span class="c1"># Used for offset/limit</span>
<div class="viewcode-block" id="RawQuery.extra_select">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/query/index.html#django.db.models.sql.query.RawQuery.extra_select">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">extra_select</span> <span class="o">=</span> <span class="p">{}</span></div>

<div class="viewcode-block" id="RawQuery.annotation_select">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/query/index.html#django.db.models.sql.query.RawQuery.annotation_select">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">annotation_select</span> <span class="o">=</span> <span class="p">{}</span></div>


<div class="viewcode-block" id="RawQuery.chain">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/query/index.html#django.db.models.sql.query.RawQuery.chain">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">chain</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">using</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">clone</span><span class="p">(</span><span class="n">using</span><span class="p">)</span></div>


<div class="viewcode-block" id="RawQuery.clone">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/query/index.html#django.db.models.sql.query.RawQuery.clone">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">clone</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">using</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">RawQuery</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sql</span><span class="p">,</span> <span class="n">using</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">)</span></div>


<div class="viewcode-block" id="RawQuery.get_columns">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/query/index.html#django.db.models.sql.query.RawQuery.get_columns">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_columns</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_execute_query</span><span class="p">()</span>
        <span class="n">converter</span> <span class="o">=</span> <span class="n">connections</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">using</span><span class="p">]</span><span class="o">.</span><span class="n">introspection</span><span class="o">.</span><span class="n">identifier_converter</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">converter</span><span class="p">(</span><span class="n">column_meta</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">column_meta</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">description</span><span class="p">]</span></div>


    <span class="k">def</span><span class="w"> </span><span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Always execute a new query for a new iterator.</span>
        <span class="c1"># This could be optimized with a cache at the expense of RAM.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_execute_query</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">connections</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">using</span><span class="p">]</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">can_use_chunked_reads</span><span class="p">:</span>
            <span class="c1"># If the database can&#39;t use chunked reads we need to make sure we</span>
            <span class="c1"># evaluate the entire query up front.</span>
            <span class="n">result</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span>
        <span class="k">return</span> <span class="nb">iter</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;&lt;</span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&gt;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>

    <span class="nd">@property</span>
<div class="viewcode-block" id="RawQuery.params_type">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/query/index.html#django.db.models.sql.query.RawQuery.params_type">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">params_type</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="nb">dict</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="n">Mapping</span><span class="p">)</span> <span class="k">else</span> <span class="nb">tuple</span></div>


    <span class="k">def</span><span class="w"> </span><span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params_type</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sql</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sql</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">params_type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_execute_query</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">connection</span> <span class="o">=</span> <span class="n">connections</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">using</span><span class="p">]</span>

        <span class="c1"># Adapt parameters to the database, as much as possible considering</span>
        <span class="c1"># that the target type isn&#39;t known. See #17755.</span>
        <span class="n">params_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params_type</span>
        <span class="n">adapter</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">adapt_unknown_value</span>
        <span class="k">if</span> <span class="n">params_type</span> <span class="ow">is</span> <span class="nb">tuple</span><span class="p">:</span>
            <span class="n">params</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">adapter</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">params_type</span> <span class="ow">is</span> <span class="nb">dict</span><span class="p">:</span>
            <span class="n">params</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">adapter</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
        <span class="k">elif</span> <span class="n">params_type</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">params</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Unexpected params type: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">params_type</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sql</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span></div>



<span class="n">ExplainInfo</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s2">&quot;ExplainInfo&quot;</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;format&quot;</span><span class="p">,</span> <span class="s2">&quot;options&quot;</span><span class="p">))</span>


<div class="viewcode-block" id="Query">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/query/index.html#django.db.models.sql.query.Query">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Query</span><span class="p">(</span><span class="n">BaseExpression</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A single SQL query.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="Query.alias_prefix">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/query/index.html#django.db.models.sql.query.Query.alias_prefix">[docs]</a>
    <span class="n">alias_prefix</span> <span class="o">=</span> <span class="s2">&quot;T&quot;</span></div>

<div class="viewcode-block" id="Query.empty_result_set_value">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/query/index.html#django.db.models.sql.query.Query.empty_result_set_value">[docs]</a>
    <span class="n">empty_result_set_value</span> <span class="o">=</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="Query.subq_aliases">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/query/index.html#django.db.models.sql.query.Query.subq_aliases">[docs]</a>
    <span class="n">subq_aliases</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">([</span><span class="n">alias_prefix</span><span class="p">])</span></div>


<div class="viewcode-block" id="Query.compiler">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/query/index.html#django.db.models.sql.query.Query.compiler">[docs]</a>
    <span class="n">compiler</span> <span class="o">=</span> <span class="s2">&quot;SQLCompiler&quot;</span></div>


<div class="viewcode-block" id="Query.base_table_class">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/query/index.html#django.db.models.sql.query.Query.base_table_class">[docs]</a>
    <span class="n">base_table_class</span> <span class="o">=</span> <span class="n">BaseTable</span></div>

<div class="viewcode-block" id="Query.join_class">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/query/index.html#django.db.models.sql.query.Query.join_class">[docs]</a>
    <span class="n">join_class</span> <span class="o">=</span> <span class="n">Join</span></div>


<div class="viewcode-block" id="Query.default_cols">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/query/index.html#django.db.models.sql.query.Query.default_cols">[docs]</a>
    <span class="n">default_cols</span> <span class="o">=</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="Query.default_ordering">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/query/index.html#django.db.models.sql.query.Query.default_ordering">[docs]</a>
    <span class="n">default_ordering</span> <span class="o">=</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="Query.standard_ordering">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/query/index.html#django.db.models.sql.query.Query.standard_ordering">[docs]</a>
    <span class="n">standard_ordering</span> <span class="o">=</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="Query.filter_is_sticky">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/query/index.html#django.db.models.sql.query.Query.filter_is_sticky">[docs]</a>
    <span class="n">filter_is_sticky</span> <span class="o">=</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="Query.subquery">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/query/index.html#django.db.models.sql.query.Query.subquery">[docs]</a>
    <span class="n">subquery</span> <span class="o">=</span> <span class="kc">False</span></div>


    <span class="c1"># SQL-related attributes.</span>
    <span class="c1"># Select and related select clauses are expressions to use in the SELECT</span>
    <span class="c1"># clause of the query. The select is used for cases where we want to set up</span>
    <span class="c1"># the select clause to contain other than default fields (values(),</span>
    <span class="c1"># subqueries...). Note that annotations go to annotations dictionary.</span>
<div class="viewcode-block" id="Query.select">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/query/index.html#django.db.models.sql.query.Query.select">[docs]</a>
    <span class="n">select</span> <span class="o">=</span> <span class="p">()</span></div>

    <span class="c1"># The group_by attribute can have one of the following forms:</span>
    <span class="c1">#  - None: no group by at all in the query</span>
    <span class="c1">#  - A tuple of expressions: group by (at least) those expressions.</span>
    <span class="c1">#    String refs are also allowed for now.</span>
    <span class="c1">#  - True: group by all select fields of the model</span>
    <span class="c1"># See compiler.get_group_by() for details.</span>
<div class="viewcode-block" id="Query.group_by">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/query/index.html#django.db.models.sql.query.Query.group_by">[docs]</a>
    <span class="n">group_by</span> <span class="o">=</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="Query.order_by">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/query/index.html#django.db.models.sql.query.Query.order_by">[docs]</a>
    <span class="n">order_by</span> <span class="o">=</span> <span class="p">()</span></div>

<div class="viewcode-block" id="Query.low_mark">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/query/index.html#django.db.models.sql.query.Query.low_mark">[docs]</a>
    <span class="n">low_mark</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># Used for offset/limit.</span></div>

<div class="viewcode-block" id="Query.high_mark">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/query/index.html#django.db.models.sql.query.Query.high_mark">[docs]</a>
    <span class="n">high_mark</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Used for offset/limit.</span></div>

<div class="viewcode-block" id="Query.distinct">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/query/index.html#django.db.models.sql.query.Query.distinct">[docs]</a>
    <span class="n">distinct</span> <span class="o">=</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="Query.distinct_fields">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/query/index.html#django.db.models.sql.query.Query.distinct_fields">[docs]</a>
    <span class="n">distinct_fields</span> <span class="o">=</span> <span class="p">()</span></div>

<div class="viewcode-block" id="Query.select_for_update">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/query/index.html#django.db.models.sql.query.Query.select_for_update">[docs]</a>
    <span class="n">select_for_update</span> <span class="o">=</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="Query.select_for_update_nowait">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/query/index.html#django.db.models.sql.query.Query.select_for_update_nowait">[docs]</a>
    <span class="n">select_for_update_nowait</span> <span class="o">=</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="Query.select_for_update_skip_locked">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/query/index.html#django.db.models.sql.query.Query.select_for_update_skip_locked">[docs]</a>
    <span class="n">select_for_update_skip_locked</span> <span class="o">=</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="Query.select_for_update_of">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/query/index.html#django.db.models.sql.query.Query.select_for_update_of">[docs]</a>
    <span class="n">select_for_update_of</span> <span class="o">=</span> <span class="p">()</span></div>

<div class="viewcode-block" id="Query.select_for_no_key_update">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/query/index.html#django.db.models.sql.query.Query.select_for_no_key_update">[docs]</a>
    <span class="n">select_for_no_key_update</span> <span class="o">=</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="Query.select_related">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/query/index.html#django.db.models.sql.query.Query.select_related">[docs]</a>
    <span class="n">select_related</span> <span class="o">=</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="Query.has_select_fields">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/query/index.html#django.db.models.sql.query.Query.has_select_fields">[docs]</a>
    <span class="n">has_select_fields</span> <span class="o">=</span> <span class="kc">False</span></div>

    <span class="c1"># Arbitrary limit for select_related to prevents infinite recursion.</span>
<div class="viewcode-block" id="Query.max_depth">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/query/index.html#django.db.models.sql.query.Query.max_depth">[docs]</a>
    <span class="n">max_depth</span> <span class="o">=</span> <span class="mi">5</span></div>

    <span class="c1"># Holds the selects defined by a call to values() or values_list()</span>
    <span class="c1"># excluding annotation_select and extra_select.</span>
<div class="viewcode-block" id="Query.values_select">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/query/index.html#django.db.models.sql.query.Query.values_select">[docs]</a>
    <span class="n">values_select</span> <span class="o">=</span> <span class="p">()</span></div>


    <span class="c1"># SQL annotation-related attributes.</span>
<div class="viewcode-block" id="Query.annotation_select_mask">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/query/index.html#django.db.models.sql.query.Query.annotation_select_mask">[docs]</a>
    <span class="n">annotation_select_mask</span> <span class="o">=</span> <span class="kc">None</span></div>

    <span class="n">_annotation_select_cache</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># Set combination attributes.</span>
<div class="viewcode-block" id="Query.combinator">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/query/index.html#django.db.models.sql.query.Query.combinator">[docs]</a>
    <span class="n">combinator</span> <span class="o">=</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="Query.combinator_all">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/query/index.html#django.db.models.sql.query.Query.combinator_all">[docs]</a>
    <span class="n">combinator_all</span> <span class="o">=</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="Query.combined_queries">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/query/index.html#django.db.models.sql.query.Query.combined_queries">[docs]</a>
    <span class="n">combined_queries</span> <span class="o">=</span> <span class="p">()</span></div>


    <span class="c1"># These are for extensions. The contents are more or less appended verbatim</span>
    <span class="c1"># to the appropriate clause.</span>
<div class="viewcode-block" id="Query.extra_select_mask">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/query/index.html#django.db.models.sql.query.Query.extra_select_mask">[docs]</a>
    <span class="n">extra_select_mask</span> <span class="o">=</span> <span class="kc">None</span></div>

    <span class="n">_extra_select_cache</span> <span class="o">=</span> <span class="kc">None</span>

<div class="viewcode-block" id="Query.extra_tables">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/query/index.html#django.db.models.sql.query.Query.extra_tables">[docs]</a>
    <span class="n">extra_tables</span> <span class="o">=</span> <span class="p">()</span></div>

<div class="viewcode-block" id="Query.extra_order_by">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/query/index.html#django.db.models.sql.query.Query.extra_order_by">[docs]</a>
    <span class="n">extra_order_by</span> <span class="o">=</span> <span class="p">()</span></div>


    <span class="c1"># A tuple that is a set of model field names and either True, if these are</span>
    <span class="c1"># the fields to defer, or False if these are the only fields to load.</span>
<div class="viewcode-block" id="Query.deferred_loading">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/query/index.html#django.db.models.sql.query.Query.deferred_loading">[docs]</a>
    <span class="n">deferred_loading</span> <span class="o">=</span> <span class="p">(</span><span class="nb">frozenset</span><span class="p">(),</span> <span class="kc">True</span><span class="p">)</span></div>


<div class="viewcode-block" id="Query.explain_info">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/query/index.html#django.db.models.sql.query.Query.explain_info">[docs]</a>
    <span class="n">explain_info</span> <span class="o">=</span> <span class="kc">None</span></div>


    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">alias_cols</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<div class="viewcode-block" id="Query.model">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/query/index.html#django.db.models.sql.query.Query.model">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span></div>

<div class="viewcode-block" id="Query.alias_refcount">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/query/index.html#django.db.models.sql.query.Query.alias_refcount">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">alias_refcount</span> <span class="o">=</span> <span class="p">{}</span></div>

        <span class="c1"># alias_map is the most important data structure regarding joins.</span>
        <span class="c1"># It&#39;s used for recording which joins exist in the query and what</span>
        <span class="c1"># types they are. The key is the alias of the joined table (possibly</span>
        <span class="c1"># the table name) and the value is a Join-like object (see</span>
        <span class="c1"># sql.datastructures.Join for more information).</span>
<div class="viewcode-block" id="Query.alias_map">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/query/index.html#django.db.models.sql.query.Query.alias_map">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">alias_map</span> <span class="o">=</span> <span class="p">{}</span></div>

        <span class="c1"># Whether to provide alias to columns during reference resolving.</span>
<div class="viewcode-block" id="Query.alias_cols">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/query/index.html#django.db.models.sql.query.Query.alias_cols">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">alias_cols</span> <span class="o">=</span> <span class="n">alias_cols</span></div>

        <span class="c1"># Sometimes the query contains references to aliases in outer queries (as</span>
        <span class="c1"># a result of split_exclude). Correct alias quoting needs to know these</span>
        <span class="c1"># aliases too.</span>
        <span class="c1"># Map external tables to whether they are aliased.</span>
<div class="viewcode-block" id="Query.external_aliases">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/query/index.html#django.db.models.sql.query.Query.external_aliases">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">external_aliases</span> <span class="o">=</span> <span class="p">{}</span></div>

<div class="viewcode-block" id="Query.table_map">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/query/index.html#django.db.models.sql.query.Query.table_map">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">table_map</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># Maps table names to list of aliases.</span></div>

<div class="viewcode-block" id="Query.used_aliases">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/query/index.html#django.db.models.sql.query.Query.used_aliases">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">used_aliases</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span></div>


<div class="viewcode-block" id="Query.where">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/query/index.html#django.db.models.sql.query.Query.where">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">where</span> <span class="o">=</span> <span class="n">WhereNode</span><span class="p">()</span></div>

        <span class="c1"># Maps alias -&gt; Annotation Expression.</span>
<div class="viewcode-block" id="Query.annotations">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/query/index.html#django.db.models.sql.query.Query.annotations">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">annotations</span> <span class="o">=</span> <span class="p">{}</span></div>

        <span class="c1"># These are for extensions. The contents are more or less appended</span>
        <span class="c1"># verbatim to the appropriate clause.</span>
<div class="viewcode-block" id="Query.extra">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/query/index.html#django.db.models.sql.query.Query.extra">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">extra</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># Maps col_alias -&gt; (col_sql, params).</span></div>


        <span class="bp">self</span><span class="o">.</span><span class="n">_filtered_relations</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="nd">@property</span>
<div class="viewcode-block" id="Query.output_field">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/query/index.html#django.db.models.sql.query.Query.output_field">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">output_field</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">select</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">select</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">select</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">select</span><span class="p">,</span> <span class="s2">&quot;target&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="n">select</span><span class="o">.</span><span class="n">field</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">annotation_select</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">annotation_select</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span><span class="o">.</span><span class="n">output_field</span></div>


    <span class="nd">@cached_property</span>
<div class="viewcode-block" id="Query.base_table">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/query/index.html#django.db.models.sql.query.Query.base_table">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">base_table</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">alias</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">alias_map</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">alias</span></div>


    <span class="k">def</span><span class="w"> </span><span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the query as a string of SQL with the parameter values</span>
<span class="sd">        substituted in (use sql_with_params() to see the unsubstituted string).</span>

<span class="sd">        Parameter values won&#39;t necessarily be quoted correctly, since that is</span>
<span class="sd">        done by the database interface at execution time.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">sql</span><span class="p">,</span> <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sql_with_params</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">sql</span> <span class="o">%</span> <span class="n">params</span>

<div class="viewcode-block" id="Query.sql_with_params">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/query/index.html#django.db.models.sql.query.Query.sql_with_params">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">sql_with_params</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the query as an SQL string and the parameters that will be</span>
<span class="sd">        substituted into the query.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_compiler</span><span class="p">(</span><span class="n">DEFAULT_DB_ALIAS</span><span class="p">)</span><span class="o">.</span><span class="n">as_sql</span><span class="p">()</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">__deepcopy__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">memo</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Limit the amount of work when a Query is deepcopied.&quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
        <span class="n">memo</span><span class="p">[</span><span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="p">)]</span> <span class="o">=</span> <span class="n">result</span>
        <span class="k">return</span> <span class="n">result</span>

<div class="viewcode-block" id="Query.get_compiler">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/query/index.html#django.db.models.sql.query.Query.get_compiler">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_compiler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">using</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">connection</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">elide_empty</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">using</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">connection</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Need either using or connection&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">using</span><span class="p">:</span>
            <span class="n">connection</span> <span class="o">=</span> <span class="n">connections</span><span class="p">[</span><span class="n">using</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">connection</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">compiler</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">compiler</span><span class="p">)(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">connection</span><span class="p">,</span> <span class="n">using</span><span class="p">,</span> <span class="n">elide_empty</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="Query.get_meta">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/query/index.html#django.db.models.sql.query.Query.get_meta">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_meta</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the Options instance (the model._meta) from which to start</span>
<span class="sd">        processing. Normally, this is self.model._meta, but it can be changed</span>
<span class="sd">        by subclasses.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_meta</span></div>


<div class="viewcode-block" id="Query.clone">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/query/index.html#django.db.models.sql.query.Query.clone">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">clone</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a copy of the current Query. A lightweight alternative to</span>
<span class="sd">        deepcopy().</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="n">Empty</span><span class="p">()</span>
        <span class="n">obj</span><span class="o">.</span><span class="vm">__class__</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span>
        <span class="c1"># Copy references to everything.</span>
        <span class="n">obj</span><span class="o">.</span><span class="vm">__dict__</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="c1"># Clone attributes that can&#39;t use shallow copy.</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">alias_refcount</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">alias_refcount</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">alias_map</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">alias_map</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">external_aliases</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">external_aliases</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">table_map</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">table_map</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">where</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">where</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">annotations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">annotations</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">annotation_select_mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">annotation_select_mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">annotation_select_mask</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">combined_queries</span><span class="p">:</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">combined_queries</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span>
                <span class="p">[</span><span class="n">query</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span> <span class="k">for</span> <span class="n">query</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">combined_queries</span><span class="p">]</span>
            <span class="p">)</span>
        <span class="c1"># _annotation_select_cache cannot be copied, as doing so breaks the</span>
        <span class="c1"># (necessary) state in which both annotations and</span>
        <span class="c1"># _annotation_select_cache point to the same underlying objects.</span>
        <span class="c1"># It will get re-populated in the cloned queryset the next time it&#39;s</span>
        <span class="c1"># used.</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">_annotation_select_cache</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">extra</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">extra</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">extra_select_mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">extra_select_mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">extra_select_mask</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extra_select_cache</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">_extra_select_cache</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extra_select_cache</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">select_related</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">False</span><span class="p">:</span>
            <span class="c1"># Use deepcopy because select_related stores fields in nested</span>
            <span class="c1"># dicts.</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">select_related</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">select_related</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;subq_aliases&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">:</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">subq_aliases</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subq_aliases</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">used_aliases</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">used_aliases</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">_filtered_relations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filtered_relations</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="c1"># Clear the cached_property, if it exists.</span>
        <span class="n">obj</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;base_table&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">obj</span></div>


<div class="viewcode-block" id="Query.chain">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/query/index.html#django.db.models.sql.query.Query.chain">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">chain</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">klass</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a copy of the current Query that&#39;s ready for another operation.</span>
<span class="sd">        The klass argument changes the type of the Query, e.g. UpdateQuery.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">klass</span> <span class="ow">and</span> <span class="n">obj</span><span class="o">.</span><span class="vm">__class__</span> <span class="o">!=</span> <span class="n">klass</span><span class="p">:</span>
            <span class="n">obj</span><span class="o">.</span><span class="vm">__class__</span> <span class="o">=</span> <span class="n">klass</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">obj</span><span class="o">.</span><span class="n">filter_is_sticky</span><span class="p">:</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">used_aliases</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">filter_is_sticky</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;_setup_query&quot;</span><span class="p">):</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">_setup_query</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">obj</span></div>


<div class="viewcode-block" id="Query.relabeled_clone">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/query/index.html#django.db.models.sql.query.Query.relabeled_clone">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">relabeled_clone</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">change_map</span><span class="p">):</span>
        <span class="n">clone</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
        <span class="n">clone</span><span class="o">.</span><span class="n">change_aliases</span><span class="p">(</span><span class="n">change_map</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">clone</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_get_col</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">alias</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">alias_cols</span><span class="p">:</span>
            <span class="n">alias</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">target</span><span class="o">.</span><span class="n">get_col</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="n">field</span><span class="p">)</span>

<div class="viewcode-block" id="Query.get_aggregation">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/query/index.html#django.db.models.sql.query.Query.get_aggregation">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_aggregation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">using</span><span class="p">,</span> <span class="n">aggregate_exprs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the dictionary with the values of the existing aggregations.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">aggregate_exprs</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{}</span>
        <span class="c1"># Store annotation mask prior to temporarily adding aggregations for</span>
        <span class="c1"># resolving purpose to facilitate their subsequent removal.</span>
        <span class="n">refs_subquery</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">refs_window</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">replacements</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">annotation_select_mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">annotation_select_mask</span>
        <span class="k">for</span> <span class="n">alias</span><span class="p">,</span> <span class="n">aggregate_expr</span> <span class="ow">in</span> <span class="n">aggregate_exprs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">check_alias</span><span class="p">(</span><span class="n">alias</span><span class="p">)</span>
            <span class="n">aggregate</span> <span class="o">=</span> <span class="n">aggregate_expr</span><span class="o">.</span><span class="n">resolve_expression</span><span class="p">(</span>
                <span class="bp">self</span><span class="p">,</span> <span class="n">allow_joins</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">reuse</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">summarize</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">aggregate</span><span class="o">.</span><span class="n">contains_aggregate</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> is not an aggregate expression&quot;</span> <span class="o">%</span> <span class="n">alias</span><span class="p">)</span>
            <span class="c1"># Temporarily add aggregate to annotations to allow remaining</span>
            <span class="c1"># members of `aggregates` to resolve against each others.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">append_annotation_mask</span><span class="p">([</span><span class="n">alias</span><span class="p">])</span>
            <span class="n">refs_subquery</span> <span class="o">|=</span> <span class="nb">any</span><span class="p">(</span>
                <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">annotations</span><span class="p">[</span><span class="n">ref</span><span class="p">],</span> <span class="s2">&quot;contains_subquery&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">ref</span> <span class="ow">in</span> <span class="n">aggregate</span><span class="o">.</span><span class="n">get_refs</span><span class="p">()</span>
            <span class="p">)</span>
            <span class="n">refs_window</span> <span class="o">|=</span> <span class="nb">any</span><span class="p">(</span>
                <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">annotations</span><span class="p">[</span><span class="n">ref</span><span class="p">],</span> <span class="s2">&quot;contains_over_clause&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">ref</span> <span class="ow">in</span> <span class="n">aggregate</span><span class="o">.</span><span class="n">get_refs</span><span class="p">()</span>
            <span class="p">)</span>
            <span class="n">aggregate</span> <span class="o">=</span> <span class="n">aggregate</span><span class="o">.</span><span class="n">replace_expressions</span><span class="p">(</span><span class="n">replacements</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">annotations</span><span class="p">[</span><span class="n">alias</span><span class="p">]</span> <span class="o">=</span> <span class="n">aggregate</span>
            <span class="n">replacements</span><span class="p">[</span><span class="n">Ref</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="n">aggregate</span><span class="p">)]</span> <span class="o">=</span> <span class="n">aggregate</span>
        <span class="c1"># Stash resolved aggregates now that they have been allowed to resolve</span>
        <span class="c1"># against each other.</span>
        <span class="n">aggregates</span> <span class="o">=</span> <span class="p">{</span><span class="n">alias</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">annotations</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">alias</span><span class="p">)</span> <span class="k">for</span> <span class="n">alias</span> <span class="ow">in</span> <span class="n">aggregate_exprs</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_annotation_mask</span><span class="p">(</span><span class="n">annotation_select_mask</span><span class="p">)</span>
        <span class="c1"># Existing usage of aggregation can be determined by the presence of</span>
        <span class="c1"># selected aggregates but also by filters against aliased aggregates.</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">having</span><span class="p">,</span> <span class="n">qualify</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">where</span><span class="o">.</span><span class="n">split_having_qualify</span><span class="p">()</span>
        <span class="n">has_existing_aggregation</span> <span class="o">=</span> <span class="p">(</span>
            <span class="nb">any</span><span class="p">(</span>
                <span class="nb">getattr</span><span class="p">(</span><span class="n">annotation</span><span class="p">,</span> <span class="s2">&quot;contains_aggregate&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">annotation</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">annotations</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
            <span class="p">)</span>
            <span class="ow">or</span> <span class="n">having</span>
        <span class="p">)</span>
        <span class="c1"># Decide if we need to use a subquery.</span>
        <span class="c1">#</span>
        <span class="c1"># Existing aggregations would cause incorrect results as</span>
        <span class="c1"># get_aggregation() must produce just one result and thus must not use</span>
        <span class="c1"># GROUP BY.</span>
        <span class="c1">#</span>
        <span class="c1"># If the query has limit or distinct, or uses set operations, then</span>
        <span class="c1"># those operations must be done in a subquery so that the query</span>
        <span class="c1"># aggregates on the limit and/or distinct results instead of applying</span>
        <span class="c1"># the distinct and limit after the aggregation.</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">group_by</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span>
            <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_sliced</span>
            <span class="ow">or</span> <span class="n">has_existing_aggregation</span>
            <span class="ow">or</span> <span class="n">refs_subquery</span>
            <span class="ow">or</span> <span class="n">refs_window</span>
            <span class="ow">or</span> <span class="n">qualify</span>
            <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">distinct</span>
            <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">combinator</span>
        <span class="p">):</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">django.db.models.sql.subqueries</span><span class="w"> </span><span class="kn">import</span> <span class="n">AggregateQuery</span>

            <span class="n">inner_query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
            <span class="n">inner_query</span><span class="o">.</span><span class="n">subquery</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">outer_query</span> <span class="o">=</span> <span class="n">AggregateQuery</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">inner_query</span><span class="p">)</span>
            <span class="n">inner_query</span><span class="o">.</span><span class="n">select_for_update</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">inner_query</span><span class="o">.</span><span class="n">select_related</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">inner_query</span><span class="o">.</span><span class="n">set_annotation_mask</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">annotation_select</span><span class="p">)</span>
            <span class="c1"># Queries with distinct_fields need ordering and when a limit is</span>
            <span class="c1"># applied we must take the slice from the ordered query. Otherwise</span>
            <span class="c1"># no need for ordering.</span>
            <span class="n">inner_query</span><span class="o">.</span><span class="n">clear_ordering</span><span class="p">(</span><span class="n">force</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">inner_query</span><span class="o">.</span><span class="n">distinct</span><span class="p">:</span>
                <span class="c1"># If the inner query uses default select and it has some</span>
                <span class="c1"># aggregate annotations, then we must make sure the inner</span>
                <span class="c1"># query is grouped by the main model&#39;s primary key. However,</span>
                <span class="c1"># clearing the select clause can alter results if distinct is</span>
                <span class="c1"># used.</span>
                <span class="k">if</span> <span class="n">inner_query</span><span class="o">.</span><span class="n">default_cols</span> <span class="ow">and</span> <span class="n">has_existing_aggregation</span><span class="p">:</span>
                    <span class="n">inner_query</span><span class="o">.</span><span class="n">group_by</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">pk</span><span class="o">.</span><span class="n">get_col</span><span class="p">(</span><span class="n">inner_query</span><span class="o">.</span><span class="n">get_initial_alias</span><span class="p">()),</span>
                    <span class="p">)</span>
                <span class="n">inner_query</span><span class="o">.</span><span class="n">default_cols</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">qualify</span><span class="p">:</span>
                    <span class="c1"># Mask existing annotations that are not referenced by</span>
                    <span class="c1"># aggregates to be pushed to the outer query unless</span>
                    <span class="c1"># filtering against window functions is involved as it</span>
                    <span class="c1"># requires complex realising.</span>
                    <span class="n">annotation_mask</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">group_by</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
                        <span class="k">for</span> <span class="n">expr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">group_by</span><span class="p">:</span>
                            <span class="n">annotation_mask</span> <span class="o">|=</span> <span class="n">expr</span><span class="o">.</span><span class="n">get_refs</span><span class="p">()</span>
                    <span class="k">for</span> <span class="n">aggregate</span> <span class="ow">in</span> <span class="n">aggregates</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                        <span class="n">annotation_mask</span> <span class="o">|=</span> <span class="n">aggregate</span><span class="o">.</span><span class="n">get_refs</span><span class="p">()</span>
                    <span class="c1"># Avoid eliding expressions that might have an incidence on</span>
                    <span class="c1"># the implicit grouping logic.</span>
                    <span class="k">for</span> <span class="n">annotation_alias</span><span class="p">,</span> <span class="n">annotation</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">annotation_select</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="k">if</span> <span class="n">annotation</span><span class="o">.</span><span class="n">get_group_by_cols</span><span class="p">():</span>
                            <span class="n">annotation_mask</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">annotation_alias</span><span class="p">)</span>
                    <span class="n">inner_query</span><span class="o">.</span><span class="n">set_annotation_mask</span><span class="p">(</span><span class="n">annotation_mask</span><span class="p">)</span>

            <span class="c1"># Add aggregates to the outer AggregateQuery. This requires making</span>
            <span class="c1"># sure all columns referenced by the aggregates are selected in the</span>
            <span class="c1"># inner query. It is achieved by retrieving all column references</span>
            <span class="c1"># by the aggregates, explicitly selecting them in the inner query,</span>
            <span class="c1"># and making sure the aggregates are repointed to them.</span>
            <span class="n">col_refs</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">alias</span><span class="p">,</span> <span class="n">aggregate</span> <span class="ow">in</span> <span class="n">aggregates</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">replacements</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gen_cols</span><span class="p">([</span><span class="n">aggregate</span><span class="p">],</span> <span class="n">resolve_refs</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">col_ref</span> <span class="o">:=</span> <span class="n">col_refs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">col</span><span class="p">)):</span>
                        <span class="n">index</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">col_refs</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
                        <span class="n">col_alias</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;__col</span><span class="si">{</span><span class="n">index</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="n">col_ref</span> <span class="o">=</span> <span class="n">Ref</span><span class="p">(</span><span class="n">col_alias</span><span class="p">,</span> <span class="n">col</span><span class="p">)</span>
                        <span class="n">col_refs</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">col_ref</span>
                        <span class="n">inner_query</span><span class="o">.</span><span class="n">annotations</span><span class="p">[</span><span class="n">col_alias</span><span class="p">]</span> <span class="o">=</span> <span class="n">col</span>
                        <span class="n">inner_query</span><span class="o">.</span><span class="n">append_annotation_mask</span><span class="p">([</span><span class="n">col_alias</span><span class="p">])</span>
                    <span class="n">replacements</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">col_ref</span>
                <span class="n">outer_query</span><span class="o">.</span><span class="n">annotations</span><span class="p">[</span><span class="n">alias</span><span class="p">]</span> <span class="o">=</span> <span class="n">aggregate</span><span class="o">.</span><span class="n">replace_expressions</span><span class="p">(</span>
                    <span class="n">replacements</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="n">inner_query</span><span class="o">.</span><span class="n">select</span> <span class="o">==</span> <span class="p">()</span>
                <span class="ow">and</span> <span class="ow">not</span> <span class="n">inner_query</span><span class="o">.</span><span class="n">default_cols</span>
                <span class="ow">and</span> <span class="ow">not</span> <span class="n">inner_query</span><span class="o">.</span><span class="n">annotation_select_mask</span>
            <span class="p">):</span>
                <span class="c1"># In case of Model.objects[0:3].count(), there would be no</span>
                <span class="c1"># field selected in the inner query, yet we must use a subquery.</span>
                <span class="c1"># So, make sure at least one field is selected.</span>
                <span class="n">inner_query</span><span class="o">.</span><span class="n">select</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">pk</span><span class="o">.</span><span class="n">get_col</span><span class="p">(</span><span class="n">inner_query</span><span class="o">.</span><span class="n">get_initial_alias</span><span class="p">()),</span>
                <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">outer_query</span> <span class="o">=</span> <span class="bp">self</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">select</span> <span class="o">=</span> <span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">default_cols</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">extra</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">annotations</span><span class="p">:</span>
                <span class="c1"># Inline reference to existing annotations and mask them as</span>
                <span class="c1"># they are unnecessary given only the summarized aggregations</span>
                <span class="c1"># are requested.</span>
                <span class="n">replacements</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="n">Ref</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="n">annotation</span><span class="p">):</span> <span class="n">annotation</span>
                    <span class="k">for</span> <span class="n">alias</span><span class="p">,</span> <span class="n">annotation</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">annotations</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                <span class="p">}</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">annotations</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="n">alias</span><span class="p">:</span> <span class="n">aggregate</span><span class="o">.</span><span class="n">replace_expressions</span><span class="p">(</span><span class="n">replacements</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">alias</span><span class="p">,</span> <span class="n">aggregate</span> <span class="ow">in</span> <span class="n">aggregates</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                <span class="p">}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">annotations</span> <span class="o">=</span> <span class="n">aggregates</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_annotation_mask</span><span class="p">(</span><span class="n">aggregates</span><span class="p">)</span>

        <span class="n">empty_set_result</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">expression</span><span class="o">.</span><span class="n">empty_result_set_value</span>
            <span class="k">for</span> <span class="n">expression</span> <span class="ow">in</span> <span class="n">outer_query</span><span class="o">.</span><span class="n">annotation_select</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
        <span class="p">]</span>
        <span class="n">elide_empty</span> <span class="o">=</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">result</span> <span class="ow">is</span> <span class="bp">NotImplemented</span> <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">empty_set_result</span><span class="p">)</span>
        <span class="n">outer_query</span><span class="o">.</span><span class="n">clear_ordering</span><span class="p">(</span><span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">outer_query</span><span class="o">.</span><span class="n">clear_limits</span><span class="p">()</span>
        <span class="n">outer_query</span><span class="o">.</span><span class="n">select_for_update</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">outer_query</span><span class="o">.</span><span class="n">select_related</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">compiler</span> <span class="o">=</span> <span class="n">outer_query</span><span class="o">.</span><span class="n">get_compiler</span><span class="p">(</span><span class="n">using</span><span class="p">,</span> <span class="n">elide_empty</span><span class="o">=</span><span class="n">elide_empty</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">compiler</span><span class="o">.</span><span class="n">execute_sql</span><span class="p">(</span><span class="n">SINGLE</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">empty_set_result</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">converters</span> <span class="o">=</span> <span class="n">compiler</span><span class="o">.</span><span class="n">get_converters</span><span class="p">(</span><span class="n">outer_query</span><span class="o">.</span><span class="n">annotation_select</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
            <span class="n">result</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">compiler</span><span class="o">.</span><span class="n">apply_converters</span><span class="p">((</span><span class="n">result</span><span class="p">,),</span> <span class="n">converters</span><span class="p">))</span>

        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">outer_query</span><span class="o">.</span><span class="n">annotation_select</span><span class="p">,</span> <span class="n">result</span><span class="p">))</span></div>


<div class="viewcode-block" id="Query.get_count">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/query/index.html#django.db.models.sql.query.Query.get_count">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_count</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">using</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Perform a COUNT() query using the current filter constraints.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">obj</span><span class="o">.</span><span class="n">get_aggregation</span><span class="p">(</span><span class="n">using</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;__count&quot;</span><span class="p">:</span> <span class="n">Count</span><span class="p">(</span><span class="s2">&quot;*&quot;</span><span class="p">)})[</span><span class="s2">&quot;__count&quot;</span><span class="p">]</span></div>


<div class="viewcode-block" id="Query.has_filters">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/query/index.html#django.db.models.sql.query.Query.has_filters">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">has_filters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">where</span></div>


<div class="viewcode-block" id="Query.exists">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/query/index.html#django.db.models.sql.query.Query.exists">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">exists</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">q</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">q</span><span class="o">.</span><span class="n">distinct</span> <span class="ow">and</span> <span class="n">q</span><span class="o">.</span><span class="n">is_sliced</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">q</span><span class="o">.</span><span class="n">group_by</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">q</span><span class="o">.</span><span class="n">add_fields</span><span class="p">(</span>
                    <span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">attname</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">concrete_fields</span><span class="p">),</span> <span class="kc">False</span>
                <span class="p">)</span>
                <span class="c1"># Disable GROUP BY aliases to avoid orphaning references to the</span>
                <span class="c1"># SELECT clause which is about to be cleared.</span>
                <span class="n">q</span><span class="o">.</span><span class="n">set_group_by</span><span class="p">(</span><span class="n">allow_aliases</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">q</span><span class="o">.</span><span class="n">clear_select_clause</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">q</span><span class="o">.</span><span class="n">combined_queries</span> <span class="ow">and</span> <span class="n">q</span><span class="o">.</span><span class="n">combinator</span> <span class="o">==</span> <span class="s2">&quot;union&quot;</span><span class="p">:</span>
            <span class="n">q</span><span class="o">.</span><span class="n">combined_queries</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span>
                <span class="n">combined_query</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">limit</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">combined_query</span> <span class="ow">in</span> <span class="n">q</span><span class="o">.</span><span class="n">combined_queries</span>
            <span class="p">)</span>
        <span class="n">q</span><span class="o">.</span><span class="n">clear_ordering</span><span class="p">(</span><span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">limit</span><span class="p">:</span>
            <span class="n">q</span><span class="o">.</span><span class="n">set_limits</span><span class="p">(</span><span class="n">high</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">q</span><span class="o">.</span><span class="n">add_annotation</span><span class="p">(</span><span class="n">Value</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">q</span></div>


<div class="viewcode-block" id="Query.has_results">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/query/index.html#django.db.models.sql.query.Query.has_results">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">has_results</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">using</span><span class="p">):</span>
        <span class="n">q</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">using</span><span class="p">)</span>
        <span class="n">compiler</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">get_compiler</span><span class="p">(</span><span class="n">using</span><span class="o">=</span><span class="n">using</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">compiler</span><span class="o">.</span><span class="n">has_results</span><span class="p">()</span></div>


<div class="viewcode-block" id="Query.explain">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/query/index.html#django.db.models.sql.query.Query.explain">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">explain</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">using</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">):</span>
        <span class="n">q</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">option_name</span> <span class="ow">in</span> <span class="n">options</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="ow">not</span> <span class="n">EXPLAIN_OPTIONS_PATTERN</span><span class="o">.</span><span class="n">fullmatch</span><span class="p">(</span><span class="n">option_name</span><span class="p">)</span>
                <span class="ow">or</span> <span class="s2">&quot;--&quot;</span> <span class="ow">in</span> <span class="n">option_name</span>
            <span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid option name: </span><span class="si">{</span><span class="n">option_name</span><span class="si">!r}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="n">q</span><span class="o">.</span><span class="n">explain_info</span> <span class="o">=</span> <span class="n">ExplainInfo</span><span class="p">(</span><span class="nb">format</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>
        <span class="n">compiler</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">get_compiler</span><span class="p">(</span><span class="n">using</span><span class="o">=</span><span class="n">using</span><span class="p">)</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">compiler</span><span class="o">.</span><span class="n">explain_query</span><span class="p">())</span></div>


<div class="viewcode-block" id="Query.combine">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/query/index.html#django.db.models.sql.query.Query.combine">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">combine</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rhs</span><span class="p">,</span> <span class="n">connector</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Merge the &#39;rhs&#39; query into the current one (with any &#39;rhs&#39; effects</span>
<span class="sd">        being applied *after* (that is, &quot;to the right of&quot;) anything in the</span>
<span class="sd">        current query. &#39;rhs&#39; is not modified during a call to this function.</span>

<span class="sd">        The &#39;connector&#39; parameter describes how to connect filters from the</span>
<span class="sd">        &#39;rhs&#39; query.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">!=</span> <span class="n">rhs</span><span class="o">.</span><span class="n">model</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Cannot combine queries on two different base models.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_sliced</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Cannot combine queries once a slice has been taken.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">distinct</span> <span class="o">!=</span> <span class="n">rhs</span><span class="o">.</span><span class="n">distinct</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Cannot combine a unique query with a non-unique query.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">distinct_fields</span> <span class="o">!=</span> <span class="n">rhs</span><span class="o">.</span><span class="n">distinct_fields</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Cannot combine queries with different distinct fields.&quot;</span><span class="p">)</span>

        <span class="c1"># If lhs and rhs shares the same alias prefix, it is possible to have</span>
        <span class="c1"># conflicting alias changes like T4 -&gt; T5, T5 -&gt; T6, which might end up</span>
        <span class="c1"># as T4 -&gt; T6 while combining two querysets. To prevent this, change an</span>
        <span class="c1"># alias prefix of the rhs and update current aliases accordingly,</span>
        <span class="c1"># except if the alias is the base table since it must be present in the</span>
        <span class="c1"># query on both sides.</span>
        <span class="n">initial_alias</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_initial_alias</span><span class="p">()</span>
        <span class="n">rhs</span><span class="o">.</span><span class="n">bump_prefix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exclude</span><span class="o">=</span><span class="p">{</span><span class="n">initial_alias</span><span class="p">})</span>

        <span class="c1"># Work out how to relabel the rhs aliases, if necessary.</span>
        <span class="n">change_map</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">conjunction</span> <span class="o">=</span> <span class="n">connector</span> <span class="o">==</span> <span class="n">AND</span>

        <span class="c1"># Determine which existing joins can be reused. When combining the</span>
        <span class="c1"># query with AND we must recreate all joins for m2m filters. When</span>
        <span class="c1"># combining with OR we can reuse joins. The reason is that in AND</span>
        <span class="c1"># case a single row can&#39;t fulfill a condition like:</span>
        <span class="c1">#     revrel__col=1 &amp; revrel__col=2</span>
        <span class="c1"># But, there might be two different related rows matching this</span>
        <span class="c1"># condition. In OR case a single True is enough, so single row is</span>
        <span class="c1"># enough, too.</span>
        <span class="c1">#</span>
        <span class="c1"># Note that we will be creating duplicate joins for non-m2m joins in</span>
        <span class="c1"># the AND case. The results will be correct but this creates too many</span>
        <span class="c1"># joins. This is something that could be fixed later on.</span>
        <span class="n">reuse</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span> <span class="k">if</span> <span class="n">conjunction</span> <span class="k">else</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">alias_map</span><span class="p">)</span>
        <span class="n">joinpromoter</span> <span class="o">=</span> <span class="n">JoinPromoter</span><span class="p">(</span><span class="n">connector</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">joinpromoter</span><span class="o">.</span><span class="n">add_votes</span><span class="p">(</span>
            <span class="n">j</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">alias_map</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">alias_map</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">join_type</span> <span class="o">==</span> <span class="n">INNER</span>
        <span class="p">)</span>
        <span class="n">rhs_votes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="c1"># Now, add the joins from rhs query into the new query (skipping base</span>
        <span class="c1"># table).</span>
        <span class="n">rhs_tables</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">rhs</span><span class="o">.</span><span class="n">alias_map</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="k">for</span> <span class="n">alias</span> <span class="ow">in</span> <span class="n">rhs_tables</span><span class="p">:</span>
            <span class="n">join</span> <span class="o">=</span> <span class="n">rhs</span><span class="o">.</span><span class="n">alias_map</span><span class="p">[</span><span class="n">alias</span><span class="p">]</span>
            <span class="c1"># If the left side of the join was already relabeled, use the</span>
            <span class="c1"># updated alias.</span>
            <span class="n">join</span> <span class="o">=</span> <span class="n">join</span><span class="o">.</span><span class="n">relabeled_clone</span><span class="p">(</span><span class="n">change_map</span><span class="p">)</span>
            <span class="n">new_alias</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">join</span><span class="p">,</span> <span class="n">reuse</span><span class="o">=</span><span class="n">reuse</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">join</span><span class="o">.</span><span class="n">join_type</span> <span class="o">==</span> <span class="n">INNER</span><span class="p">:</span>
                <span class="n">rhs_votes</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">new_alias</span><span class="p">)</span>
            <span class="c1"># We can&#39;t reuse the same join again in the query. If we have two</span>
            <span class="c1"># distinct joins for the same connection in rhs query, then the</span>
            <span class="c1"># combined query must have two joins, too.</span>
            <span class="n">reuse</span><span class="o">.</span><span class="n">discard</span><span class="p">(</span><span class="n">new_alias</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">alias</span> <span class="o">!=</span> <span class="n">new_alias</span><span class="p">:</span>
                <span class="n">change_map</span><span class="p">[</span><span class="n">alias</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_alias</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">rhs</span><span class="o">.</span><span class="n">alias_refcount</span><span class="p">[</span><span class="n">alias</span><span class="p">]:</span>
                <span class="c1"># The alias was unused in the rhs query. Unref it so that it</span>
                <span class="c1"># will be unused in the new query, too. We have to add and</span>
                <span class="c1"># unref the alias so that join promotion has information of</span>
                <span class="c1"># the join type for the unused alias.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">unref_alias</span><span class="p">(</span><span class="n">new_alias</span><span class="p">)</span>
        <span class="n">joinpromoter</span><span class="o">.</span><span class="n">add_votes</span><span class="p">(</span><span class="n">rhs_votes</span><span class="p">)</span>
        <span class="n">joinpromoter</span><span class="o">.</span><span class="n">update_join_types</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="c1"># Combine subqueries aliases to ensure aliases relabelling properly</span>
        <span class="c1"># handle subqueries when combining where and select clauses.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subq_aliases</span> <span class="o">|=</span> <span class="n">rhs</span><span class="o">.</span><span class="n">subq_aliases</span>

        <span class="c1"># Now relabel a copy of the rhs where-clause and add it to the current</span>
        <span class="c1"># one.</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">rhs</span><span class="o">.</span><span class="n">where</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
        <span class="n">w</span><span class="o">.</span><span class="n">relabel_aliases</span><span class="p">(</span><span class="n">change_map</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">where</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">connector</span><span class="p">)</span>

        <span class="c1"># Selection columns and extra extensions are those provided by &#39;rhs&#39;.</span>
        <span class="k">if</span> <span class="n">rhs</span><span class="o">.</span><span class="n">select</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_select</span><span class="p">([</span><span class="n">col</span><span class="o">.</span><span class="n">relabeled_clone</span><span class="p">(</span><span class="n">change_map</span><span class="p">)</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">rhs</span><span class="o">.</span><span class="n">select</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">select</span> <span class="o">=</span> <span class="p">()</span>

        <span class="k">if</span> <span class="n">connector</span> <span class="o">==</span> <span class="n">OR</span><span class="p">:</span>
            <span class="c1"># It would be nice to be able to handle this, but the queries don&#39;t</span>
            <span class="c1"># really make sense (or return consistent value sets). Not worth</span>
            <span class="c1"># the extra complexity when you can write a real query instead.</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">extra</span> <span class="ow">and</span> <span class="n">rhs</span><span class="o">.</span><span class="n">extra</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;When merging querysets using &#39;or&#39;, you cannot have &quot;</span>
                    <span class="s2">&quot;extra(select=...) on both sides.&quot;</span>
                <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">extra</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">rhs</span><span class="o">.</span><span class="n">extra</span><span class="p">)</span>
        <span class="n">extra_select_mask</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">extra_select_mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">extra_select_mask</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">extra_select_mask</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">rhs</span><span class="o">.</span><span class="n">extra_select_mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">extra_select_mask</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">rhs</span><span class="o">.</span><span class="n">extra_select_mask</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">extra_select_mask</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_extra_mask</span><span class="p">(</span><span class="n">extra_select_mask</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">extra_tables</span> <span class="o">+=</span> <span class="n">rhs</span><span class="o">.</span><span class="n">extra_tables</span>

        <span class="c1"># Ordering uses the &#39;rhs&#39; ordering, unless it has none, in which case</span>
        <span class="c1"># the current ordering is used.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">order_by</span> <span class="o">=</span> <span class="n">rhs</span><span class="o">.</span><span class="n">order_by</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">order_by</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">extra_order_by</span> <span class="o">=</span> <span class="n">rhs</span><span class="o">.</span><span class="n">extra_order_by</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">extra_order_by</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_get_defer_select_mask</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">opts</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">select_mask</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">select_mask</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">select_mask</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">select_mask</span><span class="p">[</span><span class="n">opts</span><span class="o">.</span><span class="n">pk</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># All concrete fields that are not part of the defer mask must be</span>
        <span class="c1"># loaded. If a relational field is encountered it gets added to the</span>
        <span class="c1"># mask for it be considered if `select_related` and the cycle continues</span>
        <span class="c1"># by recursively caling this function.</span>
        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">opts</span><span class="o">.</span><span class="n">concrete_fields</span><span class="p">:</span>
            <span class="n">field_mask</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">field_att_mask</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">attname</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">field_mask</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">field_att_mask</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">select_mask</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="p">{})</span>
            <span class="k">elif</span> <span class="n">field_mask</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">field</span><span class="o">.</span><span class="n">is_relation</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">FieldError</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">field_mask</span><span class="p">)))</span>
                <span class="n">field_select_mask</span> <span class="o">=</span> <span class="n">select_mask</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="p">{})</span>
                <span class="n">related_model</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">remote_field</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">concrete_model</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_get_defer_select_mask</span><span class="p">(</span>
                    <span class="n">related_model</span><span class="o">.</span><span class="n">_meta</span><span class="p">,</span> <span class="n">field_mask</span><span class="p">,</span> <span class="n">field_select_mask</span>
                <span class="p">)</span>
        <span class="c1"># Remaining defer entries must be references to reverse relationships.</span>
        <span class="c1"># The following code is expected to raise FieldError if it encounters</span>
        <span class="c1"># a malformed defer entry.</span>
        <span class="k">for</span> <span class="n">field_name</span><span class="p">,</span> <span class="n">field_mask</span> <span class="ow">in</span> <span class="n">mask</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">filtered_relation</span> <span class="o">:=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filtered_relations</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">field_name</span><span class="p">):</span>
                <span class="n">relation</span> <span class="o">=</span> <span class="n">opts</span><span class="o">.</span><span class="n">get_field</span><span class="p">(</span><span class="n">filtered_relation</span><span class="o">.</span><span class="n">relation_name</span><span class="p">)</span>
                <span class="n">field_select_mask</span> <span class="o">=</span> <span class="n">select_mask</span><span class="o">.</span><span class="n">setdefault</span><span class="p">((</span><span class="n">field_name</span><span class="p">,</span> <span class="n">relation</span><span class="p">),</span> <span class="p">{})</span>
                <span class="n">field</span> <span class="o">=</span> <span class="n">relation</span><span class="o">.</span><span class="n">field</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">reverse_rel</span> <span class="o">=</span> <span class="n">opts</span><span class="o">.</span><span class="n">get_field</span><span class="p">(</span><span class="n">field_name</span><span class="p">)</span>
                <span class="c1"># While virtual fields such as many-to-many and generic foreign</span>
                <span class="c1"># keys cannot be effectively deferred we&#39;ve historically</span>
                <span class="c1"># allowed them to be passed to QuerySet.defer(). Ignore such</span>
                <span class="c1"># field references until a layer of validation at mask</span>
                <span class="c1"># alteration time will be implemented eventually.</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">reverse_rel</span><span class="p">,</span> <span class="s2">&quot;field&quot;</span><span class="p">):</span>
                    <span class="k">continue</span>
                <span class="n">field</span> <span class="o">=</span> <span class="n">reverse_rel</span><span class="o">.</span><span class="n">field</span>
                <span class="n">field_select_mask</span> <span class="o">=</span> <span class="n">select_mask</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="p">{})</span>
            <span class="n">related_model</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">concrete_model</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_get_defer_select_mask</span><span class="p">(</span>
                <span class="n">related_model</span><span class="o">.</span><span class="n">_meta</span><span class="p">,</span> <span class="n">field_mask</span><span class="p">,</span> <span class="n">field_select_mask</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">select_mask</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_only_select_mask</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">opts</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">select_mask</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">select_mask</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">select_mask</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">select_mask</span><span class="p">[</span><span class="n">opts</span><span class="o">.</span><span class="n">pk</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># Only include fields mentioned in the mask.</span>
        <span class="k">for</span> <span class="n">field_name</span><span class="p">,</span> <span class="n">field_mask</span> <span class="ow">in</span> <span class="n">mask</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">field</span> <span class="o">=</span> <span class="n">opts</span><span class="o">.</span><span class="n">get_field</span><span class="p">(</span><span class="n">field_name</span><span class="p">)</span>
            <span class="c1"># Retrieve the actual field associated with reverse relationships</span>
            <span class="c1"># as that&#39;s what is expected in the select mask.</span>
            <span class="k">if</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">opts</span><span class="o">.</span><span class="n">related_objects</span><span class="p">:</span>
                <span class="n">field_key</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">field</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">field_key</span> <span class="o">=</span> <span class="n">field</span>
            <span class="n">field_select_mask</span> <span class="o">=</span> <span class="n">select_mask</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">field_key</span><span class="p">,</span> <span class="p">{})</span>
            <span class="k">if</span> <span class="n">field_mask</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">field</span><span class="o">.</span><span class="n">is_relation</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">FieldError</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">field_mask</span><span class="p">)))</span>
                <span class="n">related_model</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">remote_field</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">concrete_model</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_get_only_select_mask</span><span class="p">(</span>
                    <span class="n">related_model</span><span class="o">.</span><span class="n">_meta</span><span class="p">,</span> <span class="n">field_mask</span><span class="p">,</span> <span class="n">field_select_mask</span>
                <span class="p">)</span>
        <span class="k">return</span> <span class="n">select_mask</span>

<div class="viewcode-block" id="Query.get_select_mask">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/query/index.html#django.db.models.sql.query.Query.get_select_mask">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_select_mask</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert the self.deferred_loading data structure to an alternate data</span>
<span class="sd">        structure, describing the field that *will* be loaded. This is used to</span>
<span class="sd">        compute the columns to select from the database and also by the</span>
<span class="sd">        QuerySet class to work out which fields are being initialized on each</span>
<span class="sd">        model. Models that have all their fields included aren&#39;t mentioned in</span>
<span class="sd">        the result, only those that have field restrictions in place.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">field_names</span><span class="p">,</span> <span class="n">defer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">deferred_loading</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">field_names</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{}</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">field_name</span> <span class="ow">in</span> <span class="n">field_names</span><span class="p">:</span>
            <span class="n">part_mask</span> <span class="o">=</span> <span class="n">mask</span>
            <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">field_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">LOOKUP_SEP</span><span class="p">):</span>
                <span class="n">part_mask</span> <span class="o">=</span> <span class="n">part_mask</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">part</span><span class="p">,</span> <span class="p">{})</span>
        <span class="n">opts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_meta</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">defer</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_defer_select_mask</span><span class="p">(</span><span class="n">opts</span><span class="p">,</span> <span class="n">mask</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_only_select_mask</span><span class="p">(</span><span class="n">opts</span><span class="p">,</span> <span class="n">mask</span><span class="p">)</span></div>


<div class="viewcode-block" id="Query.table_alias">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/query/index.html#django.db.models.sql.query.Query.table_alias">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">table_alias</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table_name</span><span class="p">,</span> <span class="n">create</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">filtered_relation</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a table alias for the given table_name and whether this is a</span>
<span class="sd">        new alias or not.</span>

<span class="sd">        If &#39;create&#39; is true, a new alias is always created. Otherwise, the</span>
<span class="sd">        most recently created alias for the table (if one exists) is reused.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">alias_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">table_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">table_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">create</span> <span class="ow">and</span> <span class="n">alias_list</span><span class="p">:</span>
            <span class="n">alias</span> <span class="o">=</span> <span class="n">alias_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">alias_refcount</span><span class="p">[</span><span class="n">alias</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">return</span> <span class="n">alias</span><span class="p">,</span> <span class="kc">False</span>

        <span class="c1"># Create a new alias for this table.</span>
        <span class="k">if</span> <span class="n">alias_list</span><span class="p">:</span>
            <span class="n">alias</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">alias_prefix</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">alias_map</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">alias_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">alias</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># The first occurrence of a table uses the table name directly.</span>
            <span class="n">alias</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">filtered_relation</span><span class="o">.</span><span class="n">alias</span> <span class="k">if</span> <span class="n">filtered_relation</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">table_name</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">table_map</span><span class="p">[</span><span class="n">table_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">alias</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alias_refcount</span><span class="p">[</span><span class="n">alias</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">alias</span><span class="p">,</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="Query.ref_alias">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/query/index.html#django.db.models.sql.query.Query.ref_alias">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">ref_alias</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">alias</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Increases the reference count for this alias.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alias_refcount</span><span class="p">[</span><span class="n">alias</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span></div>


<div class="viewcode-block" id="Query.unref_alias">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/query/index.html#django.db.models.sql.query.Query.unref_alias">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">unref_alias</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">alias</span><span class="p">,</span> <span class="n">amount</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Decreases the reference count for this alias.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alias_refcount</span><span class="p">[</span><span class="n">alias</span><span class="p">]</span> <span class="o">-=</span> <span class="n">amount</span></div>


<div class="viewcode-block" id="Query.promote_joins">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/query/index.html#django.db.models.sql.query.Query.promote_joins">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">promote_joins</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">aliases</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Promote recursively the join type of given aliases and its children to</span>
<span class="sd">        an outer join. If &#39;unconditional&#39; is False, only promote the join if</span>
<span class="sd">        it is nullable or the parent join is an outer join.</span>

<span class="sd">        The children promotion is done to avoid join chains that contain a LOUTER</span>
<span class="sd">        b INNER c. So, if we have currently a INNER b INNER c and a-&gt;b is promoted,</span>
<span class="sd">        then we must also promote b-&gt;c automatically, or otherwise the promotion</span>
<span class="sd">        of a-&gt;b doesn&#39;t actually change anything in the query results.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">aliases</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">aliases</span><span class="p">)</span>
        <span class="k">while</span> <span class="n">aliases</span><span class="p">:</span>
            <span class="n">alias</span> <span class="o">=</span> <span class="n">aliases</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">alias_map</span><span class="p">[</span><span class="n">alias</span><span class="p">]</span><span class="o">.</span><span class="n">join_type</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># This is the base table (first FROM entry) - this table</span>
                <span class="c1"># isn&#39;t really joined at all in the query, so we should not</span>
                <span class="c1"># alter its join type.</span>
                <span class="k">continue</span>
            <span class="c1"># Only the first alias (skipped above) should have None join_type</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">alias_map</span><span class="p">[</span><span class="n">alias</span><span class="p">]</span><span class="o">.</span><span class="n">join_type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="n">parent_alias</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">alias_map</span><span class="p">[</span><span class="n">alias</span><span class="p">]</span><span class="o">.</span><span class="n">parent_alias</span>
            <span class="n">parent_louter</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">parent_alias</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">alias_map</span><span class="p">[</span><span class="n">parent_alias</span><span class="p">]</span><span class="o">.</span><span class="n">join_type</span> <span class="o">==</span> <span class="n">LOUTER</span>
            <span class="p">)</span>
            <span class="n">already_louter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">alias_map</span><span class="p">[</span><span class="n">alias</span><span class="p">]</span><span class="o">.</span><span class="n">join_type</span> <span class="o">==</span> <span class="n">LOUTER</span>
            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">alias_map</span><span class="p">[</span><span class="n">alias</span><span class="p">]</span><span class="o">.</span><span class="n">nullable</span> <span class="ow">or</span> <span class="n">parent_louter</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">already_louter</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">alias_map</span><span class="p">[</span><span class="n">alias</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">alias_map</span><span class="p">[</span><span class="n">alias</span><span class="p">]</span><span class="o">.</span><span class="n">promote</span><span class="p">()</span>
                <span class="c1"># Join type of &#39;alias&#39; changed, so re-examine all aliases that</span>
                <span class="c1"># refer to this one.</span>
                <span class="n">aliases</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
                    <span class="n">join</span>
                    <span class="k">for</span> <span class="n">join</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">alias_map</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">alias_map</span><span class="p">[</span><span class="n">join</span><span class="p">]</span><span class="o">.</span><span class="n">parent_alias</span> <span class="o">==</span> <span class="n">alias</span>
                    <span class="ow">and</span> <span class="n">join</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">aliases</span>
                <span class="p">)</span></div>


<div class="viewcode-block" id="Query.demote_joins">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/query/index.html#django.db.models.sql.query.Query.demote_joins">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">demote_joins</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">aliases</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Change join type from LOUTER to INNER for all joins in aliases.</span>

<span class="sd">        Similarly to promote_joins(), this method must ensure no join chains</span>
<span class="sd">        containing first an outer, then an inner join are generated. If we</span>
<span class="sd">        are demoting b-&gt;c join in chain a LOUTER b LOUTER c then we must</span>
<span class="sd">        demote a-&gt;b automatically, or otherwise the demotion of b-&gt;c doesn&#39;t</span>
<span class="sd">        actually change anything in the query results. .</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">aliases</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">aliases</span><span class="p">)</span>
        <span class="k">while</span> <span class="n">aliases</span><span class="p">:</span>
            <span class="n">alias</span> <span class="o">=</span> <span class="n">aliases</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">alias_map</span><span class="p">[</span><span class="n">alias</span><span class="p">]</span><span class="o">.</span><span class="n">join_type</span> <span class="o">==</span> <span class="n">LOUTER</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">alias_map</span><span class="p">[</span><span class="n">alias</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">alias_map</span><span class="p">[</span><span class="n">alias</span><span class="p">]</span><span class="o">.</span><span class="n">demote</span><span class="p">()</span>
                <span class="n">parent_alias</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">alias_map</span><span class="p">[</span><span class="n">alias</span><span class="p">]</span><span class="o">.</span><span class="n">parent_alias</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">alias_map</span><span class="p">[</span><span class="n">parent_alias</span><span class="p">]</span><span class="o">.</span><span class="n">join_type</span> <span class="o">==</span> <span class="n">INNER</span><span class="p">:</span>
                    <span class="n">aliases</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">parent_alias</span><span class="p">)</span></div>


<div class="viewcode-block" id="Query.reset_refcounts">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/query/index.html#django.db.models.sql.query.Query.reset_refcounts">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">reset_refcounts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">to_counts</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Reset reference counts for aliases so that they match the value passed</span>
<span class="sd">        in `to_counts`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">alias</span><span class="p">,</span> <span class="n">cur_refcount</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">alias_refcount</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">unref_amount</span> <span class="o">=</span> <span class="n">cur_refcount</span> <span class="o">-</span> <span class="n">to_counts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">unref_alias</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="n">unref_amount</span><span class="p">)</span></div>


<div class="viewcode-block" id="Query.change_aliases">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/query/index.html#django.db.models.sql.query.Query.change_aliases">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">change_aliases</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">change_map</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Change the aliases in change_map (which maps old-alias -&gt; new-alias),</span>
<span class="sd">        relabelling any references to them in select columns and the where</span>
<span class="sd">        clause.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># If keys and values of change_map were to intersect, an alias might be</span>
        <span class="c1"># updated twice (e.g. T4 -&gt; T5, T5 -&gt; T6, so also T4 -&gt; T6) depending</span>
        <span class="c1"># on their order in change_map.</span>
        <span class="k">assert</span> <span class="nb">set</span><span class="p">(</span><span class="n">change_map</span><span class="p">)</span><span class="o">.</span><span class="n">isdisjoint</span><span class="p">(</span><span class="n">change_map</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

        <span class="c1"># 1. Update references in &quot;select&quot; (normal columns plus aliases),</span>
        <span class="c1"># &quot;group by&quot; and &quot;where&quot;.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">where</span><span class="o">.</span><span class="n">relabel_aliases</span><span class="p">(</span><span class="n">change_map</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">group_by</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">group_by</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span>
                <span class="p">[</span><span class="n">col</span><span class="o">.</span><span class="n">relabeled_clone</span><span class="p">(</span><span class="n">change_map</span><span class="p">)</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">group_by</span><span class="p">]</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">select</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">([</span><span class="n">col</span><span class="o">.</span><span class="n">relabeled_clone</span><span class="p">(</span><span class="n">change_map</span><span class="p">)</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">select</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">annotations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">annotations</span> <span class="ow">and</span> <span class="p">{</span>
            <span class="n">key</span><span class="p">:</span> <span class="n">col</span><span class="o">.</span><span class="n">relabeled_clone</span><span class="p">(</span><span class="n">change_map</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">annotations</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="p">}</span>

        <span class="c1"># 2. Rename the alias in the internal table/alias datastructures.</span>
        <span class="k">for</span> <span class="n">old_alias</span><span class="p">,</span> <span class="n">new_alias</span> <span class="ow">in</span> <span class="n">change_map</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">old_alias</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">alias_map</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">alias_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">alias_map</span><span class="p">[</span><span class="n">old_alias</span><span class="p">]</span><span class="o">.</span><span class="n">relabeled_clone</span><span class="p">(</span><span class="n">change_map</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">alias_map</span><span class="p">[</span><span class="n">new_alias</span><span class="p">]</span> <span class="o">=</span> <span class="n">alias_data</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">alias_refcount</span><span class="p">[</span><span class="n">new_alias</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">alias_refcount</span><span class="p">[</span><span class="n">old_alias</span><span class="p">]</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">alias_refcount</span><span class="p">[</span><span class="n">old_alias</span><span class="p">]</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">alias_map</span><span class="p">[</span><span class="n">old_alias</span><span class="p">]</span>

            <span class="n">table_aliases</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">table_map</span><span class="p">[</span><span class="n">alias_data</span><span class="o">.</span><span class="n">table_name</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">pos</span><span class="p">,</span> <span class="n">alias</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">table_aliases</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">alias</span> <span class="o">==</span> <span class="n">old_alias</span><span class="p">:</span>
                    <span class="n">table_aliases</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_alias</span>
                    <span class="k">break</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">external_aliases</span> <span class="o">=</span> <span class="p">{</span>
            <span class="c1"># Table is aliased or it&#39;s being changed and thus is aliased.</span>
            <span class="n">change_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="n">alias</span><span class="p">):</span> <span class="p">(</span><span class="n">aliased</span> <span class="ow">or</span> <span class="n">alias</span> <span class="ow">in</span> <span class="n">change_map</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">alias</span><span class="p">,</span> <span class="n">aliased</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">external_aliases</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="p">}</span></div>


<div class="viewcode-block" id="Query.bump_prefix">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/query/index.html#django.db.models.sql.query.Query.bump_prefix">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">bump_prefix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other_query</span><span class="p">,</span> <span class="n">exclude</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Change the alias prefix to the next letter in the alphabet in a way</span>
<span class="sd">        that the other query&#39;s aliases and this query&#39;s aliases will not</span>
<span class="sd">        conflict. Even tables that previously had no alias will get an alias</span>
<span class="sd">        after this call. To prevent changing aliases use the exclude parameter.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">prefix_gen</span><span class="p">():</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Generate a sequence of characters in alphabetical order:</span>
<span class="sd">                -&gt; &#39;A&#39;, &#39;B&#39;, &#39;C&#39;, ...</span>

<span class="sd">            When the alphabet is finished, the sequence will continue with the</span>
<span class="sd">            Cartesian product:</span>
<span class="sd">                -&gt; &#39;AA&#39;, &#39;AB&#39;, &#39;AC&#39;, ...</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">alphabet</span> <span class="o">=</span> <span class="n">ascii_uppercase</span>
            <span class="n">prefix</span> <span class="o">=</span> <span class="nb">chr</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">alias_prefix</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">yield</span> <span class="n">prefix</span>
            <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">count</span><span class="p">(</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">seq</span> <span class="o">=</span> <span class="n">alphabet</span><span class="p">[</span><span class="n">alphabet</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span> <span class="p">:]</span> <span class="k">if</span> <span class="n">prefix</span> <span class="k">else</span> <span class="n">alphabet</span>
                <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">product</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="n">repeat</span><span class="o">=</span><span class="n">n</span><span class="p">):</span>
                    <span class="k">yield</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
                <span class="n">prefix</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">alias_prefix</span> <span class="o">!=</span> <span class="n">other_query</span><span class="o">.</span><span class="n">alias_prefix</span><span class="p">:</span>
            <span class="c1"># No clashes between self and outer query should be possible.</span>
            <span class="k">return</span>

        <span class="c1"># Explicitly avoid infinite loop. The constant divider is based on how</span>
        <span class="c1"># much depth recursive subquery references add to the stack. This value</span>
        <span class="c1"># might need to be adjusted when adding or removing function calls from</span>
        <span class="c1"># the code path in charge of performing these operations.</span>
        <span class="n">local_recursion_limit</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">getrecursionlimit</span><span class="p">()</span> <span class="o">//</span> <span class="mi">16</span>
        <span class="k">for</span> <span class="n">pos</span><span class="p">,</span> <span class="n">prefix</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">prefix_gen</span><span class="p">()):</span>
            <span class="k">if</span> <span class="n">prefix</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">subq_aliases</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">alias_prefix</span> <span class="o">=</span> <span class="n">prefix</span>
                <span class="k">break</span>
            <span class="k">if</span> <span class="n">pos</span> <span class="o">&gt;</span> <span class="n">local_recursion_limit</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RecursionError</span><span class="p">(</span>
                    <span class="s2">&quot;Maximum recursion depth exceeded: too many subqueries.&quot;</span>
                <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subq_aliases</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subq_aliases</span><span class="o">.</span><span class="n">union</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">alias_prefix</span><span class="p">])</span>
        <span class="n">other_query</span><span class="o">.</span><span class="n">subq_aliases</span> <span class="o">=</span> <span class="n">other_query</span><span class="o">.</span><span class="n">subq_aliases</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">subq_aliases</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">exclude</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">exclude</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">change_aliases</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="n">alias</span><span class="p">:</span> <span class="s2">&quot;</span><span class="si">%s%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">alias_prefix</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">pos</span><span class="p">,</span> <span class="n">alias</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">alias_map</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">alias</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">exclude</span>
            <span class="p">}</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="Query.get_initial_alias">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/query/index.html#django.db.models.sql.query.Query.get_initial_alias">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_initial_alias</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the first alias for this query, after increasing its reference</span>
<span class="sd">        count.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">alias_map</span><span class="p">:</span>
            <span class="n">alias</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_table</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ref_alias</span><span class="p">(</span><span class="n">alias</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">:</span>
            <span class="n">alias</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_table_class</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_meta</span><span class="p">()</span><span class="o">.</span><span class="n">db_table</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">alias</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">alias</span></div>


<div class="viewcode-block" id="Query.count_active_tables">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/query/index.html#django.db.models.sql.query.Query.count_active_tables">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">count_active_tables</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the number of tables in this query with a non-zero reference</span>
<span class="sd">        count. After execution, the reference counts are zeroed, so tables</span>
<span class="sd">        added in compiler will not be seen by this method.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">([</span><span class="mi">1</span> <span class="k">for</span> <span class="n">count</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">alias_refcount</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="k">if</span> <span class="n">count</span><span class="p">])</span></div>


<div class="viewcode-block" id="Query.join">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/query/index.html#django.db.models.sql.query.Query.join">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">join</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">join</span><span class="p">,</span> <span class="n">reuse</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">reuse_with_filtered_relation</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return an alias for the &#39;join&#39;, either reusing an existing alias for</span>
<span class="sd">        that join or creating a new one. &#39;join&#39; is either a base_table_class or</span>
<span class="sd">        join_class.</span>

<span class="sd">        The &#39;reuse&#39; parameter can be either None which means all joins are</span>
<span class="sd">        reusable, or it can be a set containing the aliases that can be reused.</span>

<span class="sd">        The &#39;reuse_with_filtered_relation&#39; parameter is used when computing</span>
<span class="sd">        FilteredRelation instances.</span>

<span class="sd">        A join is always created as LOUTER if the lhs alias is LOUTER to make</span>
<span class="sd">        sure chains like t1 LOUTER t2 INNER t3 aren&#39;t generated. All new</span>
<span class="sd">        joins are created as LOUTER if the join is nullable.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">reuse_with_filtered_relation</span> <span class="ow">and</span> <span class="n">reuse</span><span class="p">:</span>
            <span class="n">reuse_aliases</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">a</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">alias_map</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">reuse</span> <span class="ow">and</span> <span class="n">j</span><span class="o">.</span><span class="n">equals</span><span class="p">(</span><span class="n">join</span><span class="p">)</span>
            <span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">reuse_aliases</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">a</span>
                <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">alias_map</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">reuse</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">reuse</span><span class="p">)</span> <span class="ow">and</span> <span class="n">j</span> <span class="o">==</span> <span class="n">join</span>
            <span class="p">]</span>
        <span class="k">if</span> <span class="n">reuse_aliases</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">join</span><span class="o">.</span><span class="n">table_alias</span> <span class="ow">in</span> <span class="n">reuse_aliases</span><span class="p">:</span>
                <span class="n">reuse_alias</span> <span class="o">=</span> <span class="n">join</span><span class="o">.</span><span class="n">table_alias</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Reuse the most recent alias of the joined table</span>
                <span class="c1"># (a many-to-many relation may be joined multiple times).</span>
                <span class="n">reuse_alias</span> <span class="o">=</span> <span class="n">reuse_aliases</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ref_alias</span><span class="p">(</span><span class="n">reuse_alias</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">reuse_alias</span>

        <span class="c1"># No reuse is possible, so we need a new alias.</span>
        <span class="n">alias</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">table_alias</span><span class="p">(</span>
            <span class="n">join</span><span class="o">.</span><span class="n">table_name</span><span class="p">,</span> <span class="n">create</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">filtered_relation</span><span class="o">=</span><span class="n">join</span><span class="o">.</span><span class="n">filtered_relation</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">join</span><span class="o">.</span><span class="n">join_type</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">alias_map</span><span class="p">[</span><span class="n">join</span><span class="o">.</span><span class="n">parent_alias</span><span class="p">]</span><span class="o">.</span><span class="n">join_type</span> <span class="o">==</span> <span class="n">LOUTER</span> <span class="ow">or</span> <span class="n">join</span><span class="o">.</span><span class="n">nullable</span><span class="p">:</span>
                <span class="n">join_type</span> <span class="o">=</span> <span class="n">LOUTER</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">join_type</span> <span class="o">=</span> <span class="n">INNER</span>
            <span class="n">join</span><span class="o">.</span><span class="n">join_type</span> <span class="o">=</span> <span class="n">join_type</span>
        <span class="n">join</span><span class="o">.</span><span class="n">table_alias</span> <span class="o">=</span> <span class="n">alias</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alias_map</span><span class="p">[</span><span class="n">alias</span><span class="p">]</span> <span class="o">=</span> <span class="n">join</span>
        <span class="k">return</span> <span class="n">alias</span></div>


<div class="viewcode-block" id="Query.join_parent_model">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/query/index.html#django.db.models.sql.query.Query.join_parent_model">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">join_parent_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">opts</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">alias</span><span class="p">,</span> <span class="n">seen</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Make sure the given &#39;model&#39; is joined in the query. If &#39;model&#39; isn&#39;t</span>
<span class="sd">        a parent of &#39;opts&#39; or if it is None this method is a no-op.</span>

<span class="sd">        The &#39;alias&#39; is the root alias for starting the join, &#39;seen&#39; is a dict</span>
<span class="sd">        of model -&gt; alias of existing joins. It must also contain a mapping</span>
<span class="sd">        of None -&gt; some alias. This will be returned in the no-op case.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">seen</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">seen</span><span class="p">[</span><span class="n">model</span><span class="p">]</span>
        <span class="n">chain</span> <span class="o">=</span> <span class="n">opts</span><span class="o">.</span><span class="n">get_base_chain</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">chain</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">alias</span>
        <span class="n">curr_opts</span> <span class="o">=</span> <span class="n">opts</span>
        <span class="k">for</span> <span class="n">int_model</span> <span class="ow">in</span> <span class="n">chain</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">int_model</span> <span class="ow">in</span> <span class="n">seen</span><span class="p">:</span>
                <span class="n">curr_opts</span> <span class="o">=</span> <span class="n">int_model</span><span class="o">.</span><span class="n">_meta</span>
                <span class="n">alias</span> <span class="o">=</span> <span class="n">seen</span><span class="p">[</span><span class="n">int_model</span><span class="p">]</span>
                <span class="k">continue</span>
            <span class="c1"># Proxy model have elements in base chain</span>
            <span class="c1"># with no parents, assign the new options</span>
            <span class="c1"># object and skip to the next base in that</span>
            <span class="c1"># case</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">curr_opts</span><span class="o">.</span><span class="n">parents</span><span class="p">[</span><span class="n">int_model</span><span class="p">]:</span>
                <span class="n">curr_opts</span> <span class="o">=</span> <span class="n">int_model</span><span class="o">.</span><span class="n">_meta</span>
                <span class="k">continue</span>
            <span class="n">link_field</span> <span class="o">=</span> <span class="n">curr_opts</span><span class="o">.</span><span class="n">get_ancestor_link</span><span class="p">(</span><span class="n">int_model</span><span class="p">)</span>
            <span class="n">join_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup_joins</span><span class="p">([</span><span class="n">link_field</span><span class="o">.</span><span class="n">name</span><span class="p">],</span> <span class="n">curr_opts</span><span class="p">,</span> <span class="n">alias</span><span class="p">)</span>
            <span class="n">curr_opts</span> <span class="o">=</span> <span class="n">int_model</span><span class="o">.</span><span class="n">_meta</span>
            <span class="n">alias</span> <span class="o">=</span> <span class="n">seen</span><span class="p">[</span><span class="n">int_model</span><span class="p">]</span> <span class="o">=</span> <span class="n">join_info</span><span class="o">.</span><span class="n">joins</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">alias</span> <span class="ow">or</span> <span class="n">seen</span><span class="p">[</span><span class="kc">None</span><span class="p">]</span></div>


<div class="viewcode-block" id="Query.check_alias">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/query/index.html#django.db.models.sql.query.Query.check_alias">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">check_alias</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">alias</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">FORBIDDEN_ALIAS_PATTERN</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">alias</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Column aliases cannot contain whitespace characters, quotation marks, &quot;</span>
                <span class="s2">&quot;semicolons, or SQL comments.&quot;</span>
            <span class="p">)</span></div>


<div class="viewcode-block" id="Query.add_annotation">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/query/index.html#django.db.models.sql.query.Query.add_annotation">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">add_annotation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">annotation</span><span class="p">,</span> <span class="n">alias</span><span class="p">,</span> <span class="n">select</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add a single annotation expression to the Query.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_alias</span><span class="p">(</span><span class="n">alias</span><span class="p">)</span>
        <span class="n">annotation</span> <span class="o">=</span> <span class="n">annotation</span><span class="o">.</span><span class="n">resolve_expression</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">allow_joins</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">reuse</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">select</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">append_annotation_mask</span><span class="p">([</span><span class="n">alias</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_annotation_mask</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">annotation_select</span><span class="p">)</span><span class="o">.</span><span class="n">difference</span><span class="p">({</span><span class="n">alias</span><span class="p">}))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">annotations</span><span class="p">[</span><span class="n">alias</span><span class="p">]</span> <span class="o">=</span> <span class="n">annotation</span></div>


<div class="viewcode-block" id="Query.resolve_expression">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/query/index.html#django.db.models.sql.query.Query.resolve_expression">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">resolve_expression</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">clone</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
        <span class="c1"># Subqueries need to use a different set of aliases than the outer query.</span>
        <span class="n">clone</span><span class="o">.</span><span class="n">bump_prefix</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="n">clone</span><span class="o">.</span><span class="n">subquery</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">clone</span><span class="o">.</span><span class="n">where</span><span class="o">.</span><span class="n">resolve_expression</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="c1"># Resolve combined queries.</span>
        <span class="k">if</span> <span class="n">clone</span><span class="o">.</span><span class="n">combinator</span><span class="p">:</span>
            <span class="n">clone</span><span class="o">.</span><span class="n">combined_queries</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="n">combined_query</span><span class="o">.</span><span class="n">resolve_expression</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">combined_query</span> <span class="ow">in</span> <span class="n">clone</span><span class="o">.</span><span class="n">combined_queries</span>
                <span class="p">]</span>
            <span class="p">)</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">clone</span><span class="o">.</span><span class="n">annotations</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">resolved</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">resolve_expression</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">resolved</span><span class="p">,</span> <span class="s2">&quot;external_aliases&quot;</span><span class="p">):</span>
                <span class="n">resolved</span><span class="o">.</span><span class="n">external_aliases</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">clone</span><span class="o">.</span><span class="n">external_aliases</span><span class="p">)</span>
            <span class="n">clone</span><span class="o">.</span><span class="n">annotations</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">resolved</span>
        <span class="c1"># Outer query&#39;s aliases are considered external.</span>
        <span class="k">for</span> <span class="n">alias</span><span class="p">,</span> <span class="n">table</span> <span class="ow">in</span> <span class="n">query</span><span class="o">.</span><span class="n">alias_map</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">clone</span><span class="o">.</span><span class="n">external_aliases</span><span class="p">[</span><span class="n">alias</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="nb">isinstance</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">Join</span><span class="p">)</span>
                <span class="ow">and</span> <span class="n">table</span><span class="o">.</span><span class="n">join_field</span><span class="o">.</span><span class="n">related_model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">db_table</span> <span class="o">!=</span> <span class="n">alias</span>
            <span class="p">)</span> <span class="ow">or</span> <span class="p">(</span>
                <span class="nb">isinstance</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">BaseTable</span><span class="p">)</span> <span class="ow">and</span> <span class="n">table</span><span class="o">.</span><span class="n">table_name</span> <span class="o">!=</span> <span class="n">table</span><span class="o">.</span><span class="n">table_alias</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">clone</span></div>


<div class="viewcode-block" id="Query.get_external_cols">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/query/index.html#django.db.models.sql.query.Query.get_external_cols">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_external_cols</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">exprs</span> <span class="o">=</span> <span class="n">chain</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">annotations</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">where</span><span class="o">.</span><span class="n">children</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="n">col</span>
            <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gen_cols</span><span class="p">(</span><span class="n">exprs</span><span class="p">,</span> <span class="n">include_external</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">alias</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">external_aliases</span>
        <span class="p">]</span></div>


<div class="viewcode-block" id="Query.get_group_by_cols">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/query/index.html#django.db.models.sql.query.Query.get_group_by_cols">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_group_by_cols</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wrapper</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># If wrapper is referenced by an alias for an explicit GROUP BY through</span>
        <span class="c1"># values() a reference to this expression and not the self must be</span>
        <span class="c1"># returned to ensure external column references are not grouped against</span>
        <span class="c1"># as well.</span>
        <span class="n">external_cols</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_external_cols</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">col</span><span class="o">.</span><span class="n">possibly_multivalued</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">external_cols</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">wrapper</span> <span class="ow">or</span> <span class="bp">self</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">external_cols</span></div>


<div class="viewcode-block" id="Query.as_sql">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/query/index.html#django.db.models.sql.query.Query.as_sql">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">as_sql</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">compiler</span><span class="p">,</span> <span class="n">connection</span><span class="p">):</span>
        <span class="c1"># Some backends (e.g. Oracle) raise an error when a subquery contains</span>
        <span class="c1"># unnecessary ORDER BY clause.</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">subquery</span>
            <span class="ow">and</span> <span class="ow">not</span> <span class="n">connection</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">ignores_unnecessary_order_by_in_subqueries</span>
        <span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">clear_ordering</span><span class="p">(</span><span class="n">force</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">query</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">combined_queries</span><span class="p">:</span>
                <span class="n">query</span><span class="o">.</span><span class="n">clear_ordering</span><span class="p">(</span><span class="n">force</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">sql</span><span class="p">,</span> <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_compiler</span><span class="p">(</span><span class="n">connection</span><span class="o">=</span><span class="n">connection</span><span class="p">)</span><span class="o">.</span><span class="n">as_sql</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">subquery</span><span class="p">:</span>
            <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;(</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="n">sql</span>
        <span class="k">return</span> <span class="n">sql</span><span class="p">,</span> <span class="n">params</span></div>


<div class="viewcode-block" id="Query.resolve_lookup_value">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/query/index.html#django.db.models.sql.query.Query.resolve_lookup_value">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">resolve_lookup_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">can_reuse</span><span class="p">,</span> <span class="n">allow_joins</span><span class="p">,</span> <span class="n">summarize</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="s2">&quot;resolve_expression&quot;</span><span class="p">):</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">resolve_expression</span><span class="p">(</span>
                <span class="bp">self</span><span class="p">,</span>
                <span class="n">reuse</span><span class="o">=</span><span class="n">can_reuse</span><span class="p">,</span>
                <span class="n">allow_joins</span><span class="o">=</span><span class="n">allow_joins</span><span class="p">,</span>
                <span class="n">summarize</span><span class="o">=</span><span class="n">summarize</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
            <span class="c1"># The items of the iterable may be expressions and therefore need</span>
            <span class="c1"># to be resolved independently.</span>
            <span class="n">values</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">resolve_lookup_value</span><span class="p">(</span><span class="n">sub_value</span><span class="p">,</span> <span class="n">can_reuse</span><span class="p">,</span> <span class="n">allow_joins</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">sub_value</span> <span class="ow">in</span> <span class="n">value</span>
            <span class="p">)</span>
            <span class="n">type_</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">type_</span><span class="p">,</span> <span class="s2">&quot;_make&quot;</span><span class="p">):</span>  <span class="c1"># namedtuple</span>
                <span class="k">return</span> <span class="n">type_</span><span class="p">(</span><span class="o">*</span><span class="n">values</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">type_</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">value</span></div>


<div class="viewcode-block" id="Query.solve_lookup_type">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/query/index.html#django.db.models.sql.query.Query.solve_lookup_type">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">solve_lookup_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lookup</span><span class="p">,</span> <span class="n">summarize</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Solve the lookup type from the lookup (e.g.: &#39;foobar__id__icontains&#39;).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">lookup_splitted</span> <span class="o">=</span> <span class="n">lookup</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">LOOKUP_SEP</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">annotations</span><span class="p">:</span>
            <span class="n">annotation</span><span class="p">,</span> <span class="n">expression_lookups</span> <span class="o">=</span> <span class="n">refs_expression</span><span class="p">(</span>
                <span class="n">lookup_splitted</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">annotations</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">annotation</span><span class="p">:</span>
                <span class="n">expression</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">annotations</span><span class="p">[</span><span class="n">annotation</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">summarize</span><span class="p">:</span>
                    <span class="n">expression</span> <span class="o">=</span> <span class="n">Ref</span><span class="p">(</span><span class="n">annotation</span><span class="p">,</span> <span class="n">expression</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">expression_lookups</span><span class="p">,</span> <span class="p">(),</span> <span class="n">expression</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">lookup_parts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">names_to_path</span><span class="p">(</span><span class="n">lookup_splitted</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_meta</span><span class="p">())</span>
        <span class="n">field_parts</span> <span class="o">=</span> <span class="n">lookup_splitted</span><span class="p">[</span><span class="mi">0</span> <span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">lookup_splitted</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">lookup_parts</span><span class="p">)]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lookup_parts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">field_parts</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">FieldError</span><span class="p">(</span>
                <span class="s1">&#39;Invalid lookup &quot;</span><span class="si">%s</span><span class="s1">&quot; for model </span><span class="si">%s</span><span class="s1">&quot;.&#39;</span>
                <span class="o">%</span> <span class="p">(</span><span class="n">lookup</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_meta</span><span class="p">()</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">lookup_parts</span><span class="p">,</span> <span class="n">field_parts</span><span class="p">,</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="Query.check_query_object_type">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/query/index.html#django.db.models.sql.query.Query.check_query_object_type">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">check_query_object_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">opts</span><span class="p">,</span> <span class="n">field</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check whether the object passed while querying is of the correct type.</span>
<span class="sd">        If not, raise a ValueError specifying the wrong object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="s2">&quot;_meta&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">check_rel_lookup_compatibility</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">opts</span><span class="p">,</span> <span class="n">field</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s1">&#39;Cannot query &quot;</span><span class="si">%s</span><span class="s1">&quot;: Must be &quot;</span><span class="si">%s</span><span class="s1">&quot; instance.&#39;</span>
                    <span class="o">%</span> <span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">opts</span><span class="o">.</span><span class="n">object_name</span><span class="p">)</span>
                <span class="p">)</span></div>


<div class="viewcode-block" id="Query.check_related_objects">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/query/index.html#django.db.models.sql.query.Query.check_related_objects">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">check_related_objects</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">opts</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check the type of object passed to query relations.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">is_relation</span><span class="p">:</span>
            <span class="c1"># Check that the field and the queryset use the same model in a</span>
            <span class="c1"># query like .filter(author=Author.objects.all()). For example, the</span>
            <span class="c1"># opts would be Author&#39;s (from the author field) and value.model</span>
            <span class="c1"># would be Author.objects.all() queryset&#39;s .model (Author also).</span>
            <span class="c1"># The field is the related field on the lhs side.</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">Query</span><span class="p">)</span>
                <span class="ow">and</span> <span class="ow">not</span> <span class="n">value</span><span class="o">.</span><span class="n">has_select_fields</span>
                <span class="ow">and</span> <span class="ow">not</span> <span class="n">check_rel_lookup_compatibility</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">opts</span><span class="p">,</span> <span class="n">field</span><span class="p">)</span>
            <span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s1">&#39;Cannot use QuerySet for &quot;</span><span class="si">%s</span><span class="s1">&quot;: Use a QuerySet for &quot;</span><span class="si">%s</span><span class="s1">&quot;.&#39;</span>
                    <span class="o">%</span> <span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">object_name</span><span class="p">,</span> <span class="n">opts</span><span class="o">.</span><span class="n">object_name</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="s2">&quot;_meta&quot;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">check_query_object_type</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">opts</span><span class="p">,</span> <span class="n">field</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="s2">&quot;__iter__&quot;</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">check_query_object_type</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">opts</span><span class="p">,</span> <span class="n">field</span><span class="p">)</span></div>


<div class="viewcode-block" id="Query.check_filterable">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/query/index.html#django.db.models.sql.query.Query.check_filterable">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">check_filterable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expression</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Raise an error if expression cannot be used in a WHERE clause.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">expression</span><span class="p">,</span> <span class="s2">&quot;resolve_expression&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">getattr</span><span class="p">(</span>
            <span class="n">expression</span><span class="p">,</span> <span class="s2">&quot;filterable&quot;</span><span class="p">,</span> <span class="kc">True</span>
        <span class="p">):</span>
            <span class="k">raise</span> <span class="n">NotSupportedError</span><span class="p">(</span>
                <span class="n">expression</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">+</span> <span class="s2">&quot; is disallowed in the filter &quot;</span>
                <span class="s2">&quot;clause.&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">expression</span><span class="p">,</span> <span class="s2">&quot;get_source_expressions&quot;</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">expr</span> <span class="ow">in</span> <span class="n">expression</span><span class="o">.</span><span class="n">get_source_expressions</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">check_filterable</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span></div>


<div class="viewcode-block" id="Query.build_lookup">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/query/index.html#django.db.models.sql.query.Query.build_lookup">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">build_lookup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lookups</span><span class="p">,</span> <span class="n">lhs</span><span class="p">,</span> <span class="n">rhs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Try to extract transforms and lookup from given lhs.</span>

<span class="sd">        The lhs value is something that works like SQLExpression.</span>
<span class="sd">        The rhs value is what the lookup is going to compare against.</span>
<span class="sd">        The lookups is a list of names to extract using get_lookup()</span>
<span class="sd">        and get_transform().</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># __exact is the default lookup if one isn&#39;t given.</span>
        <span class="o">*</span><span class="n">transforms</span><span class="p">,</span> <span class="n">lookup_name</span> <span class="o">=</span> <span class="n">lookups</span> <span class="ow">or</span> <span class="p">[</span><span class="s2">&quot;exact&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">transforms</span><span class="p">:</span>
            <span class="n">lhs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">try_transform</span><span class="p">(</span><span class="n">lhs</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="c1"># First try get_lookup() so that the lookup takes precedence if the lhs</span>
        <span class="c1"># supports both transform and lookup for the name.</span>
        <span class="n">lookup_class</span> <span class="o">=</span> <span class="n">lhs</span><span class="o">.</span><span class="n">get_lookup</span><span class="p">(</span><span class="n">lookup_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">lookup_class</span><span class="p">:</span>
            <span class="c1"># A lookup wasn&#39;t found. Try to interpret the name as a transform</span>
            <span class="c1"># and do an Exact lookup against it.</span>
            <span class="n">lhs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">try_transform</span><span class="p">(</span><span class="n">lhs</span><span class="p">,</span> <span class="n">lookup_name</span><span class="p">)</span>
            <span class="n">lookup_name</span> <span class="o">=</span> <span class="s2">&quot;exact&quot;</span>
            <span class="n">lookup_class</span> <span class="o">=</span> <span class="n">lhs</span><span class="o">.</span><span class="n">get_lookup</span><span class="p">(</span><span class="n">lookup_name</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">lookup_class</span><span class="p">:</span>
                <span class="k">return</span>

        <span class="n">lookup</span> <span class="o">=</span> <span class="n">lookup_class</span><span class="p">(</span><span class="n">lhs</span><span class="p">,</span> <span class="n">rhs</span><span class="p">)</span>
        <span class="c1"># Interpret &#39;__exact=None&#39; as the sql &#39;is NULL&#39;; otherwise, reject all</span>
        <span class="c1"># uses of None as a query value unless the lookup supports it.</span>
        <span class="k">if</span> <span class="n">lookup</span><span class="o">.</span><span class="n">rhs</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">lookup</span><span class="o">.</span><span class="n">can_use_none_as_rhs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">lookup_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;exact&quot;</span><span class="p">,</span> <span class="s2">&quot;iexact&quot;</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot use None as a query value&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">lhs</span><span class="o">.</span><span class="n">get_lookup</span><span class="p">(</span><span class="s2">&quot;isnull&quot;</span><span class="p">)(</span><span class="n">lhs</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

        <span class="c1"># For Oracle &#39;&#39; is equivalent to null. The check must be done at this</span>
        <span class="c1"># stage because join promotion can&#39;t be done in the compiler. Using</span>
        <span class="c1"># DEFAULT_DB_ALIAS isn&#39;t nice but it&#39;s the best that can be done here.</span>
        <span class="c1"># A similar thing is done in is_nullable(), too.</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">lookup_name</span> <span class="o">==</span> <span class="s2">&quot;exact&quot;</span>
            <span class="ow">and</span> <span class="n">lookup</span><span class="o">.</span><span class="n">rhs</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span>
            <span class="ow">and</span> <span class="n">connections</span><span class="p">[</span><span class="n">DEFAULT_DB_ALIAS</span><span class="p">]</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">interprets_empty_strings_as_nulls</span>
        <span class="p">):</span>
            <span class="k">return</span> <span class="n">lhs</span><span class="o">.</span><span class="n">get_lookup</span><span class="p">(</span><span class="s2">&quot;isnull&quot;</span><span class="p">)(</span><span class="n">lhs</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">lookup</span></div>


<div class="viewcode-block" id="Query.try_transform">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/query/index.html#django.db.models.sql.query.Query.try_transform">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">try_transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lhs</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Helper method for build_lookup(). Try to fetch and initialize</span>
<span class="sd">        a transform for name parameter from lhs.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">transform_class</span> <span class="o">=</span> <span class="n">lhs</span><span class="o">.</span><span class="n">get_transform</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">transform_class</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">transform_class</span><span class="p">(</span><span class="n">lhs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">output_field</span> <span class="o">=</span> <span class="n">lhs</span><span class="o">.</span><span class="n">output_field</span><span class="o">.</span><span class="vm">__class__</span>
            <span class="n">suggested_lookups</span> <span class="o">=</span> <span class="n">difflib</span><span class="o">.</span><span class="n">get_close_matches</span><span class="p">(</span>
                <span class="n">name</span><span class="p">,</span> <span class="n">lhs</span><span class="o">.</span><span class="n">output_field</span><span class="o">.</span><span class="n">get_lookups</span><span class="p">()</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">suggested_lookups</span><span class="p">:</span>
                <span class="n">suggestion</span> <span class="o">=</span> <span class="s2">&quot;, perhaps you meant </span><span class="si">%s</span><span class="s2">?&quot;</span> <span class="o">%</span> <span class="s2">&quot; or &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">suggested_lookups</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">suggestion</span> <span class="o">=</span> <span class="s2">&quot;.&quot;</span>
            <span class="k">raise</span> <span class="n">FieldError</span><span class="p">(</span>
                <span class="s2">&quot;Unsupported lookup &#39;</span><span class="si">%s</span><span class="s2">&#39; for </span><span class="si">%s</span><span class="s2"> or join on the field not &quot;</span>
                <span class="s2">&quot;permitted</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">output_field</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">suggestion</span><span class="p">)</span>
            <span class="p">)</span></div>


<div class="viewcode-block" id="Query.build_filter">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/query/index.html#django.db.models.sql.query.Query.build_filter">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">build_filter</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">filter_expr</span><span class="p">,</span>
        <span class="n">branch_negated</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">current_negated</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">can_reuse</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">allow_joins</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">split_subq</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">reuse_with_filtered_relation</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">check_filterable</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">summarize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Build a WhereNode for a single filter clause but don&#39;t add it</span>
<span class="sd">        to this Query. Query.add_q() will then add this filter to the where</span>
<span class="sd">        Node.</span>

<span class="sd">        The &#39;branch_negated&#39; tells us if the current branch contains any</span>
<span class="sd">        negations. This will be used to determine if subqueries are needed.</span>

<span class="sd">        The &#39;current_negated&#39; is used to determine if the current filter is</span>
<span class="sd">        negated or not and this will be used to determine if IS NULL filtering</span>
<span class="sd">        is needed.</span>

<span class="sd">        The difference between current_negated and branch_negated is that</span>
<span class="sd">        branch_negated is set on first negation, but current_negated is</span>
<span class="sd">        flipped for each negation.</span>

<span class="sd">        Note that add_filter will not do any negating itself, that is done</span>
<span class="sd">        upper in the code by add_q().</span>

<span class="sd">        The &#39;can_reuse&#39; is a set of reusable joins for multijoins.</span>

<span class="sd">        If &#39;reuse_with_filtered_relation&#39; is True, then only joins in can_reuse</span>
<span class="sd">        will be reused.</span>

<span class="sd">        The method will create a filter clause that can be added to the current</span>
<span class="sd">        query. However, if the filter isn&#39;t added to the query then the caller</span>
<span class="sd">        is responsible for unreffing the joins used.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">filter_expr</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">FieldError</span><span class="p">(</span><span class="s2">&quot;Cannot parse keyword query as dict&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">filter_expr</span><span class="p">,</span> <span class="n">Q</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_q</span><span class="p">(</span>
                <span class="n">filter_expr</span><span class="p">,</span>
                <span class="n">branch_negated</span><span class="o">=</span><span class="n">branch_negated</span><span class="p">,</span>
                <span class="n">current_negated</span><span class="o">=</span><span class="n">current_negated</span><span class="p">,</span>
                <span class="n">used_aliases</span><span class="o">=</span><span class="n">can_reuse</span><span class="p">,</span>
                <span class="n">allow_joins</span><span class="o">=</span><span class="n">allow_joins</span><span class="p">,</span>
                <span class="n">split_subq</span><span class="o">=</span><span class="n">split_subq</span><span class="p">,</span>
                <span class="n">check_filterable</span><span class="o">=</span><span class="n">check_filterable</span><span class="p">,</span>
                <span class="n">summarize</span><span class="o">=</span><span class="n">summarize</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">filter_expr</span><span class="p">,</span> <span class="s2">&quot;resolve_expression&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">filter_expr</span><span class="p">,</span> <span class="s2">&quot;conditional&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Cannot filter against a non-conditional expression.&quot;</span><span class="p">)</span>
            <span class="n">condition</span> <span class="o">=</span> <span class="n">filter_expr</span><span class="o">.</span><span class="n">resolve_expression</span><span class="p">(</span>
                <span class="bp">self</span><span class="p">,</span> <span class="n">allow_joins</span><span class="o">=</span><span class="n">allow_joins</span><span class="p">,</span> <span class="n">summarize</span><span class="o">=</span><span class="n">summarize</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">condition</span><span class="p">,</span> <span class="n">Lookup</span><span class="p">):</span>
                <span class="n">condition</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_lookup</span><span class="p">([</span><span class="s2">&quot;exact&quot;</span><span class="p">],</span> <span class="n">condition</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">WhereNode</span><span class="p">([</span><span class="n">condition</span><span class="p">],</span> <span class="n">connector</span><span class="o">=</span><span class="n">AND</span><span class="p">),</span> <span class="p">[]</span>
        <span class="n">arg</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">filter_expr</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">arg</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">FieldError</span><span class="p">(</span><span class="s2">&quot;Cannot parse keyword query </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">arg</span><span class="p">)</span>
        <span class="n">lookups</span><span class="p">,</span> <span class="n">parts</span><span class="p">,</span> <span class="n">reffed_expression</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">solve_lookup_type</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">summarize</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">check_filterable</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">check_filterable</span><span class="p">(</span><span class="n">reffed_expression</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">allow_joins</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">FieldError</span><span class="p">(</span><span class="s2">&quot;Joined field references are not permitted in this query&quot;</span><span class="p">)</span>

        <span class="n">pre_joins</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">alias_refcount</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">resolve_lookup_value</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">can_reuse</span><span class="p">,</span> <span class="n">allow_joins</span><span class="p">,</span> <span class="n">summarize</span><span class="p">)</span>
        <span class="n">used_joins</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">alias_refcount</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">v</span> <span class="o">&gt;</span> <span class="n">pre_joins</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="n">check_filterable</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">check_filterable</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">reffed_expression</span><span class="p">:</span>
            <span class="n">condition</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_lookup</span><span class="p">(</span><span class="n">lookups</span><span class="p">,</span> <span class="n">reffed_expression</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">WhereNode</span><span class="p">([</span><span class="n">condition</span><span class="p">],</span> <span class="n">connector</span><span class="o">=</span><span class="n">AND</span><span class="p">),</span> <span class="p">[]</span>

        <span class="n">opts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_meta</span><span class="p">()</span>
        <span class="n">alias</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_initial_alias</span><span class="p">()</span>
        <span class="n">allow_many</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">branch_negated</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">split_subq</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">join_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup_joins</span><span class="p">(</span>
                <span class="n">parts</span><span class="p">,</span>
                <span class="n">opts</span><span class="p">,</span>
                <span class="n">alias</span><span class="p">,</span>
                <span class="n">can_reuse</span><span class="o">=</span><span class="n">can_reuse</span><span class="p">,</span>
                <span class="n">allow_many</span><span class="o">=</span><span class="n">allow_many</span><span class="p">,</span>
                <span class="n">reuse_with_filtered_relation</span><span class="o">=</span><span class="n">reuse_with_filtered_relation</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="c1"># Prevent iterator from being consumed by check_related_objects()</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">Iterator</span><span class="p">):</span>
                <span class="n">value</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">check_related_objects</span><span class="p">(</span><span class="n">join_info</span><span class="o">.</span><span class="n">final_field</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">join_info</span><span class="o">.</span><span class="n">opts</span><span class="p">)</span>

            <span class="c1"># split_exclude() needs to know which joins were generated for the</span>
            <span class="c1"># lookup parts</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_lookup_joins</span> <span class="o">=</span> <span class="n">join_info</span><span class="o">.</span><span class="n">joins</span>
        <span class="k">except</span> <span class="n">MultiJoin</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">split_exclude</span><span class="p">(</span><span class="n">filter_expr</span><span class="p">,</span> <span class="n">can_reuse</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">names_with_path</span><span class="p">)</span>

        <span class="c1"># Update used_joins before trimming since they are reused to determine</span>
        <span class="c1"># which joins could be later promoted to INNER.</span>
        <span class="n">used_joins</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">join_info</span><span class="o">.</span><span class="n">joins</span><span class="p">)</span>
        <span class="n">targets</span><span class="p">,</span> <span class="n">alias</span><span class="p">,</span> <span class="n">join_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trim_joins</span><span class="p">(</span>
            <span class="n">join_info</span><span class="o">.</span><span class="n">targets</span><span class="p">,</span> <span class="n">join_info</span><span class="o">.</span><span class="n">joins</span><span class="p">,</span> <span class="n">join_info</span><span class="o">.</span><span class="n">path</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">can_reuse</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">can_reuse</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">join_list</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">join_info</span><span class="o">.</span><span class="n">final_field</span><span class="o">.</span><span class="n">is_relation</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">targets</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">col</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_col</span><span class="p">(</span><span class="n">targets</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">join_info</span><span class="o">.</span><span class="n">final_field</span><span class="p">,</span> <span class="n">alias</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">col</span> <span class="o">=</span> <span class="n">MultiColSource</span><span class="p">(</span>
                    <span class="n">alias</span><span class="p">,</span> <span class="n">targets</span><span class="p">,</span> <span class="n">join_info</span><span class="o">.</span><span class="n">targets</span><span class="p">,</span> <span class="n">join_info</span><span class="o">.</span><span class="n">final_field</span>
                <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">col</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_col</span><span class="p">(</span><span class="n">targets</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">join_info</span><span class="o">.</span><span class="n">final_field</span><span class="p">,</span> <span class="n">alias</span><span class="p">)</span>

        <span class="n">condition</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_lookup</span><span class="p">(</span><span class="n">lookups</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="n">lookup_type</span> <span class="o">=</span> <span class="n">condition</span><span class="o">.</span><span class="n">lookup_name</span>
        <span class="n">clause</span> <span class="o">=</span> <span class="n">WhereNode</span><span class="p">([</span><span class="n">condition</span><span class="p">],</span> <span class="n">connector</span><span class="o">=</span><span class="n">AND</span><span class="p">)</span>

        <span class="n">require_outer</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">lookup_type</span> <span class="o">==</span> <span class="s2">&quot;isnull&quot;</span> <span class="ow">and</span> <span class="n">condition</span><span class="o">.</span><span class="n">rhs</span> <span class="ow">is</span> <span class="kc">True</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">current_negated</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">current_negated</span>
            <span class="ow">and</span> <span class="p">(</span><span class="n">lookup_type</span> <span class="o">!=</span> <span class="s2">&quot;isnull&quot;</span> <span class="ow">or</span> <span class="n">condition</span><span class="o">.</span><span class="n">rhs</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">)</span>
            <span class="ow">and</span> <span class="n">condition</span><span class="o">.</span><span class="n">rhs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="p">):</span>
            <span class="n">require_outer</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="n">lookup_type</span> <span class="o">!=</span> <span class="s2">&quot;isnull&quot;</span><span class="p">:</span>
                <span class="c1"># The condition added here will be SQL like this:</span>
                <span class="c1"># NOT (col IS NOT NULL), where the first NOT is added in</span>
                <span class="c1"># upper layers of code. The reason for addition is that if col</span>
                <span class="c1"># is null, then col != someval will result in SQL &quot;unknown&quot;</span>
                <span class="c1"># which isn&#39;t the same as in Python. The Python None handling</span>
                <span class="c1"># is wanted, and it can be gotten by</span>
                <span class="c1"># (col IS NULL OR col != someval)</span>
                <span class="c1">#   &lt;=&gt;</span>
                <span class="c1"># NOT (col IS NOT NULL AND col = someval).</span>
                <span class="k">if</span> <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">is_nullable</span><span class="p">(</span><span class="n">targets</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">alias_map</span><span class="p">[</span><span class="n">join_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">join_type</span> <span class="o">==</span> <span class="n">LOUTER</span>
                <span class="p">):</span>
                    <span class="n">lookup_class</span> <span class="o">=</span> <span class="n">targets</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_lookup</span><span class="p">(</span><span class="s2">&quot;isnull&quot;</span><span class="p">)</span>
                    <span class="n">col</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_col</span><span class="p">(</span><span class="n">targets</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">join_info</span><span class="o">.</span><span class="n">targets</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">alias</span><span class="p">)</span>
                    <span class="n">clause</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">lookup_class</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span> <span class="n">AND</span><span class="p">)</span>
                <span class="c1"># If someval is a nullable column, someval IS NOT NULL is</span>
                <span class="c1"># added.</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">Col</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_nullable</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">target</span><span class="p">):</span>
                    <span class="n">lookup_class</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">get_lookup</span><span class="p">(</span><span class="s2">&quot;isnull&quot;</span><span class="p">)</span>
                    <span class="n">clause</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">lookup_class</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span> <span class="n">AND</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">clause</span><span class="p">,</span> <span class="n">used_joins</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">require_outer</span> <span class="k">else</span> <span class="p">()</span></div>


<div class="viewcode-block" id="Query.add_filter">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/query/index.html#django.db.models.sql.query.Query.add_filter">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">add_filter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filter_lhs</span><span class="p">,</span> <span class="n">filter_rhs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_q</span><span class="p">(</span><span class="n">Q</span><span class="p">((</span><span class="n">filter_lhs</span><span class="p">,</span> <span class="n">filter_rhs</span><span class="p">)))</span></div>


<div class="viewcode-block" id="Query.add_q">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/query/index.html#django.db.models.sql.query.Query.add_q">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">add_q</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">q_object</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A preprocessor for the internal _add_q(). Responsible for doing final</span>
<span class="sd">        join promotion.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># For join promotion this case is doing an AND for the added q_object</span>
        <span class="c1"># and existing conditions. So, any existing inner join forces the join</span>
        <span class="c1"># type to remain inner. Existing outer joins can however be demoted.</span>
        <span class="c1"># (Consider case where rel_a is LOUTER and rel_a__col=1 is added - if</span>
        <span class="c1"># rel_a doesn&#39;t produce any rows, then the whole condition must fail.</span>
        <span class="c1"># So, demotion is OK.</span>
        <span class="n">existing_inner</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">alias_map</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">alias_map</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">join_type</span> <span class="o">==</span> <span class="n">INNER</span>
        <span class="p">}</span>
        <span class="n">clause</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_q</span><span class="p">(</span><span class="n">q_object</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">used_aliases</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">clause</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">where</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">clause</span><span class="p">,</span> <span class="n">AND</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">demote_joins</span><span class="p">(</span><span class="n">existing_inner</span><span class="p">)</span></div>


<div class="viewcode-block" id="Query.build_where">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/query/index.html#django.db.models.sql.query.Query.build_where">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">build_where</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filter_expr</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_filter</span><span class="p">(</span><span class="n">filter_expr</span><span class="p">,</span> <span class="n">allow_joins</span><span class="o">=</span><span class="kc">False</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span></div>


<div class="viewcode-block" id="Query.clear_where">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/query/index.html#django.db.models.sql.query.Query.clear_where">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">clear_where</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">where</span> <span class="o">=</span> <span class="n">WhereNode</span><span class="p">()</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_add_q</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">q_object</span><span class="p">,</span>
        <span class="n">used_aliases</span><span class="p">,</span>
        <span class="n">branch_negated</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">current_negated</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">allow_joins</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">split_subq</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">check_filterable</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">summarize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add a Q-object to the current filter.&quot;&quot;&quot;</span>
        <span class="n">connector</span> <span class="o">=</span> <span class="n">q_object</span><span class="o">.</span><span class="n">connector</span>
        <span class="n">current_negated</span> <span class="o">^=</span> <span class="n">q_object</span><span class="o">.</span><span class="n">negated</span>
        <span class="n">branch_negated</span> <span class="o">=</span> <span class="n">branch_negated</span> <span class="ow">or</span> <span class="n">q_object</span><span class="o">.</span><span class="n">negated</span>
        <span class="n">target_clause</span> <span class="o">=</span> <span class="n">WhereNode</span><span class="p">(</span><span class="n">connector</span><span class="o">=</span><span class="n">connector</span><span class="p">,</span> <span class="n">negated</span><span class="o">=</span><span class="n">q_object</span><span class="o">.</span><span class="n">negated</span><span class="p">)</span>
        <span class="n">joinpromoter</span> <span class="o">=</span> <span class="n">JoinPromoter</span><span class="p">(</span>
            <span class="n">q_object</span><span class="o">.</span><span class="n">connector</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">q_object</span><span class="o">.</span><span class="n">children</span><span class="p">),</span> <span class="n">current_negated</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">q_object</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
            <span class="n">child_clause</span><span class="p">,</span> <span class="n">needed_inner</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_filter</span><span class="p">(</span>
                <span class="n">child</span><span class="p">,</span>
                <span class="n">can_reuse</span><span class="o">=</span><span class="n">used_aliases</span><span class="p">,</span>
                <span class="n">branch_negated</span><span class="o">=</span><span class="n">branch_negated</span><span class="p">,</span>
                <span class="n">current_negated</span><span class="o">=</span><span class="n">current_negated</span><span class="p">,</span>
                <span class="n">allow_joins</span><span class="o">=</span><span class="n">allow_joins</span><span class="p">,</span>
                <span class="n">split_subq</span><span class="o">=</span><span class="n">split_subq</span><span class="p">,</span>
                <span class="n">check_filterable</span><span class="o">=</span><span class="n">check_filterable</span><span class="p">,</span>
                <span class="n">summarize</span><span class="o">=</span><span class="n">summarize</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">joinpromoter</span><span class="o">.</span><span class="n">add_votes</span><span class="p">(</span><span class="n">needed_inner</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">child_clause</span><span class="p">:</span>
                <span class="n">target_clause</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">child_clause</span><span class="p">,</span> <span class="n">connector</span><span class="p">)</span>
        <span class="n">needed_inner</span> <span class="o">=</span> <span class="n">joinpromoter</span><span class="o">.</span><span class="n">update_join_types</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">target_clause</span><span class="p">,</span> <span class="n">needed_inner</span>

<div class="viewcode-block" id="Query.build_filtered_relation_q">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/query/index.html#django.db.models.sql.query.Query.build_filtered_relation_q">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">build_filtered_relation_q</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">q_object</span><span class="p">,</span> <span class="n">reuse</span><span class="p">,</span> <span class="n">branch_negated</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">current_negated</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add a FilteredRelation object to the current filter.&quot;&quot;&quot;</span>
        <span class="n">connector</span> <span class="o">=</span> <span class="n">q_object</span><span class="o">.</span><span class="n">connector</span>
        <span class="n">current_negated</span> <span class="o">^=</span> <span class="n">q_object</span><span class="o">.</span><span class="n">negated</span>
        <span class="n">branch_negated</span> <span class="o">=</span> <span class="n">branch_negated</span> <span class="ow">or</span> <span class="n">q_object</span><span class="o">.</span><span class="n">negated</span>
        <span class="n">target_clause</span> <span class="o">=</span> <span class="n">WhereNode</span><span class="p">(</span><span class="n">connector</span><span class="o">=</span><span class="n">connector</span><span class="p">,</span> <span class="n">negated</span><span class="o">=</span><span class="n">q_object</span><span class="o">.</span><span class="n">negated</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">q_object</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">Node</span><span class="p">):</span>
                <span class="n">child_clause</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_filtered_relation_q</span><span class="p">(</span>
                    <span class="n">child</span><span class="p">,</span>
                    <span class="n">reuse</span><span class="o">=</span><span class="n">reuse</span><span class="p">,</span>
                    <span class="n">branch_negated</span><span class="o">=</span><span class="n">branch_negated</span><span class="p">,</span>
                    <span class="n">current_negated</span><span class="o">=</span><span class="n">current_negated</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">child_clause</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_filter</span><span class="p">(</span>
                    <span class="n">child</span><span class="p">,</span>
                    <span class="n">can_reuse</span><span class="o">=</span><span class="n">reuse</span><span class="p">,</span>
                    <span class="n">branch_negated</span><span class="o">=</span><span class="n">branch_negated</span><span class="p">,</span>
                    <span class="n">current_negated</span><span class="o">=</span><span class="n">current_negated</span><span class="p">,</span>
                    <span class="n">allow_joins</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">split_subq</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">reuse_with_filtered_relation</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="n">target_clause</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">child_clause</span><span class="p">,</span> <span class="n">connector</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">target_clause</span></div>


<div class="viewcode-block" id="Query.add_filtered_relation">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/query/index.html#django.db.models.sql.query.Query.add_filtered_relation">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">add_filtered_relation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filtered_relation</span><span class="p">,</span> <span class="n">alias</span><span class="p">):</span>
        <span class="n">filtered_relation</span><span class="o">.</span><span class="n">alias</span> <span class="o">=</span> <span class="n">alias</span>
        <span class="n">lookups</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">get_children_from_q</span><span class="p">(</span><span class="n">filtered_relation</span><span class="o">.</span><span class="n">condition</span><span class="p">))</span>
        <span class="n">relation_lookup_parts</span><span class="p">,</span> <span class="n">relation_field_parts</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">solve_lookup_type</span><span class="p">(</span>
            <span class="n">filtered_relation</span><span class="o">.</span><span class="n">relation_name</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">relation_lookup_parts</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;FilteredRelation&#39;s relation_name cannot contain lookups &quot;</span>
                <span class="s2">&quot;(got </span><span class="si">%r</span><span class="s2">).&quot;</span> <span class="o">%</span> <span class="n">filtered_relation</span><span class="o">.</span><span class="n">relation_name</span>
            <span class="p">)</span>
        <span class="k">for</span> <span class="n">lookup</span> <span class="ow">in</span> <span class="n">chain</span><span class="p">(</span><span class="n">lookups</span><span class="p">):</span>
            <span class="n">lookup_parts</span><span class="p">,</span> <span class="n">lookup_field_parts</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">solve_lookup_type</span><span class="p">(</span><span class="n">lookup</span><span class="p">)</span>
            <span class="n">shift</span> <span class="o">=</span> <span class="mi">2</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">lookup_parts</span> <span class="k">else</span> <span class="mi">1</span>
            <span class="n">lookup_field_path</span> <span class="o">=</span> <span class="n">lookup_field_parts</span><span class="p">[:</span><span class="o">-</span><span class="n">shift</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">lookup_field_part</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lookup_field_path</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">relation_field_parts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">idx</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">relation_field_parts</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">!=</span> <span class="n">lookup_field_part</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                            <span class="s2">&quot;FilteredRelation&#39;s condition doesn&#39;t support &quot;</span>
                            <span class="s2">&quot;relations outside the </span><span class="si">%r</span><span class="s2"> (got </span><span class="si">%r</span><span class="s2">).&quot;</span>
                            <span class="o">%</span> <span class="p">(</span><span class="n">filtered_relation</span><span class="o">.</span><span class="n">relation_name</span><span class="p">,</span> <span class="n">lookup</span><span class="p">)</span>
                        <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="s2">&quot;FilteredRelation&#39;s condition doesn&#39;t support nested &quot;</span>
                        <span class="s2">&quot;relations deeper than the relation_name (got </span><span class="si">%r</span><span class="s2"> for &quot;</span>
                        <span class="s2">&quot;</span><span class="si">%r</span><span class="s2">).&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">lookup</span><span class="p">,</span> <span class="n">filtered_relation</span><span class="o">.</span><span class="n">relation_name</span><span class="p">)</span>
                    <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_filtered_relations</span><span class="p">[</span><span class="n">filtered_relation</span><span class="o">.</span><span class="n">alias</span><span class="p">]</span> <span class="o">=</span> <span class="n">filtered_relation</span></div>


<div class="viewcode-block" id="Query.names_to_path">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/query/index.html#django.db.models.sql.query.Query.names_to_path">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">names_to_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">names</span><span class="p">,</span> <span class="n">opts</span><span class="p">,</span> <span class="n">allow_many</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fail_on_missing</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Walk the list of names and turns them into PathInfo tuples. A single</span>
<span class="sd">        name in &#39;names&#39; can generate multiple PathInfos (m2m, for example).</span>

<span class="sd">        &#39;names&#39; is the path of names to travel, &#39;opts&#39; is the model Options we</span>
<span class="sd">        start the name resolving from, &#39;allow_many&#39; is as for setup_joins().</span>
<span class="sd">        If fail_on_missing is set to True, then a name that can&#39;t be resolved</span>
<span class="sd">        will generate a FieldError.</span>

<span class="sd">        Return a list of PathInfo tuples. In addition return the final field</span>
<span class="sd">        (the last used join field) and target (which is a field guaranteed to</span>
<span class="sd">        contain the same value as the final field). Finally, return those names</span>
<span class="sd">        that weren&#39;t found (which are likely transforms and the final lookup).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">path</span><span class="p">,</span> <span class="n">names_with_path</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">pos</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">names</span><span class="p">):</span>
            <span class="n">cur_names_with_path</span> <span class="o">=</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="p">[])</span>
            <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;pk&quot;</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">opts</span><span class="o">.</span><span class="n">pk</span><span class="o">.</span><span class="n">name</span>

            <span class="n">field</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">filtered_relation</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">opts</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">FieldDoesNotExist</span>
                <span class="n">field</span> <span class="o">=</span> <span class="n">opts</span><span class="o">.</span><span class="n">get_field</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">FieldDoesNotExist</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">annotation_select</span><span class="p">:</span>
                    <span class="n">field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">annotation_select</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">output_field</span>
                <span class="k">elif</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filtered_relations</span> <span class="ow">and</span> <span class="n">pos</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">filtered_relation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filtered_relations</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">LOOKUP_SEP</span> <span class="ow">in</span> <span class="n">filtered_relation</span><span class="o">.</span><span class="n">relation_name</span><span class="p">:</span>
                        <span class="n">parts</span> <span class="o">=</span> <span class="n">filtered_relation</span><span class="o">.</span><span class="n">relation_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">LOOKUP_SEP</span><span class="p">)</span>
                        <span class="n">filtered_relation_path</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">names_to_path</span><span class="p">(</span>
                            <span class="n">parts</span><span class="p">,</span>
                            <span class="n">opts</span><span class="p">,</span>
                            <span class="n">allow_many</span><span class="p">,</span>
                            <span class="n">fail_on_missing</span><span class="p">,</span>
                        <span class="p">)</span>
                        <span class="n">path</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">filtered_relation_path</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">field</span> <span class="o">=</span> <span class="n">opts</span><span class="o">.</span><span class="n">get_field</span><span class="p">(</span><span class="n">filtered_relation</span><span class="o">.</span><span class="n">relation_name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">field</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># Fields that contain one-to-many relations with a generic</span>
                <span class="c1"># model (like a GenericForeignKey) cannot generate reverse</span>
                <span class="c1"># relations and therefore cannot be used for reverse querying.</span>
                <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">is_relation</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">field</span><span class="o">.</span><span class="n">related_model</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">FieldError</span><span class="p">(</span>
                        <span class="s2">&quot;Field </span><span class="si">%r</span><span class="s2"> does not generate an automatic reverse &quot;</span>
                        <span class="s2">&quot;relation and therefore cannot be used for reverse &quot;</span>
                        <span class="s2">&quot;querying. If it is a GenericForeignKey, consider &quot;</span>
                        <span class="s2">&quot;adding a GenericRelation.&quot;</span> <span class="o">%</span> <span class="n">name</span>
                    <span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">model</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">concrete_model</span>
                <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                    <span class="c1"># QuerySet.annotate() may introduce fields that aren&#39;t</span>
                    <span class="c1"># attached to a model.</span>
                    <span class="n">model</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># We didn&#39;t find the current field, so move position back</span>
                <span class="c1"># one step.</span>
                <span class="n">pos</span> <span class="o">-=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">pos</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">or</span> <span class="n">fail_on_missing</span><span class="p">:</span>
                    <span class="n">available</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span>
                        <span class="p">[</span>
                            <span class="o">*</span><span class="n">get_field_names_from_opts</span><span class="p">(</span><span class="n">opts</span><span class="p">),</span>
                            <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">annotation_select</span><span class="p">,</span>
                            <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_filtered_relations</span><span class="p">,</span>
                        <span class="p">]</span>
                    <span class="p">)</span>
                    <span class="k">raise</span> <span class="n">FieldError</span><span class="p">(</span>
                        <span class="s2">&quot;Cannot resolve keyword &#39;</span><span class="si">%s</span><span class="s2">&#39; into field. &quot;</span>
                        <span class="s2">&quot;Choices are: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">available</span><span class="p">))</span>
                    <span class="p">)</span>
                <span class="k">break</span>
            <span class="c1"># Check if we need any joins for concrete inheritance cases (the</span>
            <span class="c1"># field lives in parent, but we are currently in one of its</span>
            <span class="c1"># children)</span>
            <span class="k">if</span> <span class="n">opts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">opts</span><span class="o">.</span><span class="n">model</span><span class="p">:</span>
                <span class="n">path_to_parent</span> <span class="o">=</span> <span class="n">opts</span><span class="o">.</span><span class="n">get_path_to_parent</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">path_to_parent</span><span class="p">:</span>
                    <span class="n">path</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">path_to_parent</span><span class="p">)</span>
                    <span class="n">cur_names_with_path</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">path_to_parent</span><span class="p">)</span>
                    <span class="n">opts</span> <span class="o">=</span> <span class="n">path_to_parent</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">to_opts</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="s2">&quot;path_infos&quot;</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">filtered_relation</span><span class="p">:</span>
                    <span class="n">pathinfos</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">get_path_info</span><span class="p">(</span><span class="n">filtered_relation</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">pathinfos</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">path_infos</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">allow_many</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">inner_pos</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">pathinfos</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">m2m</span><span class="p">:</span>
                            <span class="n">cur_names_with_path</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">pathinfos</span><span class="p">[</span><span class="mi">0</span> <span class="p">:</span> <span class="n">inner_pos</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>
                            <span class="n">names_with_path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cur_names_with_path</span><span class="p">)</span>
                            <span class="k">raise</span> <span class="n">MultiJoin</span><span class="p">(</span><span class="n">pos</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">names_with_path</span><span class="p">)</span>
                <span class="n">last</span> <span class="o">=</span> <span class="n">pathinfos</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">path</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">pathinfos</span><span class="p">)</span>
                <span class="n">final_field</span> <span class="o">=</span> <span class="n">last</span><span class="o">.</span><span class="n">join_field</span>
                <span class="n">opts</span> <span class="o">=</span> <span class="n">last</span><span class="o">.</span><span class="n">to_opts</span>
                <span class="n">targets</span> <span class="o">=</span> <span class="n">last</span><span class="o">.</span><span class="n">target_fields</span>
                <span class="n">cur_names_with_path</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">pathinfos</span><span class="p">)</span>
                <span class="n">names_with_path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cur_names_with_path</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Local non-relational field.</span>
                <span class="n">final_field</span> <span class="o">=</span> <span class="n">field</span>
                <span class="n">targets</span> <span class="o">=</span> <span class="p">(</span><span class="n">field</span><span class="p">,)</span>
                <span class="k">if</span> <span class="n">fail_on_missing</span> <span class="ow">and</span> <span class="n">pos</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">names</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="n">FieldError</span><span class="p">(</span>
                        <span class="s2">&quot;Cannot resolve keyword </span><span class="si">%r</span><span class="s2"> into field. Join on &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span>
                        <span class="s2">&quot; not permitted.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">names</span><span class="p">[</span><span class="n">pos</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span> <span class="n">name</span><span class="p">)</span>
                    <span class="p">)</span>
                <span class="k">break</span>
        <span class="k">return</span> <span class="n">path</span><span class="p">,</span> <span class="n">final_field</span><span class="p">,</span> <span class="n">targets</span><span class="p">,</span> <span class="n">names</span><span class="p">[</span><span class="n">pos</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">:]</span></div>


<div class="viewcode-block" id="Query.setup_joins">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/query/index.html#django.db.models.sql.query.Query.setup_joins">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">setup_joins</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">names</span><span class="p">,</span>
        <span class="n">opts</span><span class="p">,</span>
        <span class="n">alias</span><span class="p">,</span>
        <span class="n">can_reuse</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">allow_many</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">reuse_with_filtered_relation</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute the necessary table joins for the passage through the fields</span>
<span class="sd">        given in &#39;names&#39;. &#39;opts&#39; is the Options class for the current model</span>
<span class="sd">        (which gives the table we are starting from), &#39;alias&#39; is the alias for</span>
<span class="sd">        the table to start the joining from.</span>

<span class="sd">        The &#39;can_reuse&#39; defines the reverse foreign key joins we can reuse. It</span>
<span class="sd">        can be None in which case all joins are reusable or a set of aliases</span>
<span class="sd">        that can be reused. Note that non-reverse foreign keys are always</span>
<span class="sd">        reusable when using setup_joins().</span>

<span class="sd">        The &#39;reuse_with_filtered_relation&#39; can be used to force &#39;can_reuse&#39;</span>
<span class="sd">        parameter and force the relation on the given connections.</span>

<span class="sd">        If &#39;allow_many&#39; is False, then any reverse foreign key seen will</span>
<span class="sd">        generate a MultiJoin exception.</span>

<span class="sd">        Return the final field involved in the joins, the target field (used</span>
<span class="sd">        for any &#39;where&#39; constraint), the final &#39;opts&#39; value, the joins, the</span>
<span class="sd">        field path traveled to generate the joins, and a transform function</span>
<span class="sd">        that takes a field and alias and is equivalent to `field.get_col(alias)`</span>
<span class="sd">        in the simple case but wraps field transforms if they were included in</span>
<span class="sd">        names.</span>

<span class="sd">        The target field is the field containing the concrete value. Final</span>
<span class="sd">        field can be something different, for example foreign key pointing to</span>
<span class="sd">        that value. Final field is needed for example in some value</span>
<span class="sd">        conversions (convert &#39;obj&#39; in fk__id=obj to pk val using the foreign</span>
<span class="sd">        key field for example).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">joins</span> <span class="o">=</span> <span class="p">[</span><span class="n">alias</span><span class="p">]</span>
        <span class="c1"># The transform can&#39;t be applied yet, as joins must be trimmed later.</span>
        <span class="c1"># To avoid making every caller of this method look up transforms</span>
        <span class="c1"># directly, compute transforms here and create a partial that converts</span>
        <span class="c1"># fields to the appropriate wrapped version.</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">final_transformer</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">alias</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">alias_cols</span><span class="p">:</span>
                <span class="n">alias</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">return</span> <span class="n">field</span><span class="o">.</span><span class="n">get_col</span><span class="p">(</span><span class="n">alias</span><span class="p">)</span>

        <span class="c1"># Try resolving all the names as fields first. If there&#39;s an error,</span>
        <span class="c1"># treat trailing names as lookups until a field can be resolved.</span>
        <span class="n">last_field_exception</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">pivot</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">names</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">path</span><span class="p">,</span> <span class="n">final_field</span><span class="p">,</span> <span class="n">targets</span><span class="p">,</span> <span class="n">rest</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">names_to_path</span><span class="p">(</span>
                    <span class="n">names</span><span class="p">[:</span><span class="n">pivot</span><span class="p">],</span>
                    <span class="n">opts</span><span class="p">,</span>
                    <span class="n">allow_many</span><span class="p">,</span>
                    <span class="n">fail_on_missing</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="n">FieldError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">pivot</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="c1"># The first item cannot be a lookup, so it&#39;s safe</span>
                    <span class="c1"># to raise the field error here.</span>
                    <span class="k">raise</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">last_field_exception</span> <span class="o">=</span> <span class="n">exc</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># The transforms are the remaining items that couldn&#39;t be</span>
                <span class="c1"># resolved into fields.</span>
                <span class="n">transforms</span> <span class="o">=</span> <span class="n">names</span><span class="p">[</span><span class="n">pivot</span><span class="p">:]</span>
                <span class="k">break</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">transforms</span><span class="p">:</span>

            <span class="k">def</span><span class="w"> </span><span class="nf">transform</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">alias</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">previous</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">wrapped</span> <span class="o">=</span> <span class="n">previous</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">alias</span><span class="p">)</span>
                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">try_transform</span><span class="p">(</span><span class="n">wrapped</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
                <span class="k">except</span> <span class="n">FieldError</span><span class="p">:</span>
                    <span class="c1"># FieldError is raised if the transform doesn&#39;t exist.</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">final_field</span><span class="p">,</span> <span class="n">Field</span><span class="p">)</span> <span class="ow">and</span> <span class="n">last_field_exception</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">last_field_exception</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span>

            <span class="n">final_transformer</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span>
                <span class="n">transform</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">previous</span><span class="o">=</span><span class="n">final_transformer</span>
            <span class="p">)</span>
            <span class="n">final_transformer</span><span class="o">.</span><span class="n">has_transforms</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="c1"># Then, add the path to the query&#39;s joins. Note that we can&#39;t trim</span>
        <span class="c1"># joins at this stage - we will need the information about join type</span>
        <span class="c1"># of the trimmed joins.</span>
        <span class="k">for</span> <span class="n">join</span> <span class="ow">in</span> <span class="n">path</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">join</span><span class="o">.</span><span class="n">filtered_relation</span><span class="p">:</span>
                <span class="n">filtered_relation</span> <span class="o">=</span> <span class="n">join</span><span class="o">.</span><span class="n">filtered_relation</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
                <span class="n">table_alias</span> <span class="o">=</span> <span class="n">filtered_relation</span><span class="o">.</span><span class="n">alias</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">filtered_relation</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">table_alias</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">opts</span> <span class="o">=</span> <span class="n">join</span><span class="o">.</span><span class="n">to_opts</span>
            <span class="k">if</span> <span class="n">join</span><span class="o">.</span><span class="n">direct</span><span class="p">:</span>
                <span class="n">nullable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_nullable</span><span class="p">(</span><span class="n">join</span><span class="o">.</span><span class="n">join_field</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">nullable</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">connection</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">join_class</span><span class="p">(</span>
                <span class="n">opts</span><span class="o">.</span><span class="n">db_table</span><span class="p">,</span>
                <span class="n">alias</span><span class="p">,</span>
                <span class="n">table_alias</span><span class="p">,</span>
                <span class="n">INNER</span><span class="p">,</span>
                <span class="n">join</span><span class="o">.</span><span class="n">join_field</span><span class="p">,</span>
                <span class="n">nullable</span><span class="p">,</span>
                <span class="n">filtered_relation</span><span class="o">=</span><span class="n">filtered_relation</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">reuse</span> <span class="o">=</span> <span class="n">can_reuse</span> <span class="k">if</span> <span class="n">join</span><span class="o">.</span><span class="n">m2m</span> <span class="ow">or</span> <span class="n">reuse_with_filtered_relation</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="n">alias</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="n">connection</span><span class="p">,</span>
                <span class="n">reuse</span><span class="o">=</span><span class="n">reuse</span><span class="p">,</span>
                <span class="n">reuse_with_filtered_relation</span><span class="o">=</span><span class="n">reuse_with_filtered_relation</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">joins</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">alias</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">filtered_relation</span><span class="p">:</span>
                <span class="n">filtered_relation</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">joins</span><span class="p">[:]</span>
        <span class="k">return</span> <span class="n">JoinInfo</span><span class="p">(</span><span class="n">final_field</span><span class="p">,</span> <span class="n">targets</span><span class="p">,</span> <span class="n">opts</span><span class="p">,</span> <span class="n">joins</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">final_transformer</span><span class="p">)</span></div>


<div class="viewcode-block" id="Query.trim_joins">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/query/index.html#django.db.models.sql.query.Query.trim_joins">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">trim_joins</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">targets</span><span class="p">,</span> <span class="n">joins</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The &#39;target&#39; parameter is the final field being joined to, &#39;joins&#39;</span>
<span class="sd">        is the full list of join aliases. The &#39;path&#39; contain the PathInfos</span>
<span class="sd">        used to create the joins.</span>

<span class="sd">        Return the final target field and table alias and the new active</span>
<span class="sd">        joins.</span>

<span class="sd">        Always trim any direct join if the target column is already in the</span>
<span class="sd">        previous table. Can&#39;t trim reverse joins as it&#39;s unknown if there&#39;s</span>
<span class="sd">        anything on the other side of the join.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">joins</span> <span class="o">=</span> <span class="n">joins</span><span class="p">[:]</span>
        <span class="k">for</span> <span class="n">pos</span><span class="p">,</span> <span class="n">info</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">reversed</span><span class="p">(</span><span class="n">path</span><span class="p">)):</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">joins</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">info</span><span class="o">.</span><span class="n">direct</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="k">if</span> <span class="n">info</span><span class="o">.</span><span class="n">filtered_relation</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">join_targets</span> <span class="o">=</span> <span class="p">{</span><span class="n">t</span><span class="o">.</span><span class="n">column</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">info</span><span class="o">.</span><span class="n">join_field</span><span class="o">.</span><span class="n">foreign_related_fields</span><span class="p">}</span>
            <span class="n">cur_targets</span> <span class="o">=</span> <span class="p">{</span><span class="n">t</span><span class="o">.</span><span class="n">column</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">targets</span><span class="p">}</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">cur_targets</span><span class="o">.</span><span class="n">issubset</span><span class="p">(</span><span class="n">join_targets</span><span class="p">):</span>
                <span class="k">break</span>
            <span class="n">targets_dict</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">column</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">info</span><span class="o">.</span><span class="n">join_field</span><span class="o">.</span><span class="n">related_fields</span>
                <span class="k">if</span> <span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">column</span> <span class="ow">in</span> <span class="n">cur_targets</span>
            <span class="p">}</span>
            <span class="n">targets</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">targets_dict</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">column</span><span class="p">]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">targets</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">unref_alias</span><span class="p">(</span><span class="n">joins</span><span class="o">.</span><span class="n">pop</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">targets</span><span class="p">,</span> <span class="n">joins</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">joins</span></div>


    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_gen_cols</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">exprs</span><span class="p">,</span> <span class="n">include_external</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">resolve_refs</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">expr</span> <span class="ow">in</span> <span class="n">exprs</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">Col</span><span class="p">):</span>
                <span class="k">yield</span> <span class="n">expr</span>
            <span class="k">elif</span> <span class="n">include_external</span> <span class="ow">and</span> <span class="nb">callable</span><span class="p">(</span>
                <span class="nb">getattr</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="s2">&quot;get_external_cols&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="p">):</span>
                <span class="k">yield from</span> <span class="n">expr</span><span class="o">.</span><span class="n">get_external_cols</span><span class="p">()</span>
            <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="s2">&quot;get_source_expressions&quot;</span><span class="p">):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">resolve_refs</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">Ref</span><span class="p">):</span>
                    <span class="k">continue</span>
                <span class="k">yield from</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_gen_cols</span><span class="p">(</span>
                    <span class="n">expr</span><span class="o">.</span><span class="n">get_source_expressions</span><span class="p">(),</span>
                    <span class="n">include_external</span><span class="o">=</span><span class="n">include_external</span><span class="p">,</span>
                    <span class="n">resolve_refs</span><span class="o">=</span><span class="n">resolve_refs</span><span class="p">,</span>
                <span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_gen_col_aliases</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">exprs</span><span class="p">):</span>
        <span class="k">yield from</span> <span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">alias</span> <span class="k">for</span> <span class="n">expr</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_gen_cols</span><span class="p">(</span><span class="n">exprs</span><span class="p">))</span>

<div class="viewcode-block" id="Query.resolve_ref">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/query/index.html#django.db.models.sql.query.Query.resolve_ref">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">resolve_ref</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">allow_joins</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">reuse</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">summarize</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">annotation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">annotations</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">annotation</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">allow_joins</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">alias</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gen_col_aliases</span><span class="p">([</span><span class="n">annotation</span><span class="p">]):</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">alias_map</span><span class="p">[</span><span class="n">alias</span><span class="p">],</span> <span class="n">Join</span><span class="p">):</span>
                        <span class="k">raise</span> <span class="n">FieldError</span><span class="p">(</span>
                            <span class="s2">&quot;Joined field references are not permitted in this query&quot;</span>
                        <span class="p">)</span>
            <span class="k">if</span> <span class="n">summarize</span><span class="p">:</span>
                <span class="c1"># Summarize currently means we are doing an aggregate() query</span>
                <span class="c1"># which is executed as a wrapped subquery if any of the</span>
                <span class="c1"># aggregate() elements reference an existing annotation. In</span>
                <span class="c1"># that case we need to return a Ref to the subquery&#39;s annotation.</span>
                <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">annotation_select</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">FieldError</span><span class="p">(</span>
                        <span class="s2">&quot;Cannot aggregate over the &#39;</span><span class="si">%s</span><span class="s2">&#39; alias. Use annotate() &quot;</span>
                        <span class="s2">&quot;to promote it.&quot;</span> <span class="o">%</span> <span class="n">name</span>
                    <span class="p">)</span>
                <span class="k">return</span> <span class="n">Ref</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">annotation_select</span><span class="p">[</span><span class="n">name</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">annotation</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">field_list</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">LOOKUP_SEP</span><span class="p">)</span>
            <span class="n">annotation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">annotations</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">field_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">annotation</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">transform</span> <span class="ow">in</span> <span class="n">field_list</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
                    <span class="n">annotation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">try_transform</span><span class="p">(</span><span class="n">annotation</span><span class="p">,</span> <span class="n">transform</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">annotation</span>
            <span class="n">join_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup_joins</span><span class="p">(</span>
                <span class="n">field_list</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_meta</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_initial_alias</span><span class="p">(),</span> <span class="n">can_reuse</span><span class="o">=</span><span class="n">reuse</span>
            <span class="p">)</span>
            <span class="n">targets</span><span class="p">,</span> <span class="n">final_alias</span><span class="p">,</span> <span class="n">join_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trim_joins</span><span class="p">(</span>
                <span class="n">join_info</span><span class="o">.</span><span class="n">targets</span><span class="p">,</span> <span class="n">join_info</span><span class="o">.</span><span class="n">joins</span><span class="p">,</span> <span class="n">join_info</span><span class="o">.</span><span class="n">path</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">allow_joins</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">join_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">FieldError</span><span class="p">(</span>
                    <span class="s2">&quot;Joined field references are not permitted in this query&quot;</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">targets</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">FieldError</span><span class="p">(</span>
                    <span class="s2">&quot;Referencing multicolumn fields with F() objects isn&#39;t supported&quot;</span>
                <span class="p">)</span>
            <span class="c1"># Verify that the last lookup in name is a field or a transform:</span>
            <span class="c1"># transform_function() raises FieldError if not.</span>
            <span class="n">transform</span> <span class="o">=</span> <span class="n">join_info</span><span class="o">.</span><span class="n">transform_function</span><span class="p">(</span><span class="n">targets</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">final_alias</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">reuse</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">reuse</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">join_list</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">transform</span></div>


<div class="viewcode-block" id="Query.split_exclude">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/query/index.html#django.db.models.sql.query.Query.split_exclude">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">split_exclude</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filter_expr</span><span class="p">,</span> <span class="n">can_reuse</span><span class="p">,</span> <span class="n">names_with_path</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        When doing an exclude against any kind of N-to-many relation, we need</span>
<span class="sd">        to use a subquery. This method constructs the nested query, given the</span>
<span class="sd">        original exclude filter (filter_expr) and the portion up to the first</span>
<span class="sd">        N-to-many relation field.</span>

<span class="sd">        For example, if the origin filter is ~Q(child__name=&#39;foo&#39;), filter_expr</span>
<span class="sd">        is (&#39;child__name&#39;, &#39;foo&#39;) and can_reuse is a set of joins usable for</span>
<span class="sd">        filters in the original query.</span>

<span class="sd">        We will turn this into equivalent of:</span>
<span class="sd">            WHERE NOT EXISTS(</span>
<span class="sd">                SELECT 1</span>
<span class="sd">                FROM child</span>
<span class="sd">                WHERE name = &#39;foo&#39; AND child.parent_id = parent.id</span>
<span class="sd">                LIMIT 1</span>
<span class="sd">            )</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Generate the inner query.</span>
        <span class="n">query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">)</span>
        <span class="n">query</span><span class="o">.</span><span class="n">_filtered_relations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filtered_relations</span>
        <span class="n">filter_lhs</span><span class="p">,</span> <span class="n">filter_rhs</span> <span class="o">=</span> <span class="n">filter_expr</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">filter_rhs</span><span class="p">,</span> <span class="n">OuterRef</span><span class="p">):</span>
            <span class="n">filter_rhs</span> <span class="o">=</span> <span class="n">OuterRef</span><span class="p">(</span><span class="n">filter_rhs</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">filter_rhs</span><span class="p">,</span> <span class="n">F</span><span class="p">):</span>
            <span class="n">filter_rhs</span> <span class="o">=</span> <span class="n">OuterRef</span><span class="p">(</span><span class="n">filter_rhs</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="n">query</span><span class="o">.</span><span class="n">add_filter</span><span class="p">(</span><span class="n">filter_lhs</span><span class="p">,</span> <span class="n">filter_rhs</span><span class="p">)</span>
        <span class="n">query</span><span class="o">.</span><span class="n">clear_ordering</span><span class="p">(</span><span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># Try to have as simple as possible subquery -&gt; trim leading joins from</span>
        <span class="c1"># the subquery.</span>
        <span class="n">trimmed_prefix</span><span class="p">,</span> <span class="n">contains_louter</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">trim_start</span><span class="p">(</span><span class="n">names_with_path</span><span class="p">)</span>

        <span class="n">col</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">select</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">select_field</span> <span class="o">=</span> <span class="n">col</span><span class="o">.</span><span class="n">target</span>
        <span class="n">alias</span> <span class="o">=</span> <span class="n">col</span><span class="o">.</span><span class="n">alias</span>
        <span class="k">if</span> <span class="n">alias</span> <span class="ow">in</span> <span class="n">can_reuse</span><span class="p">:</span>
            <span class="n">pk</span> <span class="o">=</span> <span class="n">select_field</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">pk</span>
            <span class="c1"># Need to add a restriction so that outer query&#39;s filters are in effect for</span>
            <span class="c1"># the subquery, too.</span>
            <span class="n">query</span><span class="o">.</span><span class="n">bump_prefix</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="n">lookup_class</span> <span class="o">=</span> <span class="n">select_field</span><span class="o">.</span><span class="n">get_lookup</span><span class="p">(</span><span class="s2">&quot;exact&quot;</span><span class="p">)</span>
            <span class="c1"># Note that the query.select[0].alias is different from alias</span>
            <span class="c1"># due to bump_prefix above.</span>
            <span class="n">lookup</span> <span class="o">=</span> <span class="n">lookup_class</span><span class="p">(</span><span class="n">pk</span><span class="o">.</span><span class="n">get_col</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">select</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">alias</span><span class="p">),</span> <span class="n">pk</span><span class="o">.</span><span class="n">get_col</span><span class="p">(</span><span class="n">alias</span><span class="p">))</span>
            <span class="n">query</span><span class="o">.</span><span class="n">where</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">lookup</span><span class="p">,</span> <span class="n">AND</span><span class="p">)</span>
            <span class="n">query</span><span class="o">.</span><span class="n">external_aliases</span><span class="p">[</span><span class="n">alias</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="n">lookup_class</span> <span class="o">=</span> <span class="n">select_field</span><span class="o">.</span><span class="n">get_lookup</span><span class="p">(</span><span class="s2">&quot;exact&quot;</span><span class="p">)</span>
        <span class="n">lookup</span> <span class="o">=</span> <span class="n">lookup_class</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">ResolvedOuterRef</span><span class="p">(</span><span class="n">trimmed_prefix</span><span class="p">))</span>
        <span class="n">query</span><span class="o">.</span><span class="n">where</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">lookup</span><span class="p">,</span> <span class="n">AND</span><span class="p">)</span>
        <span class="n">condition</span><span class="p">,</span> <span class="n">needed_inner</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_filter</span><span class="p">(</span><span class="n">Exists</span><span class="p">(</span><span class="n">query</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">contains_louter</span><span class="p">:</span>
            <span class="n">or_null_condition</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_filter</span><span class="p">(</span>
                <span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">__isnull&quot;</span> <span class="o">%</span> <span class="n">trimmed_prefix</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span>
                <span class="n">current_negated</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">branch_negated</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">can_reuse</span><span class="o">=</span><span class="n">can_reuse</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">condition</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">or_null_condition</span><span class="p">,</span> <span class="n">OR</span><span class="p">)</span>
            <span class="c1"># Note that the end result will be:</span>
            <span class="c1"># (outercol NOT IN innerq AND outercol IS NOT NULL) OR outercol IS NULL.</span>
            <span class="c1"># This might look crazy but due to how IN works, this seems to be</span>
            <span class="c1"># correct. If the IS NOT NULL check is removed then outercol NOT</span>
            <span class="c1"># IN will return UNKNOWN. If the IS NULL check is removed, then if</span>
            <span class="c1"># outercol IS NULL we will not match the row.</span>
        <span class="k">return</span> <span class="n">condition</span><span class="p">,</span> <span class="n">needed_inner</span></div>


<div class="viewcode-block" id="Query.set_empty">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/query/index.html#django.db.models.sql.query.Query.set_empty">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">set_empty</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">where</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">NothingNode</span><span class="p">(),</span> <span class="n">AND</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">query</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">combined_queries</span><span class="p">:</span>
            <span class="n">query</span><span class="o">.</span><span class="n">set_empty</span><span class="p">()</span></div>


<div class="viewcode-block" id="Query.is_empty">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/query/index.html#django.db.models.sql.query.Query.is_empty">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">is_empty</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">any</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">NothingNode</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">where</span><span class="o">.</span><span class="n">children</span><span class="p">)</span></div>


<div class="viewcode-block" id="Query.set_limits">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/query/index.html#django.db.models.sql.query.Query.set_limits">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">set_limits</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">low</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Adjust the limits on the rows retrieved. Use low/high to set these,</span>
<span class="sd">        as it makes it more Pythonic to read and write. When the SQL query is</span>
<span class="sd">        created, convert them to the appropriate offset and limit values.</span>

<span class="sd">        Apply any limits passed in here to the existing constraints. Add low</span>
<span class="sd">        to the current low value and clamp both to any existing high value.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">high</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">high_mark</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">high_mark</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">high_mark</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">low_mark</span> <span class="o">+</span> <span class="n">high</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">high_mark</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">low_mark</span> <span class="o">+</span> <span class="n">high</span>
        <span class="k">if</span> <span class="n">low</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">high_mark</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">low_mark</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">high_mark</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">low_mark</span> <span class="o">+</span> <span class="n">low</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">low_mark</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">low_mark</span> <span class="o">+</span> <span class="n">low</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">low_mark</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">high_mark</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_empty</span><span class="p">()</span></div>


<div class="viewcode-block" id="Query.clear_limits">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/query/index.html#django.db.models.sql.query.Query.clear_limits">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">clear_limits</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Clear any existing limits.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">low_mark</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">high_mark</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">None</span></div>


    <span class="nd">@property</span>
<div class="viewcode-block" id="Query.is_sliced">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/query/index.html#django.db.models.sql.query.Query.is_sliced">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">is_sliced</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">low_mark</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">high_mark</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="Query.has_limit_one">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/query/index.html#django.db.models.sql.query.Query.has_limit_one">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">has_limit_one</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">high_mark</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">high_mark</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">low_mark</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span></div>


<div class="viewcode-block" id="Query.can_filter">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/query/index.html#django.db.models.sql.query.Query.can_filter">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">can_filter</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return True if adding filters to this instance is still possible.</span>

<span class="sd">        Typically, this means no limits or offsets have been put on the results.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_sliced</span></div>


<div class="viewcode-block" id="Query.clear_select_clause">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/query/index.html#django.db.models.sql.query.Query.clear_select_clause">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">clear_select_clause</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Remove all fields from SELECT clause.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">select</span> <span class="o">=</span> <span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">default_cols</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">select_related</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_extra_mask</span><span class="p">(())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_annotation_mask</span><span class="p">(())</span></div>


<div class="viewcode-block" id="Query.clear_select_fields">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/query/index.html#django.db.models.sql.query.Query.clear_select_fields">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">clear_select_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Clear the list of fields to select (but not extra_select columns).</span>
<span class="sd">        Some queryset types completely replace any existing list of select</span>
<span class="sd">        columns.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">select</span> <span class="o">=</span> <span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">values_select</span> <span class="o">=</span> <span class="p">()</span></div>


<div class="viewcode-block" id="Query.add_select_col">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/query/index.html#django.db.models.sql.query.Query.add_select_col">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">add_select_col</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">select</span> <span class="o">+=</span> <span class="p">(</span><span class="n">col</span><span class="p">,)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">values_select</span> <span class="o">+=</span> <span class="p">(</span><span class="n">name</span><span class="p">,)</span></div>


<div class="viewcode-block" id="Query.set_select">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/query/index.html#django.db.models.sql.query.Query.set_select">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">set_select</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cols</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">default_cols</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">select</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">cols</span><span class="p">)</span></div>


<div class="viewcode-block" id="Query.add_distinct_fields">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/query/index.html#django.db.models.sql.query.Query.add_distinct_fields">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">add_distinct_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">field_names</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add and resolve the given fields to the query&#39;s &quot;distinct on&quot; clause.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">distinct_fields</span> <span class="o">=</span> <span class="n">field_names</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">distinct</span> <span class="o">=</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="Query.add_fields">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/query/index.html#django.db.models.sql.query.Query.add_fields">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">add_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field_names</span><span class="p">,</span> <span class="n">allow_m2m</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add the given (model) fields to the select set. Add the field names in</span>
<span class="sd">        the order specified.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">alias</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_initial_alias</span><span class="p">()</span>
        <span class="n">opts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_meta</span><span class="p">()</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">cols</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">field_names</span><span class="p">:</span>
                <span class="c1"># Join promotion note - we must not remove any rows here, so</span>
                <span class="c1"># if there is no existing joins, use outer join.</span>
                <span class="n">join_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup_joins</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">LOOKUP_SEP</span><span class="p">),</span> <span class="n">opts</span><span class="p">,</span> <span class="n">alias</span><span class="p">,</span> <span class="n">allow_many</span><span class="o">=</span><span class="n">allow_m2m</span>
                <span class="p">)</span>
                <span class="n">targets</span><span class="p">,</span> <span class="n">final_alias</span><span class="p">,</span> <span class="n">joins</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trim_joins</span><span class="p">(</span>
                    <span class="n">join_info</span><span class="o">.</span><span class="n">targets</span><span class="p">,</span>
                    <span class="n">join_info</span><span class="o">.</span><span class="n">joins</span><span class="p">,</span>
                    <span class="n">join_info</span><span class="o">.</span><span class="n">path</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">for</span> <span class="n">target</span> <span class="ow">in</span> <span class="n">targets</span><span class="p">:</span>
                    <span class="n">cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">join_info</span><span class="o">.</span><span class="n">transform_function</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">final_alias</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">cols</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_select</span><span class="p">(</span><span class="n">cols</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">MultiJoin</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">FieldError</span><span class="p">(</span><span class="s2">&quot;Invalid field name: &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">FieldError</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">LOOKUP_SEP</span> <span class="ow">in</span> <span class="n">name</span><span class="p">:</span>
                <span class="c1"># For lookups spanning over relationships, show the error</span>
                <span class="c1"># from the model on which the lookup failed.</span>
                <span class="k">raise</span>
            <span class="k">elif</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">annotations</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">FieldError</span><span class="p">(</span>
                    <span class="s2">&quot;Cannot select the &#39;</span><span class="si">%s</span><span class="s2">&#39; alias. Use annotate() to promote &quot;</span>
                    <span class="s2">&quot;it.&quot;</span> <span class="o">%</span> <span class="n">name</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">names</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span>
                    <span class="p">[</span>
                        <span class="o">*</span><span class="n">get_field_names_from_opts</span><span class="p">(</span><span class="n">opts</span><span class="p">),</span>
                        <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">extra</span><span class="p">,</span>
                        <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">annotation_select</span><span class="p">,</span>
                        <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_filtered_relations</span><span class="p">,</span>
                    <span class="p">]</span>
                <span class="p">)</span>
                <span class="k">raise</span> <span class="n">FieldError</span><span class="p">(</span>
                    <span class="s2">&quot;Cannot resolve keyword </span><span class="si">%r</span><span class="s2"> into field. &quot;</span>
                    <span class="s2">&quot;Choices are: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">names</span><span class="p">))</span>
                <span class="p">)</span></div>


<div class="viewcode-block" id="Query.add_ordering">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/query/index.html#django.db.models.sql.query.Query.add_ordering">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">add_ordering</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">ordering</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add items from the &#39;ordering&#39; sequence to the query&#39;s &quot;order by&quot;</span>
<span class="sd">        clause. These items are either field names (not column names) --</span>
<span class="sd">        possibly with a direction prefix (&#39;-&#39; or &#39;?&#39;) -- or OrderBy</span>
<span class="sd">        expressions.</span>

<span class="sd">        If &#39;ordering&#39; is empty, clear all ordering from the query.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">ordering</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">item</span> <span class="o">==</span> <span class="s2">&quot;?&quot;</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">):</span>
                    <span class="n">item</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
                <span class="k">if</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">annotations</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">extra</span> <span class="ow">and</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">extra</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="c1"># names_to_path() validates the lookup. A descriptive</span>
                <span class="c1"># FieldError will be raise if it&#39;s not.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">names_to_path</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">LOOKUP_SEP</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="p">)</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="s2">&quot;resolve_expression&quot;</span><span class="p">):</span>
                <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="s2">&quot;contains_aggregate&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">FieldError</span><span class="p">(</span>
                    <span class="s2">&quot;Using an aggregate in order_by() without also including &quot;</span>
                    <span class="s2">&quot;it in annotate() is not allowed: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">item</span>
                <span class="p">)</span>
        <span class="k">if</span> <span class="n">errors</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">FieldError</span><span class="p">(</span><span class="s2">&quot;Invalid order_by arguments: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">errors</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ordering</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">order_by</span> <span class="o">+=</span> <span class="n">ordering</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">default_ordering</span> <span class="o">=</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="Query.clear_ordering">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/query/index.html#django.db.models.sql.query.Query.clear_ordering">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">clear_ordering</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">clear_default</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Remove any ordering settings if the current query allows it without</span>
<span class="sd">        side effects, set &#39;force&#39; to True to clear the ordering regardless.</span>
<span class="sd">        If &#39;clear_default&#39; is True, there will be no ordering in the resulting</span>
<span class="sd">        query (not even the model&#39;s default).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">force</span> <span class="ow">and</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">is_sliced</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">distinct_fields</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">select_for_update</span>
        <span class="p">):</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">order_by</span> <span class="o">=</span> <span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">extra_order_by</span> <span class="o">=</span> <span class="p">()</span>
        <span class="k">if</span> <span class="n">clear_default</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">default_ordering</span> <span class="o">=</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="Query.set_group_by">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/query/index.html#django.db.models.sql.query.Query.set_group_by">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">set_group_by</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">allow_aliases</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Expand the GROUP BY clause required by the query.</span>

<span class="sd">        This will usually be the set of all non-aggregate fields in the</span>
<span class="sd">        return data. If the database backend supports grouping by the</span>
<span class="sd">        primary key, and the query would be equivalent, the optimization</span>
<span class="sd">        will be made automatically.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">allow_aliases</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">values_select</span><span class="p">:</span>
            <span class="c1"># If grouping by aliases is allowed assign selected value aliases</span>
            <span class="c1"># by moving them to annotations.</span>
            <span class="n">group_by_annotations</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">values_select</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">alias</span><span class="p">,</span> <span class="n">expr</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values_select</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">select</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">Col</span><span class="p">):</span>
                    <span class="n">values_select</span><span class="p">[</span><span class="n">alias</span><span class="p">]</span> <span class="o">=</span> <span class="n">expr</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">group_by_annotations</span><span class="p">[</span><span class="n">alias</span><span class="p">]</span> <span class="o">=</span> <span class="n">expr</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">annotations</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">group_by_annotations</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">annotations</span><span class="p">}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">append_annotation_mask</span><span class="p">(</span><span class="n">group_by_annotations</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">select</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">values_select</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">values_select</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">values_select</span><span class="p">)</span>
        <span class="n">group_by</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">select</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">alias</span><span class="p">,</span> <span class="n">annotation</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">annotation_select</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">group_by_cols</span> <span class="o">:=</span> <span class="n">annotation</span><span class="o">.</span><span class="n">get_group_by_cols</span><span class="p">()):</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">allow_aliases</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">annotation</span><span class="o">.</span><span class="n">contains_aggregate</span><span class="p">:</span>
                <span class="n">group_by</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Ref</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="n">annotation</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">group_by</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">group_by_cols</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">group_by</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">group_by</span><span class="p">)</span></div>


<div class="viewcode-block" id="Query.add_select_related">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/query/index.html#django.db.models.sql.query.Query.add_select_related">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">add_select_related</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fields</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set up the select_related data structure so that we only select</span>
<span class="sd">        certain related models (as opposed to all models, when</span>
<span class="sd">        self.select_related=True).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">select_related</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
            <span class="n">field_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">field_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">select_related</span>
        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">:</span>
            <span class="n">d</span> <span class="o">=</span> <span class="n">field_dict</span>
            <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">field</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">LOOKUP_SEP</span><span class="p">):</span>
                <span class="n">d</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">part</span><span class="p">,</span> <span class="p">{})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">select_related</span> <span class="o">=</span> <span class="n">field_dict</span></div>


<div class="viewcode-block" id="Query.add_extra">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/query/index.html#django.db.models.sql.query.Query.add_extra">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">add_extra</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">select</span><span class="p">,</span> <span class="n">select_params</span><span class="p">,</span> <span class="n">where</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">tables</span><span class="p">,</span> <span class="n">order_by</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add data to the various extra_* attributes for user-created additions</span>
<span class="sd">        to the query.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">select</span><span class="p">:</span>
            <span class="c1"># We need to pair any placeholder markers in the &#39;select&#39;</span>
            <span class="c1"># dictionary with their parameters in &#39;select_params&#39; so that</span>
            <span class="c1"># subsequent updates to the select dictionary also adjust the</span>
            <span class="c1"># parameters appropriately.</span>
            <span class="n">select_pairs</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">if</span> <span class="n">select_params</span><span class="p">:</span>
                <span class="n">param_iter</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">select_params</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">param_iter</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">([])</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">select</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">check_alias</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                <span class="n">entry</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span>
                <span class="n">entry_params</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">pos</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">while</span> <span class="n">pos</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">pos</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">entry</span><span class="p">[</span><span class="n">pos</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;%&quot;</span><span class="p">:</span>
                        <span class="n">entry_params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">param_iter</span><span class="p">))</span>
                    <span class="n">pos</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">pos</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span>
                <span class="n">select_pairs</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">entry_params</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">extra</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">select_pairs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">where</span> <span class="ow">or</span> <span class="n">params</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">where</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">ExtraWhere</span><span class="p">(</span><span class="n">where</span><span class="p">,</span> <span class="n">params</span><span class="p">),</span> <span class="n">AND</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">tables</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">extra_tables</span> <span class="o">+=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">tables</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">order_by</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">extra_order_by</span> <span class="o">=</span> <span class="n">order_by</span></div>


<div class="viewcode-block" id="Query.clear_deferred_loading">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/query/index.html#django.db.models.sql.query.Query.clear_deferred_loading">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">clear_deferred_loading</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Remove any fields from the deferred loading set.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">deferred_loading</span> <span class="o">=</span> <span class="p">(</span><span class="nb">frozenset</span><span class="p">(),</span> <span class="kc">True</span><span class="p">)</span></div>


<div class="viewcode-block" id="Query.add_deferred_loading">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/query/index.html#django.db.models.sql.query.Query.add_deferred_loading">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">add_deferred_loading</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field_names</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add the given list of model field names to the set of fields to</span>
<span class="sd">        exclude from loading from the database when automatic column selection</span>
<span class="sd">        is done. Add the new field names to any existing field names that</span>
<span class="sd">        are deferred (or removed from any existing field names that are marked</span>
<span class="sd">        as the only ones for immediate loading).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Fields on related models are stored in the literal double-underscore</span>
        <span class="c1"># format, so that we can use a set datastructure. We do the foo__bar</span>
        <span class="c1"># splitting and handling when computing the SQL column names (as part of</span>
        <span class="c1"># get_columns()).</span>
        <span class="n">existing</span><span class="p">,</span> <span class="n">defer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">deferred_loading</span>
        <span class="k">if</span> <span class="n">defer</span><span class="p">:</span>
            <span class="c1"># Add to existing deferred names.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">deferred_loading</span> <span class="o">=</span> <span class="n">existing</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">field_names</span><span class="p">),</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Remove names from the set of any existing &quot;immediate load&quot; names.</span>
            <span class="k">if</span> <span class="n">new_existing</span> <span class="o">:=</span> <span class="n">existing</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">field_names</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">deferred_loading</span> <span class="o">=</span> <span class="n">new_existing</span><span class="p">,</span> <span class="kc">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">clear_deferred_loading</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">new_only</span> <span class="o">:=</span> <span class="nb">set</span><span class="p">(</span><span class="n">field_names</span><span class="p">)</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">existing</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">deferred_loading</span> <span class="o">=</span> <span class="n">new_only</span><span class="p">,</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="Query.add_immediate_loading">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/query/index.html#django.db.models.sql.query.Query.add_immediate_loading">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">add_immediate_loading</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field_names</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add the given list of model field names to the set of fields to</span>
<span class="sd">        retrieve when the SQL is executed (&quot;immediate loading&quot; fields). The</span>
<span class="sd">        field names replace any existing immediate loading field names. If</span>
<span class="sd">        there are field names already specified for deferred loading, remove</span>
<span class="sd">        those names from the new field_names before storing the new names</span>
<span class="sd">        for immediate loading. (That is, immediate loading overrides any</span>
<span class="sd">        existing immediate values, but respects existing deferrals.)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">existing</span><span class="p">,</span> <span class="n">defer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">deferred_loading</span>
        <span class="n">field_names</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">field_names</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;pk&quot;</span> <span class="ow">in</span> <span class="n">field_names</span><span class="p">:</span>
            <span class="n">field_names</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s2">&quot;pk&quot;</span><span class="p">)</span>
            <span class="n">field_names</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_meta</span><span class="p">()</span><span class="o">.</span><span class="n">pk</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">defer</span><span class="p">:</span>
            <span class="c1"># Remove any existing deferred names from the current set before</span>
            <span class="c1"># setting the new names.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">deferred_loading</span> <span class="o">=</span> <span class="n">field_names</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">existing</span><span class="p">),</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Replace any existing &quot;immediate load&quot; field names.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">deferred_loading</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">(</span><span class="n">field_names</span><span class="p">),</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="Query.set_annotation_mask">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/query/index.html#django.db.models.sql.query.Query.set_annotation_mask">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">set_annotation_mask</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">names</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set the mask of annotations that will be returned by the SELECT.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">names</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">annotation_select_mask</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">annotation_select_mask</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">names</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_annotation_select_cache</span> <span class="o">=</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="Query.append_annotation_mask">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/query/index.html#django.db.models.sql.query.Query.append_annotation_mask">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">append_annotation_mask</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">names</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">annotation_select_mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_annotation_mask</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">annotation_select_mask</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">names</span><span class="p">))</span></div>


<div class="viewcode-block" id="Query.set_extra_mask">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/query/index.html#django.db.models.sql.query.Query.set_extra_mask">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">set_extra_mask</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">names</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set the mask of extra select items that will be returned by SELECT.</span>
<span class="sd">        Don&#39;t remove them from the Query since they might be used later.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">names</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">extra_select_mask</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">extra_select_mask</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">names</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_extra_select_cache</span> <span class="o">=</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="Query.set_values">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/query/index.html#django.db.models.sql.query.Query.set_values">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">set_values</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fields</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">select_related</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clear_deferred_loading</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clear_select_fields</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">has_select_fields</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="n">fields</span><span class="p">:</span>
            <span class="n">field_names</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">extra_names</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">annotation_names</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">extra</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">annotations</span><span class="p">:</span>
                <span class="c1"># Shortcut - if there are no extra or annotations, then</span>
                <span class="c1"># the values() clause must be just field names.</span>
                <span class="n">field_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">fields</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">default_cols</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">extra_select</span><span class="p">:</span>
                        <span class="n">extra_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">annotation_select</span><span class="p">:</span>
                        <span class="n">annotation_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">field_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_extra_mask</span><span class="p">(</span><span class="n">extra_names</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_annotation_mask</span><span class="p">(</span><span class="n">annotation_names</span><span class="p">)</span>
            <span class="n">selected</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">(</span><span class="n">field_names</span> <span class="o">+</span> <span class="n">extra_names</span> <span class="o">+</span> <span class="n">annotation_names</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">field_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">attname</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">concrete_fields</span><span class="p">]</span>
            <span class="n">selected</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">(</span><span class="n">field_names</span><span class="p">)</span>
        <span class="c1"># Selected annotations must be known before setting the GROUP BY</span>
        <span class="c1"># clause.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">group_by</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_fields</span><span class="p">(</span>
                <span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">attname</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">concrete_fields</span><span class="p">),</span> <span class="kc">False</span>
            <span class="p">)</span>
            <span class="c1"># Disable GROUP BY aliases to avoid orphaning references to the</span>
            <span class="c1"># SELECT clause which is about to be cleared.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_group_by</span><span class="p">(</span><span class="n">allow_aliases</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">clear_select_fields</span><span class="p">()</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">group_by</span><span class="p">:</span>
            <span class="c1"># Resolve GROUP BY annotation references if they are not part of</span>
            <span class="c1"># the selected fields anymore.</span>
            <span class="n">group_by</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">expr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">group_by</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">Ref</span><span class="p">)</span> <span class="ow">and</span> <span class="n">expr</span><span class="o">.</span><span class="n">refs</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">selected</span><span class="p">:</span>
                    <span class="n">expr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">annotations</span><span class="p">[</span><span class="n">expr</span><span class="o">.</span><span class="n">refs</span><span class="p">]</span>
                <span class="n">group_by</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">group_by</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">group_by</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">values_select</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">field_names</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_fields</span><span class="p">(</span><span class="n">field_names</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span></div>


    <span class="nd">@property</span>
<div class="viewcode-block" id="Query.annotation_select">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/query/index.html#django.db.models.sql.query.Query.annotation_select">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">annotation_select</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the dictionary of aggregate columns that are not masked and</span>
<span class="sd">        should be used in the SELECT clause. Cache this result for performance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_annotation_select_cache</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_annotation_select_cache</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">annotations</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{}</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">annotation_select_mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_annotation_select_cache</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">k</span><span class="p">:</span> <span class="n">v</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">annotations</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">annotation_select_mask</span>
            <span class="p">}</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_annotation_select_cache</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">annotations</span></div>


    <span class="nd">@property</span>
<div class="viewcode-block" id="Query.extra_select">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/query/index.html#django.db.models.sql.query.Query.extra_select">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">extra_select</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extra_select_cache</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extra_select_cache</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">extra</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{}</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">extra_select_mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_extra_select_cache</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">extra</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">extra_select_mask</span>
            <span class="p">}</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extra_select_cache</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">extra</span></div>


<div class="viewcode-block" id="Query.trim_start">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/query/index.html#django.db.models.sql.query.Query.trim_start">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">trim_start</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">names_with_path</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Trim joins from the start of the join path. The candidates for trim</span>
<span class="sd">        are the PathInfos in names_with_path structure that are m2m joins.</span>

<span class="sd">        Also set the select column so the start matches the join.</span>

<span class="sd">        This method is meant to be used for generating the subquery joins &amp;</span>
<span class="sd">        cols in split_exclude().</span>

<span class="sd">        Return a lookup usable for doing outerq.filter(lookup=self) and a</span>
<span class="sd">        boolean indicating if the joins in the prefix contain a LEFT OUTER join.</span>
<span class="sd">        _&quot;&quot;&quot;</span>
        <span class="n">all_paths</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">paths</span> <span class="ow">in</span> <span class="n">names_with_path</span><span class="p">:</span>
            <span class="n">all_paths</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">paths</span><span class="p">)</span>
        <span class="n">contains_louter</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1"># Trim and operate only on tables that were generated for</span>
        <span class="c1"># the lookup part of the query. That is, avoid trimming</span>
        <span class="c1"># joins generated for F() expressions.</span>
        <span class="n">lookup_tables</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">alias_map</span> <span class="k">if</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lookup_joins</span> <span class="ow">or</span> <span class="n">t</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_table</span>
        <span class="p">]</span>
        <span class="k">for</span> <span class="n">trimmed_paths</span><span class="p">,</span> <span class="n">path</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">all_paths</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">m2m</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">alias_map</span><span class="p">[</span><span class="n">lookup_tables</span><span class="p">[</span><span class="n">trimmed_paths</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">join_type</span> <span class="o">==</span> <span class="n">LOUTER</span><span class="p">:</span>
                <span class="n">contains_louter</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">alias</span> <span class="o">=</span> <span class="n">lookup_tables</span><span class="p">[</span><span class="n">trimmed_paths</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">unref_alias</span><span class="p">(</span><span class="n">alias</span><span class="p">)</span>
        <span class="c1"># The path.join_field is a Rel, lets get the other side&#39;s field</span>
        <span class="n">join_field</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">join_field</span><span class="o">.</span><span class="n">field</span>
        <span class="c1"># Build the filter prefix.</span>
        <span class="n">paths_in_prefix</span> <span class="o">=</span> <span class="n">trimmed_paths</span>
        <span class="n">trimmed_prefix</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">names_with_path</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">paths_in_prefix</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">trimmed_prefix</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="n">paths_in_prefix</span> <span class="o">-=</span> <span class="nb">len</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="n">trimmed_prefix</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">join_field</span><span class="o">.</span><span class="n">foreign_related_fields</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="n">trimmed_prefix</span> <span class="o">=</span> <span class="n">LOOKUP_SEP</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">trimmed_prefix</span><span class="p">)</span>
        <span class="c1"># Lets still see if we can trim the first join from the inner query</span>
        <span class="c1"># (that is, self). We can&#39;t do this for:</span>
        <span class="c1"># - LEFT JOINs because we would miss those rows that have nothing on</span>
        <span class="c1">#   the outer side,</span>
        <span class="c1"># - INNER JOINs from filtered relations because we would miss their</span>
        <span class="c1">#   filters.</span>
        <span class="n">first_join</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">alias_map</span><span class="p">[</span><span class="n">lookup_tables</span><span class="p">[</span><span class="n">trimmed_paths</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]]</span>
        <span class="k">if</span> <span class="n">first_join</span><span class="o">.</span><span class="n">join_type</span> <span class="o">!=</span> <span class="n">LOUTER</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">first_join</span><span class="o">.</span><span class="n">filtered_relation</span><span class="p">:</span>
            <span class="n">select_fields</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">join_field</span><span class="o">.</span><span class="n">related_fields</span><span class="p">]</span>
            <span class="n">select_alias</span> <span class="o">=</span> <span class="n">lookup_tables</span><span class="p">[</span><span class="n">trimmed_paths</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">unref_alias</span><span class="p">(</span><span class="n">lookup_tables</span><span class="p">[</span><span class="n">trimmed_paths</span><span class="p">])</span>
            <span class="n">extra_restriction</span> <span class="o">=</span> <span class="n">join_field</span><span class="o">.</span><span class="n">get_extra_restriction</span><span class="p">(</span>
                <span class="kc">None</span><span class="p">,</span> <span class="n">lookup_tables</span><span class="p">[</span><span class="n">trimmed_paths</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">extra_restriction</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">where</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">extra_restriction</span><span class="p">,</span> <span class="n">AND</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># TODO: It might be possible to trim more joins from the start of the</span>
            <span class="c1"># inner query if it happens to have a longer join chain containing the</span>
            <span class="c1"># values in select_fields. Lets punt this one for now.</span>
            <span class="n">select_fields</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">join_field</span><span class="o">.</span><span class="n">related_fields</span><span class="p">]</span>
            <span class="n">select_alias</span> <span class="o">=</span> <span class="n">lookup_tables</span><span class="p">[</span><span class="n">trimmed_paths</span><span class="p">]</span>
        <span class="c1"># The found starting point is likely a join_class instead of a</span>
        <span class="c1"># base_table_class reference. But the first entry in the query&#39;s FROM</span>
        <span class="c1"># clause must not be a JOIN.</span>
        <span class="k">for</span> <span class="n">table</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">alias_map</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">alias_refcount</span><span class="p">[</span><span class="n">table</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">alias_map</span><span class="p">[</span><span class="n">table</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_table_class</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">alias_map</span><span class="p">[</span><span class="n">table</span><span class="p">]</span><span class="o">.</span><span class="n">table_name</span><span class="p">,</span>
                    <span class="n">table</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">break</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_select</span><span class="p">([</span><span class="n">f</span><span class="o">.</span><span class="n">get_col</span><span class="p">(</span><span class="n">select_alias</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">select_fields</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">trimmed_prefix</span><span class="p">,</span> <span class="n">contains_louter</span></div>


<div class="viewcode-block" id="Query.is_nullable">
<a class="viewcode-back" href="../../../../../autoapi/django/db/models/sql/query/index.html#django.db.models.sql.query.Query.is_nullable">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">is_nullable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check if the given field should be treated as nullable.</span>

<span class="sd">        Some backends treat &#39;&#39; as null and Django treats such fields as</span>
<span class="sd">        nullable for those backends. In such situations field.null can be</span>
<span class="sd">        False even if we should treat the field as nullable.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># We need to use DEFAULT_DB_ALIAS here, as QuerySet does not have</span>
        <span class="c1"># (nor should it have) knowledge of which connection is going to be</span>
        <span class="c1"># used. The proper fix would be to defer all decisions where</span>
        <span class="c1"># is_nullable() is needed to the compiler stage, but that is not easy</span>
        <span class="c1"># to do currently.</span>
        <span class="k">return</span> <span class="n">field</span><span class="o">.</span><span class="n">null</span> <span class="ow">or</span> <span class="p">(</span>
            <span class="n">field</span><span class="o">.</span><span class="n">empty_strings_allowed</span>
            <span class="ow">and</span> <span class="n">connections</span><span class="p">[</span><span class="n">DEFAULT_DB_ALIAS</span><span class="p">]</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">interprets_empty_strings_as_nulls</span>
        <span class="p">)</span></div>
</div>



<span class="k">def</span><span class="w"> </span><span class="nf">get_order_dir</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;ASC&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return the field name and direction for an order specification. For</span>
<span class="sd">    example, &#39;-foo&#39; is returned as (&#39;foo&#39;, &#39;DESC&#39;).</span>

<span class="sd">    The &#39;default&#39; param is used to indicate which way no prefix (or a &#39;+&#39;</span>
<span class="sd">    prefix) should sort. The &#39;-&#39; prefix always sorts the opposite way.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">dirn</span> <span class="o">=</span> <span class="n">ORDER_DIR</span><span class="p">[</span><span class="n">default</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">field</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;-&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">field</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">dirn</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">field</span><span class="p">,</span> <span class="n">dirn</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>


<span class="k">class</span><span class="w"> </span><span class="nc">JoinPromoter</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A class to abstract away join promotion problems for complex filter</span>
<span class="sd">    conditions.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">connector</span><span class="p">,</span> <span class="n">num_children</span><span class="p">,</span> <span class="n">negated</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connector</span> <span class="o">=</span> <span class="n">connector</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">negated</span> <span class="o">=</span> <span class="n">negated</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">negated</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">connector</span> <span class="o">==</span> <span class="n">AND</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">effective_connector</span> <span class="o">=</span> <span class="n">OR</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">effective_connector</span> <span class="o">=</span> <span class="n">AND</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">effective_connector</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connector</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_children</span> <span class="o">=</span> <span class="n">num_children</span>
        <span class="c1"># Maps of table alias to how many times it is seen as required for</span>
        <span class="c1"># inner and/or outer joins.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">votes</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__qualname__</span><span class="si">}</span><span class="s2">(connector=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">connector</span><span class="si">!r}</span><span class="s2">, &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;num_children=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">num_children</span><span class="si">!r}</span><span class="s2">, negated=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">negated</span><span class="si">!r}</span><span class="s2">)&quot;</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">add_votes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">votes</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add single vote per item to self.votes. Parameter can be any</span>
<span class="sd">        iterable.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">votes</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">votes</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">update_join_types</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Change join types so that the generated query is as efficient as</span>
<span class="sd">        possible, but still correct. So, change as many joins as possible</span>
<span class="sd">        to INNER, but don&#39;t make OUTER joins INNER if that could remove</span>
<span class="sd">        results from the query.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">to_promote</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">to_demote</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="c1"># The effective_connector is used so that NOT (a AND b) is treated</span>
        <span class="c1"># similarly to (a OR b) for join promotion.</span>
        <span class="k">for</span> <span class="n">table</span><span class="p">,</span> <span class="n">votes</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">votes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># We must use outer joins in OR case when the join isn&#39;t contained</span>
            <span class="c1"># in all of the joins. Otherwise the INNER JOIN itself could remove</span>
            <span class="c1"># valid results. Consider the case where a model with rel_a and</span>
            <span class="c1"># rel_b relations is queried with rel_a__col=1 | rel_b__col=2. Now,</span>
            <span class="c1"># if rel_a join doesn&#39;t produce any results is null (for example</span>
            <span class="c1"># reverse foreign key or null value in direct foreign key), and</span>
            <span class="c1"># there is a matching row in rel_b with col=2, then an INNER join</span>
            <span class="c1"># to rel_a would remove a valid match from the query. So, we need</span>
            <span class="c1"># to promote any existing INNER to LOUTER (it is possible this</span>
            <span class="c1"># promotion in turn will be demoted later on).</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">effective_connector</span> <span class="o">==</span> <span class="n">OR</span> <span class="ow">and</span> <span class="n">votes</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_children</span><span class="p">:</span>
                <span class="n">to_promote</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">table</span><span class="p">)</span>
            <span class="c1"># If connector is AND and there is a filter that can match only</span>
            <span class="c1"># when there is a joinable row, then use INNER. For example, in</span>
            <span class="c1"># rel_a__col=1 &amp; rel_b__col=2, if either of the rels produce NULL</span>
            <span class="c1"># as join output, then the col=1 or col=2 can&#39;t match (as</span>
            <span class="c1"># NULL=anything is always false).</span>
            <span class="c1"># For the OR case, if all children voted for a join to be inner,</span>
            <span class="c1"># then we can use INNER for the join. For example:</span>
            <span class="c1">#     (rel_a__col__icontains=Alex | rel_a__col__icontains=Russell)</span>
            <span class="c1"># then if rel_a doesn&#39;t produce any rows, the whole condition</span>
            <span class="c1"># can&#39;t match. Hence we can safely use INNER join.</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">effective_connector</span> <span class="o">==</span> <span class="n">AND</span> <span class="ow">or</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">effective_connector</span> <span class="o">==</span> <span class="n">OR</span> <span class="ow">and</span> <span class="n">votes</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_children</span>
            <span class="p">):</span>
                <span class="n">to_demote</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">table</span><span class="p">)</span>
            <span class="c1"># Finally, what happens in cases where we have:</span>
            <span class="c1">#    (rel_a__col=1|rel_b__col=2) &amp; rel_a__col__gte=0</span>
            <span class="c1"># Now, we first generate the OR clause, and promote joins for it</span>
            <span class="c1"># in the first if branch above. Both rel_a and rel_b are promoted</span>
            <span class="c1"># to LOUTER joins. After that we do the AND case. The OR case</span>
            <span class="c1"># voted no inner joins but the rel_a__col__gte=0 votes inner join</span>
            <span class="c1"># for rel_a. We demote it back to INNER join (in AND case a single</span>
            <span class="c1"># vote is enough). The demotion is OK, if rel_a doesn&#39;t produce</span>
            <span class="c1"># rows, then the rel_a__col__gte=0 clause can&#39;t be true, and thus</span>
            <span class="c1"># the whole clause must be false. So, it is safe to use INNER</span>
            <span class="c1"># join.</span>
            <span class="c1"># Note that in this example we could just as well have the __gte</span>
            <span class="c1"># clause and the OR clause swapped. Or we could replace the __gte</span>
            <span class="c1"># clause with an OR clause containing rel_a__col=1|rel_a__col=2,</span>
            <span class="c1"># and again we could safely demote to INNER.</span>
        <span class="n">query</span><span class="o">.</span><span class="n">promote_joins</span><span class="p">(</span><span class="n">to_promote</span><span class="p">)</span>
        <span class="n">query</span><span class="o">.</span><span class="n">demote_joins</span><span class="p">(</span><span class="n">to_demote</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">to_demote</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright .</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>