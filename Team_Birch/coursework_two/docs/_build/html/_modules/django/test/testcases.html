

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>django.test.testcases &mdash; Coursework Two 1.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../../_static/graphviz.css?v=4ae1632d" />

  
      <script src="../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../_static/documentation_options.js?v=f2a433a1"></script>
      <script src="../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            Coursework Two
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../installation_guide.html">Installation Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../usage_instructions.html">Usage Instructions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../architecture_overview.html">Architecture Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../autoapi/index.html">API Reference</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Coursework Two</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
          <li class="breadcrumb-item"><a href="../../django.html">django</a></li>
      <li class="breadcrumb-item active">django.test.testcases</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for django.test.testcases</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span><span class="w"> </span><span class="nn">difflib</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">inspect</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">posixpath</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">threading</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">unittest</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">collections</span><span class="w"> </span><span class="kn">import</span> <span class="n">Counter</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">contextlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">contextmanager</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">copy</span><span class="w"> </span><span class="kn">import</span> <span class="n">copy</span><span class="p">,</span> <span class="n">deepcopy</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">difflib</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_close_matches</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">functools</span><span class="w"> </span><span class="kn">import</span> <span class="n">wraps</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">unittest.suite</span><span class="w"> </span><span class="kn">import</span> <span class="n">_DebugResult</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">unittest.util</span><span class="w"> </span><span class="kn">import</span> <span class="n">safe_repr</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">urllib.parse</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">parse_qsl</span><span class="p">,</span>
    <span class="n">unquote</span><span class="p">,</span>
    <span class="n">urlencode</span><span class="p">,</span>
    <span class="n">urljoin</span><span class="p">,</span>
    <span class="n">urlparse</span><span class="p">,</span>
    <span class="n">urlsplit</span><span class="p">,</span>
    <span class="n">urlunparse</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">urllib.request</span><span class="w"> </span><span class="kn">import</span> <span class="n">url2pathname</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">asgiref.sync</span><span class="w"> </span><span class="kn">import</span> <span class="n">async_to_sync</span><span class="p">,</span> <span class="n">iscoroutinefunction</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.apps</span><span class="w"> </span><span class="kn">import</span> <span class="n">apps</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.conf</span><span class="w"> </span><span class="kn">import</span> <span class="n">settings</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.core</span><span class="w"> </span><span class="kn">import</span> <span class="n">mail</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.core.exceptions</span><span class="w"> </span><span class="kn">import</span> <span class="n">ImproperlyConfigured</span><span class="p">,</span> <span class="n">ValidationError</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.core.files</span><span class="w"> </span><span class="kn">import</span> <span class="n">locks</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.core.handlers.wsgi</span><span class="w"> </span><span class="kn">import</span> <span class="n">WSGIHandler</span><span class="p">,</span> <span class="n">get_path_info</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.core.management</span><span class="w"> </span><span class="kn">import</span> <span class="n">call_command</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.core.management.color</span><span class="w"> </span><span class="kn">import</span> <span class="n">no_style</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.core.management.sql</span><span class="w"> </span><span class="kn">import</span> <span class="n">emit_post_migrate_signal</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.core.servers.basehttp</span><span class="w"> </span><span class="kn">import</span> <span class="n">ThreadedWSGIServer</span><span class="p">,</span> <span class="n">WSGIRequestHandler</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.core.signals</span><span class="w"> </span><span class="kn">import</span> <span class="n">setting_changed</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.db</span><span class="w"> </span><span class="kn">import</span> <span class="n">DEFAULT_DB_ALIAS</span><span class="p">,</span> <span class="n">connection</span><span class="p">,</span> <span class="n">connections</span><span class="p">,</span> <span class="n">transaction</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.forms.fields</span><span class="w"> </span><span class="kn">import</span> <span class="n">CharField</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.http</span><span class="w"> </span><span class="kn">import</span> <span class="n">QueryDict</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.http.request</span><span class="w"> </span><span class="kn">import</span> <span class="n">split_domain_port</span><span class="p">,</span> <span class="n">validate_host</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.http.response</span><span class="w"> </span><span class="kn">import</span> <span class="n">HttpResponseBase</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.test.client</span><span class="w"> </span><span class="kn">import</span> <span class="n">AsyncClient</span><span class="p">,</span> <span class="n">Client</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.test.html</span><span class="w"> </span><span class="kn">import</span> <span class="n">HTMLParseError</span><span class="p">,</span> <span class="n">parse_html</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.test.signals</span><span class="w"> </span><span class="kn">import</span> <span class="n">template_rendered</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.test.utils</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">CaptureQueriesContext</span><span class="p">,</span>
    <span class="n">ContextList</span><span class="p">,</span>
    <span class="n">compare_xml</span><span class="p">,</span>
    <span class="n">modify_settings</span><span class="p">,</span>
    <span class="n">override_settings</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.utils.deprecation</span><span class="w"> </span><span class="kn">import</span> <span class="n">RemovedInDjango50Warning</span><span class="p">,</span> <span class="n">RemovedInDjango51Warning</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.utils.functional</span><span class="w"> </span><span class="kn">import</span> <span class="n">classproperty</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.utils.version</span><span class="w"> </span><span class="kn">import</span> <span class="n">PY310</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.views.static</span><span class="w"> </span><span class="kn">import</span> <span class="n">serve</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;django.test&quot;</span><span class="p">)</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">(</span>
    <span class="s2">&quot;TestCase&quot;</span><span class="p">,</span>
    <span class="s2">&quot;TransactionTestCase&quot;</span><span class="p">,</span>
    <span class="s2">&quot;SimpleTestCase&quot;</span><span class="p">,</span>
    <span class="s2">&quot;skipIfDBFeature&quot;</span><span class="p">,</span>
    <span class="s2">&quot;skipUnlessDBFeature&quot;</span><span class="p">,</span>
<span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">to_list</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Put value into a list if it&#39;s not already one.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">value</span> <span class="o">=</span> <span class="p">[</span><span class="n">value</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">value</span>


<span class="k">def</span><span class="w"> </span><span class="nf">assert_and_parse_html</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">html</span><span class="p">,</span> <span class="n">user_msg</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">dom</span> <span class="o">=</span> <span class="n">parse_html</span><span class="p">(</span><span class="n">html</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">HTMLParseError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">standardMsg</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_formatMessage</span><span class="p">(</span><span class="n">user_msg</span><span class="p">,</span> <span class="n">standardMsg</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">dom</span>


<span class="k">class</span><span class="w"> </span><span class="nc">_AssertNumQueriesContext</span><span class="p">(</span><span class="n">CaptureQueriesContext</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">test_case</span><span class="p">,</span> <span class="n">num</span><span class="p">,</span> <span class="n">connection</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_case</span> <span class="o">=</span> <span class="n">test_case</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num</span> <span class="o">=</span> <span class="n">num</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_value</span><span class="p">,</span> <span class="n">traceback</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__exit__</span><span class="p">(</span><span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_value</span><span class="p">,</span> <span class="n">traceback</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">exc_type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">executed</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_case</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
            <span class="n">executed</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">num</span><span class="p">,</span>
            <span class="s2">&quot;</span><span class="si">%d</span><span class="s2"> queries executed, </span><span class="si">%d</span><span class="s2"> expected</span><span class="se">\n</span><span class="s2">Captured queries were:</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span>
            <span class="o">%</span> <span class="p">(</span>
                <span class="n">executed</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">num</span><span class="p">,</span>
                <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="s2">&quot;</span><span class="si">%d</span><span class="s2">. </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">query</span><span class="p">[</span><span class="s2">&quot;sql&quot;</span><span class="p">])</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">query</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">captured_queries</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="p">),</span>
            <span class="p">),</span>
        <span class="p">)</span>


<span class="k">class</span><span class="w"> </span><span class="nc">_AssertTemplateUsedContext</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">test_case</span><span class="p">,</span> <span class="n">template_name</span><span class="p">,</span> <span class="n">msg_prefix</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_case</span> <span class="o">=</span> <span class="n">test_case</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">template_name</span> <span class="o">=</span> <span class="n">template_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">msg_prefix</span> <span class="o">=</span> <span class="n">msg_prefix</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">count</span> <span class="o">=</span> <span class="n">count</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">rendered_templates</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rendered_template_names</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">context</span> <span class="o">=</span> <span class="n">ContextList</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">on_template_render</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sender</span><span class="p">,</span> <span class="n">signal</span><span class="p">,</span> <span class="n">template</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rendered_templates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">template</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rendered_template_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">template</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">copy</span><span class="p">(</span><span class="n">context</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">test</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_case</span><span class="o">.</span><span class="n">_assert_template_used</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">template_name</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rendered_template_names</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">msg_prefix</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">count</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">template_rendered</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">on_template_render</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_value</span><span class="p">,</span> <span class="n">traceback</span><span class="p">):</span>
        <span class="n">template_rendered</span><span class="o">.</span><span class="n">disconnect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">on_template_render</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">exc_type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test</span><span class="p">()</span>


<span class="k">class</span><span class="w"> </span><span class="nc">_AssertTemplateNotUsedContext</span><span class="p">(</span><span class="n">_AssertTemplateUsedContext</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">test</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_case</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">template_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rendered_template_names</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">msg_prefix</span><span class="si">}</span><span class="s2">Template &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">template_name</span><span class="si">}</span><span class="s2">&#39; was used &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;unexpectedly in rendering the response&quot;</span><span class="p">,</span>
        <span class="p">)</span>


<span class="k">class</span><span class="w"> </span><span class="nc">DatabaseOperationForbidden</span><span class="p">(</span><span class="ne">AssertionError</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="k">class</span><span class="w"> </span><span class="nc">_DatabaseFailure</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wrapped</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wrapped</span> <span class="o">=</span> <span class="n">wrapped</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">message</span> <span class="o">=</span> <span class="n">message</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">DatabaseOperationForbidden</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">message</span><span class="p">)</span>


<span class="c1"># RemovedInDjango50Warning</span>
<span class="k">class</span><span class="w"> </span><span class="nc">_AssertFormErrorDeprecationHelper</span><span class="p">:</span>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">assertFormError</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">form</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">errors</span><span class="p">,</span> <span class="n">msg_prefix</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Search through all the rendered contexts of the `response` for a form named</span>
<span class="sd">        `form` then dispatch to the new assertFormError() using that instance.</span>
<span class="sd">        If multiple contexts contain the form, they&#39;re all checked in order and any</span>
<span class="sd">        failure will abort (this matches the old behavior).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">warning_msg</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Passing response to assertFormError() is deprecated. Use the form object &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;directly: assertFormError(response.context[</span><span class="si">{</span><span class="n">form</span><span class="si">!r}</span><span class="s2">], </span><span class="si">{</span><span class="n">field</span><span class="si">!r}</span><span class="s2">, ...)&quot;</span>
        <span class="p">)</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">warning_msg</span><span class="p">,</span> <span class="n">RemovedInDjango50Warning</span><span class="p">,</span> <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

        <span class="n">full_msg_prefix</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">msg_prefix</span><span class="si">}</span><span class="s2">: &quot;</span> <span class="k">if</span> <span class="n">msg_prefix</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
        <span class="n">contexts</span> <span class="o">=</span> <span class="n">to_list</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">context</span><span class="p">)</span> <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">context</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">contexts</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">full_msg_prefix</span><span class="si">}</span><span class="s2">Response did not use any contexts to render the &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;response&quot;</span>
            <span class="p">)</span>
        <span class="c1"># Search all contexts for the error.</span>
        <span class="n">found_form</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">context</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">contexts</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">form</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">context</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">found_form</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertFormError</span><span class="p">(</span><span class="n">context</span><span class="p">[</span><span class="n">form</span><span class="p">],</span> <span class="n">field</span><span class="p">,</span> <span class="n">errors</span><span class="p">,</span> <span class="n">msg_prefix</span><span class="o">=</span><span class="n">msg_prefix</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">found_form</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">full_msg_prefix</span><span class="si">}</span><span class="s2">The form &#39;</span><span class="si">{</span><span class="n">form</span><span class="si">}</span><span class="s2">&#39; was not used to render the &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;response&quot;</span>
            <span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">assertFormSetError</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">formset</span><span class="p">,</span> <span class="n">form_index</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">errors</span><span class="p">,</span> <span class="n">msg_prefix</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Search for a formset named &quot;formset&quot; in the &quot;response&quot; and dispatch to</span>
<span class="sd">        the new assertFormSetError() using that instance. If the name is found</span>
<span class="sd">        in multiple contexts they&#39;re all checked in order and any failure will</span>
<span class="sd">        abort the test.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">warning_msg</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Passing response to assertFormSetError() is deprecated. Use the formset &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;object directly: assertFormSetError(response.context[</span><span class="si">{</span><span class="n">formset</span><span class="si">!r}</span><span class="s2">], &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">form_index</span><span class="si">!r}</span><span class="s2">, ...)&quot;</span>
        <span class="p">)</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">warning_msg</span><span class="p">,</span> <span class="n">RemovedInDjango50Warning</span><span class="p">,</span> <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

        <span class="n">full_msg_prefix</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">msg_prefix</span><span class="si">}</span><span class="s2">: &quot;</span> <span class="k">if</span> <span class="n">msg_prefix</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
        <span class="n">contexts</span> <span class="o">=</span> <span class="n">to_list</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">context</span><span class="p">)</span> <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">context</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">contexts</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">full_msg_prefix</span><span class="si">}</span><span class="s2">Response did not use any contexts to render the &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;response&quot;</span>
            <span class="p">)</span>
        <span class="n">found_formset</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">context</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">contexts</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">formset</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">context</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">context</span><span class="p">[</span><span class="n">formset</span><span class="p">],</span> <span class="s2">&quot;forms&quot;</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="n">found_formset</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertFormSetError</span><span class="p">(</span>
                <span class="n">context</span><span class="p">[</span><span class="n">formset</span><span class="p">],</span> <span class="n">form_index</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">errors</span><span class="p">,</span> <span class="n">msg_prefix</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">found_formset</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">full_msg_prefix</span><span class="si">}</span><span class="s2">The formset &#39;</span><span class="si">{</span><span class="n">formset</span><span class="si">}</span><span class="s2">&#39; was not used to render the &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;response&quot;</span>
            <span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">patch_signature</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">new_method</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Replace the decorated method with a new one that inspects the passed</span>
<span class="sd">        args/kwargs and dispatch to the old implementation (with deprecation</span>
<span class="sd">        warning) when it detects the old signature.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="nd">@wraps</span><span class="p">(</span><span class="n">new_method</span><span class="p">)</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">patched_method</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="n">old_method</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">new_method</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
            <span class="n">old_signature</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">old_method</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">old_bound_args</span> <span class="o">=</span> <span class="n">old_signature</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                <span class="c1"># If old signature doesn&#39;t match then either:</span>
                <span class="c1"># 1) new signature will match</span>
                <span class="c1"># 2) or a TypeError will be raised showing the user information</span>
                <span class="c1"># about the new signature.</span>
                <span class="k">return</span> <span class="n">new_method</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

            <span class="n">new_signature</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">new_method</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">new_bound_args</span> <span class="o">=</span> <span class="n">new_signature</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                <span class="c1"># Old signature matches but not the new one (because of</span>
                <span class="c1"># previous try/except).</span>
                <span class="k">return</span> <span class="n">old_method</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

            <span class="c1"># If both signatures match, decide on which method to call by</span>
            <span class="c1"># inspecting the first arg (arg[0] = self).</span>
            <span class="k">assert</span> <span class="n">old_bound_args</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">new_bound_args</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span>
                <span class="n">old_bound_args</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;context&quot;</span>
            <span class="p">):</span>  <span class="c1"># Looks like a response object =&gt; old method.</span>
                <span class="k">return</span> <span class="n">old_method</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">old_bound_args</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">HttpResponseBase</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">old_method</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">() is only usable on responses fetched &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;using the Django test Client.&quot;</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">new_method</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">patched_method</span>


<div class="viewcode-block" id="SimpleTestCase">
<a class="viewcode-back" href="../../../autoapi/django/test/testcases/index.html#django.test.testcases.SimpleTestCase">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">SimpleTestCase</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="c1"># The class we&#39;ll use for the test client self.client.</span>
    <span class="c1"># Can be overridden in derived classes.</span>
<div class="viewcode-block" id="SimpleTestCase.client_class">
<a class="viewcode-back" href="../../../autoapi/django/test/testcases/index.html#django.test.testcases.SimpleTestCase.client_class">[docs]</a>
    <span class="n">client_class</span> <span class="o">=</span> <span class="n">Client</span></div>

<div class="viewcode-block" id="SimpleTestCase.async_client_class">
<a class="viewcode-back" href="../../../autoapi/django/test/testcases/index.html#django.test.testcases.SimpleTestCase.async_client_class">[docs]</a>
    <span class="n">async_client_class</span> <span class="o">=</span> <span class="n">AsyncClient</span></div>

    <span class="n">_overridden_settings</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_modified_settings</span> <span class="o">=</span> <span class="kc">None</span>

<div class="viewcode-block" id="SimpleTestCase.databases">
<a class="viewcode-back" href="../../../autoapi/django/test/testcases/index.html#django.test.testcases.SimpleTestCase.databases">[docs]</a>
    <span class="n">databases</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span></div>

    <span class="n">_disallowed_database_msg</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">&quot;Database </span><span class="si">%(operation)s</span><span class="s2"> to </span><span class="si">%(alias)r</span><span class="s2"> are not allowed in SimpleTestCase &quot;</span>
        <span class="s2">&quot;subclasses. Either subclass TestCase or TransactionTestCase to ensure &quot;</span>
        <span class="s2">&quot;proper test isolation or add </span><span class="si">%(alias)r</span><span class="s2"> to </span><span class="si">%(test)s</span><span class="s2">.databases to silence &quot;</span>
        <span class="s2">&quot;this failure.&quot;</span>
    <span class="p">)</span>
    <span class="n">_disallowed_connection_methods</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="s2">&quot;connect&quot;</span><span class="p">,</span> <span class="s2">&quot;connections&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;temporary_connection&quot;</span><span class="p">,</span> <span class="s2">&quot;connections&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;cursor&quot;</span><span class="p">,</span> <span class="s2">&quot;queries&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;chunked_cursor&quot;</span><span class="p">,</span> <span class="s2">&quot;queries&quot;</span><span class="p">),</span>
    <span class="p">]</span>

    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="SimpleTestCase.setUpClass">
<a class="viewcode-back" href="../../../autoapi/django/test/testcases/index.html#django.test.testcases.SimpleTestCase.setUpClass">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">setUpClass</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">setUpClass</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_overridden_settings</span><span class="p">:</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">_cls_overridden_context</span> <span class="o">=</span> <span class="n">override_settings</span><span class="p">(</span><span class="o">**</span><span class="bp">cls</span><span class="o">.</span><span class="n">_overridden_settings</span><span class="p">)</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">_cls_overridden_context</span><span class="o">.</span><span class="n">enable</span><span class="p">()</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">addClassCleanup</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_cls_overridden_context</span><span class="o">.</span><span class="n">disable</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_modified_settings</span><span class="p">:</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">_cls_modified_context</span> <span class="o">=</span> <span class="n">modify_settings</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_modified_settings</span><span class="p">)</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">_cls_modified_context</span><span class="o">.</span><span class="n">enable</span><span class="p">()</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">addClassCleanup</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_cls_modified_context</span><span class="o">.</span><span class="n">disable</span><span class="p">)</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">_add_databases_failures</span><span class="p">()</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">addClassCleanup</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_remove_databases_failures</span><span class="p">)</span></div>


    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_validate_databases</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">cls</span><span class="o">.</span><span class="n">databases</span> <span class="o">==</span> <span class="s2">&quot;__all__&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">frozenset</span><span class="p">(</span><span class="n">connections</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">alias</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">databases</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">alias</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">connections</span><span class="p">:</span>
                <span class="n">message</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">.</span><span class="si">%s</span><span class="s2">.databases refers to </span><span class="si">%r</span><span class="s2"> which is not defined in &quot;</span>
                    <span class="s2">&quot;settings.DATABASES.&quot;</span>
                    <span class="o">%</span> <span class="p">(</span>
                        <span class="bp">cls</span><span class="o">.</span><span class="vm">__module__</span><span class="p">,</span>
                        <span class="bp">cls</span><span class="o">.</span><span class="vm">__qualname__</span><span class="p">,</span>
                        <span class="n">alias</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="p">)</span>
                <span class="n">close_matches</span> <span class="o">=</span> <span class="n">get_close_matches</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">connections</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">close_matches</span><span class="p">:</span>
                    <span class="n">message</span> <span class="o">+=</span> <span class="s2">&quot; Did you mean </span><span class="si">%r</span><span class="s2">?&quot;</span> <span class="o">%</span> <span class="n">close_matches</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">raise</span> <span class="n">ImproperlyConfigured</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">frozenset</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">databases</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_add_databases_failures</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">databases</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_validate_databases</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">alias</span> <span class="ow">in</span> <span class="n">connections</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">alias</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">databases</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">connection</span> <span class="o">=</span> <span class="n">connections</span><span class="p">[</span><span class="n">alias</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">operation</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_disallowed_connection_methods</span><span class="p">:</span>
                <span class="n">message</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_disallowed_database_msg</span> <span class="o">%</span> <span class="p">{</span>
                    <span class="s2">&quot;test&quot;</span><span class="p">:</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">.</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="vm">__module__</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__qualname__</span><span class="p">),</span>
                    <span class="s2">&quot;alias&quot;</span><span class="p">:</span> <span class="n">alias</span><span class="p">,</span>
                    <span class="s2">&quot;operation&quot;</span><span class="p">:</span> <span class="n">operation</span><span class="p">,</span>
                <span class="p">}</span>
                <span class="n">method</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">connection</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="n">connection</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">_DatabaseFailure</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="n">message</span><span class="p">))</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_remove_databases_failures</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">alias</span> <span class="ow">in</span> <span class="n">connections</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">alias</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">databases</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">connection</span> <span class="o">=</span> <span class="n">connections</span><span class="p">[</span><span class="n">alias</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_disallowed_connection_methods</span><span class="p">:</span>
                <span class="n">method</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">connection</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="n">connection</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">method</span><span class="o">.</span><span class="n">wrapped</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">result</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Wrapper around default __call__ method to perform common Django test</span>
<span class="sd">        set up. This means that user-defined Test Cases aren&#39;t required to</span>
<span class="sd">        include a call to super().setUp().</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_setup_and_call</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

<div class="viewcode-block" id="SimpleTestCase.debug">
<a class="viewcode-back" href="../../../autoapi/django/test/testcases/index.html#django.test.testcases.SimpleTestCase.debug">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">debug</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Perform the same as __call__(), without catching the exception.&quot;&quot;&quot;</span>
        <span class="n">debug_result</span> <span class="o">=</span> <span class="n">_DebugResult</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_setup_and_call</span><span class="p">(</span><span class="n">debug_result</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_setup_and_call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Perform the following in order: pre-setup, run test, post-teardown,</span>
<span class="sd">        skipping pre/post hooks if test is set to be skipped.</span>

<span class="sd">        If debug=True, reraise any errors in setup and use super().debug()</span>
<span class="sd">        instead of __call__() to run the test.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">testMethod</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_testMethodName</span><span class="p">)</span>
        <span class="n">skipped</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span> <span class="s2">&quot;__unittest_skip__&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">getattr</span><span class="p">(</span>
            <span class="n">testMethod</span><span class="p">,</span> <span class="s2">&quot;__unittest_skip__&quot;</span><span class="p">,</span> <span class="kc">False</span>
        <span class="p">)</span>

        <span class="c1"># Convert async test methods.</span>
        <span class="k">if</span> <span class="n">iscoroutinefunction</span><span class="p">(</span><span class="n">testMethod</span><span class="p">):</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_testMethodName</span><span class="p">,</span> <span class="n">async_to_sync</span><span class="p">(</span><span class="n">testMethod</span><span class="p">))</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">skipped</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_pre_setup</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
                    <span class="k">raise</span>
                <span class="n">result</span><span class="o">.</span><span class="n">addError</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">())</span>
                <span class="k">return</span>
        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">debug</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__call__</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">skipped</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_post_teardown</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
                    <span class="k">raise</span>
                <span class="n">result</span><span class="o">.</span><span class="n">addError</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">())</span>
                <span class="k">return</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_pre_setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Perform pre-test setup:</span>
<span class="sd">        * Create a test client.</span>
<span class="sd">        * Clear the mail test outbox.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">client</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client_class</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">async_client</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">async_client_class</span><span class="p">()</span>
        <span class="n">mail</span><span class="o">.</span><span class="n">outbox</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_post_teardown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Perform post-test things.&quot;&quot;&quot;</span>
        <span class="k">pass</span>

<div class="viewcode-block" id="SimpleTestCase.settings">
<a class="viewcode-back" href="../../../autoapi/django/test/testcases/index.html#django.test.testcases.SimpleTestCase.settings">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">settings</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A context manager that temporarily sets a setting and reverts to the</span>
<span class="sd">        original value when exiting the context.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">override_settings</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<div class="viewcode-block" id="SimpleTestCase.modify_settings">
<a class="viewcode-back" href="../../../autoapi/django/test/testcases/index.html#django.test.testcases.SimpleTestCase.modify_settings">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">modify_settings</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A context manager that temporarily applies changes a list setting and</span>
<span class="sd">        reverts back to the original value when exiting the context.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">modify_settings</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<div class="viewcode-block" id="SimpleTestCase.assertRedirects">
<a class="viewcode-back" href="../../../autoapi/django/test/testcases/index.html#django.test.testcases.SimpleTestCase.assertRedirects">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">assertRedirects</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">response</span><span class="p">,</span>
        <span class="n">expected_url</span><span class="p">,</span>
        <span class="n">status_code</span><span class="o">=</span><span class="mi">302</span><span class="p">,</span>
        <span class="n">target_status_code</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span>
        <span class="n">msg_prefix</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="n">fetch_redirect_response</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Assert that a response redirected to a specific URL and that the</span>
<span class="sd">        redirect URL can be loaded.</span>

<span class="sd">        Won&#39;t work for external links since it uses the test client to do a</span>
<span class="sd">        request (use fetch_redirect_response=False to check such links without</span>
<span class="sd">        fetching them).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">msg_prefix</span><span class="p">:</span>
            <span class="n">msg_prefix</span> <span class="o">+=</span> <span class="s2">&quot;: &quot;</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="s2">&quot;redirect_chain&quot;</span><span class="p">):</span>
            <span class="c1"># The request was a followed redirect</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span>
                <span class="n">response</span><span class="o">.</span><span class="n">redirect_chain</span><span class="p">,</span>
                <span class="n">msg_prefix</span>
                <span class="o">+</span> <span class="p">(</span>
                    <span class="s2">&quot;Response didn&#39;t redirect as expected: Response code was </span><span class="si">%d</span><span class="s2"> &quot;</span>
                    <span class="s2">&quot;(expected </span><span class="si">%d</span><span class="s2">)&quot;</span>
                <span class="p">)</span>
                <span class="o">%</span> <span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span> <span class="n">status_code</span><span class="p">),</span>
            <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
                <span class="n">response</span><span class="o">.</span><span class="n">redirect_chain</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
                <span class="n">status_code</span><span class="p">,</span>
                <span class="n">msg_prefix</span>
                <span class="o">+</span> <span class="p">(</span>
                    <span class="s2">&quot;Initial response didn&#39;t redirect as expected: Response code was &quot;</span>
                    <span class="s2">&quot;</span><span class="si">%d</span><span class="s2"> (expected </span><span class="si">%d</span><span class="s2">)&quot;</span>
                <span class="p">)</span>
                <span class="o">%</span> <span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">redirect_chain</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">status_code</span><span class="p">),</span>
            <span class="p">)</span>

            <span class="n">url</span><span class="p">,</span> <span class="n">status_code</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">redirect_chain</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
                <span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span>
                <span class="n">target_status_code</span><span class="p">,</span>
                <span class="n">msg_prefix</span>
                <span class="o">+</span> <span class="p">(</span>
                    <span class="s2">&quot;Response didn&#39;t redirect as expected: Final Response code was </span><span class="si">%d</span><span class="s2"> &quot;</span>
                    <span class="s2">&quot;(expected </span><span class="si">%d</span><span class="s2">)&quot;</span>
                <span class="p">)</span>
                <span class="o">%</span> <span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span> <span class="n">target_status_code</span><span class="p">),</span>
            <span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Not a followed redirect</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
                <span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span>
                <span class="n">status_code</span><span class="p">,</span>
                <span class="n">msg_prefix</span>
                <span class="o">+</span> <span class="p">(</span>
                    <span class="s2">&quot;Response didn&#39;t redirect as expected: Response code was </span><span class="si">%d</span><span class="s2"> &quot;</span>
                    <span class="s2">&quot;(expected </span><span class="si">%d</span><span class="s2">)&quot;</span>
                <span class="p">)</span>
                <span class="o">%</span> <span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span> <span class="n">status_code</span><span class="p">),</span>
            <span class="p">)</span>

            <span class="n">url</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">url</span>
            <span class="n">scheme</span><span class="p">,</span> <span class="n">netloc</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">fragment</span> <span class="o">=</span> <span class="n">urlsplit</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>

            <span class="c1"># Prepend the request path to handle relative path redirects.</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">):</span>
                <span class="n">url</span> <span class="o">=</span> <span class="n">urljoin</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">request</span><span class="p">[</span><span class="s2">&quot;PATH_INFO&quot;</span><span class="p">],</span> <span class="n">url</span><span class="p">)</span>
                <span class="n">path</span> <span class="o">=</span> <span class="n">urljoin</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">request</span><span class="p">[</span><span class="s2">&quot;PATH_INFO&quot;</span><span class="p">],</span> <span class="n">path</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">fetch_redirect_response</span><span class="p">:</span>
                <span class="c1"># netloc might be empty, or in cases where Django tests the</span>
                <span class="c1"># HTTP scheme, the convention is for netloc to be &#39;testserver&#39;.</span>
                <span class="c1"># Trust both as &quot;internal&quot; URLs here.</span>
                <span class="n">domain</span><span class="p">,</span> <span class="n">port</span> <span class="o">=</span> <span class="n">split_domain_port</span><span class="p">(</span><span class="n">netloc</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">domain</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">validate_host</span><span class="p">(</span><span class="n">domain</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">ALLOWED_HOSTS</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="s2">&quot;The test client is unable to fetch remote URLs (got </span><span class="si">%s</span><span class="s2">). &quot;</span>
                        <span class="s2">&quot;If the host is served by Django, add &#39;</span><span class="si">%s</span><span class="s2">&#39; to ALLOWED_HOSTS. &quot;</span>
                        <span class="s2">&quot;Otherwise, use &quot;</span>
                        <span class="s2">&quot;assertRedirects(..., fetch_redirect_response=False).&quot;</span>
                        <span class="o">%</span> <span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">domain</span><span class="p">)</span>
                    <span class="p">)</span>
                <span class="c1"># Get the redirection page, using the same client that was used</span>
                <span class="c1"># to obtain the original response.</span>
                <span class="n">extra</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">extra</span> <span class="ow">or</span> <span class="p">{}</span>
                <span class="n">headers</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">headers</span> <span class="ow">or</span> <span class="p">{}</span>
                <span class="n">redirect_response</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                    <span class="n">path</span><span class="p">,</span>
                    <span class="n">QueryDict</span><span class="p">(</span><span class="n">query</span><span class="p">),</span>
                    <span class="n">secure</span><span class="o">=</span><span class="p">(</span><span class="n">scheme</span> <span class="o">==</span> <span class="s2">&quot;https&quot;</span><span class="p">),</span>
                    <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span>
                    <span class="o">**</span><span class="n">extra</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
                    <span class="n">redirect_response</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span>
                    <span class="n">target_status_code</span><span class="p">,</span>
                    <span class="n">msg_prefix</span>
                    <span class="o">+</span> <span class="p">(</span>
                        <span class="s2">&quot;Couldn&#39;t retrieve redirection page &#39;</span><span class="si">%s</span><span class="s2">&#39;: response code was </span><span class="si">%d</span><span class="s2"> &quot;</span>
                        <span class="s2">&quot;(expected </span><span class="si">%d</span><span class="s2">)&quot;</span>
                    <span class="p">)</span>
                    <span class="o">%</span> <span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">redirect_response</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span> <span class="n">target_status_code</span><span class="p">),</span>
                <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertURLEqual</span><span class="p">(</span>
            <span class="n">url</span><span class="p">,</span>
            <span class="n">expected_url</span><span class="p">,</span>
            <span class="n">msg_prefix</span>
            <span class="o">+</span> <span class="s2">&quot;Response redirected to &#39;</span><span class="si">%s</span><span class="s2">&#39;, expected &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">expected_url</span><span class="p">),</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="SimpleTestCase.assertURLEqual">
<a class="viewcode-back" href="../../../autoapi/django/test/testcases/index.html#django.test.testcases.SimpleTestCase.assertURLEqual">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">assertURLEqual</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url1</span><span class="p">,</span> <span class="n">url2</span><span class="p">,</span> <span class="n">msg_prefix</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Assert that two URLs are the same, ignoring the order of query string</span>
<span class="sd">        parameters except for parameters with the same name.</span>

<span class="sd">        For example, /path/?x=1&amp;y=2 is equal to /path/?y=2&amp;x=1, but</span>
<span class="sd">        /path/?a=1&amp;a=2 isn&#39;t equal to /path/?a=2&amp;a=1.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">normalize</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Sort the URL&#39;s query string parameters.&quot;&quot;&quot;</span>
            <span class="n">url</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>  <span class="c1"># Coerce reverse_lazy() URLs.</span>
            <span class="n">scheme</span><span class="p">,</span> <span class="n">netloc</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">fragment</span> <span class="o">=</span> <span class="n">urlparse</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
            <span class="n">query_parts</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">parse_qsl</span><span class="p">(</span><span class="n">query</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">urlunparse</span><span class="p">(</span>
                <span class="p">(</span><span class="n">scheme</span><span class="p">,</span> <span class="n">netloc</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">urlencode</span><span class="p">(</span><span class="n">query_parts</span><span class="p">),</span> <span class="n">fragment</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
            <span class="n">normalize</span><span class="p">(</span><span class="n">url1</span><span class="p">),</span>
            <span class="n">normalize</span><span class="p">(</span><span class="n">url2</span><span class="p">),</span>
            <span class="n">msg_prefix</span> <span class="o">+</span> <span class="s2">&quot;Expected &#39;</span><span class="si">%s</span><span class="s2">&#39; to equal &#39;</span><span class="si">%s</span><span class="s2">&#39;.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">url1</span><span class="p">,</span> <span class="n">url2</span><span class="p">),</span>
        <span class="p">)</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_assert_contains</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">status_code</span><span class="p">,</span> <span class="n">msg_prefix</span><span class="p">,</span> <span class="n">html</span><span class="p">):</span>
        <span class="c1"># If the response supports deferred rendering and hasn&#39;t been rendered</span>
        <span class="c1"># yet, then ensure that it does get rendered before proceeding further.</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="nb">hasattr</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="s2">&quot;render&quot;</span><span class="p">)</span>
            <span class="ow">and</span> <span class="nb">callable</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">render</span><span class="p">)</span>
            <span class="ow">and</span> <span class="ow">not</span> <span class="n">response</span><span class="o">.</span><span class="n">is_rendered</span>
        <span class="p">):</span>
            <span class="n">response</span><span class="o">.</span><span class="n">render</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">msg_prefix</span><span class="p">:</span>
            <span class="n">msg_prefix</span> <span class="o">+=</span> <span class="s2">&quot;: &quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
            <span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span>
            <span class="n">status_code</span><span class="p">,</span>
            <span class="n">msg_prefix</span> <span class="o">+</span> <span class="s2">&quot;Couldn&#39;t retrieve content: Response code was </span><span class="si">%d</span><span class="s2">&quot;</span>
            <span class="s2">&quot; (expected </span><span class="si">%d</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span> <span class="n">status_code</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">streaming</span><span class="p">:</span>
            <span class="n">content</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">streaming_content</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">content</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">content</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">)</span> <span class="ow">or</span> <span class="n">html</span><span class="p">:</span>
            <span class="n">text</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
            <span class="n">content</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">charset</span><span class="p">)</span>
            <span class="n">text_repr</span> <span class="o">=</span> <span class="s2">&quot;&#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">text</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">text_repr</span> <span class="o">=</span> <span class="nb">repr</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">html</span><span class="p">:</span>
            <span class="n">content</span> <span class="o">=</span> <span class="n">assert_and_parse_html</span><span class="p">(</span>
                <span class="bp">self</span><span class="p">,</span> <span class="n">content</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Response&#39;s content is not valid HTML:&quot;</span>
            <span class="p">)</span>
            <span class="n">text</span> <span class="o">=</span> <span class="n">assert_and_parse_html</span><span class="p">(</span>
                <span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Second argument is not valid HTML:&quot;</span>
            <span class="p">)</span>
        <span class="n">real_count</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">text_repr</span><span class="p">,</span> <span class="n">real_count</span><span class="p">,</span> <span class="n">msg_prefix</span><span class="p">)</span>

<div class="viewcode-block" id="SimpleTestCase.assertContains">
<a class="viewcode-back" href="../../../autoapi/django/test/testcases/index.html#django.test.testcases.SimpleTestCase.assertContains">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">assertContains</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">status_code</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">msg_prefix</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">html</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Assert that a response indicates that some content was retrieved</span>
<span class="sd">        successfully, (i.e., the HTTP status code was as expected) and that</span>
<span class="sd">        ``text`` occurs ``count`` times in the content of the response.</span>
<span class="sd">        If ``count`` is None, the count doesn&#39;t matter - the assertion is true</span>
<span class="sd">        if the text occurs at least once in the response.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">text_repr</span><span class="p">,</span> <span class="n">real_count</span><span class="p">,</span> <span class="n">msg_prefix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_assert_contains</span><span class="p">(</span>
            <span class="n">response</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">status_code</span><span class="p">,</span> <span class="n">msg_prefix</span><span class="p">,</span> <span class="n">html</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">count</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
                <span class="n">real_count</span><span class="p">,</span>
                <span class="n">count</span><span class="p">,</span>
                <span class="n">msg_prefix</span>
                <span class="o">+</span> <span class="s2">&quot;Found </span><span class="si">%d</span><span class="s2"> instances of </span><span class="si">%s</span><span class="s2"> in response (expected </span><span class="si">%d</span><span class="s2">)&quot;</span>
                <span class="o">%</span> <span class="p">(</span><span class="n">real_count</span><span class="p">,</span> <span class="n">text_repr</span><span class="p">,</span> <span class="n">count</span><span class="p">),</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span>
                <span class="n">real_count</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">msg_prefix</span> <span class="o">+</span> <span class="s2">&quot;Couldn&#39;t find </span><span class="si">%s</span><span class="s2"> in response&quot;</span> <span class="o">%</span> <span class="n">text_repr</span>
            <span class="p">)</span></div>


<div class="viewcode-block" id="SimpleTestCase.assertNotContains">
<a class="viewcode-back" href="../../../autoapi/django/test/testcases/index.html#django.test.testcases.SimpleTestCase.assertNotContains">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">assertNotContains</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">status_code</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">msg_prefix</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">html</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Assert that a response indicates that some content was retrieved</span>
<span class="sd">        successfully, (i.e., the HTTP status code was as expected) and that</span>
<span class="sd">        ``text`` doesn&#39;t occur in the content of the response.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">text_repr</span><span class="p">,</span> <span class="n">real_count</span><span class="p">,</span> <span class="n">msg_prefix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_assert_contains</span><span class="p">(</span>
            <span class="n">response</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">status_code</span><span class="p">,</span> <span class="n">msg_prefix</span><span class="p">,</span> <span class="n">html</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
            <span class="n">real_count</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">msg_prefix</span> <span class="o">+</span> <span class="s2">&quot;Response should not contain </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">text_repr</span>
        <span class="p">)</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_check_test_client_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">attribute</span><span class="p">,</span> <span class="n">method_name</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Raise a ValueError if the given response doesn&#39;t have the required</span>
<span class="sd">        attribute.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">attribute</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">method_name</span><span class="si">}</span><span class="s2">() is only usable on responses fetched using &quot;</span>
                <span class="s2">&quot;the Django test Client.&quot;</span>
            <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_assert_form_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">form</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">errors</span><span class="p">,</span> <span class="n">msg_prefix</span><span class="p">,</span> <span class="n">form_repr</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">form</span><span class="o">.</span><span class="n">is_bound</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">msg_prefix</span><span class="si">}</span><span class="s2">The </span><span class="si">{</span><span class="n">form_repr</span><span class="si">}</span><span class="s2"> is not bound, it will never have any &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;errors.&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">field</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">field</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">form</span><span class="o">.</span><span class="n">fields</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">msg_prefix</span><span class="si">}</span><span class="s2">The </span><span class="si">{</span><span class="n">form_repr</span><span class="si">}</span><span class="s2"> does not contain the field </span><span class="si">{</span><span class="n">field</span><span class="si">!r}</span><span class="s2">.&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">field</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">field_errors</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">non_field_errors</span><span class="p">()</span>
            <span class="n">failure_message</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;The non-field errors of </span><span class="si">{</span><span class="n">form_repr</span><span class="si">}</span><span class="s2"> don&#39;t match.&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">field_errors</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="p">[])</span>
            <span class="n">failure_message</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;The errors of field </span><span class="si">{</span><span class="n">field</span><span class="si">!r}</span><span class="s2"> on </span><span class="si">{</span><span class="n">form_repr</span><span class="si">}</span><span class="s2"> don&#39;t match.&quot;</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">field_errors</span><span class="p">,</span> <span class="n">errors</span><span class="p">,</span> <span class="n">msg_prefix</span> <span class="o">+</span> <span class="n">failure_message</span><span class="p">)</span>

    <span class="c1"># RemovedInDjango50Warning: When the deprecation ends, remove the</span>
    <span class="c1"># decorator.</span>
    <span class="nd">@_AssertFormErrorDeprecationHelper</span><span class="o">.</span><span class="n">patch_signature</span>
<div class="viewcode-block" id="SimpleTestCase.assertFormError">
<a class="viewcode-back" href="../../../autoapi/django/test/testcases/index.html#django.test.testcases.SimpleTestCase.assertFormError">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">assertFormError</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">form</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">errors</span><span class="p">,</span> <span class="n">msg_prefix</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Assert that a field named &quot;field&quot; on the given form object has specific</span>
<span class="sd">        errors.</span>

<span class="sd">        errors can be either a single error message or a list of errors</span>
<span class="sd">        messages. Using errors=[] test that the field has no errors.</span>

<span class="sd">        You can pass field=None to check the form&#39;s non-field errors.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">errors</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="s2">&quot;Passing errors=None to assertFormError() is deprecated, use &quot;</span>
                <span class="s2">&quot;errors=[] instead.&quot;</span><span class="p">,</span>
                <span class="n">RemovedInDjango50Warning</span><span class="p">,</span>
                <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="n">msg_prefix</span><span class="p">:</span>
            <span class="n">msg_prefix</span> <span class="o">+=</span> <span class="s2">&quot;: &quot;</span>
        <span class="n">errors</span> <span class="o">=</span> <span class="n">to_list</span><span class="p">(</span><span class="n">errors</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_assert_form_error</span><span class="p">(</span><span class="n">form</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">errors</span><span class="p">,</span> <span class="n">msg_prefix</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;form </span><span class="si">{</span><span class="n">form</span><span class="si">!r}</span><span class="s2">&quot;</span><span class="p">)</span></div>


    <span class="c1"># RemovedInDjango51Warning.</span>
<div class="viewcode-block" id="SimpleTestCase.assertFormsetError">
<a class="viewcode-back" href="../../../autoapi/django/test/testcases/index.html#django.test.testcases.SimpleTestCase.assertFormsetError">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">assertFormsetError</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
            <span class="s2">&quot;assertFormsetError() is deprecated in favor of assertFormSetError().&quot;</span><span class="p">,</span>
            <span class="n">category</span><span class="o">=</span><span class="n">RemovedInDjango51Warning</span><span class="p">,</span>
            <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertFormSetError</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span></div>


    <span class="c1"># RemovedInDjango50Warning: When the deprecation ends, remove the</span>
    <span class="c1"># decorator.</span>
    <span class="nd">@_AssertFormErrorDeprecationHelper</span><span class="o">.</span><span class="n">patch_signature</span>
<div class="viewcode-block" id="SimpleTestCase.assertFormSetError">
<a class="viewcode-back" href="../../../autoapi/django/test/testcases/index.html#django.test.testcases.SimpleTestCase.assertFormSetError">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">assertFormSetError</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">formset</span><span class="p">,</span> <span class="n">form_index</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">errors</span><span class="p">,</span> <span class="n">msg_prefix</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Similar to assertFormError() but for formsets.</span>

<span class="sd">        Use form_index=None to check the formset&#39;s non-form errors (in that</span>
<span class="sd">        case, you must also use field=None).</span>
<span class="sd">        Otherwise use an integer to check the formset&#39;s n-th form for errors.</span>

<span class="sd">        Other parameters are the same as assertFormError().</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">errors</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="s2">&quot;Passing errors=None to assertFormSetError() is deprecated, &quot;</span>
                <span class="s2">&quot;use errors=[] instead.&quot;</span><span class="p">,</span>
                <span class="n">RemovedInDjango50Warning</span><span class="p">,</span>
                <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="n">form_index</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">field</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;You must use field=None with form_index=None.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">msg_prefix</span><span class="p">:</span>
            <span class="n">msg_prefix</span> <span class="o">+=</span> <span class="s2">&quot;: &quot;</span>
        <span class="n">errors</span> <span class="o">=</span> <span class="n">to_list</span><span class="p">(</span><span class="n">errors</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">formset</span><span class="o">.</span><span class="n">is_bound</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">msg_prefix</span><span class="si">}</span><span class="s2">The formset </span><span class="si">{</span><span class="n">formset</span><span class="si">!r}</span><span class="s2"> is not bound, it will never have &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;any errors.&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">form_index</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">form_index</span> <span class="o">&gt;=</span> <span class="n">formset</span><span class="o">.</span><span class="n">total_form_count</span><span class="p">():</span>
            <span class="n">form_count</span> <span class="o">=</span> <span class="n">formset</span><span class="o">.</span><span class="n">total_form_count</span><span class="p">()</span>
            <span class="n">form_or_forms</span> <span class="o">=</span> <span class="s2">&quot;forms&quot;</span> <span class="k">if</span> <span class="n">form_count</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="s2">&quot;form&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">msg_prefix</span><span class="si">}</span><span class="s2">The formset </span><span class="si">{</span><span class="n">formset</span><span class="si">!r}</span><span class="s2"> only has </span><span class="si">{</span><span class="n">form_count</span><span class="si">}</span><span class="s2"> &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">form_or_forms</span><span class="si">}</span><span class="s2">.&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">form_index</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">form_repr</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;form </span><span class="si">{</span><span class="n">form_index</span><span class="si">}</span><span class="s2"> of formset </span><span class="si">{</span><span class="n">formset</span><span class="si">!r}</span><span class="s2">&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_assert_form_error</span><span class="p">(</span>
                <span class="n">formset</span><span class="o">.</span><span class="n">forms</span><span class="p">[</span><span class="n">form_index</span><span class="p">],</span> <span class="n">field</span><span class="p">,</span> <span class="n">errors</span><span class="p">,</span> <span class="n">msg_prefix</span><span class="p">,</span> <span class="n">form_repr</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">failure_message</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;The non-form errors of formset </span><span class="si">{</span><span class="n">formset</span><span class="si">!r}</span><span class="s2"> don&#39;t match.&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
                <span class="n">formset</span><span class="o">.</span><span class="n">non_form_errors</span><span class="p">(),</span> <span class="n">errors</span><span class="p">,</span> <span class="n">msg_prefix</span> <span class="o">+</span> <span class="n">failure_message</span>
            <span class="p">)</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_get_template_used</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">template_name</span><span class="p">,</span> <span class="n">msg_prefix</span><span class="p">,</span> <span class="n">method_name</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">response</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">template_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;response and/or template_name argument must be provided&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">msg_prefix</span><span class="p">:</span>
            <span class="n">msg_prefix</span> <span class="o">+=</span> <span class="s2">&quot;: &quot;</span>

        <span class="k">if</span> <span class="n">template_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">response</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_check_test_client_response</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="s2">&quot;templates&quot;</span><span class="p">,</span> <span class="n">method_name</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="s2">&quot;templates&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">response</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">template_name</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">response</span><span class="p">:</span>
                <span class="n">template_name</span> <span class="o">=</span> <span class="n">response</span>
                <span class="n">response</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="c1"># use this template with context manager</span>
            <span class="k">return</span> <span class="n">template_name</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">msg_prefix</span>

        <span class="n">template_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">templates</span> <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">]</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="n">template_names</span><span class="p">,</span> <span class="n">msg_prefix</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_assert_template_used</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">template_name</span><span class="p">,</span> <span class="n">template_names</span><span class="p">,</span> <span class="n">msg_prefix</span><span class="p">,</span> <span class="n">count</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">template_names</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="n">msg_prefix</span> <span class="o">+</span> <span class="s2">&quot;No templates used to render the response&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span>
            <span class="n">template_name</span> <span class="ow">in</span> <span class="n">template_names</span><span class="p">,</span>
            <span class="n">msg_prefix</span> <span class="o">+</span> <span class="s2">&quot;Template &#39;</span><span class="si">%s</span><span class="s2">&#39; was not a template used to render&quot;</span>
            <span class="s2">&quot; the response. Actual template(s) used: </span><span class="si">%s</span><span class="s2">&quot;</span>
            <span class="o">%</span> <span class="p">(</span><span class="n">template_name</span><span class="p">,</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">template_names</span><span class="p">)),</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">count</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
                <span class="n">template_names</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">template_name</span><span class="p">),</span>
                <span class="n">count</span><span class="p">,</span>
                <span class="n">msg_prefix</span> <span class="o">+</span> <span class="s2">&quot;Template &#39;</span><span class="si">%s</span><span class="s2">&#39; was expected to be rendered </span><span class="si">%d</span><span class="s2"> &quot;</span>
                <span class="s2">&quot;time(s) but was actually rendered </span><span class="si">%d</span><span class="s2"> time(s).&quot;</span>
                <span class="o">%</span> <span class="p">(</span><span class="n">template_name</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">template_names</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">template_name</span><span class="p">)),</span>
            <span class="p">)</span>

<div class="viewcode-block" id="SimpleTestCase.assertTemplateUsed">
<a class="viewcode-back" href="../../../autoapi/django/test/testcases/index.html#django.test.testcases.SimpleTestCase.assertTemplateUsed">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">assertTemplateUsed</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">template_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">msg_prefix</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="kc">None</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Assert that the template with the provided name was used in rendering</span>
<span class="sd">        the response. Also usable as context manager.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">context_mgr_template</span><span class="p">,</span> <span class="n">template_names</span><span class="p">,</span> <span class="n">msg_prefix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_template_used</span><span class="p">(</span>
            <span class="n">response</span><span class="p">,</span>
            <span class="n">template_name</span><span class="p">,</span>
            <span class="n">msg_prefix</span><span class="p">,</span>
            <span class="s2">&quot;assertTemplateUsed&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">context_mgr_template</span><span class="p">:</span>
            <span class="c1"># Use assertTemplateUsed as context manager.</span>
            <span class="k">return</span> <span class="n">_AssertTemplateUsedContext</span><span class="p">(</span>
                <span class="bp">self</span><span class="p">,</span> <span class="n">context_mgr_template</span><span class="p">,</span> <span class="n">msg_prefix</span><span class="p">,</span> <span class="n">count</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_assert_template_used</span><span class="p">(</span><span class="n">template_name</span><span class="p">,</span> <span class="n">template_names</span><span class="p">,</span> <span class="n">msg_prefix</span><span class="p">,</span> <span class="n">count</span><span class="p">)</span></div>


<div class="viewcode-block" id="SimpleTestCase.assertTemplateNotUsed">
<a class="viewcode-back" href="../../../autoapi/django/test/testcases/index.html#django.test.testcases.SimpleTestCase.assertTemplateNotUsed">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">assertTemplateNotUsed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">template_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">msg_prefix</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Assert that the template with the provided name was NOT used in</span>
<span class="sd">        rendering the response. Also usable as context manager.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">context_mgr_template</span><span class="p">,</span> <span class="n">template_names</span><span class="p">,</span> <span class="n">msg_prefix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_template_used</span><span class="p">(</span>
            <span class="n">response</span><span class="p">,</span>
            <span class="n">template_name</span><span class="p">,</span>
            <span class="n">msg_prefix</span><span class="p">,</span>
            <span class="s2">&quot;assertTemplateNotUsed&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">context_mgr_template</span><span class="p">:</span>
            <span class="c1"># Use assertTemplateNotUsed as context manager.</span>
            <span class="k">return</span> <span class="n">_AssertTemplateNotUsedContext</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context_mgr_template</span><span class="p">,</span> <span class="n">msg_prefix</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span>
            <span class="n">template_name</span> <span class="ow">in</span> <span class="n">template_names</span><span class="p">,</span>
            <span class="n">msg_prefix</span>
            <span class="o">+</span> <span class="s2">&quot;Template &#39;</span><span class="si">%s</span><span class="s2">&#39; was used unexpectedly in rendering the response&quot;</span>
            <span class="o">%</span> <span class="n">template_name</span><span class="p">,</span>
        <span class="p">)</span></div>


    <span class="nd">@contextmanager</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_assert_raises_or_warns_cm</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">cm_attr</span><span class="p">,</span> <span class="n">expected_exception</span><span class="p">,</span> <span class="n">expected_message</span>
    <span class="p">):</span>
        <span class="k">with</span> <span class="n">func</span><span class="p">(</span><span class="n">expected_exception</span><span class="p">)</span> <span class="k">as</span> <span class="n">cm</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">cm</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="n">expected_message</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="n">cm_attr</span><span class="p">)))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_assertFooMessage</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">cm_attr</span><span class="p">,</span> <span class="n">expected_exception</span><span class="p">,</span> <span class="n">expected_message</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">):</span>
        <span class="n">callable_obj</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">args</span><span class="p">:</span>
            <span class="n">callable_obj</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span> <span class="o">=</span> <span class="n">args</span>
        <span class="n">cm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_assert_raises_or_warns_cm</span><span class="p">(</span>
            <span class="n">func</span><span class="p">,</span> <span class="n">cm_attr</span><span class="p">,</span> <span class="n">expected_exception</span><span class="p">,</span> <span class="n">expected_message</span>
        <span class="p">)</span>
        <span class="c1"># Assertion used in context manager fashion.</span>
        <span class="k">if</span> <span class="n">callable_obj</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">cm</span>
        <span class="c1"># Assertion was passed a callable.</span>
        <span class="k">with</span> <span class="n">cm</span><span class="p">:</span>
            <span class="n">callable_obj</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

<div class="viewcode-block" id="SimpleTestCase.assertRaisesMessage">
<a class="viewcode-back" href="../../../autoapi/django/test/testcases/index.html#django.test.testcases.SimpleTestCase.assertRaisesMessage">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">assertRaisesMessage</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">expected_exception</span><span class="p">,</span> <span class="n">expected_message</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Assert that expected_message is found in the message of a raised</span>
<span class="sd">        exception.</span>

<span class="sd">        Args:</span>
<span class="sd">            expected_exception: Exception class expected to be raised.</span>
<span class="sd">            expected_message: expected error message string value.</span>
<span class="sd">            args: Function to be called and extra positional args.</span>
<span class="sd">            kwargs: Extra kwargs.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_assertFooMessage</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">,</span>
            <span class="s2">&quot;exception&quot;</span><span class="p">,</span>
            <span class="n">expected_exception</span><span class="p">,</span>
            <span class="n">expected_message</span><span class="p">,</span>
            <span class="o">*</span><span class="n">args</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="SimpleTestCase.assertWarnsMessage">
<a class="viewcode-back" href="../../../autoapi/django/test/testcases/index.html#django.test.testcases.SimpleTestCase.assertWarnsMessage">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">assertWarnsMessage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expected_warning</span><span class="p">,</span> <span class="n">expected_message</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Same as assertRaisesMessage but for assertWarns() instead of</span>
<span class="sd">        assertRaises().</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_assertFooMessage</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertWarns</span><span class="p">,</span>
            <span class="s2">&quot;warning&quot;</span><span class="p">,</span>
            <span class="n">expected_warning</span><span class="p">,</span>
            <span class="n">expected_message</span><span class="p">,</span>
            <span class="o">*</span><span class="n">args</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
        <span class="p">)</span></div>


    <span class="c1"># A similar method is available in Python 3.10+.</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">PY310</span><span class="p">:</span>

        <span class="nd">@contextmanager</span>
<div class="viewcode-block" id="SimpleTestCase.assertNoLogs">
<a class="viewcode-back" href="../../../autoapi/django/test/testcases/index.html#django.test.testcases.SimpleTestCase.assertNoLogs">[docs]</a>
        <span class="k">def</span><span class="w"> </span><span class="nf">assertNoLogs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">logger</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Assert no messages are logged on the logger, with at least the</span>
<span class="sd">            given level.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">level</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
                <span class="n">level</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLevelName</span><span class="p">(</span><span class="n">level</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">level</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">level</span> <span class="o">=</span> <span class="s2">&quot;INFO&quot;</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertLogs</span><span class="p">(</span><span class="n">logger</span><span class="p">,</span> <span class="n">level</span><span class="p">)</span> <span class="k">as</span> <span class="n">cm</span><span class="p">:</span>
                    <span class="k">yield</span>
            <span class="k">except</span> <span class="ne">AssertionError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">expected_msg</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;no logs of level </span><span class="si">{</span><span class="n">level</span><span class="si">}</span><span class="s2"> or higher triggered on </span><span class="si">{</span><span class="n">logger</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">msg</span> <span class="o">!=</span> <span class="n">expected_msg</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">e</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unexpected logs found: </span><span class="si">{</span><span class="n">cm</span><span class="o">.</span><span class="n">output</span><span class="si">!r}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="SimpleTestCase.assertFieldOutput">
<a class="viewcode-back" href="../../../autoapi/django/test/testcases/index.html#django.test.testcases.SimpleTestCase.assertFieldOutput">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">assertFieldOutput</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">fieldclass</span><span class="p">,</span>
        <span class="n">valid</span><span class="p">,</span>
        <span class="n">invalid</span><span class="p">,</span>
        <span class="n">field_args</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">field_kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">empty_value</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Assert that a form field behaves correctly with various inputs.</span>

<span class="sd">        Args:</span>
<span class="sd">            fieldclass: the class of the field to be tested.</span>
<span class="sd">            valid: a dictionary mapping valid inputs to their expected</span>
<span class="sd">                    cleaned values.</span>
<span class="sd">            invalid: a dictionary mapping invalid inputs to one or more</span>
<span class="sd">                    raised error messages.</span>
<span class="sd">            field_args: the args passed to instantiate the field</span>
<span class="sd">            field_kwargs: the kwargs passed to instantiate the field</span>
<span class="sd">            empty_value: the expected clean output for inputs in empty_values</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">field_args</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">field_args</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">field_kwargs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">field_kwargs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">required</span> <span class="o">=</span> <span class="n">fieldclass</span><span class="p">(</span><span class="o">*</span><span class="n">field_args</span><span class="p">,</span> <span class="o">**</span><span class="n">field_kwargs</span><span class="p">)</span>
        <span class="n">optional</span> <span class="o">=</span> <span class="n">fieldclass</span><span class="p">(</span><span class="o">*</span><span class="n">field_args</span><span class="p">,</span> <span class="o">**</span><span class="p">{</span><span class="o">**</span><span class="n">field_kwargs</span><span class="p">,</span> <span class="s2">&quot;required&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">})</span>
        <span class="c1"># test valid inputs</span>
        <span class="k">for</span> <span class="nb">input</span><span class="p">,</span> <span class="n">output</span> <span class="ow">in</span> <span class="n">valid</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">required</span><span class="o">.</span><span class="n">clean</span><span class="p">(</span><span class="nb">input</span><span class="p">),</span> <span class="n">output</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">optional</span><span class="o">.</span><span class="n">clean</span><span class="p">(</span><span class="nb">input</span><span class="p">),</span> <span class="n">output</span><span class="p">)</span>
        <span class="c1"># test invalid inputs</span>
        <span class="k">for</span> <span class="nb">input</span><span class="p">,</span> <span class="n">errors</span> <span class="ow">in</span> <span class="n">invalid</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">ValidationError</span><span class="p">)</span> <span class="k">as</span> <span class="n">context_manager</span><span class="p">:</span>
                <span class="n">required</span><span class="o">.</span><span class="n">clean</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">context_manager</span><span class="o">.</span><span class="n">exception</span><span class="o">.</span><span class="n">messages</span><span class="p">,</span> <span class="n">errors</span><span class="p">)</span>

            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">ValidationError</span><span class="p">)</span> <span class="k">as</span> <span class="n">context_manager</span><span class="p">:</span>
                <span class="n">optional</span><span class="o">.</span><span class="n">clean</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">context_manager</span><span class="o">.</span><span class="n">exception</span><span class="o">.</span><span class="n">messages</span><span class="p">,</span> <span class="n">errors</span><span class="p">)</span>
        <span class="c1"># test required inputs</span>
        <span class="n">error_required</span> <span class="o">=</span> <span class="p">[</span><span class="n">required</span><span class="o">.</span><span class="n">error_messages</span><span class="p">[</span><span class="s2">&quot;required&quot;</span><span class="p">]]</span>
        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">required</span><span class="o">.</span><span class="n">empty_values</span><span class="p">:</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">ValidationError</span><span class="p">)</span> <span class="k">as</span> <span class="n">context_manager</span><span class="p">:</span>
                <span class="n">required</span><span class="o">.</span><span class="n">clean</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">context_manager</span><span class="o">.</span><span class="n">exception</span><span class="o">.</span><span class="n">messages</span><span class="p">,</span> <span class="n">error_required</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">optional</span><span class="o">.</span><span class="n">clean</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="n">empty_value</span><span class="p">)</span>
        <span class="c1"># test that max_length and min_length are always accepted</span>
        <span class="k">if</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">fieldclass</span><span class="p">,</span> <span class="n">CharField</span><span class="p">):</span>
            <span class="n">field_kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;min_length&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;max_length&quot;</span><span class="p">:</span> <span class="mi">20</span><span class="p">})</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertIsInstance</span><span class="p">(</span><span class="n">fieldclass</span><span class="p">(</span><span class="o">*</span><span class="n">field_args</span><span class="p">,</span> <span class="o">**</span><span class="n">field_kwargs</span><span class="p">),</span> <span class="n">fieldclass</span><span class="p">)</span></div>


<div class="viewcode-block" id="SimpleTestCase.assertHTMLEqual">
<a class="viewcode-back" href="../../../autoapi/django/test/testcases/index.html#django.test.testcases.SimpleTestCase.assertHTMLEqual">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">assertHTMLEqual</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">html1</span><span class="p">,</span> <span class="n">html2</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Assert that two HTML snippets are semantically the same.</span>
<span class="sd">        Whitespace in most cases is ignored, and attribute ordering is not</span>
<span class="sd">        significant. The arguments must be valid HTML.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dom1</span> <span class="o">=</span> <span class="n">assert_and_parse_html</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">html1</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="s2">&quot;First argument is not valid HTML:&quot;</span>
        <span class="p">)</span>
        <span class="n">dom2</span> <span class="o">=</span> <span class="n">assert_and_parse_html</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">html2</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="s2">&quot;Second argument is not valid HTML:&quot;</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">dom1</span> <span class="o">!=</span> <span class="n">dom2</span><span class="p">:</span>
            <span class="n">standardMsg</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> != </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">safe_repr</span><span class="p">(</span><span class="n">dom1</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span> <span class="n">safe_repr</span><span class="p">(</span><span class="n">dom2</span><span class="p">,</span> <span class="kc">True</span><span class="p">))</span>
            <span class="n">diff</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="n">difflib</span><span class="o">.</span><span class="n">ndiff</span><span class="p">(</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">dom1</span><span class="p">)</span><span class="o">.</span><span class="n">splitlines</span><span class="p">(),</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">dom2</span><span class="p">)</span><span class="o">.</span><span class="n">splitlines</span><span class="p">(),</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="n">standardMsg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_truncateMessage</span><span class="p">(</span><span class="n">standardMsg</span><span class="p">,</span> <span class="n">diff</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_formatMessage</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">standardMsg</span><span class="p">))</span></div>


<div class="viewcode-block" id="SimpleTestCase.assertHTMLNotEqual">
<a class="viewcode-back" href="../../../autoapi/django/test/testcases/index.html#django.test.testcases.SimpleTestCase.assertHTMLNotEqual">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">assertHTMLNotEqual</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">html1</span><span class="p">,</span> <span class="n">html2</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Assert that two HTML snippets are not semantically equivalent.&quot;&quot;&quot;</span>
        <span class="n">dom1</span> <span class="o">=</span> <span class="n">assert_and_parse_html</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">html1</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="s2">&quot;First argument is not valid HTML:&quot;</span>
        <span class="p">)</span>
        <span class="n">dom2</span> <span class="o">=</span> <span class="n">assert_and_parse_html</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">html2</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="s2">&quot;Second argument is not valid HTML:&quot;</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">dom1</span> <span class="o">==</span> <span class="n">dom2</span><span class="p">:</span>
            <span class="n">standardMsg</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> == </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">safe_repr</span><span class="p">(</span><span class="n">dom1</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span> <span class="n">safe_repr</span><span class="p">(</span><span class="n">dom2</span><span class="p">,</span> <span class="kc">True</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_formatMessage</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">standardMsg</span><span class="p">))</span></div>


<div class="viewcode-block" id="SimpleTestCase.assertInHTML">
<a class="viewcode-back" href="../../../autoapi/django/test/testcases/index.html#django.test.testcases.SimpleTestCase.assertInHTML">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">assertInHTML</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">needle</span><span class="p">,</span> <span class="n">haystack</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">msg_prefix</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
        <span class="n">needle</span> <span class="o">=</span> <span class="n">assert_and_parse_html</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">needle</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;First argument is not valid HTML:&quot;</span>
        <span class="p">)</span>
        <span class="n">haystack</span> <span class="o">=</span> <span class="n">assert_and_parse_html</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">haystack</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Second argument is not valid HTML:&quot;</span>
        <span class="p">)</span>
        <span class="n">real_count</span> <span class="o">=</span> <span class="n">haystack</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">needle</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">count</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
                <span class="n">real_count</span><span class="p">,</span>
                <span class="n">count</span><span class="p">,</span>
                <span class="n">msg_prefix</span>
                <span class="o">+</span> <span class="s2">&quot;Found </span><span class="si">%d</span><span class="s2"> instances of &#39;</span><span class="si">%s</span><span class="s2">&#39; in response (expected </span><span class="si">%d</span><span class="s2">)&quot;</span>
                <span class="o">%</span> <span class="p">(</span><span class="n">real_count</span><span class="p">,</span> <span class="n">needle</span><span class="p">,</span> <span class="n">count</span><span class="p">),</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span>
                <span class="n">real_count</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">msg_prefix</span> <span class="o">+</span> <span class="s2">&quot;Couldn&#39;t find &#39;</span><span class="si">%s</span><span class="s2">&#39; in response&quot;</span> <span class="o">%</span> <span class="n">needle</span>
            <span class="p">)</span></div>


<div class="viewcode-block" id="SimpleTestCase.assertJSONEqual">
<a class="viewcode-back" href="../../../autoapi/django/test/testcases/index.html#django.test.testcases.SimpleTestCase.assertJSONEqual">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">assertJSONEqual</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">raw</span><span class="p">,</span> <span class="n">expected_data</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Assert that the JSON fragments raw and expected_data are equal.</span>
<span class="sd">        Usual JSON non-significant whitespace rules apply as the heavyweight</span>
<span class="sd">        is delegated to the json library.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">json</span><span class="o">.</span><span class="n">JSONDecodeError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="s2">&quot;First argument is not valid JSON: </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">raw</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expected_data</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">expected_data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">expected_data</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="s2">&quot;Second argument is not valid JSON: </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">expected_data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">expected_data</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="n">msg</span><span class="p">)</span></div>


<div class="viewcode-block" id="SimpleTestCase.assertJSONNotEqual">
<a class="viewcode-back" href="../../../autoapi/django/test/testcases/index.html#django.test.testcases.SimpleTestCase.assertJSONNotEqual">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">assertJSONNotEqual</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">raw</span><span class="p">,</span> <span class="n">expected_data</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Assert that the JSON fragments raw and expected_data are not equal.</span>
<span class="sd">        Usual JSON non-significant whitespace rules apply as the heavyweight</span>
<span class="sd">        is delegated to the json library.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">json</span><span class="o">.</span><span class="n">JSONDecodeError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="s2">&quot;First argument is not valid JSON: </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">raw</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expected_data</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">expected_data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">expected_data</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">json</span><span class="o">.</span><span class="n">JSONDecodeError</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="s2">&quot;Second argument is not valid JSON: </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">expected_data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertNotEqual</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">expected_data</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="n">msg</span><span class="p">)</span></div>


<div class="viewcode-block" id="SimpleTestCase.assertXMLEqual">
<a class="viewcode-back" href="../../../autoapi/django/test/testcases/index.html#django.test.testcases.SimpleTestCase.assertXMLEqual">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">assertXMLEqual</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xml1</span><span class="p">,</span> <span class="n">xml2</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Assert that two XML snippets are semantically the same.</span>
<span class="sd">        Whitespace in most cases is ignored and attribute ordering is not</span>
<span class="sd">        significant. The arguments must be valid XML.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">compare_xml</span><span class="p">(</span><span class="n">xml1</span><span class="p">,</span> <span class="n">xml2</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">standardMsg</span> <span class="o">=</span> <span class="s2">&quot;First or second argument is not valid XML</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">e</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_formatMessage</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">standardMsg</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span><span class="p">:</span>
                <span class="n">standardMsg</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> != </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">safe_repr</span><span class="p">(</span><span class="n">xml1</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span>
                    <span class="n">safe_repr</span><span class="p">(</span><span class="n">xml2</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span>
                <span class="p">)</span>
                <span class="n">diff</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="n">difflib</span><span class="o">.</span><span class="n">ndiff</span><span class="p">(</span><span class="n">xml1</span><span class="o">.</span><span class="n">splitlines</span><span class="p">(),</span> <span class="n">xml2</span><span class="o">.</span><span class="n">splitlines</span><span class="p">())</span>
                <span class="p">)</span>
                <span class="n">standardMsg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_truncateMessage</span><span class="p">(</span><span class="n">standardMsg</span><span class="p">,</span> <span class="n">diff</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_formatMessage</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">standardMsg</span><span class="p">))</span></div>


<div class="viewcode-block" id="SimpleTestCase.assertXMLNotEqual">
<a class="viewcode-back" href="../../../autoapi/django/test/testcases/index.html#django.test.testcases.SimpleTestCase.assertXMLNotEqual">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">assertXMLNotEqual</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xml1</span><span class="p">,</span> <span class="n">xml2</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Assert that two XML snippets are not semantically equivalent.</span>
<span class="sd">        Whitespace in most cases is ignored and attribute ordering is not</span>
<span class="sd">        significant. The arguments must be valid XML.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">compare_xml</span><span class="p">(</span><span class="n">xml1</span><span class="p">,</span> <span class="n">xml2</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">standardMsg</span> <span class="o">=</span> <span class="s2">&quot;First or second argument is not valid XML</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">e</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_formatMessage</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">standardMsg</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
                <span class="n">standardMsg</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> == </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">safe_repr</span><span class="p">(</span><span class="n">xml1</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span>
                    <span class="n">safe_repr</span><span class="p">(</span><span class="n">xml2</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_formatMessage</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">standardMsg</span><span class="p">))</span></div>
</div>



<div class="viewcode-block" id="TransactionTestCase">
<a class="viewcode-back" href="../../../autoapi/django/test/testcases/index.html#django.test.testcases.TransactionTestCase">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">TransactionTestCase</span><span class="p">(</span><span class="n">SimpleTestCase</span><span class="p">):</span>
    <span class="c1"># Subclasses can ask for resetting of auto increment sequence before each</span>
    <span class="c1"># test case</span>
<div class="viewcode-block" id="TransactionTestCase.reset_sequences">
<a class="viewcode-back" href="../../../autoapi/django/test/testcases/index.html#django.test.testcases.TransactionTestCase.reset_sequences">[docs]</a>
    <span class="n">reset_sequences</span> <span class="o">=</span> <span class="kc">False</span></div>


    <span class="c1"># Subclasses can enable only a subset of apps for faster tests</span>
<div class="viewcode-block" id="TransactionTestCase.available_apps">
<a class="viewcode-back" href="../../../autoapi/django/test/testcases/index.html#django.test.testcases.TransactionTestCase.available_apps">[docs]</a>
    <span class="n">available_apps</span> <span class="o">=</span> <span class="kc">None</span></div>


    <span class="c1"># Subclasses can define fixtures which will be automatically installed.</span>
<div class="viewcode-block" id="TransactionTestCase.fixtures">
<a class="viewcode-back" href="../../../autoapi/django/test/testcases/index.html#django.test.testcases.TransactionTestCase.fixtures">[docs]</a>
    <span class="n">fixtures</span> <span class="o">=</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="TransactionTestCase.databases">
<a class="viewcode-back" href="../../../autoapi/django/test/testcases/index.html#django.test.testcases.TransactionTestCase.databases">[docs]</a>
    <span class="n">databases</span> <span class="o">=</span> <span class="p">{</span><span class="n">DEFAULT_DB_ALIAS</span><span class="p">}</span></div>

    <span class="n">_disallowed_database_msg</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">&quot;Database </span><span class="si">%(operation)s</span><span class="s2"> to </span><span class="si">%(alias)r</span><span class="s2"> are not allowed in this test. &quot;</span>
        <span class="s2">&quot;Add </span><span class="si">%(alias)r</span><span class="s2"> to </span><span class="si">%(test)s</span><span class="s2">.databases to ensure proper test isolation &quot;</span>
        <span class="s2">&quot;and silence this failure.&quot;</span>
    <span class="p">)</span>

    <span class="c1"># If transactions aren&#39;t available, Django will serialize the database</span>
    <span class="c1"># contents into a fixture during setup and flush and reload them</span>
    <span class="c1"># during teardown (as flush does not restore data from migrations).</span>
    <span class="c1"># This can be slow; this flag allows enabling on a per-case basis.</span>
<div class="viewcode-block" id="TransactionTestCase.serialized_rollback">
<a class="viewcode-back" href="../../../autoapi/django/test/testcases/index.html#django.test.testcases.TransactionTestCase.serialized_rollback">[docs]</a>
    <span class="n">serialized_rollback</span> <span class="o">=</span> <span class="kc">False</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_pre_setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Perform pre-test setup:</span>
<span class="sd">        * If the class has an &#39;available_apps&#39; attribute, restrict the app</span>
<span class="sd">          registry to these applications, then fire the post_migrate signal --</span>
<span class="sd">          it must run with the correct set of applications for the test case.</span>
<span class="sd">        * If the class has a &#39;fixtures&#39; attribute, install those fixtures.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">_pre_setup</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">available_apps</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">apps</span><span class="o">.</span><span class="n">set_available_apps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">available_apps</span><span class="p">)</span>
            <span class="n">setting_changed</span><span class="o">.</span><span class="n">send</span><span class="p">(</span>
                <span class="n">sender</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">_wrapped</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span>
                <span class="n">setting</span><span class="o">=</span><span class="s2">&quot;INSTALLED_APPS&quot;</span><span class="p">,</span>
                <span class="n">value</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">available_apps</span><span class="p">,</span>
                <span class="n">enter</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">db_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_databases_names</span><span class="p">(</span><span class="n">include_mirrors</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
                <span class="n">emit_post_migrate_signal</span><span class="p">(</span><span class="n">verbosity</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">interactive</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">db</span><span class="o">=</span><span class="n">db_name</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_fixture_setup</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">available_apps</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">apps</span><span class="o">.</span><span class="n">unset_available_apps</span><span class="p">()</span>
                <span class="n">setting_changed</span><span class="o">.</span><span class="n">send</span><span class="p">(</span>
                    <span class="n">sender</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">_wrapped</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span>
                    <span class="n">setting</span><span class="o">=</span><span class="s2">&quot;INSTALLED_APPS&quot;</span><span class="p">,</span>
                    <span class="n">value</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">INSTALLED_APPS</span><span class="p">,</span>
                    <span class="n">enter</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">raise</span>
        <span class="c1"># Clear the queries_log so that it&#39;s less likely to overflow (a single</span>
        <span class="c1"># test probably won&#39;t execute 9K queries). If queries_log overflows,</span>
        <span class="c1"># then assertNumQueries() doesn&#39;t work.</span>
        <span class="k">for</span> <span class="n">db_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_databases_names</span><span class="p">(</span><span class="n">include_mirrors</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
            <span class="n">connections</span><span class="p">[</span><span class="n">db_name</span><span class="p">]</span><span class="o">.</span><span class="n">queries_log</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_databases_names</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">include_mirrors</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="c1"># Only consider allowed database aliases, including mirrors or not.</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="n">alias</span>
            <span class="k">for</span> <span class="n">alias</span> <span class="ow">in</span> <span class="n">connections</span>
            <span class="k">if</span> <span class="n">alias</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">databases</span>
            <span class="ow">and</span> <span class="p">(</span>
                <span class="n">include_mirrors</span>
                <span class="ow">or</span> <span class="ow">not</span> <span class="n">connections</span><span class="p">[</span><span class="n">alias</span><span class="p">]</span><span class="o">.</span><span class="n">settings_dict</span><span class="p">[</span><span class="s2">&quot;TEST&quot;</span><span class="p">][</span><span class="s2">&quot;MIRROR&quot;</span><span class="p">]</span>
            <span class="p">)</span>
        <span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_reset_sequences</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db_name</span><span class="p">):</span>
        <span class="n">conn</span> <span class="o">=</span> <span class="n">connections</span><span class="p">[</span><span class="n">db_name</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">conn</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">supports_sequence_reset</span><span class="p">:</span>
            <span class="n">sql_list</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">sequence_reset_by_name_sql</span><span class="p">(</span>
                <span class="n">no_style</span><span class="p">(),</span> <span class="n">conn</span><span class="o">.</span><span class="n">introspection</span><span class="o">.</span><span class="n">sequence_list</span><span class="p">()</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">sql_list</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">transaction</span><span class="o">.</span><span class="n">atomic</span><span class="p">(</span><span class="n">using</span><span class="o">=</span><span class="n">db_name</span><span class="p">):</span>
                    <span class="k">with</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span> <span class="k">as</span> <span class="n">cursor</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">sql</span> <span class="ow">in</span> <span class="n">sql_list</span><span class="p">:</span>
                            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_fixture_setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">db_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_databases_names</span><span class="p">(</span><span class="n">include_mirrors</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
            <span class="c1"># Reset sequences</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reset_sequences</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_reset_sequences</span><span class="p">(</span><span class="n">db_name</span><span class="p">)</span>

            <span class="c1"># Provide replica initial data from migrated apps, if needed.</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">serialized_rollback</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span>
                <span class="n">connections</span><span class="p">[</span><span class="n">db_name</span><span class="p">],</span> <span class="s2">&quot;_test_serialized_contents&quot;</span>
            <span class="p">):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">available_apps</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">apps</span><span class="o">.</span><span class="n">unset_available_apps</span><span class="p">()</span>
                <span class="n">connections</span><span class="p">[</span><span class="n">db_name</span><span class="p">]</span><span class="o">.</span><span class="n">creation</span><span class="o">.</span><span class="n">deserialize_db_from_string</span><span class="p">(</span>
                    <span class="n">connections</span><span class="p">[</span><span class="n">db_name</span><span class="p">]</span><span class="o">.</span><span class="n">_test_serialized_contents</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">available_apps</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">apps</span><span class="o">.</span><span class="n">set_available_apps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">available_apps</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fixtures</span><span class="p">:</span>
                <span class="c1"># We have to use this slightly awkward syntax due to the fact</span>
                <span class="c1"># that we&#39;re using *args and **kwargs together.</span>
                <span class="n">call_command</span><span class="p">(</span>
                    <span class="s2">&quot;loaddata&quot;</span><span class="p">,</span> <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">fixtures</span><span class="p">,</span> <span class="o">**</span><span class="p">{</span><span class="s2">&quot;verbosity&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;database&quot;</span><span class="p">:</span> <span class="n">db_name</span><span class="p">}</span>
                <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_should_reload_connections</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_post_teardown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Perform post-test things:</span>
<span class="sd">        * Flush the contents of the database to leave a clean slate. If the</span>
<span class="sd">          class has an &#39;available_apps&#39; attribute, don&#39;t fire post_migrate.</span>
<span class="sd">        * Force-close the connection so the next test gets a clean cursor.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_fixture_teardown</span><span class="p">()</span>
            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">_post_teardown</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_should_reload_connections</span><span class="p">():</span>
                <span class="c1"># Some DB cursors include SQL statements as part of cursor</span>
                <span class="c1"># creation. If you have a test that does a rollback, the effect</span>
                <span class="c1"># of these statements is lost, which can affect the operation of</span>
                <span class="c1"># tests (e.g., losing a timezone setting causing objects to be</span>
                <span class="c1"># created with the wrong time). To make sure this doesn&#39;t</span>
                <span class="c1"># happen, get a clean connection at the start of every test.</span>
                <span class="k">for</span> <span class="n">conn</span> <span class="ow">in</span> <span class="n">connections</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">initialized_only</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
                    <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">available_apps</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">apps</span><span class="o">.</span><span class="n">unset_available_apps</span><span class="p">()</span>
                <span class="n">setting_changed</span><span class="o">.</span><span class="n">send</span><span class="p">(</span>
                    <span class="n">sender</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">_wrapped</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span>
                    <span class="n">setting</span><span class="o">=</span><span class="s2">&quot;INSTALLED_APPS&quot;</span><span class="p">,</span>
                    <span class="n">value</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">INSTALLED_APPS</span><span class="p">,</span>
                    <span class="n">enter</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_fixture_teardown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Allow TRUNCATE ... CASCADE and don&#39;t emit the post_migrate signal</span>
        <span class="c1"># when flushing only a subset of the apps</span>
        <span class="k">for</span> <span class="n">db_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_databases_names</span><span class="p">(</span><span class="n">include_mirrors</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
            <span class="c1"># Flush the database</span>
            <span class="n">inhibit_post_migrate</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">available_apps</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                <span class="ow">or</span> <span class="p">(</span>  <span class="c1"># Inhibit the post_migrate signal when using serialized</span>
                    <span class="c1"># rollback to avoid trying to recreate the serialized data.</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">serialized_rollback</span>
                    <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">connections</span><span class="p">[</span><span class="n">db_name</span><span class="p">],</span> <span class="s2">&quot;_test_serialized_contents&quot;</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="n">call_command</span><span class="p">(</span>
                <span class="s2">&quot;flush&quot;</span><span class="p">,</span>
                <span class="n">verbosity</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                <span class="n">interactive</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">database</span><span class="o">=</span><span class="n">db_name</span><span class="p">,</span>
                <span class="n">reset_sequences</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">allow_cascade</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">available_apps</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span>
                <span class="n">inhibit_post_migrate</span><span class="o">=</span><span class="n">inhibit_post_migrate</span><span class="p">,</span>
            <span class="p">)</span>

    <span class="c1"># RemovedInDjango51Warning.</span>
<div class="viewcode-block" id="TransactionTestCase.assertQuerysetEqual">
<a class="viewcode-back" href="../../../autoapi/django/test/testcases/index.html#django.test.testcases.TransactionTestCase.assertQuerysetEqual">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">assertQuerysetEqual</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
            <span class="s2">&quot;assertQuerysetEqual() is deprecated in favor of assertQuerySetEqual().&quot;</span><span class="p">,</span>
            <span class="n">category</span><span class="o">=</span><span class="n">RemovedInDjango51Warning</span><span class="p">,</span>
            <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerySetEqual</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span></div>


<div class="viewcode-block" id="TransactionTestCase.assertQuerySetEqual">
<a class="viewcode-back" href="../../../autoapi/django/test/testcases/index.html#django.test.testcases.TransactionTestCase.assertQuerySetEqual">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">assertQuerySetEqual</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">qs</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ordered</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">values</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
        <span class="n">items</span> <span class="o">=</span> <span class="n">qs</span>
        <span class="k">if</span> <span class="n">transform</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">items</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="n">transform</span><span class="p">,</span> <span class="n">items</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ordered</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertDictEqual</span><span class="p">(</span><span class="n">Counter</span><span class="p">(</span><span class="n">items</span><span class="p">),</span> <span class="n">Counter</span><span class="p">(</span><span class="n">values</span><span class="p">),</span> <span class="n">msg</span><span class="o">=</span><span class="n">msg</span><span class="p">)</span>
        <span class="c1"># For example qs.iterator() could be passed as qs, but it does not</span>
        <span class="c1"># have &#39;ordered&#39; attribute.</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">qs</span><span class="p">,</span> <span class="s2">&quot;ordered&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">qs</span><span class="o">.</span><span class="n">ordered</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Trying to compare non-ordered queryset against more than one &quot;</span>
                <span class="s2">&quot;ordered value.&quot;</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">items</span><span class="p">),</span> <span class="n">values</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="n">msg</span><span class="p">)</span></div>


<div class="viewcode-block" id="TransactionTestCase.assertNumQueries">
<a class="viewcode-back" href="../../../autoapi/django/test/testcases/index.html#django.test.testcases.TransactionTestCase.assertNumQueries">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">assertNumQueries</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num</span><span class="p">,</span> <span class="n">func</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">using</span><span class="o">=</span><span class="n">DEFAULT_DB_ALIAS</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">conn</span> <span class="o">=</span> <span class="n">connections</span><span class="p">[</span><span class="n">using</span><span class="p">]</span>

        <span class="n">context</span> <span class="o">=</span> <span class="n">_AssertNumQueriesContext</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num</span><span class="p">,</span> <span class="n">conn</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">func</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">context</span>

        <span class="k">with</span> <span class="n">context</span><span class="p">:</span>
            <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>
</div>



<span class="k">def</span><span class="w"> </span><span class="nf">connections_support_transactions</span><span class="p">(</span><span class="n">aliases</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return whether or not all (or specified) connections support</span>
<span class="sd">    transactions.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">conns</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">connections</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">aliases</span> <span class="ow">is</span> <span class="kc">None</span>
        <span class="k">else</span> <span class="p">(</span><span class="n">connections</span><span class="p">[</span><span class="n">alias</span><span class="p">]</span> <span class="k">for</span> <span class="n">alias</span> <span class="ow">in</span> <span class="n">aliases</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="nb">all</span><span class="p">(</span><span class="n">conn</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">supports_transactions</span> <span class="k">for</span> <span class="n">conn</span> <span class="ow">in</span> <span class="n">conns</span><span class="p">)</span>


<span class="k">class</span><span class="w"> </span><span class="nc">TestData</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Descriptor to provide TestCase instance isolation for attributes assigned</span>
<span class="sd">    during the setUpTestData() phase.</span>

<span class="sd">    Allow safe alteration of objects assigned in setUpTestData() by test</span>
<span class="sd">    methods by exposing deep copies instead of the original objects.</span>

<span class="sd">    Objects are deep copied using a memo kept on the test case instance in</span>
<span class="sd">    order to maintain their original relationships.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">memo_attr</span> <span class="o">=</span> <span class="s2">&quot;_testdata_memo&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_memo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">testcase</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">memo</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">testcase</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">memo_attr</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="n">memo</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">testcase</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">memo_attr</span><span class="p">,</span> <span class="n">memo</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">memo</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__get__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">owner</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">instance</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span>
        <span class="n">memo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_memo</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">memo</span><span class="p">)</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">data</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;&lt;TestData: name=</span><span class="si">%r</span><span class="s2">, data=</span><span class="si">%r</span><span class="s2">&gt;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>


<div class="viewcode-block" id="TestCase">
<a class="viewcode-back" href="../../../autoapi/django/test/testcases/index.html#django.test.testcases.TestCase">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">TestCase</span><span class="p">(</span><span class="n">TransactionTestCase</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Similar to TransactionTestCase, but use `transaction.atomic()` to achieve</span>
<span class="sd">    test isolation.</span>

<span class="sd">    In most situations, TestCase should be preferred to TransactionTestCase as</span>
<span class="sd">    it allows faster execution. However, there are some situations where using</span>
<span class="sd">    TransactionTestCase might be necessary (e.g. testing some transactional</span>
<span class="sd">    behavior).</span>

<span class="sd">    On database backends with no transaction support, TestCase behaves as</span>
<span class="sd">    TransactionTestCase.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_enter_atomics</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Open atomic blocks for multiple databases.&quot;&quot;&quot;</span>
        <span class="n">atomics</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">db_name</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_databases_names</span><span class="p">():</span>
            <span class="n">atomic</span> <span class="o">=</span> <span class="n">transaction</span><span class="o">.</span><span class="n">atomic</span><span class="p">(</span><span class="n">using</span><span class="o">=</span><span class="n">db_name</span><span class="p">)</span>
            <span class="n">atomic</span><span class="o">.</span><span class="n">_from_testcase</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">atomic</span><span class="o">.</span><span class="fm">__enter__</span><span class="p">()</span>
            <span class="n">atomics</span><span class="p">[</span><span class="n">db_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">atomic</span>
        <span class="k">return</span> <span class="n">atomics</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_rollback_atomics</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">atomics</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Rollback atomic blocks opened by the previous method.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">db_name</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_databases_names</span><span class="p">()):</span>
            <span class="n">transaction</span><span class="o">.</span><span class="n">set_rollback</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">using</span><span class="o">=</span><span class="n">db_name</span><span class="p">)</span>
            <span class="n">atomics</span><span class="p">[</span><span class="n">db_name</span><span class="p">]</span><span class="o">.</span><span class="fm">__exit__</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_databases_support_transactions</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">connections_support_transactions</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">databases</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="TestCase.setUpClass">
<a class="viewcode-back" href="../../../autoapi/django/test/testcases/index.html#django.test.testcases.TestCase.setUpClass">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">setUpClass</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">setUpClass</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_databases_support_transactions</span><span class="p">():</span>
            <span class="k">return</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">cls_atomics</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_enter_atomics</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">cls</span><span class="o">.</span><span class="n">fixtures</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">db_name</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_databases_names</span><span class="p">(</span><span class="n">include_mirrors</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">call_command</span><span class="p">(</span>
                        <span class="s2">&quot;loaddata&quot;</span><span class="p">,</span>
                        <span class="o">*</span><span class="bp">cls</span><span class="o">.</span><span class="n">fixtures</span><span class="p">,</span>
                        <span class="o">**</span><span class="p">{</span><span class="s2">&quot;verbosity&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;database&quot;</span><span class="p">:</span> <span class="n">db_name</span><span class="p">},</span>
                    <span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="bp">cls</span><span class="o">.</span><span class="n">_rollback_atomics</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">cls_atomics</span><span class="p">)</span>
                    <span class="k">raise</span>
        <span class="n">pre_attrs</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">setUpTestData</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">_rollback_atomics</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">cls_atomics</span><span class="p">)</span>
            <span class="k">raise</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">pre_attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">TestData</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span></div>


    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="TestCase.tearDownClass">
<a class="viewcode-back" href="../../../autoapi/django/test/testcases/index.html#django.test.testcases.TestCase.tearDownClass">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">tearDownClass</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_databases_support_transactions</span><span class="p">():</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">_rollback_atomics</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">cls_atomics</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">conn</span> <span class="ow">in</span> <span class="n">connections</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">initialized_only</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
                <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">tearDownClass</span><span class="p">()</span></div>


    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="TestCase.setUpTestData">
<a class="viewcode-back" href="../../../autoapi/django/test/testcases/index.html#django.test.testcases.TestCase.setUpTestData">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">setUpTestData</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Load initial data for the TestCase.&quot;&quot;&quot;</span>
        <span class="k">pass</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_should_reload_connections</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_databases_support_transactions</span><span class="p">():</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">_should_reload_connections</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_fixture_setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_databases_support_transactions</span><span class="p">():</span>
            <span class="c1"># If the backend does not support transactions, we should reload</span>
            <span class="c1"># class data before each test</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setUpTestData</span><span class="p">()</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">_fixture_setup</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reset_sequences</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;reset_sequences cannot be used on TestCase instances&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">atomics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_enter_atomics</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_fixture_teardown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_databases_support_transactions</span><span class="p">():</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">_fixture_teardown</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">db_name</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_databases_names</span><span class="p">()):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_should_check_constraints</span><span class="p">(</span><span class="n">connections</span><span class="p">[</span><span class="n">db_name</span><span class="p">]):</span>
                    <span class="n">connections</span><span class="p">[</span><span class="n">db_name</span><span class="p">]</span><span class="o">.</span><span class="n">check_constraints</span><span class="p">()</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_rollback_atomics</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atomics</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_should_check_constraints</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">connection</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="n">connection</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">can_defer_constraint_checks</span>
            <span class="ow">and</span> <span class="ow">not</span> <span class="n">connection</span><span class="o">.</span><span class="n">needs_rollback</span>
            <span class="ow">and</span> <span class="n">connection</span><span class="o">.</span><span class="n">is_usable</span><span class="p">()</span>
        <span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="nd">@contextmanager</span>
<div class="viewcode-block" id="TestCase.captureOnCommitCallbacks">
<a class="viewcode-back" href="../../../autoapi/django/test/testcases/index.html#django.test.testcases.TestCase.captureOnCommitCallbacks">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">captureOnCommitCallbacks</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">using</span><span class="o">=</span><span class="n">DEFAULT_DB_ALIAS</span><span class="p">,</span> <span class="n">execute</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Context manager to capture transaction.on_commit() callbacks.&quot;&quot;&quot;</span>
        <span class="n">callbacks</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">start_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">connections</span><span class="p">[</span><span class="n">using</span><span class="p">]</span><span class="o">.</span><span class="n">run_on_commit</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">callbacks</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">callback_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">connections</span><span class="p">[</span><span class="n">using</span><span class="p">]</span><span class="o">.</span><span class="n">run_on_commit</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">callback</span><span class="p">,</span> <span class="n">robust</span> <span class="ow">in</span> <span class="n">connections</span><span class="p">[</span><span class="n">using</span><span class="p">]</span><span class="o">.</span><span class="n">run_on_commit</span><span class="p">[</span>
                    <span class="n">start_count</span><span class="p">:</span>
                <span class="p">]:</span>
                    <span class="n">callbacks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">callback</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">execute</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">robust</span><span class="p">:</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">callback</span><span class="p">()</span>
                            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                                    <span class="sa">f</span><span class="s2">&quot;Error calling </span><span class="si">{</span><span class="n">callback</span><span class="o">.</span><span class="vm">__qualname__</span><span class="si">}</span><span class="s2"> in &quot;</span>
                                    <span class="sa">f</span><span class="s2">&quot;on_commit() (%s).&quot;</span><span class="p">,</span>
                                    <span class="n">e</span><span class="p">,</span>
                                    <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                <span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">callback</span><span class="p">()</span>

                <span class="k">if</span> <span class="n">callback_count</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">connections</span><span class="p">[</span><span class="n">using</span><span class="p">]</span><span class="o">.</span><span class="n">run_on_commit</span><span class="p">):</span>
                    <span class="k">break</span>
                <span class="n">start_count</span> <span class="o">=</span> <span class="n">callback_count</span></div>
</div>



<span class="k">class</span><span class="w"> </span><span class="nc">CheckCondition</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Descriptor class for deferred condition checking.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">conditions</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conditions</span> <span class="o">=</span> <span class="n">conditions</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">add_condition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">condition</span><span class="p">,</span> <span class="n">reason</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">conditions</span><span class="p">,</span> <span class="p">(</span><span class="n">condition</span><span class="p">,</span> <span class="n">reason</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__get__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># Trigger access for all bases.</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="s2">&quot;__unittest_skip__&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="k">for</span> <span class="n">base</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__bases__</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">for</span> <span class="n">condition</span><span class="p">,</span> <span class="n">reason</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">conditions</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">condition</span><span class="p">():</span>
                <span class="c1"># Override this descriptor&#39;s value and set the skip reason.</span>
                <span class="bp">cls</span><span class="o">.</span><span class="n">__unittest_skip__</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="bp">cls</span><span class="o">.</span><span class="n">__unittest_skip_why__</span> <span class="o">=</span> <span class="n">reason</span>
                <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_deferredSkip</span><span class="p">(</span><span class="n">condition</span><span class="p">,</span> <span class="n">reason</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">decorator</span><span class="p">(</span><span class="n">test_func</span><span class="p">):</span>
        <span class="k">nonlocal</span> <span class="n">condition</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span>
            <span class="nb">isinstance</span><span class="p">(</span><span class="n">test_func</span><span class="p">,</span> <span class="nb">type</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">test_func</span><span class="p">,</span> <span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">)</span>
        <span class="p">):</span>

            <span class="nd">@wraps</span><span class="p">(</span><span class="n">test_func</span><span class="p">)</span>
            <span class="k">def</span><span class="w"> </span><span class="nf">skip_wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
                <span class="k">if</span> <span class="p">(</span>
                    <span class="n">args</span>
                    <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">)</span>
                    <span class="ow">and</span> <span class="n">connection</span><span class="o">.</span><span class="n">alias</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;databases&quot;</span><span class="p">,</span> <span class="p">{})</span>
                <span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> cannot be used on </span><span class="si">%s</span><span class="s2"> as </span><span class="si">%s</span><span class="s2"> doesn&#39;t allow queries &quot;</span>
                        <span class="s2">&quot;against the </span><span class="si">%r</span><span class="s2"> database.&quot;</span>
                        <span class="o">%</span> <span class="p">(</span>
                            <span class="n">name</span><span class="p">,</span>
                            <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                            <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__qualname__</span><span class="p">,</span>
                            <span class="n">connection</span><span class="o">.</span><span class="n">alias</span><span class="p">,</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
                <span class="k">if</span> <span class="n">condition</span><span class="p">():</span>
                    <span class="k">raise</span> <span class="n">unittest</span><span class="o">.</span><span class="n">SkipTest</span><span class="p">(</span><span class="n">reason</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">test_func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

            <span class="n">test_item</span> <span class="o">=</span> <span class="n">skip_wrapper</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Assume a class is decorated</span>
            <span class="n">test_item</span> <span class="o">=</span> <span class="n">test_func</span>
            <span class="n">databases</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">test_item</span><span class="p">,</span> <span class="s2">&quot;databases&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">databases</span> <span class="ow">or</span> <span class="n">connection</span><span class="o">.</span><span class="n">alias</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">databases</span><span class="p">:</span>
                <span class="c1"># Defer raising to allow importing test class&#39;s module.</span>
                <span class="k">def</span><span class="w"> </span><span class="nf">condition</span><span class="p">():</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> cannot be used on </span><span class="si">%s</span><span class="s2"> as it doesn&#39;t allow queries &quot;</span>
                        <span class="s2">&quot;against the &#39;</span><span class="si">%s</span><span class="s2">&#39; database.&quot;</span>
                        <span class="o">%</span> <span class="p">(</span>
                            <span class="n">name</span><span class="p">,</span>
                            <span class="n">test_item</span><span class="p">,</span>
                            <span class="n">connection</span><span class="o">.</span><span class="n">alias</span><span class="p">,</span>
                        <span class="p">)</span>
                    <span class="p">)</span>

            <span class="c1"># Retrieve the possibly existing value from the class&#39;s dict to</span>
            <span class="c1"># avoid triggering the descriptor.</span>
            <span class="n">skip</span> <span class="o">=</span> <span class="n">test_func</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;__unittest_skip__&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">skip</span><span class="p">,</span> <span class="n">CheckCondition</span><span class="p">):</span>
                <span class="n">test_item</span><span class="o">.</span><span class="n">__unittest_skip__</span> <span class="o">=</span> <span class="n">skip</span><span class="o">.</span><span class="n">add_condition</span><span class="p">(</span><span class="n">condition</span><span class="p">,</span> <span class="n">reason</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">skip</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">test_item</span><span class="o">.</span><span class="n">__unittest_skip__</span> <span class="o">=</span> <span class="n">CheckCondition</span><span class="p">((</span><span class="n">condition</span><span class="p">,</span> <span class="n">reason</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">test_item</span>

    <span class="k">return</span> <span class="n">decorator</span>


<div class="viewcode-block" id="skipIfDBFeature">
<a class="viewcode-back" href="../../../autoapi/django/test/testcases/index.html#django.test.testcases.skipIfDBFeature">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">skipIfDBFeature</span><span class="p">(</span><span class="o">*</span><span class="n">features</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Skip a test if a database has at least one of the named features.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">_deferredSkip</span><span class="p">(</span>
        <span class="k">lambda</span><span class="p">:</span> <span class="nb">any</span><span class="p">(</span>
            <span class="nb">getattr</span><span class="p">(</span><span class="n">connection</span><span class="o">.</span><span class="n">features</span><span class="p">,</span> <span class="n">feature</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="n">features</span>
        <span class="p">),</span>
        <span class="s2">&quot;Database has feature(s) </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">features</span><span class="p">),</span>
        <span class="s2">&quot;skipIfDBFeature&quot;</span><span class="p">,</span>
    <span class="p">)</span></div>



<div class="viewcode-block" id="skipUnlessDBFeature">
<a class="viewcode-back" href="../../../autoapi/django/test/testcases/index.html#django.test.testcases.skipUnlessDBFeature">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">skipUnlessDBFeature</span><span class="p">(</span><span class="o">*</span><span class="n">features</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Skip a test unless a database has all the named features.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">_deferredSkip</span><span class="p">(</span>
        <span class="k">lambda</span><span class="p">:</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span>
            <span class="nb">getattr</span><span class="p">(</span><span class="n">connection</span><span class="o">.</span><span class="n">features</span><span class="p">,</span> <span class="n">feature</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="n">features</span>
        <span class="p">),</span>
        <span class="s2">&quot;Database doesn&#39;t support feature(s): </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">features</span><span class="p">),</span>
        <span class="s2">&quot;skipUnlessDBFeature&quot;</span><span class="p">,</span>
    <span class="p">)</span></div>



<span class="k">def</span><span class="w"> </span><span class="nf">skipUnlessAnyDBFeature</span><span class="p">(</span><span class="o">*</span><span class="n">features</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Skip a test unless a database has any of the named features.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">_deferredSkip</span><span class="p">(</span>
        <span class="k">lambda</span><span class="p">:</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span>
            <span class="nb">getattr</span><span class="p">(</span><span class="n">connection</span><span class="o">.</span><span class="n">features</span><span class="p">,</span> <span class="n">feature</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="n">features</span>
        <span class="p">),</span>
        <span class="s2">&quot;Database doesn&#39;t support any of the feature(s): </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">features</span><span class="p">),</span>
        <span class="s2">&quot;skipUnlessAnyDBFeature&quot;</span><span class="p">,</span>
    <span class="p">)</span>


<span class="k">class</span><span class="w"> </span><span class="nc">QuietWSGIRequestHandler</span><span class="p">(</span><span class="n">WSGIRequestHandler</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A WSGIRequestHandler that doesn&#39;t log to standard output any of the</span>
<span class="sd">    requests received, so as to not clutter the test result output.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">log_message</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="k">pass</span>


<span class="k">class</span><span class="w"> </span><span class="nc">FSFilesHandler</span><span class="p">(</span><span class="n">WSGIHandler</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    WSGI middleware that intercepts calls to a directory, as defined by one of</span>
<span class="sd">    the *_ROOT settings, and serves those files, publishing them under *_URL.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">application</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">application</span> <span class="o">=</span> <span class="n">application</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_url</span> <span class="o">=</span> <span class="n">urlparse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_base_url</span><span class="p">())</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_should_handle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check if the path should be handled. Ignore the path if:</span>
<span class="sd">        * the host is provided as part of the base_url</span>
<span class="sd">        * the request&#39;s path isn&#39;t under the media path (or equal)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">path</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">file_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the relative path to the file on disk for the given URL.&quot;&quot;&quot;</span>
        <span class="n">relative_url</span> <span class="o">=</span> <span class="n">url</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="p">:]</span>
        <span class="k">return</span> <span class="n">url2pathname</span><span class="p">(</span><span class="n">relative_url</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">django.http</span><span class="w"> </span><span class="kn">import</span> <span class="n">Http404</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_should_handle</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">serve</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">Http404</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">get_response</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">serve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="n">os_rel_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_path</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
        <span class="n">os_rel_path</span> <span class="o">=</span> <span class="n">posixpath</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">unquote</span><span class="p">(</span><span class="n">os_rel_path</span><span class="p">))</span>
        <span class="c1"># Emulate behavior of django.contrib.staticfiles.views.serve() when it</span>
        <span class="c1"># invokes staticfiles&#39; finders functionality.</span>
        <span class="c1"># TODO: Modify if/when that internal API is refactored</span>
        <span class="n">final_rel_path</span> <span class="o">=</span> <span class="n">os_rel_path</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;/&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">serve</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">final_rel_path</span><span class="p">,</span> <span class="n">document_root</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_base_dir</span><span class="p">())</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_should_handle</span><span class="p">(</span><span class="n">get_path_info</span><span class="p">(</span><span class="n">environ</span><span class="p">)):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="p">(</span><span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__call__</span><span class="p">(</span><span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">)</span>


<span class="k">class</span><span class="w"> </span><span class="nc">_StaticFilesHandler</span><span class="p">(</span><span class="n">FSFilesHandler</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Handler for serving static files. A private class that is meant to be used</span>
<span class="sd">    solely as a convenience by LiveServerThread.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_base_dir</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">settings</span><span class="o">.</span><span class="n">STATIC_ROOT</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_base_url</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">settings</span><span class="o">.</span><span class="n">STATIC_URL</span>


<span class="k">class</span><span class="w"> </span><span class="nc">_MediaFilesHandler</span><span class="p">(</span><span class="n">FSFilesHandler</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Handler for serving the media files. A private class that is meant to be</span>
<span class="sd">    used solely as a convenience by LiveServerThread.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_base_dir</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">settings</span><span class="o">.</span><span class="n">MEDIA_ROOT</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_base_url</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">settings</span><span class="o">.</span><span class="n">MEDIA_URL</span>


<span class="k">class</span><span class="w"> </span><span class="nc">LiveServerThread</span><span class="p">(</span><span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Thread for running a live HTTP server while the tests are running.&quot;&quot;&quot;</span>

    <span class="n">server_class</span> <span class="o">=</span> <span class="n">ThreadedWSGIServer</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">static_handler</span><span class="p">,</span> <span class="n">connections_override</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">host</span> <span class="o">=</span> <span class="n">host</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">port</span> <span class="o">=</span> <span class="n">port</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_ready</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Event</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">error</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">static_handler</span> <span class="o">=</span> <span class="n">static_handler</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connections_override</span> <span class="o">=</span> <span class="n">connections_override</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set up the live server and databases, and then loop over handling</span>
<span class="sd">        HTTP requests.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">connections_override</span><span class="p">:</span>
            <span class="c1"># Override this thread&#39;s database connections with the ones</span>
            <span class="c1"># provided by the main thread.</span>
            <span class="k">for</span> <span class="n">alias</span><span class="p">,</span> <span class="n">conn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">connections_override</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">connections</span><span class="p">[</span><span class="n">alias</span><span class="p">]</span> <span class="o">=</span> <span class="n">conn</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Create the handler for serving static and media files</span>
            <span class="n">handler</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">static_handler</span><span class="p">(</span><span class="n">_MediaFilesHandler</span><span class="p">(</span><span class="n">WSGIHandler</span><span class="p">()))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">httpd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_server</span><span class="p">(</span>
                <span class="n">connections_override</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">connections_override</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="c1"># If binding to port zero, assign the port allocated by the OS.</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">port</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">port</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">httpd</span><span class="o">.</span><span class="n">server_address</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">httpd</span><span class="o">.</span><span class="n">set_app</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">is_ready</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">httpd</span><span class="o">.</span><span class="n">serve_forever</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">error</span> <span class="o">=</span> <span class="n">e</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">is_ready</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">connections</span><span class="o">.</span><span class="n">close_all</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_create_server</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">connections_override</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">server_class</span><span class="p">(</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">),</span>
            <span class="n">QuietWSGIRequestHandler</span><span class="p">,</span>
            <span class="n">allow_reuse_address</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">connections_override</span><span class="o">=</span><span class="n">connections_override</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">terminate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;httpd&quot;</span><span class="p">):</span>
            <span class="c1"># Stop the WSGI server</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">httpd</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">httpd</span><span class="o">.</span><span class="n">server_close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>


<span class="k">class</span><span class="w"> </span><span class="nc">LiveServerTestCase</span><span class="p">(</span><span class="n">TransactionTestCase</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Do basically the same as TransactionTestCase but also launch a live HTTP</span>
<span class="sd">    server in a separate thread so that the tests may use another testing</span>
<span class="sd">    framework, such as Selenium for example, instead of the built-in dummy</span>
<span class="sd">    client.</span>
<span class="sd">    It inherits from TransactionTestCase instead of TestCase because the</span>
<span class="sd">    threads don&#39;t share the same transactions (unless if using in-memory sqlite)</span>
<span class="sd">    and each thread needs to commit all their transactions so that the other</span>
<span class="sd">    thread can see the changes.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">host</span> <span class="o">=</span> <span class="s2">&quot;localhost&quot;</span>
    <span class="n">port</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">server_thread_class</span> <span class="o">=</span> <span class="n">LiveServerThread</span>
    <span class="n">static_handler</span> <span class="o">=</span> <span class="n">_StaticFilesHandler</span>

    <span class="nd">@classproperty</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">live_server_url</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;http://</span><span class="si">%s</span><span class="s2">:</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">host</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">server_thread</span><span class="o">.</span><span class="n">port</span><span class="p">)</span>

    <span class="nd">@classproperty</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">allowed_host</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">host</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_make_connections_override</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="n">connections_override</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">conn</span> <span class="ow">in</span> <span class="n">connections</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
            <span class="c1"># If using in-memory sqlite databases, pass the connections to</span>
            <span class="c1"># the server thread.</span>
            <span class="k">if</span> <span class="n">conn</span><span class="o">.</span><span class="n">vendor</span> <span class="o">==</span> <span class="s2">&quot;sqlite&quot;</span> <span class="ow">and</span> <span class="n">conn</span><span class="o">.</span><span class="n">is_in_memory_db</span><span class="p">():</span>
                <span class="n">connections_override</span><span class="p">[</span><span class="n">conn</span><span class="o">.</span><span class="n">alias</span><span class="p">]</span> <span class="o">=</span> <span class="n">conn</span>
        <span class="k">return</span> <span class="n">connections_override</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">setUpClass</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">setUpClass</span><span class="p">()</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">_live_server_modified_settings</span> <span class="o">=</span> <span class="n">modify_settings</span><span class="p">(</span>
            <span class="n">ALLOWED_HOSTS</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;append&quot;</span><span class="p">:</span> <span class="bp">cls</span><span class="o">.</span><span class="n">allowed_host</span><span class="p">},</span>
        <span class="p">)</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">_live_server_modified_settings</span><span class="o">.</span><span class="n">enable</span><span class="p">()</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">addClassCleanup</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_live_server_modified_settings</span><span class="o">.</span><span class="n">disable</span><span class="p">)</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">_start_server_thread</span><span class="p">()</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_start_server_thread</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="n">connections_override</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_make_connections_override</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">conn</span> <span class="ow">in</span> <span class="n">connections_override</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="c1"># Explicitly enable thread-shareability for this connection.</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">inc_thread_sharing</span><span class="p">()</span>

        <span class="bp">cls</span><span class="o">.</span><span class="n">server_thread</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_create_server_thread</span><span class="p">(</span><span class="n">connections_override</span><span class="p">)</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">server_thread</span><span class="o">.</span><span class="n">daemon</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">server_thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">addClassCleanup</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_terminate_thread</span><span class="p">)</span>

        <span class="c1"># Wait for the live server to be ready</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">server_thread</span><span class="o">.</span><span class="n">is_ready</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">cls</span><span class="o">.</span><span class="n">server_thread</span><span class="o">.</span><span class="n">error</span><span class="p">:</span>
            <span class="k">raise</span> <span class="bp">cls</span><span class="o">.</span><span class="n">server_thread</span><span class="o">.</span><span class="n">error</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_create_server_thread</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">connections_override</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">server_thread_class</span><span class="p">(</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">host</span><span class="p">,</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">static_handler</span><span class="p">,</span>
            <span class="n">connections_override</span><span class="o">=</span><span class="n">connections_override</span><span class="p">,</span>
            <span class="n">port</span><span class="o">=</span><span class="bp">cls</span><span class="o">.</span><span class="n">port</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_terminate_thread</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="c1"># Terminate the live server&#39;s thread.</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">server_thread</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
        <span class="c1"># Restore shared connections&#39; non-shareability.</span>
        <span class="k">for</span> <span class="n">conn</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">server_thread</span><span class="o">.</span><span class="n">connections_override</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">dec_thread_sharing</span><span class="p">()</span>


<span class="k">class</span><span class="w"> </span><span class="nc">SerializeMixin</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Enforce serialization of TestCases that share a common resource.</span>

<span class="sd">    Define a common &#39;lockfile&#39; for each set of TestCases to serialize. This</span>
<span class="sd">    file must exist on the filesystem.</span>

<span class="sd">    Place it early in the MRO in order to isolate setUpClass()/tearDownClass().</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">lockfile</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">__init_subclass__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">/</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__init_subclass__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">cls</span><span class="o">.</span><span class="n">lockfile</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">.lockfile isn&#39;t set. Set it to a unique value &quot;</span>
                <span class="s2">&quot;in the base class.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
            <span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">setUpClass</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">_lockfile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">lockfile</span><span class="p">)</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">addClassCleanup</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_lockfile</span><span class="o">.</span><span class="n">close</span><span class="p">)</span>
        <span class="n">locks</span><span class="o">.</span><span class="n">lock</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_lockfile</span><span class="p">,</span> <span class="n">locks</span><span class="o">.</span><span class="n">LOCK_EX</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">setUpClass</span><span class="p">()</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright .</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>