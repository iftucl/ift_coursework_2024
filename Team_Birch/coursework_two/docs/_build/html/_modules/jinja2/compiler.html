

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>jinja2.compiler &mdash; Coursework Two 1.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css?v=4ae1632d" />

  
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=f2a433a1"></script>
      <script src="../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            Coursework Two
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../installation_guide.html">Installation Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usage_instructions.html">Usage Instructions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../architecture_overview.html">Architecture Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../autoapi/index.html">API Reference</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Coursework Two</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">jinja2.compiler</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for jinja2.compiler</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Compiles nodes from the parser into Python code.&quot;&quot;&quot;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">t</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">contextlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">contextmanager</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">functools</span><span class="w"> </span><span class="kn">import</span> <span class="n">update_wrapper</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">io</span><span class="w"> </span><span class="kn">import</span> <span class="n">StringIO</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">itertools</span><span class="w"> </span><span class="kn">import</span> <span class="n">chain</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">keyword</span><span class="w"> </span><span class="kn">import</span> <span class="n">iskeyword</span> <span class="k">as</span> <span class="n">is_python_keyword</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">markupsafe</span><span class="w"> </span><span class="kn">import</span> <span class="n">Markup</span><span class="p">,</span> <span class="n">escape</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">.</span><span class="w"> </span><span class="kn">import</span> <span class="n">nodes</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.exceptions</span><span class="w"> </span><span class="kn">import</span> <span class="n">TemplateAssertionError</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.idtracking</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">VAR_LOAD_ALIAS</span><span class="p">,</span>
    <span class="n">VAR_LOAD_PARAMETER</span><span class="p">,</span>
    <span class="n">VAR_LOAD_RESOLVE</span><span class="p">,</span>
    <span class="n">VAR_LOAD_UNDEFINED</span><span class="p">,</span>
    <span class="n">Symbols</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.nodes</span><span class="w"> </span><span class="kn">import</span> <span class="n">EvalContext</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.optimizer</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optimizer</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">_PassArg</span><span class="p">,</span> <span class="n">concat</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.visitor</span><span class="w"> </span><span class="kn">import</span> <span class="n">NodeVisitor</span>

<span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">TYPE_CHECKING</span><span class="p">:</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">typing_extensions</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">te</span>

    <span class="kn">from</span><span class="w"> </span><span class="nn">.environment</span><span class="w"> </span><span class="kn">import</span> <span class="n">Environment</span>

<div class="viewcode-block" id="F">
<a class="viewcode-back" href="../../autoapi/jinja2/compiler/index.html#jinja2.compiler.F">[docs]</a>
<span class="n">F</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">TypeVar</span><span class="p">(</span><span class="s2">&quot;F&quot;</span><span class="p">,</span> <span class="n">bound</span><span class="o">=</span><span class="n">t</span><span class="o">.</span><span class="n">Callable</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">Any</span><span class="p">])</span></div>


<div class="viewcode-block" id="operators">
<a class="viewcode-back" href="../../autoapi/jinja2/compiler/index.html#jinja2.compiler.operators">[docs]</a>
<span class="n">operators</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;eq&quot;</span><span class="p">:</span> <span class="s2">&quot;==&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ne&quot;</span><span class="p">:</span> <span class="s2">&quot;!=&quot;</span><span class="p">,</span>
    <span class="s2">&quot;gt&quot;</span><span class="p">:</span> <span class="s2">&quot;&gt;&quot;</span><span class="p">,</span>
    <span class="s2">&quot;gteq&quot;</span><span class="p">:</span> <span class="s2">&quot;&gt;=&quot;</span><span class="p">,</span>
    <span class="s2">&quot;lt&quot;</span><span class="p">:</span> <span class="s2">&quot;&lt;&quot;</span><span class="p">,</span>
    <span class="s2">&quot;lteq&quot;</span><span class="p">:</span> <span class="s2">&quot;&lt;=&quot;</span><span class="p">,</span>
    <span class="s2">&quot;in&quot;</span><span class="p">:</span> <span class="s2">&quot;in&quot;</span><span class="p">,</span>
    <span class="s2">&quot;notin&quot;</span><span class="p">:</span> <span class="s2">&quot;not in&quot;</span><span class="p">,</span>
<span class="p">}</span></div>



<div class="viewcode-block" id="optimizeconst">
<a class="viewcode-back" href="../../autoapi/jinja2/compiler/index.html#jinja2.compiler.optimizeconst">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">optimizeconst</span><span class="p">(</span><span class="n">f</span><span class="p">:</span> <span class="n">F</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">F</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">new_func</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">:</span> <span class="s2">&quot;CodeGenerator&quot;</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">nodes</span><span class="o">.</span><span class="n">Expr</span><span class="p">,</span> <span class="n">frame</span><span class="p">:</span> <span class="s2">&quot;Frame&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Any</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Any</span><span class="p">:</span>
        <span class="c1"># Only optimize if the frame is not volatile</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">frame</span><span class="o">.</span><span class="n">eval_ctx</span><span class="o">.</span><span class="n">volatile</span><span class="p">:</span>
            <span class="n">new_node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">frame</span><span class="o">.</span><span class="n">eval_ctx</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">new_node</span> <span class="o">!=</span> <span class="n">node</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">new_node</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">f</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">frame</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">update_wrapper</span><span class="p">(</span><span class="n">new_func</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>  <span class="c1"># type: ignore[return-value]</span></div>



<span class="k">def</span><span class="w"> </span><span class="nf">_make_binop</span><span class="p">(</span><span class="n">op</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Callable</span><span class="p">[[</span><span class="s2">&quot;CodeGenerator&quot;</span><span class="p">,</span> <span class="n">nodes</span><span class="o">.</span><span class="n">BinExpr</span><span class="p">,</span> <span class="s2">&quot;Frame&quot;</span><span class="p">],</span> <span class="kc">None</span><span class="p">]:</span>
    <span class="nd">@optimizeconst</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">visitor</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="s2">&quot;CodeGenerator&quot;</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">nodes</span><span class="o">.</span><span class="n">BinExpr</span><span class="p">,</span> <span class="n">frame</span><span class="p">:</span> <span class="n">Frame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">sandboxed</span> <span class="ow">and</span> <span class="n">op</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">intercepted_binops</span>  <span class="c1"># type: ignore</span>
        <span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;environment.call_binop(context, </span><span class="si">{</span><span class="n">op</span><span class="si">!r}</span><span class="s2">, &quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">left</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;, &quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">right</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;(&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">left</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="n">op</span><span class="si">}</span><span class="s2"> &quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">right</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;)&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">visitor</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_make_unop</span><span class="p">(</span>
    <span class="n">op</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Callable</span><span class="p">[[</span><span class="s2">&quot;CodeGenerator&quot;</span><span class="p">,</span> <span class="n">nodes</span><span class="o">.</span><span class="n">UnaryExpr</span><span class="p">,</span> <span class="s2">&quot;Frame&quot;</span><span class="p">],</span> <span class="kc">None</span><span class="p">]:</span>
    <span class="nd">@optimizeconst</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">visitor</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="s2">&quot;CodeGenerator&quot;</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">nodes</span><span class="o">.</span><span class="n">UnaryExpr</span><span class="p">,</span> <span class="n">frame</span><span class="p">:</span> <span class="n">Frame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">sandboxed</span> <span class="ow">and</span> <span class="n">op</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">intercepted_unops</span>  <span class="c1"># type: ignore</span>
        <span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;environment.call_unop(context, </span><span class="si">{</span><span class="n">op</span><span class="si">!r}</span><span class="s2">, &quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">node</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;(&quot;</span> <span class="o">+</span> <span class="n">op</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">node</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;)&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">visitor</span>


<div class="viewcode-block" id="generate">
<a class="viewcode-back" href="../../autoapi/jinja2/compiler/index.html#jinja2.compiler.generate">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">generate</span><span class="p">(</span>
    <span class="n">node</span><span class="p">:</span> <span class="n">nodes</span><span class="o">.</span><span class="n">Template</span><span class="p">,</span>
    <span class="n">environment</span><span class="p">:</span> <span class="s2">&quot;Environment&quot;</span><span class="p">,</span>
    <span class="n">name</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">filename</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">stream</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">TextIO</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">defer_init</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">optimized</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generate the python source for a node tree.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">nodes</span><span class="o">.</span><span class="n">Template</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Can&#39;t compile non template nodes&quot;</span><span class="p">)</span>

    <span class="n">generator</span> <span class="o">=</span> <span class="n">environment</span><span class="o">.</span><span class="n">code_generator_class</span><span class="p">(</span>
        <span class="n">environment</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">stream</span><span class="p">,</span> <span class="n">defer_init</span><span class="p">,</span> <span class="n">optimized</span>
    <span class="p">)</span>
    <span class="n">generator</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">stream</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">generator</span><span class="o">.</span><span class="n">stream</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span>  <span class="c1"># type: ignore</span>

    <span class="k">return</span> <span class="kc">None</span></div>



<div class="viewcode-block" id="has_safe_repr">
<a class="viewcode-back" href="../../autoapi/jinja2/compiler/index.html#jinja2.compiler.has_safe_repr">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">has_safe_repr</span><span class="p">(</span><span class="n">value</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Does the node have a safe representation?&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">value</span> <span class="ow">is</span> <span class="bp">NotImplemented</span> <span class="ow">or</span> <span class="n">value</span> <span class="ow">is</span> <span class="bp">Ellipsis</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="ow">in</span> <span class="p">{</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">complex</span><span class="p">,</span> <span class="nb">range</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="n">Markup</span><span class="p">}:</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="ow">in</span> <span class="p">{</span><span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">,</span> <span class="nb">set</span><span class="p">,</span> <span class="nb">frozenset</span><span class="p">}:</span>
        <span class="k">return</span> <span class="nb">all</span><span class="p">(</span><span class="n">has_safe_repr</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">value</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">dict</span><span class="p">:</span>  <span class="c1"># noqa E721</span>
        <span class="k">return</span> <span class="nb">all</span><span class="p">(</span><span class="n">has_safe_repr</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="ow">and</span> <span class="n">has_safe_repr</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">value</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>

    <span class="k">return</span> <span class="kc">False</span></div>



<div class="viewcode-block" id="find_undeclared">
<a class="viewcode-back" href="../../autoapi/jinja2/compiler/index.html#jinja2.compiler.find_undeclared">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">find_undeclared</span><span class="p">(</span>
    <span class="n">nodes</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Iterable</span><span class="p">[</span><span class="n">nodes</span><span class="o">.</span><span class="n">Node</span><span class="p">],</span> <span class="n">names</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Check if the names passed are accessed undeclared.  The return value</span>
<span class="sd">    is a set of all the undeclared names from the sequence of names found.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">visitor</span> <span class="o">=</span> <span class="n">UndeclaredNameVisitor</span><span class="p">(</span><span class="n">names</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">:</span>
            <span class="n">visitor</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">VisitorExit</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">return</span> <span class="n">visitor</span><span class="o">.</span><span class="n">undeclared</span></div>



<div class="viewcode-block" id="MacroRef">
<a class="viewcode-back" href="../../autoapi/jinja2/compiler/index.html#jinja2.compiler.MacroRef">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">MacroRef</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="n">nodes</span><span class="o">.</span><span class="n">Macro</span><span class="p">,</span> <span class="n">nodes</span><span class="o">.</span><span class="n">CallBlock</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<div class="viewcode-block" id="MacroRef.node">
<a class="viewcode-back" href="../../autoapi/jinja2/compiler/index.html#jinja2.compiler.MacroRef.node">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">node</span> <span class="o">=</span> <span class="n">node</span></div>

<div class="viewcode-block" id="MacroRef.accesses_caller">
<a class="viewcode-back" href="../../autoapi/jinja2/compiler/index.html#jinja2.compiler.MacroRef.accesses_caller">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">accesses_caller</span> <span class="o">=</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="MacroRef.accesses_kwargs">
<a class="viewcode-back" href="../../autoapi/jinja2/compiler/index.html#jinja2.compiler.MacroRef.accesses_kwargs">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">accesses_kwargs</span> <span class="o">=</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="MacroRef.accesses_varargs">
<a class="viewcode-back" href="../../autoapi/jinja2/compiler/index.html#jinja2.compiler.MacroRef.accesses_varargs">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">accesses_varargs</span> <span class="o">=</span> <span class="kc">False</span></div>
</div>



<div class="viewcode-block" id="Frame">
<a class="viewcode-back" href="../../autoapi/jinja2/compiler/index.html#jinja2.compiler.Frame">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Frame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Holds compile time information for us.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">eval_ctx</span><span class="p">:</span> <span class="n">EvalContext</span><span class="p">,</span>
        <span class="n">parent</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="s2">&quot;Frame&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">level</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<div class="viewcode-block" id="Frame.eval_ctx">
<a class="viewcode-back" href="../../autoapi/jinja2/compiler/index.html#jinja2.compiler.Frame.eval_ctx">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">eval_ctx</span> <span class="o">=</span> <span class="n">eval_ctx</span></div>


        <span class="c1"># the parent of this frame</span>
<div class="viewcode-block" id="Frame.parent">
<a class="viewcode-back" href="../../autoapi/jinja2/compiler/index.html#jinja2.compiler.Frame.parent">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">parent</span></div>


        <span class="k">if</span> <span class="n">parent</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">symbols</span> <span class="o">=</span> <span class="n">Symbols</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">level</span><span class="p">)</span>

            <span class="c1"># in some dynamic inheritance situations the compiler needs to add</span>
            <span class="c1"># write tests around output statements.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">require_output_check</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="c1"># inside some tags we are using a buffer rather than yield statements.</span>
            <span class="c1"># this for example affects {% filter %} or {% macro %}.  If a frame</span>
            <span class="c1"># is buffered this variable points to the name of the list used as</span>
            <span class="c1"># buffer.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="c1"># the name of the block we&#39;re in, otherwise None.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">block</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">symbols</span> <span class="o">=</span> <span class="n">Symbols</span><span class="p">(</span><span class="n">parent</span><span class="o">.</span><span class="n">symbols</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">level</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">require_output_check</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">require_output_check</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">buffer</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">block</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">block</span>

        <span class="c1"># a toplevel frame is the root + soft frames such as if conditions.</span>
<div class="viewcode-block" id="Frame.toplevel">
<a class="viewcode-back" href="../../autoapi/jinja2/compiler/index.html#jinja2.compiler.Frame.toplevel">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">toplevel</span> <span class="o">=</span> <span class="kc">False</span></div>


        <span class="c1"># the root frame is basically just the outermost frame, so no if</span>
        <span class="c1"># conditions.  This information is used to optimize inheritance</span>
        <span class="c1"># situations.</span>
<div class="viewcode-block" id="Frame.rootlevel">
<a class="viewcode-back" href="../../autoapi/jinja2/compiler/index.html#jinja2.compiler.Frame.rootlevel">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">rootlevel</span> <span class="o">=</span> <span class="kc">False</span></div>


        <span class="c1"># variables set inside of loops and blocks should not affect outer frames,</span>
        <span class="c1"># but they still needs to be kept track of as part of the active context.</span>
<div class="viewcode-block" id="Frame.loop_frame">
<a class="viewcode-back" href="../../autoapi/jinja2/compiler/index.html#jinja2.compiler.Frame.loop_frame">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">loop_frame</span> <span class="o">=</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="Frame.block_frame">
<a class="viewcode-back" href="../../autoapi/jinja2/compiler/index.html#jinja2.compiler.Frame.block_frame">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">block_frame</span> <span class="o">=</span> <span class="kc">False</span></div>


        <span class="c1"># track whether the frame is being used in an if-statement or conditional</span>
        <span class="c1"># expression as it determines which errors should be raised during runtime</span>
        <span class="c1"># or compile time.</span>
<div class="viewcode-block" id="Frame.soft_frame">
<a class="viewcode-back" href="../../autoapi/jinja2/compiler/index.html#jinja2.compiler.Frame.soft_frame">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">soft_frame</span> <span class="o">=</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="Frame.copy">
<a class="viewcode-back" href="../../autoapi/jinja2/compiler/index.html#jinja2.compiler.Frame.copy">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;te.Self&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a copy of the current one.&quot;&quot;&quot;</span>
        <span class="n">rv</span> <span class="o">=</span> <span class="nb">object</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">)</span>
        <span class="n">rv</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span>
        <span class="n">rv</span><span class="o">.</span><span class="n">symbols</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbols</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">rv</span></div>


<div class="viewcode-block" id="Frame.inner">
<a class="viewcode-back" href="../../autoapi/jinja2/compiler/index.html#jinja2.compiler.Frame.inner">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">inner</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">isolated</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Frame&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return an inner frame.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">isolated</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Frame</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eval_ctx</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">symbols</span><span class="o">.</span><span class="n">level</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Frame</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eval_ctx</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span></div>


<div class="viewcode-block" id="Frame.soft">
<a class="viewcode-back" href="../../autoapi/jinja2/compiler/index.html#jinja2.compiler.Frame.soft">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">soft</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;te.Self&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a soft frame.  A soft frame may not be modified as</span>
<span class="sd">        standalone thing as it shares the resources with the frame it</span>
<span class="sd">        was created of, but it&#39;s not a rootlevel frame any longer.</span>

<span class="sd">        This is only used to implement if-statements and conditional</span>
<span class="sd">        expressions.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">rv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">rv</span><span class="o">.</span><span class="n">rootlevel</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">rv</span><span class="o">.</span><span class="n">soft_frame</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="n">rv</span></div>


    <span class="n">__copy__</span> <span class="o">=</span> <span class="n">copy</span></div>



<div class="viewcode-block" id="VisitorExit">
<a class="viewcode-back" href="../../autoapi/jinja2/compiler/index.html#jinja2.compiler.VisitorExit">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">VisitorExit</span><span class="p">(</span><span class="ne">RuntimeError</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Exception used by the `UndeclaredNameVisitor` to signal a stop.&quot;&quot;&quot;</span></div>



<div class="viewcode-block" id="DependencyFinderVisitor">
<a class="viewcode-back" href="../../autoapi/jinja2/compiler/index.html#jinja2.compiler.DependencyFinderVisitor">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">DependencyFinderVisitor</span><span class="p">(</span><span class="n">NodeVisitor</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A visitor that collects filter and test calls.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<div class="viewcode-block" id="DependencyFinderVisitor.filters">
<a class="viewcode-back" href="../../autoapi/jinja2/compiler/index.html#jinja2.compiler.DependencyFinderVisitor.filters">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">filters</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span></div>

<div class="viewcode-block" id="DependencyFinderVisitor.tests">
<a class="viewcode-back" href="../../autoapi/jinja2/compiler/index.html#jinja2.compiler.DependencyFinderVisitor.tests">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">tests</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span></div>


<div class="viewcode-block" id="DependencyFinderVisitor.visit_Filter">
<a class="viewcode-back" href="../../autoapi/jinja2/compiler/index.html#jinja2.compiler.DependencyFinderVisitor.visit_Filter">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">visit_Filter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">nodes</span><span class="o">.</span><span class="n">Filter</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">generic_visit</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filters</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="p">)</span></div>


<div class="viewcode-block" id="DependencyFinderVisitor.visit_Test">
<a class="viewcode-back" href="../../autoapi/jinja2/compiler/index.html#jinja2.compiler.DependencyFinderVisitor.visit_Test">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">visit_Test</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">nodes</span><span class="o">.</span><span class="n">Test</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">generic_visit</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tests</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="p">)</span></div>


<div class="viewcode-block" id="DependencyFinderVisitor.visit_Block">
<a class="viewcode-back" href="../../autoapi/jinja2/compiler/index.html#jinja2.compiler.DependencyFinderVisitor.visit_Block">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">visit_Block</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">nodes</span><span class="o">.</span><span class="n">Block</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Stop visiting at blocks.&quot;&quot;&quot;</span></div>
</div>



<div class="viewcode-block" id="UndeclaredNameVisitor">
<a class="viewcode-back" href="../../autoapi/jinja2/compiler/index.html#jinja2.compiler.UndeclaredNameVisitor">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">UndeclaredNameVisitor</span><span class="p">(</span><span class="n">NodeVisitor</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A visitor that checks if a name is accessed without being</span>
<span class="sd">    declared.  This is different from the frame visitor as it will</span>
<span class="sd">    not stop at closure frames.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">names</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<div class="viewcode-block" id="UndeclaredNameVisitor.names">
<a class="viewcode-back" href="../../autoapi/jinja2/compiler/index.html#jinja2.compiler.UndeclaredNameVisitor.names">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">names</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">names</span><span class="p">)</span></div>

<div class="viewcode-block" id="UndeclaredNameVisitor.undeclared">
<a class="viewcode-back" href="../../autoapi/jinja2/compiler/index.html#jinja2.compiler.UndeclaredNameVisitor.undeclared">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">undeclared</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span></div>


<div class="viewcode-block" id="UndeclaredNameVisitor.visit_Name">
<a class="viewcode-back" href="../../autoapi/jinja2/compiler/index.html#jinja2.compiler.UndeclaredNameVisitor.visit_Name">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">visit_Name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">nodes</span><span class="o">.</span><span class="n">Name</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">ctx</span> <span class="o">==</span> <span class="s2">&quot;load&quot;</span> <span class="ow">and</span> <span class="n">node</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">names</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">undeclared</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">undeclared</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">names</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">VisitorExit</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">names</span><span class="o">.</span><span class="n">discard</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="p">)</span></div>


<div class="viewcode-block" id="UndeclaredNameVisitor.visit_Block">
<a class="viewcode-back" href="../../autoapi/jinja2/compiler/index.html#jinja2.compiler.UndeclaredNameVisitor.visit_Block">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">visit_Block</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">nodes</span><span class="o">.</span><span class="n">Block</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Stop visiting a blocks.&quot;&quot;&quot;</span></div>
</div>



<div class="viewcode-block" id="CompilerExit">
<a class="viewcode-back" href="../../autoapi/jinja2/compiler/index.html#jinja2.compiler.CompilerExit">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">CompilerExit</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Raised if the compiler encountered a situation where it just</span>
<span class="sd">    doesn&#39;t make sense to further process the code.  Any block that</span>
<span class="sd">    raises such an exception is not further processed.</span>
<span class="sd">    &quot;&quot;&quot;</span></div>



<div class="viewcode-block" id="CodeGenerator">
<a class="viewcode-back" href="../../autoapi/jinja2/compiler/index.html#jinja2.compiler.CodeGenerator">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">CodeGenerator</span><span class="p">(</span><span class="n">NodeVisitor</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">environment</span><span class="p">:</span> <span class="s2">&quot;Environment&quot;</span><span class="p">,</span>
        <span class="n">name</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">filename</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">stream</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">TextIO</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">defer_init</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">optimized</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">stream</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">stream</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">()</span>
<div class="viewcode-block" id="CodeGenerator.environment">
<a class="viewcode-back" href="../../autoapi/jinja2/compiler/index.html#jinja2.compiler.CodeGenerator.environment">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">environment</span> <span class="o">=</span> <span class="n">environment</span></div>

<div class="viewcode-block" id="CodeGenerator.name">
<a class="viewcode-back" href="../../autoapi/jinja2/compiler/index.html#jinja2.compiler.CodeGenerator.name">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span></div>

<div class="viewcode-block" id="CodeGenerator.filename">
<a class="viewcode-back" href="../../autoapi/jinja2/compiler/index.html#jinja2.compiler.CodeGenerator.filename">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span></div>

<div class="viewcode-block" id="CodeGenerator.stream">
<a class="viewcode-back" href="../../autoapi/jinja2/compiler/index.html#jinja2.compiler.CodeGenerator.stream">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">stream</span> <span class="o">=</span> <span class="n">stream</span></div>

<div class="viewcode-block" id="CodeGenerator.created_block_context">
<a class="viewcode-back" href="../../autoapi/jinja2/compiler/index.html#jinja2.compiler.CodeGenerator.created_block_context">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">created_block_context</span> <span class="o">=</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="CodeGenerator.defer_init">
<a class="viewcode-back" href="../../autoapi/jinja2/compiler/index.html#jinja2.compiler.CodeGenerator.defer_init">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">defer_init</span> <span class="o">=</span> <span class="n">defer_init</span></div>

<div class="viewcode-block" id="CodeGenerator.optimizer">
<a class="viewcode-back" href="../../autoapi/jinja2/compiler/index.html#jinja2.compiler.CodeGenerator.optimizer">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">Optimizer</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span></div>


        <span class="k">if</span> <span class="n">optimized</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span> <span class="o">=</span> <span class="n">Optimizer</span><span class="p">(</span><span class="n">environment</span><span class="p">)</span>

        <span class="c1"># aliases for imports</span>
<div class="viewcode-block" id="CodeGenerator.import_aliases">
<a class="viewcode-back" href="../../autoapi/jinja2/compiler/index.html#jinja2.compiler.CodeGenerator.import_aliases">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">import_aliases</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span></div>


        <span class="c1"># a registry for all blocks.  Because blocks are moved out</span>
        <span class="c1"># into the global python scope they are registered here</span>
<div class="viewcode-block" id="CodeGenerator.blocks">
<a class="viewcode-back" href="../../autoapi/jinja2/compiler/index.html#jinja2.compiler.CodeGenerator.blocks">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">blocks</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">nodes</span><span class="o">.</span><span class="n">Block</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span></div>


        <span class="c1"># the number of extends statements so far</span>
<div class="viewcode-block" id="CodeGenerator.extends_so_far">
<a class="viewcode-back" href="../../autoapi/jinja2/compiler/index.html#jinja2.compiler.CodeGenerator.extends_so_far">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">extends_so_far</span> <span class="o">=</span> <span class="mi">0</span></div>


        <span class="c1"># some templates have a rootlevel extends.  In this case we</span>
        <span class="c1"># can safely assume that we&#39;re a child template and do some</span>
        <span class="c1"># more optimizations.</span>
<div class="viewcode-block" id="CodeGenerator.has_known_extends">
<a class="viewcode-back" href="../../autoapi/jinja2/compiler/index.html#jinja2.compiler.CodeGenerator.has_known_extends">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">has_known_extends</span> <span class="o">=</span> <span class="kc">False</span></div>


        <span class="c1"># the current line number</span>
<div class="viewcode-block" id="CodeGenerator.code_lineno">
<a class="viewcode-back" href="../../autoapi/jinja2/compiler/index.html#jinja2.compiler.CodeGenerator.code_lineno">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">code_lineno</span> <span class="o">=</span> <span class="mi">1</span></div>


        <span class="c1"># registry of all filters and tests (global, not block local)</span>
<div class="viewcode-block" id="CodeGenerator.tests">
<a class="viewcode-back" href="../../autoapi/jinja2/compiler/index.html#jinja2.compiler.CodeGenerator.tests">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">tests</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span></div>

<div class="viewcode-block" id="CodeGenerator.filters">
<a class="viewcode-back" href="../../autoapi/jinja2/compiler/index.html#jinja2.compiler.CodeGenerator.filters">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">filters</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span></div>


        <span class="c1"># the debug information</span>
<div class="viewcode-block" id="CodeGenerator.debug_info">
<a class="viewcode-back" href="../../autoapi/jinja2/compiler/index.html#jinja2.compiler.CodeGenerator.debug_info">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug_info</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">List</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span></div>

        <span class="bp">self</span><span class="o">.</span><span class="n">_write_debug_info</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># the number of new lines before the next write()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_new_lines</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># the line number of the last written statement</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_last_line</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># true if nothing was written so far.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_first_write</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># used by the `temporary_identifier` method to get new</span>
        <span class="c1"># unique, temporary identifier</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_last_identifier</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># the current indentation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_indentation</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># Tracks toplevel assignments</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_assign_stack</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">List</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Tracks parameter definition blocks</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_param_def_block</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">List</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Tracks the current context.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_context_reference_stack</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;context&quot;</span><span class="p">]</span>

    <span class="nd">@property</span>
<div class="viewcode-block" id="CodeGenerator.optimized">
<a class="viewcode-back" href="../../autoapi/jinja2/compiler/index.html#jinja2.compiler.CodeGenerator.optimized">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">optimized</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span></div>


    <span class="c1"># -- Various compilation helpers</span>

<div class="viewcode-block" id="CodeGenerator.fail">
<a class="viewcode-back" href="../../autoapi/jinja2/compiler/index.html#jinja2.compiler.CodeGenerator.fail">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">fail</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">lineno</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;te.NoReturn&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Fail with a :exc:`TemplateAssertionError`.&quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="n">TemplateAssertionError</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">lineno</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span></div>


<div class="viewcode-block" id="CodeGenerator.temporary_identifier">
<a class="viewcode-back" href="../../autoapi/jinja2/compiler/index.html#jinja2.compiler.CodeGenerator.temporary_identifier">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">temporary_identifier</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get a new unique identifier.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_last_identifier</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;t_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_last_identifier</span><span class="si">}</span><span class="s2">&quot;</span></div>


<div class="viewcode-block" id="CodeGenerator.buffer">
<a class="viewcode-back" href="../../autoapi/jinja2/compiler/index.html#jinja2.compiler.CodeGenerator.buffer">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">buffer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame</span><span class="p">:</span> <span class="n">Frame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Enable buffering for the frame from that point onwards.&quot;&quot;&quot;</span>
        <span class="n">frame</span><span class="o">.</span><span class="n">buffer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">temporary_identifier</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">frame</span><span class="o">.</span><span class="n">buffer</span><span class="si">}</span><span class="s2"> = []&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="CodeGenerator.return_buffer_contents">
<a class="viewcode-back" href="../../autoapi/jinja2/compiler/index.html#jinja2.compiler.CodeGenerator.return_buffer_contents">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">return_buffer_contents</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">frame</span><span class="p">:</span> <span class="n">Frame</span><span class="p">,</span> <span class="n">force_unescaped</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the buffer contents of the frame.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">force_unescaped</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">frame</span><span class="o">.</span><span class="n">eval_ctx</span><span class="o">.</span><span class="n">volatile</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="s2">&quot;if context.eval_ctx.autoescape:&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">indent</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;return Markup(concat(</span><span class="si">{</span><span class="n">frame</span><span class="o">.</span><span class="n">buffer</span><span class="si">}</span><span class="s2">))&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">outdent</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="s2">&quot;else:&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">indent</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;return concat(</span><span class="si">{</span><span class="n">frame</span><span class="o">.</span><span class="n">buffer</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">outdent</span><span class="p">()</span>
                <span class="k">return</span>
            <span class="k">elif</span> <span class="n">frame</span><span class="o">.</span><span class="n">eval_ctx</span><span class="o">.</span><span class="n">autoescape</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;return Markup(concat(</span><span class="si">{</span><span class="n">frame</span><span class="o">.</span><span class="n">buffer</span><span class="si">}</span><span class="s2">))&quot;</span><span class="p">)</span>
                <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;return concat(</span><span class="si">{</span><span class="n">frame</span><span class="o">.</span><span class="n">buffer</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="CodeGenerator.indent">
<a class="viewcode-back" href="../../autoapi/jinja2/compiler/index.html#jinja2.compiler.CodeGenerator.indent">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">indent</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Indent by one.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_indentation</span> <span class="o">+=</span> <span class="mi">1</span></div>


<div class="viewcode-block" id="CodeGenerator.outdent">
<a class="viewcode-back" href="../../autoapi/jinja2/compiler/index.html#jinja2.compiler.CodeGenerator.outdent">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">outdent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">step</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Outdent by step.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_indentation</span> <span class="o">-=</span> <span class="n">step</span></div>


<div class="viewcode-block" id="CodeGenerator.start_write">
<a class="viewcode-back" href="../../autoapi/jinja2/compiler/index.html#jinja2.compiler.CodeGenerator.start_write">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">start_write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame</span><span class="p">:</span> <span class="n">Frame</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">nodes</span><span class="o">.</span><span class="n">Node</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Yield or write into the frame buffer.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">frame</span><span class="o">.</span><span class="n">buffer</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="s2">&quot;yield &quot;</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">frame</span><span class="o">.</span><span class="n">buffer</span><span class="si">}</span><span class="s2">.append(&quot;</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span></div>


<div class="viewcode-block" id="CodeGenerator.end_write">
<a class="viewcode-back" href="../../autoapi/jinja2/compiler/index.html#jinja2.compiler.CodeGenerator.end_write">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">end_write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame</span><span class="p">:</span> <span class="n">Frame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;End the writing process started by `start_write`.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">frame</span><span class="o">.</span><span class="n">buffer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;)&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="CodeGenerator.simple_write">
<a class="viewcode-back" href="../../autoapi/jinja2/compiler/index.html#jinja2.compiler.CodeGenerator.simple_write">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">simple_write</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">frame</span><span class="p">:</span> <span class="n">Frame</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">nodes</span><span class="o">.</span><span class="n">Node</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Simple shortcut for start_write + write + end_write.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_write</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">end_write</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span></div>


<div class="viewcode-block" id="CodeGenerator.blockvisit">
<a class="viewcode-back" href="../../autoapi/jinja2/compiler/index.html#jinja2.compiler.CodeGenerator.blockvisit">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">blockvisit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nodes</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Iterable</span><span class="p">[</span><span class="n">nodes</span><span class="o">.</span><span class="n">Node</span><span class="p">],</span> <span class="n">frame</span><span class="p">:</span> <span class="n">Frame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Visit a list of nodes as block in a frame.  If the current frame</span>
<span class="sd">        is no buffer a dummy ``if 0: yield None`` is written automatically.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="s2">&quot;pass&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">CompilerExit</span><span class="p">:</span>
            <span class="k">pass</span></div>


<div class="viewcode-block" id="CodeGenerator.write">
<a class="viewcode-back" href="../../autoapi/jinja2/compiler/index.html#jinja2.compiler.CodeGenerator.write">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Write a string into the output stream.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_new_lines</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_first_write</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">stream</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_new_lines</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">code_lineno</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_new_lines</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_write_debug_info</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">debug_info</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">_write_debug_info</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">code_lineno</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_write_debug_info</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_first_write</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stream</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;    &quot;</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_indentation</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_new_lines</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stream</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">x</span><span class="p">)</span></div>


<div class="viewcode-block" id="CodeGenerator.writeline">
<a class="viewcode-back" href="../../autoapi/jinja2/compiler/index.html#jinja2.compiler.CodeGenerator.writeline">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">writeline</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">nodes</span><span class="o">.</span><span class="n">Node</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">extra</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Combination of newline and write.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">newline</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">extra</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">x</span><span class="p">)</span></div>


<div class="viewcode-block" id="CodeGenerator.newline">
<a class="viewcode-back" href="../../autoapi/jinja2/compiler/index.html#jinja2.compiler.CodeGenerator.newline">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">newline</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">nodes</span><span class="o">.</span><span class="n">Node</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">extra</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add one or more newlines before the next write.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_new_lines</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_new_lines</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">extra</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">node</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">node</span><span class="o">.</span><span class="n">lineno</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_line</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_write_debug_info</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">lineno</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_last_line</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">lineno</span></div>


<div class="viewcode-block" id="CodeGenerator.signature">
<a class="viewcode-back" href="../../autoapi/jinja2/compiler/index.html#jinja2.compiler.CodeGenerator.signature">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">signature</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">node</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="n">nodes</span><span class="o">.</span><span class="n">Call</span><span class="p">,</span> <span class="n">nodes</span><span class="o">.</span><span class="n">Filter</span><span class="p">,</span> <span class="n">nodes</span><span class="o">.</span><span class="n">Test</span><span class="p">],</span>
        <span class="n">frame</span><span class="p">:</span> <span class="n">Frame</span><span class="p">,</span>
        <span class="n">extra_kwargs</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Writes a function call to the stream for the current node.</span>
<span class="sd">        A leading comma is added automatically.  The extra keyword</span>
<span class="sd">        arguments may not include python keywords otherwise a syntax</span>
<span class="sd">        error could occur.  The extra keyword arguments should be given</span>
<span class="sd">        as python dict.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># if any of the given keyword arguments is a python keyword</span>
        <span class="c1"># we have to make sure that no invalid call is created.</span>
        <span class="n">kwarg_workaround</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span>
            <span class="n">is_python_keyword</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">k</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">chain</span><span class="p">((</span><span class="n">x</span><span class="o">.</span><span class="n">key</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">kwargs</span><span class="p">),</span> <span class="n">extra_kwargs</span> <span class="ow">or</span> <span class="p">())</span>
        <span class="p">)</span>

        <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;, &quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">kwarg_workaround</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">kwarg</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">kwargs</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;, &quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">kwarg</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">extra_kwargs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">extra_kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;, </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">=</span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">dyn_args</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;, *&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">dyn_args</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">kwarg_workaround</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">dyn_kwargs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;, **dict({&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;, **{&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">kwarg</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">kwargs</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">kwarg</span><span class="o">.</span><span class="n">key</span><span class="si">!r}</span><span class="s2">: &quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">kwarg</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;, &quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">extra_kwargs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">extra_kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">key</span><span class="si">!r}</span><span class="s2">: </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">, &quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">dyn_kwargs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;}, **&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">dyn_kwargs</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;)&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;}&quot;</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">node</span><span class="o">.</span><span class="n">dyn_kwargs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;, **&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">dyn_kwargs</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span></div>


<div class="viewcode-block" id="CodeGenerator.pull_dependencies">
<a class="viewcode-back" href="../../autoapi/jinja2/compiler/index.html#jinja2.compiler.CodeGenerator.pull_dependencies">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">pull_dependencies</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nodes</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Iterable</span><span class="p">[</span><span class="n">nodes</span><span class="o">.</span><span class="n">Node</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Find all filter and test names used in the template and</span>
<span class="sd">        assign them to variables in the compiled namespace. Checking</span>
<span class="sd">        that the names are registered with the environment is done when</span>
<span class="sd">        compiling the Filter and Test nodes. If the node is in an If or</span>
<span class="sd">        CondExpr node, the check is done at runtime instead.</span>

<span class="sd">        .. versionchanged:: 3.0</span>
<span class="sd">            Filters and tests in If and CondExpr nodes are checked at</span>
<span class="sd">            runtime instead of compile time.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">visitor</span> <span class="o">=</span> <span class="n">DependencyFinderVisitor</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">:</span>
            <span class="n">visitor</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">id_map</span><span class="p">,</span> <span class="n">names</span><span class="p">,</span> <span class="n">dependency</span> <span class="ow">in</span> <span class="p">(</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filters</span><span class="p">,</span> <span class="n">visitor</span><span class="o">.</span><span class="n">filters</span><span class="p">,</span> <span class="s2">&quot;filters&quot;</span><span class="p">),</span>
            <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tests</span><span class="p">,</span>
                <span class="n">visitor</span><span class="o">.</span><span class="n">tests</span><span class="p">,</span>
                <span class="s2">&quot;tests&quot;</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">):</span>
            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">names</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">id_map</span><span class="p">:</span>
                    <span class="n">id_map</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">temporary_identifier</span><span class="p">()</span>

                <span class="c1"># add check during runtime that dependencies used inside of executed</span>
                <span class="c1"># blocks are defined, as this step may be skipped during compile time</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="s2">&quot;try:&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">indent</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">id_map</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="si">}</span><span class="s2"> = environment.</span><span class="si">{</span><span class="n">dependency</span><span class="si">}</span><span class="s2">[</span><span class="si">{</span><span class="n">name</span><span class="si">!r}</span><span class="s2">]&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">outdent</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="s2">&quot;except KeyError:&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">indent</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="s2">&quot;@internalcode&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;def </span><span class="si">{</span><span class="n">id_map</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="si">}</span><span class="s2">(*unused):&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">indent</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s1">&#39;raise TemplateRuntimeError(&quot;No </span><span class="si">{</span><span class="n">dependency</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span>
                    <span class="sa">f</span><span class="s1">&#39; named </span><span class="si">{</span><span class="n">name</span><span class="si">!r}</span><span class="s1"> found.&quot;)&#39;</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">outdent</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">outdent</span><span class="p">()</span></div>


<div class="viewcode-block" id="CodeGenerator.enter_frame">
<a class="viewcode-back" href="../../autoapi/jinja2/compiler/index.html#jinja2.compiler.CodeGenerator.enter_frame">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">enter_frame</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame</span><span class="p">:</span> <span class="n">Frame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">undefs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">target</span><span class="p">,</span> <span class="p">(</span><span class="n">action</span><span class="p">,</span> <span class="n">param</span><span class="p">)</span> <span class="ow">in</span> <span class="n">frame</span><span class="o">.</span><span class="n">symbols</span><span class="o">.</span><span class="n">loads</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">action</span> <span class="o">==</span> <span class="n">VAR_LOAD_PARAMETER</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">elif</span> <span class="n">action</span> <span class="o">==</span> <span class="n">VAR_LOAD_RESOLVE</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">target</span><span class="si">}</span><span class="s2"> = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">get_resolve_func</span><span class="p">()</span><span class="si">}</span><span class="s2">(</span><span class="si">{</span><span class="n">param</span><span class="si">!r}</span><span class="s2">)&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">action</span> <span class="o">==</span> <span class="n">VAR_LOAD_ALIAS</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">target</span><span class="si">}</span><span class="s2"> = </span><span class="si">{</span><span class="n">param</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">action</span> <span class="o">==</span> <span class="n">VAR_LOAD_UNDEFINED</span><span class="p">:</span>
                <span class="n">undefs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;unknown load instruction&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">undefs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39; = &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">undefs</span><span class="p">)</span><span class="si">}</span><span class="s2"> = missing&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="CodeGenerator.leave_frame">
<a class="viewcode-back" href="../../autoapi/jinja2/compiler/index.html#jinja2.compiler.CodeGenerator.leave_frame">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">leave_frame</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame</span><span class="p">:</span> <span class="n">Frame</span><span class="p">,</span> <span class="n">with_python_scope</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">with_python_scope</span><span class="p">:</span>
            <span class="n">undefs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">target</span> <span class="ow">in</span> <span class="n">frame</span><span class="o">.</span><span class="n">symbols</span><span class="o">.</span><span class="n">loads</span><span class="p">:</span>
                <span class="n">undefs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">undefs</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39; = &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">undefs</span><span class="p">)</span><span class="si">}</span><span class="s2"> = missing&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="CodeGenerator.choose_async">
<a class="viewcode-back" href="../../autoapi/jinja2/compiler/index.html#jinja2.compiler.CodeGenerator.choose_async">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">choose_async</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">async_value</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;async &quot;</span><span class="p">,</span> <span class="n">sync_value</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">async_value</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">is_async</span> <span class="k">else</span> <span class="n">sync_value</span></div>


<div class="viewcode-block" id="CodeGenerator.func">
<a class="viewcode-back" href="../../autoapi/jinja2/compiler/index.html#jinja2.compiler.CodeGenerator.func">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">func</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">choose_async</span><span class="p">()</span><span class="si">}</span><span class="s2">def </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span></div>


<div class="viewcode-block" id="CodeGenerator.macro_body">
<a class="viewcode-back" href="../../autoapi/jinja2/compiler/index.html#jinja2.compiler.CodeGenerator.macro_body">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">macro_body</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="n">nodes</span><span class="o">.</span><span class="n">Macro</span><span class="p">,</span> <span class="n">nodes</span><span class="o">.</span><span class="n">CallBlock</span><span class="p">],</span> <span class="n">frame</span><span class="p">:</span> <span class="n">Frame</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Tuple</span><span class="p">[</span><span class="n">Frame</span><span class="p">,</span> <span class="n">MacroRef</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Dump the function def of a macro or call block.&quot;&quot;&quot;</span>
        <span class="n">frame</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">inner</span><span class="p">()</span>
        <span class="n">frame</span><span class="o">.</span><span class="n">symbols</span><span class="o">.</span><span class="n">analyze_node</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="n">macro_ref</span> <span class="o">=</span> <span class="n">MacroRef</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>

        <span class="n">explicit_caller</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">skip_special_params</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">arg</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">args</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">arg</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;caller&quot;</span><span class="p">:</span>
                <span class="n">explicit_caller</span> <span class="o">=</span> <span class="n">idx</span>
            <span class="k">if</span> <span class="n">arg</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;kwargs&quot;</span><span class="p">,</span> <span class="s2">&quot;varargs&quot;</span><span class="p">):</span>
                <span class="n">skip_special_params</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">arg</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">frame</span><span class="o">.</span><span class="n">symbols</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="n">arg</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>

        <span class="n">undeclared</span> <span class="o">=</span> <span class="n">find_undeclared</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">body</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;caller&quot;</span><span class="p">,</span> <span class="s2">&quot;kwargs&quot;</span><span class="p">,</span> <span class="s2">&quot;varargs&quot;</span><span class="p">))</span>

        <span class="k">if</span> <span class="s2">&quot;caller&quot;</span> <span class="ow">in</span> <span class="n">undeclared</span><span class="p">:</span>
            <span class="c1"># In older Jinja versions there was a bug that allowed caller</span>
            <span class="c1"># to retain the special behavior even if it was mentioned in</span>
            <span class="c1"># the argument list.  However thankfully this was only really</span>
            <span class="c1"># working if it was the last argument.  So we are explicitly</span>
            <span class="c1"># checking this now and error out if it is anywhere else in</span>
            <span class="c1"># the argument list.</span>
            <span class="k">if</span> <span class="n">explicit_caller</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">node</span><span class="o">.</span><span class="n">defaults</span><span class="p">[</span><span class="n">explicit_caller</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">args</span><span class="p">)]</span>
                <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span>
                        <span class="s2">&quot;When defining macros or call blocks the &quot;</span>
                        <span class="s1">&#39;special &quot;caller&quot; argument must be omitted &#39;</span>
                        <span class="s2">&quot;or be given a default.&quot;</span><span class="p">,</span>
                        <span class="n">node</span><span class="o">.</span><span class="n">lineno</span><span class="p">,</span>
                    <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">frame</span><span class="o">.</span><span class="n">symbols</span><span class="o">.</span><span class="n">declare_parameter</span><span class="p">(</span><span class="s2">&quot;caller&quot;</span><span class="p">))</span>
            <span class="n">macro_ref</span><span class="o">.</span><span class="n">accesses_caller</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="s2">&quot;kwargs&quot;</span> <span class="ow">in</span> <span class="n">undeclared</span> <span class="ow">and</span> <span class="s2">&quot;kwargs&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">skip_special_params</span><span class="p">:</span>
            <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">frame</span><span class="o">.</span><span class="n">symbols</span><span class="o">.</span><span class="n">declare_parameter</span><span class="p">(</span><span class="s2">&quot;kwargs&quot;</span><span class="p">))</span>
            <span class="n">macro_ref</span><span class="o">.</span><span class="n">accesses_kwargs</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="s2">&quot;varargs&quot;</span> <span class="ow">in</span> <span class="n">undeclared</span> <span class="ow">and</span> <span class="s2">&quot;varargs&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">skip_special_params</span><span class="p">:</span>
            <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">frame</span><span class="o">.</span><span class="n">symbols</span><span class="o">.</span><span class="n">declare_parameter</span><span class="p">(</span><span class="s2">&quot;varargs&quot;</span><span class="p">))</span>
            <span class="n">macro_ref</span><span class="o">.</span><span class="n">accesses_varargs</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># macros are delayed, they never require output checks</span>
        <span class="n">frame</span><span class="o">.</span><span class="n">require_output_check</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">frame</span><span class="o">.</span><span class="n">symbols</span><span class="o">.</span><span class="n">analyze_node</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">func</span><span class="p">(</span><span class="s1">&#39;macro&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">(</span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="p">)</span><span class="si">}</span><span class="s2">):&quot;</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">indent</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">enter_frame</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">push_parameter_definitions</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">arg</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">args</span><span class="p">):</span>
            <span class="n">ref</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">symbols</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="n">arg</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;if </span><span class="si">{</span><span class="n">ref</span><span class="si">}</span><span class="s2"> is missing:&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">indent</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">default</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">defaults</span><span class="p">[</span><span class="n">idx</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">args</span><span class="p">)]</span>
            <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">ref</span><span class="si">}</span><span class="s1"> = undefined(&quot;parameter </span><span class="si">{</span><span class="n">arg</span><span class="o">.</span><span class="n">name</span><span class="si">!r}</span><span class="s1"> was not provided&quot;,&#39;</span>
                    <span class="sa">f</span><span class="s2">&quot; name=</span><span class="si">{</span><span class="n">arg</span><span class="o">.</span><span class="n">name</span><span class="si">!r}</span><span class="s2">)&quot;</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ref</span><span class="si">}</span><span class="s2"> = &quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">default</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mark_parameter_stored</span><span class="p">(</span><span class="n">ref</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">outdent</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pop_parameter_definitions</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">blockvisit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">body</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">return_buffer_contents</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">force_unescaped</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">leave_frame</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">with_python_scope</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outdent</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">frame</span><span class="p">,</span> <span class="n">macro_ref</span></div>


<div class="viewcode-block" id="CodeGenerator.macro_def">
<a class="viewcode-back" href="../../autoapi/jinja2/compiler/index.html#jinja2.compiler.CodeGenerator.macro_def">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">macro_def</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">macro_ref</span><span class="p">:</span> <span class="n">MacroRef</span><span class="p">,</span> <span class="n">frame</span><span class="p">:</span> <span class="n">Frame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Dump the macro definition for the def created by macro_body.&quot;&quot;&quot;</span>
        <span class="n">arg_tuple</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">macro_ref</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
        <span class="n">name</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">macro_ref</span><span class="o">.</span><span class="n">node</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">macro_ref</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">arg_tuple</span> <span class="o">+=</span> <span class="s2">&quot;,&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Macro(environment, macro, </span><span class="si">{</span><span class="n">name</span><span class="si">!r}</span><span class="s2">, (</span><span class="si">{</span><span class="n">arg_tuple</span><span class="si">}</span><span class="s2">),&quot;</span>
            <span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="n">macro_ref</span><span class="o">.</span><span class="n">accesses_kwargs</span><span class="si">!r}</span><span class="s2">, </span><span class="si">{</span><span class="n">macro_ref</span><span class="o">.</span><span class="n">accesses_varargs</span><span class="si">!r}</span><span class="s2">,&quot;</span>
            <span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="n">macro_ref</span><span class="o">.</span><span class="n">accesses_caller</span><span class="si">!r}</span><span class="s2">, context.eval_ctx.autoescape)&quot;</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="CodeGenerator.position">
<a class="viewcode-back" href="../../autoapi/jinja2/compiler/index.html#jinja2.compiler.CodeGenerator.position">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">position</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">nodes</span><span class="o">.</span><span class="n">Node</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a human readable position for the node.&quot;&quot;&quot;</span>
        <span class="n">rv</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;line </span><span class="si">{</span><span class="n">node</span><span class="o">.</span><span class="n">lineno</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">rv</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">rv</span><span class="si">}</span><span class="s2"> in </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">!r}</span><span class="s2">&quot;</span>
        <span class="k">return</span> <span class="n">rv</span></div>


<div class="viewcode-block" id="CodeGenerator.dump_local_context">
<a class="viewcode-back" href="../../autoapi/jinja2/compiler/index.html#jinja2.compiler.CodeGenerator.dump_local_context">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">dump_local_context</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame</span><span class="p">:</span> <span class="n">Frame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">items_kv</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">!r}</span><span class="s2">: </span><span class="si">{</span><span class="n">target</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">target</span> <span class="ow">in</span> <span class="n">frame</span><span class="o">.</span><span class="n">symbols</span><span class="o">.</span><span class="n">dump_stores</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">{{</span><span class="si">{</span><span class="n">items_kv</span><span class="si">}</span><span class="se">}}</span><span class="s2">&quot;</span></div>


<div class="viewcode-block" id="CodeGenerator.write_commons">
<a class="viewcode-back" href="../../autoapi/jinja2/compiler/index.html#jinja2.compiler.CodeGenerator.write_commons">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">write_commons</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Writes a common preamble that is used by root and block functions.</span>
<span class="sd">        Primarily this sets up common local helpers and enforces a generator</span>
<span class="sd">        through a dead branch.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="s2">&quot;resolve = context.resolve_or_missing&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="s2">&quot;undefined = environment.undefined&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="s2">&quot;concat = environment.concat&quot;</span><span class="p">)</span>
        <span class="c1"># always use the standard Undefined class for the implicit else of</span>
        <span class="c1"># conditional expressions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="s2">&quot;cond_expr_undefined = Undefined&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="s2">&quot;if 0: yield None&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="CodeGenerator.push_parameter_definitions">
<a class="viewcode-back" href="../../autoapi/jinja2/compiler/index.html#jinja2.compiler.CodeGenerator.push_parameter_definitions">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">push_parameter_definitions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame</span><span class="p">:</span> <span class="n">Frame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Pushes all parameter targets from the given frame into a local</span>
<span class="sd">        stack that permits tracking of yet to be assigned parameters.  In</span>
<span class="sd">        particular this enables the optimization from `visit_Name` to skip</span>
<span class="sd">        undefined expressions for parameters in macros as macros can reference</span>
<span class="sd">        otherwise unbound parameters.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_param_def_block</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">frame</span><span class="o">.</span><span class="n">symbols</span><span class="o">.</span><span class="n">dump_param_targets</span><span class="p">())</span></div>


<div class="viewcode-block" id="CodeGenerator.pop_parameter_definitions">
<a class="viewcode-back" href="../../autoapi/jinja2/compiler/index.html#jinja2.compiler.CodeGenerator.pop_parameter_definitions">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">pop_parameter_definitions</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Pops the current parameter definitions set.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_param_def_block</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span></div>


<div class="viewcode-block" id="CodeGenerator.mark_parameter_stored">
<a class="viewcode-back" href="../../autoapi/jinja2/compiler/index.html#jinja2.compiler.CodeGenerator.mark_parameter_stored">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">mark_parameter_stored</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Marks a parameter in the current parameter definitions as stored.</span>
<span class="sd">        This will skip the enforced undefined checks.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_param_def_block</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_param_def_block</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">discard</span><span class="p">(</span><span class="n">target</span><span class="p">)</span></div>


<div class="viewcode-block" id="CodeGenerator.push_context_reference">
<a class="viewcode-back" href="../../autoapi/jinja2/compiler/index.html#jinja2.compiler.CodeGenerator.push_context_reference">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">push_context_reference</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_context_reference_stack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">target</span><span class="p">)</span></div>


<div class="viewcode-block" id="CodeGenerator.pop_context_reference">
<a class="viewcode-back" href="../../autoapi/jinja2/compiler/index.html#jinja2.compiler.CodeGenerator.pop_context_reference">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">pop_context_reference</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_context_reference_stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span></div>


<div class="viewcode-block" id="CodeGenerator.get_context_ref">
<a class="viewcode-back" href="../../autoapi/jinja2/compiler/index.html#jinja2.compiler.CodeGenerator.get_context_ref">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_context_ref</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_context_reference_stack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span></div>


<div class="viewcode-block" id="CodeGenerator.get_resolve_func">
<a class="viewcode-back" href="../../autoapi/jinja2/compiler/index.html#jinja2.compiler.CodeGenerator.get_resolve_func">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_resolve_func</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">target</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_context_reference_stack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">target</span> <span class="o">==</span> <span class="s2">&quot;context&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;resolve&quot;</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">target</span><span class="si">}</span><span class="s2">.resolve&quot;</span></div>


<div class="viewcode-block" id="CodeGenerator.derive_context">
<a class="viewcode-back" href="../../autoapi/jinja2/compiler/index.html#jinja2.compiler.CodeGenerator.derive_context">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">derive_context</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame</span><span class="p">:</span> <span class="n">Frame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">get_context_ref</span><span class="p">()</span><span class="si">}</span><span class="s2">.derived(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dump_local_context</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span></div>


<div class="viewcode-block" id="CodeGenerator.parameter_is_undeclared">
<a class="viewcode-back" href="../../autoapi/jinja2/compiler/index.html#jinja2.compiler.CodeGenerator.parameter_is_undeclared">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">parameter_is_undeclared</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Checks if a given target is an undeclared parameter.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_param_def_block</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="n">target</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_param_def_block</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span></div>


<div class="viewcode-block" id="CodeGenerator.push_assign_tracking">
<a class="viewcode-back" href="../../autoapi/jinja2/compiler/index.html#jinja2.compiler.CodeGenerator.push_assign_tracking">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">push_assign_tracking</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Pushes a new layer for assignment tracking.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_assign_stack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">set</span><span class="p">())</span></div>


<div class="viewcode-block" id="CodeGenerator.pop_assign_tracking">
<a class="viewcode-back" href="../../autoapi/jinja2/compiler/index.html#jinja2.compiler.CodeGenerator.pop_assign_tracking">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">pop_assign_tracking</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame</span><span class="p">:</span> <span class="n">Frame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Pops the topmost level for assignment tracking and updates the</span>
<span class="sd">        context variables if necessary.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">vars</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_assign_stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="ow">not</span> <span class="n">frame</span><span class="o">.</span><span class="n">block_frame</span>
            <span class="ow">and</span> <span class="ow">not</span> <span class="n">frame</span><span class="o">.</span><span class="n">loop_frame</span>
            <span class="ow">and</span> <span class="ow">not</span> <span class="n">frame</span><span class="o">.</span><span class="n">toplevel</span>
            <span class="ow">or</span> <span class="ow">not</span> <span class="nb">vars</span>
        <span class="p">):</span>
            <span class="k">return</span>
        <span class="n">public_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">vars</span> <span class="k">if</span> <span class="n">x</span><span class="p">[:</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;_&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">vars</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="nb">vars</span><span class="p">))</span>
            <span class="n">ref</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">symbols</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">frame</span><span class="o">.</span><span class="n">loop_frame</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;_loop_vars[</span><span class="si">{</span><span class="n">name</span><span class="si">!r}</span><span class="s2">] = </span><span class="si">{</span><span class="n">ref</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="k">if</span> <span class="n">frame</span><span class="o">.</span><span class="n">block_frame</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;_block_vars[</span><span class="si">{</span><span class="n">name</span><span class="si">!r}</span><span class="s2">] = </span><span class="si">{</span><span class="n">ref</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;context.vars[</span><span class="si">{</span><span class="n">name</span><span class="si">!r}</span><span class="s2">] = </span><span class="si">{</span><span class="n">ref</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">frame</span><span class="o">.</span><span class="n">loop_frame</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="s2">&quot;_loop_vars.update({&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">frame</span><span class="o">.</span><span class="n">block_frame</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="s2">&quot;_block_vars.update({&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="s2">&quot;context.vars.update({&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="nb">vars</span><span class="p">)):</span>
                <span class="k">if</span> <span class="n">idx</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;, &quot;</span><span class="p">)</span>
                <span class="n">ref</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">symbols</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">!r}</span><span class="s2">: </span><span class="si">{</span><span class="n">ref</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;})&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">frame</span><span class="o">.</span><span class="n">block_frame</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">frame</span><span class="o">.</span><span class="n">loop_frame</span> <span class="ow">and</span> <span class="n">public_names</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">public_names</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;context.exported_vars.add(</span><span class="si">{</span><span class="n">public_names</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">!r}</span><span class="s2">)&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">names_str</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">repr</span><span class="p">,</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">public_names</span><span class="p">)))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;context.exported_vars.update((</span><span class="si">{</span><span class="n">names_str</span><span class="si">}</span><span class="s2">))&quot;</span><span class="p">)</span></div>


    <span class="c1"># -- Statement Visitors</span>

<div class="viewcode-block" id="CodeGenerator.visit_Template">
<a class="viewcode-back" href="../../autoapi/jinja2/compiler/index.html#jinja2.compiler.CodeGenerator.visit_Template">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">visit_Template</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">nodes</span><span class="o">.</span><span class="n">Template</span><span class="p">,</span> <span class="n">frame</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">Frame</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">frame</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;no root frame allowed&quot;</span>
        <span class="n">eval_ctx</span> <span class="o">=</span> <span class="n">EvalContext</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">environment</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="kn">from</span><span class="w"> </span><span class="nn">.runtime</span><span class="w"> </span><span class="kn">import</span> <span class="n">async_exported</span><span class="p">,</span> <span class="n">exported</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">is_async</span><span class="p">:</span>
            <span class="n">exported_names</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">exported</span> <span class="o">+</span> <span class="n">async_exported</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">exported_names</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">exported</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="s2">&quot;from jinja2.runtime import &quot;</span> <span class="o">+</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">exported_names</span><span class="p">))</span>

        <span class="c1"># if we want a deferred initialization we cannot move the</span>
        <span class="c1"># environment into a local name</span>
        <span class="n">envenv</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">defer_init</span> <span class="k">else</span> <span class="s2">&quot;, environment=environment&quot;</span>

        <span class="c1"># do we have an extends tag at all?  If not, we can save some</span>
        <span class="c1"># overhead by just not processing any inheritance code.</span>
        <span class="n">have_extends</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">nodes</span><span class="o">.</span><span class="n">Extends</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

        <span class="c1"># find all blocks</span>
        <span class="k">for</span> <span class="n">block</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="n">nodes</span><span class="o">.</span><span class="n">Block</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">block</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">blocks</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;block </span><span class="si">{</span><span class="n">block</span><span class="o">.</span><span class="n">name</span><span class="si">!r}</span><span class="s2"> defined twice&quot;</span><span class="p">,</span> <span class="n">block</span><span class="o">.</span><span class="n">lineno</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">blocks</span><span class="p">[</span><span class="n">block</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">block</span>

        <span class="c1"># find all imports and import them</span>
        <span class="k">for</span> <span class="n">import_</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="n">nodes</span><span class="o">.</span><span class="n">ImportedName</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">import_</span><span class="o">.</span><span class="n">importname</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">import_aliases</span><span class="p">:</span>
                <span class="n">imp</span> <span class="o">=</span> <span class="n">import_</span><span class="o">.</span><span class="n">importname</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">import_aliases</span><span class="p">[</span><span class="n">imp</span><span class="p">]</span> <span class="o">=</span> <span class="n">alias</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">temporary_identifier</span><span class="p">()</span>
                <span class="k">if</span> <span class="s2">&quot;.&quot;</span> <span class="ow">in</span> <span class="n">imp</span><span class="p">:</span>
                    <span class="n">module</span><span class="p">,</span> <span class="n">obj</span> <span class="o">=</span> <span class="n">imp</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;from </span><span class="si">{</span><span class="n">module</span><span class="si">}</span><span class="s2"> import </span><span class="si">{</span><span class="n">obj</span><span class="si">}</span><span class="s2"> as </span><span class="si">{</span><span class="n">alias</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;import </span><span class="si">{</span><span class="n">imp</span><span class="si">}</span><span class="s2"> as </span><span class="si">{</span><span class="n">alias</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># add the load name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;name = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">!r}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># generate the root render function.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">func</span><span class="p">(</span><span class="s1">&#39;root&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">(context, missing=missing</span><span class="si">{</span><span class="n">envenv</span><span class="si">}</span><span class="s2">):&quot;</span><span class="p">,</span> <span class="n">extra</span><span class="o">=</span><span class="mi">1</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">indent</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_commons</span><span class="p">()</span>

        <span class="c1"># process the root</span>
        <span class="n">frame</span> <span class="o">=</span> <span class="n">Frame</span><span class="p">(</span><span class="n">eval_ctx</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;self&quot;</span> <span class="ow">in</span> <span class="n">find_undeclared</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">body</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;self&quot;</span><span class="p">,)):</span>
            <span class="n">ref</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">symbols</span><span class="o">.</span><span class="n">declare_parameter</span><span class="p">(</span><span class="s2">&quot;self&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ref</span><span class="si">}</span><span class="s2"> = TemplateReference(context)&quot;</span><span class="p">)</span>
        <span class="n">frame</span><span class="o">.</span><span class="n">symbols</span><span class="o">.</span><span class="n">analyze_node</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="n">frame</span><span class="o">.</span><span class="n">toplevel</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">rootlevel</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">frame</span><span class="o">.</span><span class="n">require_output_check</span> <span class="o">=</span> <span class="n">have_extends</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_known_extends</span>
        <span class="k">if</span> <span class="n">have_extends</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="s2">&quot;parent_template = None&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">enter_frame</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pull_dependencies</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">blockvisit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">body</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">leave_frame</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">with_python_scope</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outdent</span><span class="p">()</span>

        <span class="c1"># make sure that the parent root is called.</span>
        <span class="k">if</span> <span class="n">have_extends</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_known_extends</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">indent</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="s2">&quot;if parent_template is not None:&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">indent</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">is_async</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="s2">&quot;yield from parent_template.root_render_func(context)&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="s2">&quot;agen = parent_template.root_render_func(context)&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="s2">&quot;try:&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">indent</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="s2">&quot;async for event in agen:&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">indent</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="s2">&quot;yield event&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">outdent</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">outdent</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="s2">&quot;finally: await agen.aclose()&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">outdent</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_known_extends</span><span class="p">))</span>

        <span class="c1"># at this point we now have the blocks collected and can visit them too.</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">block</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">blocks</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">func</span><span class="p">(</span><span class="s1">&#39;block_&#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">name</span><span class="p">)</span><span class="si">}</span><span class="s2">(context, missing=missing</span><span class="si">{</span><span class="n">envenv</span><span class="si">}</span><span class="s2">):&quot;</span><span class="p">,</span>
                <span class="n">block</span><span class="p">,</span>
                <span class="mi">1</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">indent</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_commons</span><span class="p">()</span>
            <span class="c1"># It&#39;s important that we do not make this frame a child of the</span>
            <span class="c1"># toplevel template.  This would cause a variety of</span>
            <span class="c1"># interesting issues with identifier tracking.</span>
            <span class="n">block_frame</span> <span class="o">=</span> <span class="n">Frame</span><span class="p">(</span><span class="n">eval_ctx</span><span class="p">)</span>
            <span class="n">block_frame</span><span class="o">.</span><span class="n">block_frame</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">undeclared</span> <span class="o">=</span> <span class="n">find_undeclared</span><span class="p">(</span><span class="n">block</span><span class="o">.</span><span class="n">body</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;self&quot;</span><span class="p">,</span> <span class="s2">&quot;super&quot;</span><span class="p">))</span>
            <span class="k">if</span> <span class="s2">&quot;self&quot;</span> <span class="ow">in</span> <span class="n">undeclared</span><span class="p">:</span>
                <span class="n">ref</span> <span class="o">=</span> <span class="n">block_frame</span><span class="o">.</span><span class="n">symbols</span><span class="o">.</span><span class="n">declare_parameter</span><span class="p">(</span><span class="s2">&quot;self&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ref</span><span class="si">}</span><span class="s2"> = TemplateReference(context)&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="s2">&quot;super&quot;</span> <span class="ow">in</span> <span class="n">undeclared</span><span class="p">:</span>
                <span class="n">ref</span> <span class="o">=</span> <span class="n">block_frame</span><span class="o">.</span><span class="n">symbols</span><span class="o">.</span><span class="n">declare_parameter</span><span class="p">(</span><span class="s2">&quot;super&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ref</span><span class="si">}</span><span class="s2"> = context.super(</span><span class="si">{</span><span class="n">name</span><span class="si">!r}</span><span class="s2">, block_</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
            <span class="n">block_frame</span><span class="o">.</span><span class="n">symbols</span><span class="o">.</span><span class="n">analyze_node</span><span class="p">(</span><span class="n">block</span><span class="p">)</span>
            <span class="n">block_frame</span><span class="o">.</span><span class="n">block</span> <span class="o">=</span> <span class="n">name</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="s2">&quot;_block_vars = </span><span class="si">{}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">enter_frame</span><span class="p">(</span><span class="n">block_frame</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pull_dependencies</span><span class="p">(</span><span class="n">block</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">blockvisit</span><span class="p">(</span><span class="n">block</span><span class="o">.</span><span class="n">body</span><span class="p">,</span> <span class="n">block_frame</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">leave_frame</span><span class="p">(</span><span class="n">block_frame</span><span class="p">,</span> <span class="n">with_python_scope</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">outdent</span><span class="p">()</span>

        <span class="n">blocks_kv_str</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">x</span><span class="si">!r}</span><span class="s2">: block_</span><span class="si">{</span><span class="n">x</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">blocks</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;blocks = </span><span class="se">{{</span><span class="si">{</span><span class="n">blocks_kv_str</span><span class="si">}</span><span class="se">}}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">extra</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">debug_kv_str</span> <span class="o">=</span> <span class="s2">&quot;&amp;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">=</span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug_info</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;debug_info = </span><span class="si">{</span><span class="n">debug_kv_str</span><span class="si">!r}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="CodeGenerator.visit_Block">
<a class="viewcode-back" href="../../autoapi/jinja2/compiler/index.html#jinja2.compiler.CodeGenerator.visit_Block">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">visit_Block</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">nodes</span><span class="o">.</span><span class="n">Block</span><span class="p">,</span> <span class="n">frame</span><span class="p">:</span> <span class="n">Frame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Call a block and register it for the template.&quot;&quot;&quot;</span>
        <span class="n">level</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">frame</span><span class="o">.</span><span class="n">toplevel</span><span class="p">:</span>
            <span class="c1"># if we know that we are a child template, there is no need to</span>
            <span class="c1"># check if we are one</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_known_extends</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">extends_so_far</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="s2">&quot;if parent_template is None:&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">indent</span><span class="p">()</span>
                <span class="n">level</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">scoped</span><span class="p">:</span>
            <span class="n">context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">derive_context</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_context_ref</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">required</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;if len(context.blocks[</span><span class="si">{</span><span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="si">!r}</span><span class="s2">]) &lt;= 1:&quot;</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">indent</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;raise TemplateRuntimeError(&quot;Required block </span><span class="si">{</span><span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="si">!r}</span><span class="s1"> not found&quot;)&#39;</span><span class="p">,</span>
                <span class="n">node</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">outdent</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">is_async</span> <span class="ow">and</span> <span class="n">frame</span><span class="o">.</span><span class="n">buffer</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;yield from context.blocks[</span><span class="si">{</span><span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="si">!r}</span><span class="s2">][0](</span><span class="si">{</span><span class="n">context</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="n">node</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;gen = context.blocks[</span><span class="si">{</span><span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="si">!r}</span><span class="s2">][0](</span><span class="si">{</span><span class="n">context</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="s2">&quot;try:&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">indent</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">choose_async</span><span class="p">()</span><span class="si">}</span><span class="s2">for event in gen:&quot;</span><span class="p">,</span>
                <span class="n">node</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">indent</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">simple_write</span><span class="p">(</span><span class="s2">&quot;event&quot;</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">outdent</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">outdent</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;finally: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">choose_async</span><span class="p">(</span><span class="s1">&#39;await gen.aclose()&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;gen.close()&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">outdent</span><span class="p">(</span><span class="n">level</span><span class="p">)</span></div>


<div class="viewcode-block" id="CodeGenerator.visit_Extends">
<a class="viewcode-back" href="../../autoapi/jinja2/compiler/index.html#jinja2.compiler.CodeGenerator.visit_Extends">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">visit_Extends</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">nodes</span><span class="o">.</span><span class="n">Extends</span><span class="p">,</span> <span class="n">frame</span><span class="p">:</span> <span class="n">Frame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calls the extender.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">frame</span><span class="o">.</span><span class="n">toplevel</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="s2">&quot;cannot use extend from a non top-level scope&quot;</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">lineno</span><span class="p">)</span>

        <span class="c1"># if the number of extends statements in general is zero so</span>
        <span class="c1"># far, we don&#39;t have to add a check if something extended</span>
        <span class="c1"># the template before this one.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">extends_so_far</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># if we have a known extends we just add a template runtime</span>
            <span class="c1"># error into the generated code.  We could catch that at compile</span>
            <span class="c1"># time too, but i welcome it not to confuse users by throwing the</span>
            <span class="c1"># same error at different times just &quot;because we can&quot;.</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_known_extends</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="s2">&quot;if parent_template is not None:&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">indent</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="s1">&#39;raise TemplateRuntimeError(&quot;extended multiple times&quot;)&#39;</span><span class="p">)</span>

            <span class="c1"># if we have a known extends already we don&#39;t need that code here</span>
            <span class="c1"># as we know that the template execution will end here.</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_known_extends</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">CompilerExit</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">outdent</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="s2">&quot;parent_template = environment.get_template(&quot;</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">template</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;, </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">!r}</span><span class="s2">)&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="s2">&quot;for name, parent_block in parent_template.blocks.items():&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">indent</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="s2">&quot;context.blocks.setdefault(name, []).append(parent_block)&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outdent</span><span class="p">()</span>

        <span class="c1"># if this extends statement was in the root level we can take</span>
        <span class="c1"># advantage of that information and simplify the generated code</span>
        <span class="c1"># in the top level from this point onwards</span>
        <span class="k">if</span> <span class="n">frame</span><span class="o">.</span><span class="n">rootlevel</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">has_known_extends</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># and now we have one more</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">extends_so_far</span> <span class="o">+=</span> <span class="mi">1</span></div>


<div class="viewcode-block" id="CodeGenerator.visit_Include">
<a class="viewcode-back" href="../../autoapi/jinja2/compiler/index.html#jinja2.compiler.CodeGenerator.visit_Include">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">visit_Include</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">nodes</span><span class="o">.</span><span class="n">Include</span><span class="p">,</span> <span class="n">frame</span><span class="p">:</span> <span class="n">Frame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Handles includes.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">ignore_missing</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="s2">&quot;try:&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">indent</span><span class="p">()</span>

        <span class="n">func_name</span> <span class="o">=</span> <span class="s2">&quot;get_or_select_template&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">template</span><span class="p">,</span> <span class="n">nodes</span><span class="o">.</span><span class="n">Const</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">template</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">func_name</span> <span class="o">=</span> <span class="s2">&quot;get_template&quot;</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">template</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">)):</span>
                <span class="n">func_name</span> <span class="o">=</span> <span class="s2">&quot;select_template&quot;</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">template</span><span class="p">,</span> <span class="p">(</span><span class="n">nodes</span><span class="o">.</span><span class="n">Tuple</span><span class="p">,</span> <span class="n">nodes</span><span class="o">.</span><span class="n">List</span><span class="p">)):</span>
            <span class="n">func_name</span> <span class="o">=</span> <span class="s2">&quot;select_template&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;template = environment.</span><span class="si">{</span><span class="n">func_name</span><span class="si">}</span><span class="s2">(&quot;</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">template</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;, </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">!r}</span><span class="s2">)&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">ignore_missing</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">outdent</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="s2">&quot;except TemplateNotFound:&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">indent</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="s2">&quot;pass&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">outdent</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="s2">&quot;else:&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">indent</span><span class="p">()</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">loop_body</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">indent</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">simple_write</span><span class="p">(</span><span class="s2">&quot;event&quot;</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">outdent</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">with_context</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;gen = template.root_render_func(&quot;</span>
                <span class="s2">&quot;template.new_context(context.get_all(), True,&quot;</span>
                <span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dump_local_context</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span><span class="si">}</span><span class="s2">))&quot;</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="s2">&quot;try:&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">indent</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">choose_async</span><span class="p">()</span><span class="si">}</span><span class="s2">for event in gen:&quot;</span><span class="p">)</span>
            <span class="n">loop_body</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">outdent</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;finally: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">choose_async</span><span class="p">(</span><span class="s1">&#39;await gen.aclose()&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;gen.close()&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">is_async</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span>
                <span class="s2">&quot;for event in (await template._get_default_module_async())&quot;</span>
                <span class="s2">&quot;._body_stream:&quot;</span>
            <span class="p">)</span>
            <span class="n">loop_body</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="s2">&quot;yield from template._get_default_module()._body_stream&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">ignore_missing</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">outdent</span><span class="p">()</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_import_common</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="n">nodes</span><span class="o">.</span><span class="n">Import</span><span class="p">,</span> <span class="n">nodes</span><span class="o">.</span><span class="n">FromImport</span><span class="p">],</span> <span class="n">frame</span><span class="p">:</span> <span class="n">Frame</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">choose_async</span><span class="p">(</span><span class="s1">&#39;await &#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">environment.get_template(&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">template</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;, </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">!r}</span><span class="s2">).&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">with_context</span><span class="p">:</span>
            <span class="n">f_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;make_module</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">choose_async</span><span class="p">(</span><span class="s1">&#39;_async&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">f_name</span><span class="si">}</span><span class="s2">(context.get_all(), True, </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dump_local_context</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;_get_default_module</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">choose_async</span><span class="p">(</span><span class="s1">&#39;_async&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">(context)&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="CodeGenerator.visit_Import">
<a class="viewcode-back" href="../../autoapi/jinja2/compiler/index.html#jinja2.compiler.CodeGenerator.visit_Import">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">visit_Import</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">nodes</span><span class="o">.</span><span class="n">Import</span><span class="p">,</span> <span class="n">frame</span><span class="p">:</span> <span class="n">Frame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Visit regular imports.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">frame</span><span class="o">.</span><span class="n">symbols</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">target</span><span class="p">)</span><span class="si">}</span><span class="s2"> = &quot;</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">frame</span><span class="o">.</span><span class="n">toplevel</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;context.vars[</span><span class="si">{</span><span class="n">node</span><span class="o">.</span><span class="n">target</span><span class="si">!r}</span><span class="s2">] = &quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_import_common</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">frame</span><span class="o">.</span><span class="n">toplevel</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">node</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;context.exported_vars.discard(</span><span class="si">{</span><span class="n">node</span><span class="o">.</span><span class="n">target</span><span class="si">!r}</span><span class="s2">)&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="CodeGenerator.visit_FromImport">
<a class="viewcode-back" href="../../autoapi/jinja2/compiler/index.html#jinja2.compiler.CodeGenerator.visit_FromImport">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">visit_FromImport</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">nodes</span><span class="o">.</span><span class="n">FromImport</span><span class="p">,</span> <span class="n">frame</span><span class="p">:</span> <span class="n">Frame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Visit named imports.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">newline</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;included_template = &quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_import_common</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span>
        <span class="n">var_names</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">discarded_names</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">names</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
                <span class="n">name</span><span class="p">,</span> <span class="n">alias</span> <span class="o">=</span> <span class="n">name</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">alias</span> <span class="o">=</span> <span class="n">name</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">frame</span><span class="o">.</span><span class="n">symbols</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="n">alias</span><span class="p">)</span><span class="si">}</span><span class="s2"> =&quot;</span>
                <span class="sa">f</span><span class="s2">&quot; getattr(included_template, </span><span class="si">{</span><span class="n">name</span><span class="si">!r}</span><span class="s2">, missing)&quot;</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;if </span><span class="si">{</span><span class="n">frame</span><span class="o">.</span><span class="n">symbols</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="n">alias</span><span class="p">)</span><span class="si">}</span><span class="s2"> is missing:&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">indent</span><span class="p">()</span>
            <span class="c1"># The position will contain the template name, and will be formatted</span>
            <span class="c1"># into a string that will be compiled into an f-string. Curly braces</span>
            <span class="c1"># in the name must be replaced with escapes so that they will not be</span>
            <span class="c1"># executed as part of the f-string.</span>
            <span class="n">position</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">position</span><span class="p">(</span><span class="n">node</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;{&quot;</span><span class="p">,</span> <span class="s2">&quot;{{&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;}&quot;</span><span class="p">,</span> <span class="s2">&quot;}}&quot;</span><span class="p">)</span>
            <span class="n">message</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;the template </span><span class="si">{included_template.__name__!r}</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot; (imported on </span><span class="si">{</span><span class="n">position</span><span class="si">}</span><span class="s2">)&quot;</span>
                <span class="sa">f</span><span class="s2">&quot; does not export the requested name </span><span class="si">{</span><span class="n">name</span><span class="si">!r}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">frame</span><span class="o">.</span><span class="n">symbols</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="n">alias</span><span class="p">)</span><span class="si">}</span><span class="s2"> = undefined(f</span><span class="si">{</span><span class="n">message</span><span class="si">!r}</span><span class="s2">, name=</span><span class="si">{</span><span class="n">name</span><span class="si">!r}</span><span class="s2">)&quot;</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">outdent</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">frame</span><span class="o">.</span><span class="n">toplevel</span><span class="p">:</span>
                <span class="n">var_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">alias</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">alias</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">):</span>
                    <span class="n">discarded_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">alias</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">var_names</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">var_names</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">var_names</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;context.vars[</span><span class="si">{</span><span class="n">name</span><span class="si">!r}</span><span class="s2">] = </span><span class="si">{</span><span class="n">frame</span><span class="o">.</span><span class="n">symbols</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="n">name</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">names_kv</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">!r}</span><span class="s2">: </span><span class="si">{</span><span class="n">frame</span><span class="o">.</span><span class="n">symbols</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="n">name</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">var_names</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;context.vars.update(</span><span class="se">{{</span><span class="si">{</span><span class="n">names_kv</span><span class="si">}</span><span class="se">}}</span><span class="s2">)&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">discarded_names</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">discarded_names</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;context.exported_vars.discard(</span><span class="si">{</span><span class="n">discarded_names</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">!r}</span><span class="s2">)&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">names_str</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">repr</span><span class="p">,</span> <span class="n">discarded_names</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;context.exported_vars.difference_update((</span><span class="si">{</span><span class="n">names_str</span><span class="si">}</span><span class="s2">))&quot;</span>
                <span class="p">)</span></div>


<div class="viewcode-block" id="CodeGenerator.visit_For">
<a class="viewcode-back" href="../../autoapi/jinja2/compiler/index.html#jinja2.compiler.CodeGenerator.visit_For">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">visit_For</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">nodes</span><span class="o">.</span><span class="n">For</span><span class="p">,</span> <span class="n">frame</span><span class="p">:</span> <span class="n">Frame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">loop_frame</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">inner</span><span class="p">()</span>
        <span class="n">loop_frame</span><span class="o">.</span><span class="n">loop_frame</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">test_frame</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">inner</span><span class="p">()</span>
        <span class="n">else_frame</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">inner</span><span class="p">()</span>

        <span class="c1"># try to figure out if we have an extended loop.  An extended loop</span>
        <span class="c1"># is necessary if the loop is in recursive mode if the special loop</span>
        <span class="c1"># variable is accessed in the body if the body is a scoped block.</span>
        <span class="n">extended_loop</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">node</span><span class="o">.</span><span class="n">recursive</span>
            <span class="ow">or</span> <span class="s2">&quot;loop&quot;</span>
            <span class="ow">in</span> <span class="n">find_undeclared</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">iter_child_nodes</span><span class="p">(</span><span class="n">only</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;body&quot;</span><span class="p">,)),</span> <span class="p">(</span><span class="s2">&quot;loop&quot;</span><span class="p">,))</span>
            <span class="ow">or</span> <span class="nb">any</span><span class="p">(</span><span class="n">block</span><span class="o">.</span><span class="n">scoped</span> <span class="k">for</span> <span class="n">block</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="n">nodes</span><span class="o">.</span><span class="n">Block</span><span class="p">))</span>
        <span class="p">)</span>

        <span class="n">loop_ref</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">extended_loop</span><span class="p">:</span>
            <span class="n">loop_ref</span> <span class="o">=</span> <span class="n">loop_frame</span><span class="o">.</span><span class="n">symbols</span><span class="o">.</span><span class="n">declare_parameter</span><span class="p">(</span><span class="s2">&quot;loop&quot;</span><span class="p">)</span>

        <span class="n">loop_frame</span><span class="o">.</span><span class="n">symbols</span><span class="o">.</span><span class="n">analyze_node</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">for_branch</span><span class="o">=</span><span class="s2">&quot;body&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">else_</span><span class="p">:</span>
            <span class="n">else_frame</span><span class="o">.</span><span class="n">symbols</span><span class="o">.</span><span class="n">analyze_node</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">for_branch</span><span class="o">=</span><span class="s2">&quot;else&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">test</span><span class="p">:</span>
            <span class="n">loop_filter_func</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">temporary_identifier</span><span class="p">()</span>
            <span class="n">test_frame</span><span class="o">.</span><span class="n">symbols</span><span class="o">.</span><span class="n">analyze_node</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">for_branch</span><span class="o">=</span><span class="s2">&quot;test&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">func</span><span class="p">(</span><span class="n">loop_filter_func</span><span class="p">)</span><span class="si">}</span><span class="s2">(fiter):&quot;</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">test</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">indent</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">enter_frame</span><span class="p">(</span><span class="n">test_frame</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">choose_async</span><span class="p">(</span><span class="s2">&quot;async for &quot;</span><span class="p">,</span> <span class="s2">&quot;for &quot;</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">target</span><span class="p">,</span> <span class="n">loop_frame</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; in &quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">choose_async</span><span class="p">(</span><span class="s2">&quot;auto_aiter(fiter)&quot;</span><span class="p">,</span> <span class="s2">&quot;fiter&quot;</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">indent</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="s2">&quot;if &quot;</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">test</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">test</span><span class="p">,</span> <span class="n">test_frame</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">indent</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="s2">&quot;yield &quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">target</span><span class="p">,</span> <span class="n">loop_frame</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">outdent</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">leave_frame</span><span class="p">(</span><span class="n">test_frame</span><span class="p">,</span> <span class="n">with_python_scope</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># if we don&#39;t have an recursive loop we have to find the shadowed</span>
        <span class="c1"># variables at that point.  Because loops can be nested but the loop</span>
        <span class="c1"># variable is a special one we have to enforce aliasing for it.</span>
        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">recursive</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">func</span><span class="p">(</span><span class="s1">&#39;loop&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">(reciter, loop_render_func, depth=0):&quot;</span><span class="p">,</span> <span class="n">node</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">indent</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="p">(</span><span class="n">loop_frame</span><span class="p">)</span>

            <span class="c1"># Use the same buffer for the else frame</span>
            <span class="n">else_frame</span><span class="o">.</span><span class="n">buffer</span> <span class="o">=</span> <span class="n">loop_frame</span><span class="o">.</span><span class="n">buffer</span>

        <span class="c1"># make sure the loop variable is a special one and raise a template</span>
        <span class="c1"># assertion error if a loop tries to write to loop</span>
        <span class="k">if</span> <span class="n">extended_loop</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">loop_ref</span><span class="si">}</span><span class="s2"> = missing&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="n">nodes</span><span class="o">.</span><span class="n">Name</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">name</span><span class="o">.</span><span class="n">ctx</span> <span class="o">==</span> <span class="s2">&quot;store&quot;</span> <span class="ow">and</span> <span class="n">name</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;loop&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span>
                    <span class="s2">&quot;Can&#39;t assign to special loop variable in for-loop target&quot;</span><span class="p">,</span>
                    <span class="n">name</span><span class="o">.</span><span class="n">lineno</span><span class="p">,</span>
                <span class="p">)</span>

        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">else_</span><span class="p">:</span>
            <span class="n">iteration_indicator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">temporary_identifier</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">iteration_indicator</span><span class="si">}</span><span class="s2"> = 1&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">choose_async</span><span class="p">(</span><span class="s2">&quot;async for &quot;</span><span class="p">,</span> <span class="s2">&quot;for &quot;</span><span class="p">),</span> <span class="n">node</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">target</span><span class="p">,</span> <span class="n">loop_frame</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">extended_loop</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;, </span><span class="si">{</span><span class="n">loop_ref</span><span class="si">}</span><span class="s2"> in </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">choose_async</span><span class="p">(</span><span class="s1">&#39;Async&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">LoopContext(&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; in &quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">test</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">loop_filter_func</span><span class="si">}</span><span class="s2">(&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">recursive</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;reciter&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">is_async</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">extended_loop</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;auto_aiter(&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">iter</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">is_async</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">extended_loop</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;)&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">test</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;)&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">recursive</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;, undefined, loop_render_func, depth):&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;, undefined):&quot;</span> <span class="k">if</span> <span class="n">extended_loop</span> <span class="k">else</span> <span class="s2">&quot;:&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">indent</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">enter_frame</span><span class="p">(</span><span class="n">loop_frame</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="s2">&quot;_loop_vars = </span><span class="si">{}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">blockvisit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">body</span><span class="p">,</span> <span class="n">loop_frame</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">else_</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">iteration_indicator</span><span class="si">}</span><span class="s2"> = 0&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outdent</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">leave_frame</span><span class="p">(</span>
            <span class="n">loop_frame</span><span class="p">,</span> <span class="n">with_python_scope</span><span class="o">=</span><span class="n">node</span><span class="o">.</span><span class="n">recursive</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">node</span><span class="o">.</span><span class="n">else_</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">else_</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;if </span><span class="si">{</span><span class="n">iteration_indicator</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">indent</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">enter_frame</span><span class="p">(</span><span class="n">else_frame</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">blockvisit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">else_</span><span class="p">,</span> <span class="n">else_frame</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">leave_frame</span><span class="p">(</span><span class="n">else_frame</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">outdent</span><span class="p">()</span>

        <span class="c1"># if the node was recursive we have to return the buffer contents</span>
        <span class="c1"># and start the iteration code</span>
        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">recursive</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">return_buffer_contents</span><span class="p">(</span><span class="n">loop_frame</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">outdent</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">start_write</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">choose_async</span><span class="p">(</span><span class="s1">&#39;await &#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">loop(&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">is_async</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;auto_aiter(&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">iter</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">is_async</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;)&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;, loop)&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">end_write</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>

        <span class="c1"># at the end of the iteration, clear any assignments made in the</span>
        <span class="c1"># loop from the top level</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_assign_stack</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_assign_stack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">difference_update</span><span class="p">(</span><span class="n">loop_frame</span><span class="o">.</span><span class="n">symbols</span><span class="o">.</span><span class="n">stores</span><span class="p">)</span></div>


<div class="viewcode-block" id="CodeGenerator.visit_If">
<a class="viewcode-back" href="../../autoapi/jinja2/compiler/index.html#jinja2.compiler.CodeGenerator.visit_If">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">visit_If</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">nodes</span><span class="o">.</span><span class="n">If</span><span class="p">,</span> <span class="n">frame</span><span class="p">:</span> <span class="n">Frame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">if_frame</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">soft</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="s2">&quot;if &quot;</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">test</span><span class="p">,</span> <span class="n">if_frame</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">indent</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">blockvisit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">body</span><span class="p">,</span> <span class="n">if_frame</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outdent</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">elif_</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">elif_</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="s2">&quot;elif &quot;</span><span class="p">,</span> <span class="n">elif_</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">elif_</span><span class="o">.</span><span class="n">test</span><span class="p">,</span> <span class="n">if_frame</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">indent</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">blockvisit</span><span class="p">(</span><span class="n">elif_</span><span class="o">.</span><span class="n">body</span><span class="p">,</span> <span class="n">if_frame</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">outdent</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">else_</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="s2">&quot;else:&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">indent</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">blockvisit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">else_</span><span class="p">,</span> <span class="n">if_frame</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">outdent</span><span class="p">()</span></div>


<div class="viewcode-block" id="CodeGenerator.visit_Macro">
<a class="viewcode-back" href="../../autoapi/jinja2/compiler/index.html#jinja2.compiler.CodeGenerator.visit_Macro">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">visit_Macro</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">nodes</span><span class="o">.</span><span class="n">Macro</span><span class="p">,</span> <span class="n">frame</span><span class="p">:</span> <span class="n">Frame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">macro_frame</span><span class="p">,</span> <span class="n">macro_ref</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">macro_body</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">newline</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">frame</span><span class="o">.</span><span class="n">toplevel</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;context.exported_vars.add(</span><span class="si">{</span><span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="si">!r}</span><span class="s2">)&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;context.vars[</span><span class="si">{</span><span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="si">!r}</span><span class="s2">] = &quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">frame</span><span class="o">.</span><span class="n">symbols</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="p">)</span><span class="si">}</span><span class="s2"> = &quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">macro_def</span><span class="p">(</span><span class="n">macro_ref</span><span class="p">,</span> <span class="n">macro_frame</span><span class="p">)</span></div>


<div class="viewcode-block" id="CodeGenerator.visit_CallBlock">
<a class="viewcode-back" href="../../autoapi/jinja2/compiler/index.html#jinja2.compiler.CodeGenerator.visit_CallBlock">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">visit_CallBlock</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">nodes</span><span class="o">.</span><span class="n">CallBlock</span><span class="p">,</span> <span class="n">frame</span><span class="p">:</span> <span class="n">Frame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">call_frame</span><span class="p">,</span> <span class="n">macro_ref</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">macro_body</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="s2">&quot;caller = &quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">macro_def</span><span class="p">(</span><span class="n">macro_ref</span><span class="p">,</span> <span class="n">call_frame</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_write</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visit_Call</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">call</span><span class="p">,</span> <span class="n">frame</span><span class="p">,</span> <span class="n">forward_caller</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">end_write</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span></div>


<div class="viewcode-block" id="CodeGenerator.visit_FilterBlock">
<a class="viewcode-back" href="../../autoapi/jinja2/compiler/index.html#jinja2.compiler.CodeGenerator.visit_FilterBlock">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">visit_FilterBlock</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">nodes</span><span class="o">.</span><span class="n">FilterBlock</span><span class="p">,</span> <span class="n">frame</span><span class="p">:</span> <span class="n">Frame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">filter_frame</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">inner</span><span class="p">()</span>
        <span class="n">filter_frame</span><span class="o">.</span><span class="n">symbols</span><span class="o">.</span><span class="n">analyze_node</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">enter_frame</span><span class="p">(</span><span class="n">filter_frame</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="p">(</span><span class="n">filter_frame</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">blockvisit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">body</span><span class="p">,</span> <span class="n">filter_frame</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_write</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visit_Filter</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">filter</span><span class="p">,</span> <span class="n">filter_frame</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">end_write</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">leave_frame</span><span class="p">(</span><span class="n">filter_frame</span><span class="p">)</span></div>


<div class="viewcode-block" id="CodeGenerator.visit_With">
<a class="viewcode-back" href="../../autoapi/jinja2/compiler/index.html#jinja2.compiler.CodeGenerator.visit_With">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">visit_With</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">nodes</span><span class="o">.</span><span class="n">With</span><span class="p">,</span> <span class="n">frame</span><span class="p">:</span> <span class="n">Frame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">with_frame</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">inner</span><span class="p">()</span>
        <span class="n">with_frame</span><span class="o">.</span><span class="n">symbols</span><span class="o">.</span><span class="n">analyze_node</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">enter_frame</span><span class="p">(</span><span class="n">with_frame</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">target</span><span class="p">,</span> <span class="n">expr</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">targets</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">values</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">newline</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">with_frame</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; = &quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">blockvisit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">body</span><span class="p">,</span> <span class="n">with_frame</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">leave_frame</span><span class="p">(</span><span class="n">with_frame</span><span class="p">)</span></div>


<div class="viewcode-block" id="CodeGenerator.visit_ExprStmt">
<a class="viewcode-back" href="../../autoapi/jinja2/compiler/index.html#jinja2.compiler.CodeGenerator.visit_ExprStmt">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">visit_ExprStmt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">nodes</span><span class="o">.</span><span class="n">ExprStmt</span><span class="p">,</span> <span class="n">frame</span><span class="p">:</span> <span class="n">Frame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">newline</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">node</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span></div>


    <span class="k">class</span><span class="w"> </span><span class="nc">_FinalizeInfo</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">NamedTuple</span><span class="p">):</span>
        <span class="n">const</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">Callable</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span>
        <span class="n">src</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_default_finalize</span><span class="p">(</span><span class="n">value</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Any</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The default finalize function if the environment isn&#39;t</span>
<span class="sd">        configured with one. Or, if the environment has one, this is</span>
<span class="sd">        called on that function&#39;s output for constants.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="n">_finalize</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">_FinalizeInfo</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_make_finalize</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_FinalizeInfo</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Build the finalize function to be used on constants and at</span>
<span class="sd">        runtime. Cached so it&#39;s only created once for all output nodes.</span>

<span class="sd">        Returns a ``namedtuple`` with the following attributes:</span>

<span class="sd">        ``const``</span>
<span class="sd">            A function to finalize constant data at compile time.</span>

<span class="sd">        ``src``</span>
<span class="sd">            Source code to output around nodes to be evaluated at</span>
<span class="sd">            runtime.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_finalize</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_finalize</span>

        <span class="n">finalize</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">Callable</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">Any</span><span class="p">]]</span>
        <span class="n">finalize</span> <span class="o">=</span> <span class="n">default</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_default_finalize</span>
        <span class="n">src</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">finalize</span><span class="p">:</span>
            <span class="n">src</span> <span class="o">=</span> <span class="s2">&quot;environment.finalize(&quot;</span>
            <span class="n">env_finalize</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">finalize</span>
            <span class="n">pass_arg</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">_PassArg</span><span class="o">.</span><span class="n">context</span><span class="p">:</span> <span class="s2">&quot;context&quot;</span><span class="p">,</span>
                <span class="n">_PassArg</span><span class="o">.</span><span class="n">eval_context</span><span class="p">:</span> <span class="s2">&quot;context.eval_ctx&quot;</span><span class="p">,</span>
                <span class="n">_PassArg</span><span class="o">.</span><span class="n">environment</span><span class="p">:</span> <span class="s2">&quot;environment&quot;</span><span class="p">,</span>
            <span class="p">}</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="n">_PassArg</span><span class="o">.</span><span class="n">from_obj</span><span class="p">(</span><span class="n">env_finalize</span><span class="p">)</span>  <span class="c1"># type: ignore</span>
            <span class="p">)</span>
            <span class="n">finalize</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="k">if</span> <span class="n">pass_arg</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>

                <span class="k">def</span><span class="w"> </span><span class="nf">finalize</span><span class="p">(</span><span class="n">value</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Any</span><span class="p">:</span>  <span class="c1"># noqa: F811</span>
                    <span class="k">return</span> <span class="n">default</span><span class="p">(</span><span class="n">env_finalize</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">src</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">src</span><span class="si">}{</span><span class="n">pass_arg</span><span class="si">}</span><span class="s2">, &quot;</span>

                <span class="k">if</span> <span class="n">pass_arg</span> <span class="o">==</span> <span class="s2">&quot;environment&quot;</span><span class="p">:</span>

                    <span class="k">def</span><span class="w"> </span><span class="nf">finalize</span><span class="p">(</span><span class="n">value</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Any</span><span class="p">:</span>  <span class="c1"># noqa: F811</span>
                        <span class="k">return</span> <span class="n">default</span><span class="p">(</span><span class="n">env_finalize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">environment</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_finalize</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_FinalizeInfo</span><span class="p">(</span><span class="n">finalize</span><span class="p">,</span> <span class="n">src</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_finalize</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_output_const_repr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">group</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Iterable</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Given a group of constant values converted from ``Output``</span>
<span class="sd">        child nodes, produce a string to write to the template module</span>
<span class="sd">        source.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">repr</span><span class="p">(</span><span class="n">concat</span><span class="p">(</span><span class="n">group</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_output_child_to_const</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">nodes</span><span class="o">.</span><span class="n">Expr</span><span class="p">,</span> <span class="n">frame</span><span class="p">:</span> <span class="n">Frame</span><span class="p">,</span> <span class="n">finalize</span><span class="p">:</span> <span class="n">_FinalizeInfo</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Try to optimize a child of an ``Output`` node by trying to</span>
<span class="sd">        convert it to constant, finalized data at compile time.</span>

<span class="sd">        If :exc:`Impossible` is raised, the node is not constant and</span>
<span class="sd">        will be evaluated at runtime. Any other exception will also be</span>
<span class="sd">        evaluated at runtime for easier debugging.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">const</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">as_const</span><span class="p">(</span><span class="n">frame</span><span class="o">.</span><span class="n">eval_ctx</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">frame</span><span class="o">.</span><span class="n">eval_ctx</span><span class="o">.</span><span class="n">autoescape</span><span class="p">:</span>
            <span class="n">const</span> <span class="o">=</span> <span class="n">escape</span><span class="p">(</span><span class="n">const</span><span class="p">)</span>

        <span class="c1"># Template data doesn&#39;t go through finalize.</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">nodes</span><span class="o">.</span><span class="n">TemplateData</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">const</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">finalize</span><span class="o">.</span><span class="n">const</span><span class="p">(</span><span class="n">const</span><span class="p">)</span>  <span class="c1"># type: ignore</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_output_child_pre</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">nodes</span><span class="o">.</span><span class="n">Expr</span><span class="p">,</span> <span class="n">frame</span><span class="p">:</span> <span class="n">Frame</span><span class="p">,</span> <span class="n">finalize</span><span class="p">:</span> <span class="n">_FinalizeInfo</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Output extra source code before visiting a child of an</span>
<span class="sd">        ``Output`` node.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">frame</span><span class="o">.</span><span class="n">eval_ctx</span><span class="o">.</span><span class="n">volatile</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;(escape if context.eval_ctx.autoescape else str)(&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">frame</span><span class="o">.</span><span class="n">eval_ctx</span><span class="o">.</span><span class="n">autoescape</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;escape(&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;str(&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">finalize</span><span class="o">.</span><span class="n">src</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">finalize</span><span class="o">.</span><span class="n">src</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_output_child_post</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">nodes</span><span class="o">.</span><span class="n">Expr</span><span class="p">,</span> <span class="n">frame</span><span class="p">:</span> <span class="n">Frame</span><span class="p">,</span> <span class="n">finalize</span><span class="p">:</span> <span class="n">_FinalizeInfo</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Output extra source code after visiting a child of an</span>
<span class="sd">        ``Output`` node.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;)&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">finalize</span><span class="o">.</span><span class="n">src</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;)&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="CodeGenerator.visit_Output">
<a class="viewcode-back" href="../../autoapi/jinja2/compiler/index.html#jinja2.compiler.CodeGenerator.visit_Output">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">visit_Output</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">nodes</span><span class="o">.</span><span class="n">Output</span><span class="p">,</span> <span class="n">frame</span><span class="p">:</span> <span class="n">Frame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># If an extends is active, don&#39;t render outside a block.</span>
        <span class="k">if</span> <span class="n">frame</span><span class="o">.</span><span class="n">require_output_check</span><span class="p">:</span>
            <span class="c1"># A top-level extends is known to exist at compile time.</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_known_extends</span><span class="p">:</span>
                <span class="k">return</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="s2">&quot;if parent_template is None:&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">indent</span><span class="p">()</span>

        <span class="n">finalize</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_finalize</span><span class="p">()</span>
        <span class="n">body</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">List</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">List</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">Any</span><span class="p">],</span> <span class="n">nodes</span><span class="o">.</span><span class="n">Expr</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Evaluate constants at compile time if possible. Each item in</span>
        <span class="c1"># body will be either a list of static data or a node to be</span>
        <span class="c1"># evaluated at runtime.</span>
        <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">nodes</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span>
                    <span class="c1"># If the finalize function requires runtime context,</span>
                    <span class="c1"># constants can&#39;t be evaluated at compile time.</span>
                    <span class="n">finalize</span><span class="o">.</span><span class="n">const</span>
                    <span class="c1"># Unless it&#39;s basic template data that won&#39;t be</span>
                    <span class="c1"># finalized anyway.</span>
                    <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">nodes</span><span class="o">.</span><span class="n">TemplateData</span><span class="p">)</span>
                <span class="p">):</span>
                    <span class="k">raise</span> <span class="n">nodes</span><span class="o">.</span><span class="n">Impossible</span><span class="p">()</span>

                <span class="n">const</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_output_child_to_const</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">frame</span><span class="p">,</span> <span class="n">finalize</span><span class="p">)</span>
            <span class="k">except</span> <span class="p">(</span><span class="n">nodes</span><span class="o">.</span><span class="n">Impossible</span><span class="p">,</span> <span class="ne">Exception</span><span class="p">):</span>
                <span class="c1"># The node was not constant and needs to be evaluated at</span>
                <span class="c1"># runtime. Or another error was raised, which is easier</span>
                <span class="c1"># to debug at runtime.</span>
                <span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">child</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">body</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">body</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">body</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">const</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">const</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">frame</span><span class="o">.</span><span class="n">buffer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">body</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">frame</span><span class="o">.</span><span class="n">buffer</span><span class="si">}</span><span class="s2">.append(&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">frame</span><span class="o">.</span><span class="n">buffer</span><span class="si">}</span><span class="s2">.extend((&quot;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">indent</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">body</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="c1"># A group of constant data to join and output.</span>
                <span class="n">val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_output_const_repr</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">frame</span><span class="o">.</span><span class="n">buffer</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="s2">&quot;yield &quot;</span> <span class="o">+</span> <span class="n">val</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="n">val</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">frame</span><span class="o">.</span><span class="n">buffer</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="s2">&quot;yield &quot;</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">newline</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>

                <span class="c1"># A node to be evaluated at runtime.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_output_child_pre</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">frame</span><span class="p">,</span> <span class="n">finalize</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_output_child_post</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">frame</span><span class="p">,</span> <span class="n">finalize</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">frame</span><span class="o">.</span><span class="n">buffer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">frame</span><span class="o">.</span><span class="n">buffer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">outdent</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="s2">&quot;)&quot;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">body</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="s2">&quot;))&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">frame</span><span class="o">.</span><span class="n">require_output_check</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">outdent</span><span class="p">()</span></div>


<div class="viewcode-block" id="CodeGenerator.visit_Assign">
<a class="viewcode-back" href="../../autoapi/jinja2/compiler/index.html#jinja2.compiler.CodeGenerator.visit_Assign">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">visit_Assign</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">nodes</span><span class="o">.</span><span class="n">Assign</span><span class="p">,</span> <span class="n">frame</span><span class="p">:</span> <span class="n">Frame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">push_assign_tracking</span><span class="p">()</span>

        <span class="c1"># ``a.b`` is allowed for assignment, and is parsed as an NSRef. However,</span>
        <span class="c1"># it is only valid if it references a Namespace object. Emit a check for</span>
        <span class="c1"># that for each ref here, before assignment code is emitted. This can&#39;t</span>
        <span class="c1"># be done in visit_NSRef as the ref could be in the middle of a tuple.</span>
        <span class="n">seen_refs</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">nsref</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="n">nodes</span><span class="o">.</span><span class="n">NSRef</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">nsref</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">seen_refs</span><span class="p">:</span>
                <span class="c1"># Only emit the check for each reference once, in case the same</span>
                <span class="c1"># ref is used multiple times in a tuple, `ns.a, ns.b = c, d`.</span>
                <span class="k">continue</span>

            <span class="n">seen_refs</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">nsref</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="n">ref</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">symbols</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="n">nsref</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;if not isinstance(</span><span class="si">{</span><span class="n">ref</span><span class="si">}</span><span class="s2">, Namespace):&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">indent</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span>
                <span class="s2">&quot;raise TemplateRuntimeError&quot;</span>
                <span class="s1">&#39;(&quot;cannot assign attribute on non-namespace object&quot;)&#39;</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">outdent</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">newline</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">target</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; = &quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">node</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pop_assign_tracking</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span></div>


<div class="viewcode-block" id="CodeGenerator.visit_AssignBlock">
<a class="viewcode-back" href="../../autoapi/jinja2/compiler/index.html#jinja2.compiler.CodeGenerator.visit_AssignBlock">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">visit_AssignBlock</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">nodes</span><span class="o">.</span><span class="n">AssignBlock</span><span class="p">,</span> <span class="n">frame</span><span class="p">:</span> <span class="n">Frame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">push_assign_tracking</span><span class="p">()</span>
        <span class="n">block_frame</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">inner</span><span class="p">()</span>
        <span class="c1"># This is a special case.  Since a set block always captures we</span>
        <span class="c1"># will disable output checks.  This way one can use set blocks</span>
        <span class="c1"># toplevel even in extended templates.</span>
        <span class="n">block_frame</span><span class="o">.</span><span class="n">require_output_check</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">block_frame</span><span class="o">.</span><span class="n">symbols</span><span class="o">.</span><span class="n">analyze_node</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">enter_frame</span><span class="p">(</span><span class="n">block_frame</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="p">(</span><span class="n">block_frame</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">blockvisit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">body</span><span class="p">,</span> <span class="n">block_frame</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">newline</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">target</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; = (Markup if context.eval_ctx.autoescape else identity)(&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">filter</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">visit_Filter</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">filter</span><span class="p">,</span> <span class="n">block_frame</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;concat(</span><span class="si">{</span><span class="n">block_frame</span><span class="o">.</span><span class="n">buffer</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;)&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pop_assign_tracking</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">leave_frame</span><span class="p">(</span><span class="n">block_frame</span><span class="p">)</span></div>


    <span class="c1"># -- Expression Visitors</span>

<div class="viewcode-block" id="CodeGenerator.visit_Name">
<a class="viewcode-back" href="../../autoapi/jinja2/compiler/index.html#jinja2.compiler.CodeGenerator.visit_Name">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">visit_Name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">nodes</span><span class="o">.</span><span class="n">Name</span><span class="p">,</span> <span class="n">frame</span><span class="p">:</span> <span class="n">Frame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">ctx</span> <span class="o">==</span> <span class="s2">&quot;store&quot;</span> <span class="ow">and</span> <span class="p">(</span>
            <span class="n">frame</span><span class="o">.</span><span class="n">toplevel</span> <span class="ow">or</span> <span class="n">frame</span><span class="o">.</span><span class="n">loop_frame</span> <span class="ow">or</span> <span class="n">frame</span><span class="o">.</span><span class="n">block_frame</span>
        <span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_assign_stack</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_assign_stack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="n">ref</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">symbols</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="c1"># If we are looking up a variable we might have to deal with the</span>
        <span class="c1"># case where it&#39;s undefined.  We can skip that case if the load</span>
        <span class="c1"># instruction indicates a parameter which are always defined.</span>
        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">ctx</span> <span class="o">==</span> <span class="s2">&quot;load&quot;</span><span class="p">:</span>
            <span class="n">load</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">symbols</span><span class="o">.</span><span class="n">find_load</span><span class="p">(</span><span class="n">ref</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span>
                <span class="n">load</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                <span class="ow">and</span> <span class="n">load</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">VAR_LOAD_PARAMETER</span>
                <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameter_is_undeclared</span><span class="p">(</span><span class="n">ref</span><span class="p">)</span>
            <span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;(undefined(name=</span><span class="si">{</span><span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="si">!r}</span><span class="s2">) if </span><span class="si">{</span><span class="n">ref</span><span class="si">}</span><span class="s2"> is missing else </span><span class="si">{</span><span class="n">ref</span><span class="si">}</span><span class="s2">)&quot;</span>
                <span class="p">)</span>
                <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">ref</span><span class="p">)</span></div>


<div class="viewcode-block" id="CodeGenerator.visit_NSRef">
<a class="viewcode-back" href="../../autoapi/jinja2/compiler/index.html#jinja2.compiler.CodeGenerator.visit_NSRef">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">visit_NSRef</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">nodes</span><span class="o">.</span><span class="n">NSRef</span><span class="p">,</span> <span class="n">frame</span><span class="p">:</span> <span class="n">Frame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># NSRef is a dotted assignment target a.b=c, but uses a[b]=c internally.</span>
        <span class="c1"># visit_Assign emits code to validate that each ref is to a Namespace</span>
        <span class="c1"># object only. That can&#39;t be emitted here as the ref could be in the</span>
        <span class="c1"># middle of a tuple assignment.</span>
        <span class="n">ref</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">symbols</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ref</span><span class="si">}</span><span class="s2">[</span><span class="si">{</span><span class="n">node</span><span class="o">.</span><span class="n">attr</span><span class="si">!r}</span><span class="s2">]&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="CodeGenerator.visit_Const">
<a class="viewcode-back" href="../../autoapi/jinja2/compiler/index.html#jinja2.compiler.CodeGenerator.visit_Const">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">visit_Const</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">nodes</span><span class="o">.</span><span class="n">Const</span><span class="p">,</span> <span class="n">frame</span><span class="p">:</span> <span class="n">Frame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">val</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">as_const</span><span class="p">(</span><span class="n">frame</span><span class="o">.</span><span class="n">eval_ctx</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">val</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">val</span><span class="p">))</span></div>


<div class="viewcode-block" id="CodeGenerator.visit_TemplateData">
<a class="viewcode-back" href="../../autoapi/jinja2/compiler/index.html#jinja2.compiler.CodeGenerator.visit_TemplateData">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">visit_TemplateData</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">nodes</span><span class="o">.</span><span class="n">TemplateData</span><span class="p">,</span> <span class="n">frame</span><span class="p">:</span> <span class="n">Frame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">as_const</span><span class="p">(</span><span class="n">frame</span><span class="o">.</span><span class="n">eval_ctx</span><span class="p">)))</span>
        <span class="k">except</span> <span class="n">nodes</span><span class="o">.</span><span class="n">Impossible</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;(Markup if context.eval_ctx.autoescape else identity)(</span><span class="si">{</span><span class="n">node</span><span class="o">.</span><span class="n">data</span><span class="si">!r}</span><span class="s2">)&quot;</span>
            <span class="p">)</span></div>


<div class="viewcode-block" id="CodeGenerator.visit_Tuple">
<a class="viewcode-back" href="../../autoapi/jinja2/compiler/index.html#jinja2.compiler.CodeGenerator.visit_Tuple">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">visit_Tuple</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">nodes</span><span class="o">.</span><span class="n">Tuple</span><span class="p">,</span> <span class="n">frame</span><span class="p">:</span> <span class="n">Frame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;(&quot;</span><span class="p">)</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">items</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">idx</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;, &quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;,)&quot;</span> <span class="k">if</span> <span class="n">idx</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;)&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="CodeGenerator.visit_List">
<a class="viewcode-back" href="../../autoapi/jinja2/compiler/index.html#jinja2.compiler.CodeGenerator.visit_List">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">visit_List</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">nodes</span><span class="o">.</span><span class="n">List</span><span class="p">,</span> <span class="n">frame</span><span class="p">:</span> <span class="n">Frame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;[&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">items</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">idx</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;, &quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;]&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="CodeGenerator.visit_Dict">
<a class="viewcode-back" href="../../autoapi/jinja2/compiler/index.html#jinja2.compiler.CodeGenerator.visit_Dict">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">visit_Dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">nodes</span><span class="o">.</span><span class="n">Dict</span><span class="p">,</span> <span class="n">frame</span><span class="p">:</span> <span class="n">Frame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;{&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">items</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">idx</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;, &quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">key</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;: &quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;}&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="CodeGenerator.visit_Add">
<a class="viewcode-back" href="../../autoapi/jinja2/compiler/index.html#jinja2.compiler.CodeGenerator.visit_Add">[docs]</a>
    <span class="n">visit_Add</span> <span class="o">=</span> <span class="n">_make_binop</span><span class="p">(</span><span class="s2">&quot;+&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="CodeGenerator.visit_Sub">
<a class="viewcode-back" href="../../autoapi/jinja2/compiler/index.html#jinja2.compiler.CodeGenerator.visit_Sub">[docs]</a>
    <span class="n">visit_Sub</span> <span class="o">=</span> <span class="n">_make_binop</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="CodeGenerator.visit_Mul">
<a class="viewcode-back" href="../../autoapi/jinja2/compiler/index.html#jinja2.compiler.CodeGenerator.visit_Mul">[docs]</a>
    <span class="n">visit_Mul</span> <span class="o">=</span> <span class="n">_make_binop</span><span class="p">(</span><span class="s2">&quot;*&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="CodeGenerator.visit_Div">
<a class="viewcode-back" href="../../autoapi/jinja2/compiler/index.html#jinja2.compiler.CodeGenerator.visit_Div">[docs]</a>
    <span class="n">visit_Div</span> <span class="o">=</span> <span class="n">_make_binop</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="CodeGenerator.visit_FloorDiv">
<a class="viewcode-back" href="../../autoapi/jinja2/compiler/index.html#jinja2.compiler.CodeGenerator.visit_FloorDiv">[docs]</a>
    <span class="n">visit_FloorDiv</span> <span class="o">=</span> <span class="n">_make_binop</span><span class="p">(</span><span class="s2">&quot;//&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="CodeGenerator.visit_Pow">
<a class="viewcode-back" href="../../autoapi/jinja2/compiler/index.html#jinja2.compiler.CodeGenerator.visit_Pow">[docs]</a>
    <span class="n">visit_Pow</span> <span class="o">=</span> <span class="n">_make_binop</span><span class="p">(</span><span class="s2">&quot;**&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="CodeGenerator.visit_Mod">
<a class="viewcode-back" href="../../autoapi/jinja2/compiler/index.html#jinja2.compiler.CodeGenerator.visit_Mod">[docs]</a>
    <span class="n">visit_Mod</span> <span class="o">=</span> <span class="n">_make_binop</span><span class="p">(</span><span class="s2">&quot;%&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="CodeGenerator.visit_And">
<a class="viewcode-back" href="../../autoapi/jinja2/compiler/index.html#jinja2.compiler.CodeGenerator.visit_And">[docs]</a>
    <span class="n">visit_And</span> <span class="o">=</span> <span class="n">_make_binop</span><span class="p">(</span><span class="s2">&quot;and&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="CodeGenerator.visit_Or">
<a class="viewcode-back" href="../../autoapi/jinja2/compiler/index.html#jinja2.compiler.CodeGenerator.visit_Or">[docs]</a>
    <span class="n">visit_Or</span> <span class="o">=</span> <span class="n">_make_binop</span><span class="p">(</span><span class="s2">&quot;or&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="CodeGenerator.visit_Pos">
<a class="viewcode-back" href="../../autoapi/jinja2/compiler/index.html#jinja2.compiler.CodeGenerator.visit_Pos">[docs]</a>
    <span class="n">visit_Pos</span> <span class="o">=</span> <span class="n">_make_unop</span><span class="p">(</span><span class="s2">&quot;+&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="CodeGenerator.visit_Neg">
<a class="viewcode-back" href="../../autoapi/jinja2/compiler/index.html#jinja2.compiler.CodeGenerator.visit_Neg">[docs]</a>
    <span class="n">visit_Neg</span> <span class="o">=</span> <span class="n">_make_unop</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="CodeGenerator.visit_Not">
<a class="viewcode-back" href="../../autoapi/jinja2/compiler/index.html#jinja2.compiler.CodeGenerator.visit_Not">[docs]</a>
    <span class="n">visit_Not</span> <span class="o">=</span> <span class="n">_make_unop</span><span class="p">(</span><span class="s2">&quot;not &quot;</span><span class="p">)</span></div>


    <span class="nd">@optimizeconst</span>
<div class="viewcode-block" id="CodeGenerator.visit_Concat">
<a class="viewcode-back" href="../../autoapi/jinja2/compiler/index.html#jinja2.compiler.CodeGenerator.visit_Concat">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">visit_Concat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">nodes</span><span class="o">.</span><span class="n">Concat</span><span class="p">,</span> <span class="n">frame</span><span class="p">:</span> <span class="n">Frame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">frame</span><span class="o">.</span><span class="n">eval_ctx</span><span class="o">.</span><span class="n">volatile</span><span class="p">:</span>
            <span class="n">func_name</span> <span class="o">=</span> <span class="s2">&quot;(markup_join if context.eval_ctx.volatile else str_join)&quot;</span>
        <span class="k">elif</span> <span class="n">frame</span><span class="o">.</span><span class="n">eval_ctx</span><span class="o">.</span><span class="n">autoescape</span><span class="p">:</span>
            <span class="n">func_name</span> <span class="o">=</span> <span class="s2">&quot;markup_join&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">func_name</span> <span class="o">=</span> <span class="s2">&quot;str_join&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">func_name</span><span class="si">}</span><span class="s2">((&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">nodes</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;, &quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;))&quot;</span><span class="p">)</span></div>


    <span class="nd">@optimizeconst</span>
<div class="viewcode-block" id="CodeGenerator.visit_Compare">
<a class="viewcode-back" href="../../autoapi/jinja2/compiler/index.html#jinja2.compiler.CodeGenerator.visit_Compare">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">visit_Compare</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">nodes</span><span class="o">.</span><span class="n">Compare</span><span class="p">,</span> <span class="n">frame</span><span class="p">:</span> <span class="n">Frame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;(&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">expr</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">ops</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;)&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="CodeGenerator.visit_Operand">
<a class="viewcode-back" href="../../autoapi/jinja2/compiler/index.html#jinja2.compiler.CodeGenerator.visit_Operand">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">visit_Operand</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">nodes</span><span class="o">.</span><span class="n">Operand</span><span class="p">,</span> <span class="n">frame</span><span class="p">:</span> <span class="n">Frame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="n">operators</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">op</span><span class="p">]</span><span class="si">}</span><span class="s2"> &quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">expr</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span></div>


    <span class="nd">@optimizeconst</span>
<div class="viewcode-block" id="CodeGenerator.visit_Getattr">
<a class="viewcode-back" href="../../autoapi/jinja2/compiler/index.html#jinja2.compiler.CodeGenerator.visit_Getattr">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">visit_Getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">nodes</span><span class="o">.</span><span class="n">Getattr</span><span class="p">,</span> <span class="n">frame</span><span class="p">:</span> <span class="n">Frame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">is_async</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;(await auto_await(&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;environment.getattr(&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">node</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;, </span><span class="si">{</span><span class="n">node</span><span class="o">.</span><span class="n">attr</span><span class="si">!r}</span><span class="s2">)&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">is_async</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;))&quot;</span><span class="p">)</span></div>


    <span class="nd">@optimizeconst</span>
<div class="viewcode-block" id="CodeGenerator.visit_Getitem">
<a class="viewcode-back" href="../../autoapi/jinja2/compiler/index.html#jinja2.compiler.CodeGenerator.visit_Getitem">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">visit_Getitem</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">nodes</span><span class="o">.</span><span class="n">Getitem</span><span class="p">,</span> <span class="n">frame</span><span class="p">:</span> <span class="n">Frame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># slices bypass the environment getitem method.</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">arg</span><span class="p">,</span> <span class="n">nodes</span><span class="o">.</span><span class="n">Slice</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">node</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;[&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">arg</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;]&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">is_async</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;(await auto_await(&quot;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;environment.getitem(&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">node</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;, &quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">arg</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;)&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">is_async</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;))&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="CodeGenerator.visit_Slice">
<a class="viewcode-back" href="../../autoapi/jinja2/compiler/index.html#jinja2.compiler.CodeGenerator.visit_Slice">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">visit_Slice</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">nodes</span><span class="o">.</span><span class="n">Slice</span><span class="p">,</span> <span class="n">frame</span><span class="p">:</span> <span class="n">Frame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">start</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">stop</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">stop</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">step</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">step</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span></div>


    <span class="nd">@contextmanager</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_filter_test_common</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="n">nodes</span><span class="o">.</span><span class="n">Filter</span><span class="p">,</span> <span class="n">nodes</span><span class="o">.</span><span class="n">Test</span><span class="p">],</span> <span class="n">frame</span><span class="p">:</span> <span class="n">Frame</span><span class="p">,</span> <span class="n">is_filter</span><span class="p">:</span> <span class="nb">bool</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Iterator</span><span class="p">[</span><span class="kc">None</span><span class="p">]:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">is_async</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;(await auto_await(&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">is_filter</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">filters</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="si">}</span><span class="s2">(&quot;</span><span class="p">)</span>
            <span class="n">func</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">filters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">tests</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="si">}</span><span class="s2">(&quot;</span><span class="p">)</span>
            <span class="n">func</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">tests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="c1"># When inside an If or CondExpr frame, allow the filter to be</span>
        <span class="c1"># undefined at compile time and only raise an error if it&#39;s</span>
        <span class="c1"># actually called at runtime. See pull_dependencies.</span>
        <span class="k">if</span> <span class="n">func</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">frame</span><span class="o">.</span><span class="n">soft_frame</span><span class="p">:</span>
            <span class="n">type_name</span> <span class="o">=</span> <span class="s2">&quot;filter&quot;</span> <span class="k">if</span> <span class="n">is_filter</span> <span class="k">else</span> <span class="s2">&quot;test&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No </span><span class="si">{</span><span class="n">type_name</span><span class="si">}</span><span class="s2"> named </span><span class="si">{</span><span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="si">!r}</span><span class="s2">.&quot;</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">lineno</span><span class="p">)</span>

        <span class="n">pass_arg</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">_PassArg</span><span class="o">.</span><span class="n">context</span><span class="p">:</span> <span class="s2">&quot;context&quot;</span><span class="p">,</span>
            <span class="n">_PassArg</span><span class="o">.</span><span class="n">eval_context</span><span class="p">:</span> <span class="s2">&quot;context.eval_ctx&quot;</span><span class="p">,</span>
            <span class="n">_PassArg</span><span class="o">.</span><span class="n">environment</span><span class="p">:</span> <span class="s2">&quot;environment&quot;</span><span class="p">,</span>
        <span class="p">}</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="n">_PassArg</span><span class="o">.</span><span class="n">from_obj</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>  <span class="c1"># type: ignore</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">pass_arg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">pass_arg</span><span class="si">}</span><span class="s2">, &quot;</span><span class="p">)</span>

        <span class="c1"># Back to the visitor function to handle visiting the target of</span>
        <span class="c1"># the filter or test.</span>
        <span class="k">yield</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;)&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">is_async</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;))&quot;</span><span class="p">)</span>

    <span class="nd">@optimizeconst</span>
<div class="viewcode-block" id="CodeGenerator.visit_Filter">
<a class="viewcode-back" href="../../autoapi/jinja2/compiler/index.html#jinja2.compiler.CodeGenerator.visit_Filter">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">visit_Filter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">nodes</span><span class="o">.</span><span class="n">Filter</span><span class="p">,</span> <span class="n">frame</span><span class="p">:</span> <span class="n">Frame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filter_test_common</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">frame</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span>
            <span class="c1"># if the filter node is None we are inside a filter block</span>
            <span class="c1"># and want to write to the current buffer</span>
            <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">node</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">node</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">frame</span><span class="o">.</span><span class="n">eval_ctx</span><span class="o">.</span><span class="n">volatile</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;(Markup(concat(</span><span class="si">{</span><span class="n">frame</span><span class="o">.</span><span class="n">buffer</span><span class="si">}</span><span class="s2">))&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot; if context.eval_ctx.autoescape else concat(</span><span class="si">{</span><span class="n">frame</span><span class="o">.</span><span class="n">buffer</span><span class="si">}</span><span class="s2">))&quot;</span>
                <span class="p">)</span>
            <span class="k">elif</span> <span class="n">frame</span><span class="o">.</span><span class="n">eval_ctx</span><span class="o">.</span><span class="n">autoescape</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Markup(concat(</span><span class="si">{</span><span class="n">frame</span><span class="o">.</span><span class="n">buffer</span><span class="si">}</span><span class="s2">))&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;concat(</span><span class="si">{</span><span class="n">frame</span><span class="o">.</span><span class="n">buffer</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span></div>


    <span class="nd">@optimizeconst</span>
<div class="viewcode-block" id="CodeGenerator.visit_Test">
<a class="viewcode-back" href="../../autoapi/jinja2/compiler/index.html#jinja2.compiler.CodeGenerator.visit_Test">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">visit_Test</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">nodes</span><span class="o">.</span><span class="n">Test</span><span class="p">,</span> <span class="n">frame</span><span class="p">:</span> <span class="n">Frame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filter_test_common</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">frame</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">node</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span></div>


    <span class="nd">@optimizeconst</span>
<div class="viewcode-block" id="CodeGenerator.visit_CondExpr">
<a class="viewcode-back" href="../../autoapi/jinja2/compiler/index.html#jinja2.compiler.CodeGenerator.visit_CondExpr">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">visit_CondExpr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">nodes</span><span class="o">.</span><span class="n">CondExpr</span><span class="p">,</span> <span class="n">frame</span><span class="p">:</span> <span class="n">Frame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">frame</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">soft</span><span class="p">()</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">write_expr2</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">expr2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">expr2</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span>
                <span class="k">return</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;cond_expr_undefined(&quot;the inline if-expression on&#39;</span>
                <span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">position</span><span class="p">(</span><span class="n">node</span><span class="p">)</span><span class="si">}</span><span class="s2"> evaluated to false and no else&quot;</span>
                <span class="sa">f</span><span class="s1">&#39; section was defined.&quot;)&#39;</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;(&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">expr1</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; if &quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">test</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; else &quot;</span><span class="p">)</span>
        <span class="n">write_expr2</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;)&quot;</span><span class="p">)</span></div>


    <span class="nd">@optimizeconst</span>
<div class="viewcode-block" id="CodeGenerator.visit_Call">
<a class="viewcode-back" href="../../autoapi/jinja2/compiler/index.html#jinja2.compiler.CodeGenerator.visit_Call">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">visit_Call</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">nodes</span><span class="o">.</span><span class="n">Call</span><span class="p">,</span> <span class="n">frame</span><span class="p">:</span> <span class="n">Frame</span><span class="p">,</span> <span class="n">forward_caller</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">is_async</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;(await auto_await(&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">sandboxed</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;environment.call(context, &quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;context.call(&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">node</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span>
        <span class="n">extra_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;caller&quot;</span><span class="p">:</span> <span class="s2">&quot;caller&quot;</span><span class="p">}</span> <span class="k">if</span> <span class="n">forward_caller</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">loop_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;_loop_vars&quot;</span><span class="p">:</span> <span class="s2">&quot;_loop_vars&quot;</span><span class="p">}</span> <span class="k">if</span> <span class="n">frame</span><span class="o">.</span><span class="n">loop_frame</span> <span class="k">else</span> <span class="p">{}</span>
        <span class="n">block_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;_block_vars&quot;</span><span class="p">:</span> <span class="s2">&quot;_block_vars&quot;</span><span class="p">}</span> <span class="k">if</span> <span class="n">frame</span><span class="o">.</span><span class="n">block_frame</span> <span class="k">else</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">extra_kwargs</span><span class="p">:</span>
            <span class="n">extra_kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">loop_kwargs</span><span class="p">,</span> <span class="o">**</span><span class="n">block_kwargs</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">loop_kwargs</span> <span class="ow">or</span> <span class="n">block_kwargs</span><span class="p">:</span>
            <span class="n">extra_kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">loop_kwargs</span><span class="p">,</span> <span class="o">**</span><span class="n">block_kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">frame</span><span class="p">,</span> <span class="n">extra_kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;)&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">is_async</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;))&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="CodeGenerator.visit_Keyword">
<a class="viewcode-back" href="../../autoapi/jinja2/compiler/index.html#jinja2.compiler.CodeGenerator.visit_Keyword">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">visit_Keyword</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">nodes</span><span class="o">.</span><span class="n">Keyword</span><span class="p">,</span> <span class="n">frame</span><span class="p">:</span> <span class="n">Frame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">key</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span></div>


    <span class="c1"># -- Unused nodes for extensions</span>

<div class="viewcode-block" id="CodeGenerator.visit_MarkSafe">
<a class="viewcode-back" href="../../autoapi/jinja2/compiler/index.html#jinja2.compiler.CodeGenerator.visit_MarkSafe">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">visit_MarkSafe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">nodes</span><span class="o">.</span><span class="n">MarkSafe</span><span class="p">,</span> <span class="n">frame</span><span class="p">:</span> <span class="n">Frame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Markup(&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">expr</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;)&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="CodeGenerator.visit_MarkSafeIfAutoescape">
<a class="viewcode-back" href="../../autoapi/jinja2/compiler/index.html#jinja2.compiler.CodeGenerator.visit_MarkSafeIfAutoescape">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">visit_MarkSafeIfAutoescape</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">nodes</span><span class="o">.</span><span class="n">MarkSafeIfAutoescape</span><span class="p">,</span> <span class="n">frame</span><span class="p">:</span> <span class="n">Frame</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;(Markup if context.eval_ctx.autoescape else identity)(&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">expr</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;)&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="CodeGenerator.visit_EnvironmentAttribute">
<a class="viewcode-back" href="../../autoapi/jinja2/compiler/index.html#jinja2.compiler.CodeGenerator.visit_EnvironmentAttribute">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">visit_EnvironmentAttribute</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">nodes</span><span class="o">.</span><span class="n">EnvironmentAttribute</span><span class="p">,</span> <span class="n">frame</span><span class="p">:</span> <span class="n">Frame</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;environment.&quot;</span> <span class="o">+</span> <span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="p">)</span></div>


<div class="viewcode-block" id="CodeGenerator.visit_ExtensionAttribute">
<a class="viewcode-back" href="../../autoapi/jinja2/compiler/index.html#jinja2.compiler.CodeGenerator.visit_ExtensionAttribute">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">visit_ExtensionAttribute</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">nodes</span><span class="o">.</span><span class="n">ExtensionAttribute</span><span class="p">,</span> <span class="n">frame</span><span class="p">:</span> <span class="n">Frame</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;environment.extensions[</span><span class="si">{</span><span class="n">node</span><span class="o">.</span><span class="n">identifier</span><span class="si">!r}</span><span class="s2">].</span><span class="si">{</span><span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="CodeGenerator.visit_ImportedName">
<a class="viewcode-back" href="../../autoapi/jinja2/compiler/index.html#jinja2.compiler.CodeGenerator.visit_ImportedName">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">visit_ImportedName</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">nodes</span><span class="o">.</span><span class="n">ImportedName</span><span class="p">,</span> <span class="n">frame</span><span class="p">:</span> <span class="n">Frame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">import_aliases</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">importname</span><span class="p">])</span></div>


<div class="viewcode-block" id="CodeGenerator.visit_InternalName">
<a class="viewcode-back" href="../../autoapi/jinja2/compiler/index.html#jinja2.compiler.CodeGenerator.visit_InternalName">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">visit_InternalName</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">nodes</span><span class="o">.</span><span class="n">InternalName</span><span class="p">,</span> <span class="n">frame</span><span class="p">:</span> <span class="n">Frame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="p">)</span></div>


<div class="viewcode-block" id="CodeGenerator.visit_ContextReference">
<a class="viewcode-back" href="../../autoapi/jinja2/compiler/index.html#jinja2.compiler.CodeGenerator.visit_ContextReference">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">visit_ContextReference</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">nodes</span><span class="o">.</span><span class="n">ContextReference</span><span class="p">,</span> <span class="n">frame</span><span class="p">:</span> <span class="n">Frame</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;context&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="CodeGenerator.visit_DerivedContextReference">
<a class="viewcode-back" href="../../autoapi/jinja2/compiler/index.html#jinja2.compiler.CodeGenerator.visit_DerivedContextReference">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">visit_DerivedContextReference</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">nodes</span><span class="o">.</span><span class="n">DerivedContextReference</span><span class="p">,</span> <span class="n">frame</span><span class="p">:</span> <span class="n">Frame</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">derive_context</span><span class="p">(</span><span class="n">frame</span><span class="p">))</span></div>


<div class="viewcode-block" id="CodeGenerator.visit_Continue">
<a class="viewcode-back" href="../../autoapi/jinja2/compiler/index.html#jinja2.compiler.CodeGenerator.visit_Continue">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">visit_Continue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">nodes</span><span class="o">.</span><span class="n">Continue</span><span class="p">,</span> <span class="n">frame</span><span class="p">:</span> <span class="n">Frame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="s2">&quot;continue&quot;</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span></div>


<div class="viewcode-block" id="CodeGenerator.visit_Break">
<a class="viewcode-back" href="../../autoapi/jinja2/compiler/index.html#jinja2.compiler.CodeGenerator.visit_Break">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">visit_Break</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">nodes</span><span class="o">.</span><span class="n">Break</span><span class="p">,</span> <span class="n">frame</span><span class="p">:</span> <span class="n">Frame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="s2">&quot;break&quot;</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span></div>


<div class="viewcode-block" id="CodeGenerator.visit_Scope">
<a class="viewcode-back" href="../../autoapi/jinja2/compiler/index.html#jinja2.compiler.CodeGenerator.visit_Scope">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">visit_Scope</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">nodes</span><span class="o">.</span><span class="n">Scope</span><span class="p">,</span> <span class="n">frame</span><span class="p">:</span> <span class="n">Frame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">scope_frame</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">inner</span><span class="p">()</span>
        <span class="n">scope_frame</span><span class="o">.</span><span class="n">symbols</span><span class="o">.</span><span class="n">analyze_node</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">enter_frame</span><span class="p">(</span><span class="n">scope_frame</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">blockvisit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">body</span><span class="p">,</span> <span class="n">scope_frame</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">leave_frame</span><span class="p">(</span><span class="n">scope_frame</span><span class="p">)</span></div>


<div class="viewcode-block" id="CodeGenerator.visit_OverlayScope">
<a class="viewcode-back" href="../../autoapi/jinja2/compiler/index.html#jinja2.compiler.CodeGenerator.visit_OverlayScope">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">visit_OverlayScope</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">nodes</span><span class="o">.</span><span class="n">OverlayScope</span><span class="p">,</span> <span class="n">frame</span><span class="p">:</span> <span class="n">Frame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ctx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">temporary_identifier</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ctx</span><span class="si">}</span><span class="s2"> = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">derive_context</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ctx</span><span class="si">}</span><span class="s2">.vars = &quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">push_context_reference</span><span class="p">(</span><span class="n">ctx</span><span class="p">)</span>

        <span class="n">scope_frame</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">isolated</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">scope_frame</span><span class="o">.</span><span class="n">symbols</span><span class="o">.</span><span class="n">analyze_node</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">enter_frame</span><span class="p">(</span><span class="n">scope_frame</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">blockvisit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">body</span><span class="p">,</span> <span class="n">scope_frame</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">leave_frame</span><span class="p">(</span><span class="n">scope_frame</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pop_context_reference</span><span class="p">()</span></div>


<div class="viewcode-block" id="CodeGenerator.visit_EvalContextModifier">
<a class="viewcode-back" href="../../autoapi/jinja2/compiler/index.html#jinja2.compiler.CodeGenerator.visit_EvalContextModifier">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">visit_EvalContextModifier</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">nodes</span><span class="o">.</span><span class="n">EvalContextModifier</span><span class="p">,</span> <span class="n">frame</span><span class="p">:</span> <span class="n">Frame</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">keyword</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">options</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;context.eval_ctx.</span><span class="si">{</span><span class="n">keyword</span><span class="o">.</span><span class="n">key</span><span class="si">}</span><span class="s2"> = &quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">keyword</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">val</span> <span class="o">=</span> <span class="n">keyword</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">as_const</span><span class="p">(</span><span class="n">frame</span><span class="o">.</span><span class="n">eval_ctx</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">nodes</span><span class="o">.</span><span class="n">Impossible</span><span class="p">:</span>
                <span class="n">frame</span><span class="o">.</span><span class="n">eval_ctx</span><span class="o">.</span><span class="n">volatile</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="n">frame</span><span class="o">.</span><span class="n">eval_ctx</span><span class="p">,</span> <span class="n">keyword</span><span class="o">.</span><span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span></div>


<div class="viewcode-block" id="CodeGenerator.visit_ScopedEvalContextModifier">
<a class="viewcode-back" href="../../autoapi/jinja2/compiler/index.html#jinja2.compiler.CodeGenerator.visit_ScopedEvalContextModifier">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">visit_ScopedEvalContextModifier</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">nodes</span><span class="o">.</span><span class="n">ScopedEvalContextModifier</span><span class="p">,</span> <span class="n">frame</span><span class="p">:</span> <span class="n">Frame</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">old_ctx_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">temporary_identifier</span><span class="p">()</span>
        <span class="n">saved_ctx</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">eval_ctx</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">old_ctx_name</span><span class="si">}</span><span class="s2"> = context.eval_ctx.save()&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visit_EvalContextModifier</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">body</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span>
        <span class="n">frame</span><span class="o">.</span><span class="n">eval_ctx</span><span class="o">.</span><span class="n">revert</span><span class="p">(</span><span class="n">saved_ctx</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;context.eval_ctx.revert(</span><span class="si">{</span><span class="n">old_ctx_name</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span></div>
</div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright .</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>