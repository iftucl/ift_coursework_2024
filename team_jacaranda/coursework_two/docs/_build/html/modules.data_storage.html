<!DOCTYPE html>

<html lang="en" data-content_root="./">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>modules.data_storage package &#8212; Bigdata_cw2_Jacaranda 1.0 documentation</title>
    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=5ecbeea2" />
    <link rel="stylesheet" type="text/css" href="_static/basic.css?v=b08954a9" />
    <link rel="stylesheet" type="text/css" href="_static/alabaster.css?v=27fed22d" />
    <script src="_static/documentation_options.js?v=f2a433a1"></script>
    <script src="_static/doctools.js?v=9bcbadda"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="modules.frontend package" href="modules.frontend.html" />
    <link rel="prev" title="modules package" href="modules.html" />
   
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="modules-data-storage-package">
<h1>modules.data_storage package<a class="headerlink" href="#modules-data-storage-package" title="Link to this heading">¶</a></h1>
<section id="submodules">
<h2>Submodules<a class="headerlink" href="#submodules" title="Link to this heading">¶</a></h2>
</section>
<section id="module-modules.data_storage.create_table">
<span id="modules-data-storage-create-table-module"></span><h2>modules.data_storage.create_table module<a class="headerlink" href="#module-modules.data_storage.create_table" title="Link to this heading">¶</a></h2>
<p>Database setup module for CSR reporting system.</p>
<p>This module connects to a PostgreSQL database, creates necessary schema and tables
for storing CSR indicators and associated data, and populates the indicators table
with predefined environmental indicators and keywords.</p>
<dl class="py function">
<dt class="sig sig-object py" id="modules.data_storage.create_table.create_table_and_insert_data">
<span class="sig-prename descclassname"><span class="pre">modules.data_storage.create_table.</span></span><span class="sig-name descname"><span class="pre">create_table_and_insert_data</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="reference internal" href="_modules/modules/data_storage/create_table.html#create_table_and_insert_data"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#modules.data_storage.create_table.create_table_and_insert_data" title="Link to this definition">¶</a></dt>
<dd><p>Create the schema and tables required for CSR data reporting and
insert predefined indicator metadata into the <cite>CSR_indicators</cite> table.</p>
<p>This includes:
- Creating the <cite>csr_reporting</cite> schema if it does not exist.
- Creating the <cite>CSR_indicators</cite> table to store CSR indicator metadata.
- Creating the <cite>CSR_Data</cite> table to store extracted CSR data.
- Inserting predefined indicators and associated keywords.</p>
<dl class="field-list simple">
<dt class="field-odd">Raises<span class="colon">:</span></dt>
<dd class="field-odd"><p><strong>psycopg2.Error</strong> – If any error occurs during schema/table creation or data insertion.</p>
</dd>
</dl>
</dd></dl>

</section>
<section id="module-modules.data_storage.data_export">
<span id="modules-data-storage-data-export-module"></span><h2>modules.data_storage.data_export module<a class="headerlink" href="#module-modules.data_storage.data_export" title="Link to this heading">¶</a></h2>
<p>This module exports tables from a PostgreSQL database to CSV files.</p>
<p>It uses <cite>psycopg2</cite> for database connectivity and <cite>pandas</cite> to execute SQL queries and export the results
to CSV files. The module supports configuration for the database connection, output file paths,
and default sorting columns for the queries.</p>
<p>Functions:
- <cite>export_table_to_csv</cite>: Exports a specified table from the PostgreSQL database to a CSV file.
- <cite>main</cite>: Orchestrates the connection to the database and exports predefined tables to CSV files.</p>
<dl class="py function">
<dt class="sig sig-object py" id="modules.data_storage.data_export.export_table_to_csv">
<span class="sig-prename descclassname"><span class="pre">modules.data_storage.data_export.</span></span><span class="sig-name descname"><span class="pre">export_table_to_csv</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">table_name</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">output_path</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">conn</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/modules/data_storage/data_export.html#export_table_to_csv"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#modules.data_storage.data_export.export_table_to_csv" title="Link to this definition">¶</a></dt>
<dd><p>Exports a specific table from the PostgreSQL database to a CSV file.</p>
<p>This function fetches all data from the specified table, optionally ordering it
by a default column (if configured), and saves the results to a CSV file at the
provided output path.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>table_name</strong> (<em>str</em>) – The name of the table to export.</p></li>
<li><p><strong>output_path</strong> (<em>str</em>) – The path where the CSV file will be saved.</p></li>
<li><p><strong>conn</strong> (<em>psycopg2.extensions.connection</em>) – A psycopg2 connection object used to interact with the database.</p></li>
</ul>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p>None</p>
</dd>
<dt class="field-odd">Raises<span class="colon">:</span></dt>
<dd class="field-odd"><p>Any exceptions raised by the <cite>pandas.read_sql_query</cite> or <cite>pandas.DataFrame.to_csv</cite> functions.</p>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="modules.data_storage.data_export.main">
<span class="sig-prename descclassname"><span class="pre">modules.data_storage.data_export.</span></span><span class="sig-name descname"><span class="pre">main</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="reference internal" href="_modules/modules/data_storage/data_export.html#main"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#modules.data_storage.data_export.main" title="Link to this definition">¶</a></dt>
<dd><p>Main function to connect to the PostgreSQL database and export multiple tables to CSV files.</p>
<p>This function establishes a connection to the database, iterates over a predefined
list of tables, and calls <cite>export_table_to_csv</cite> to export each table to a CSV file.</p>
<dl class="field-list simple">
<dt class="field-odd">Returns<span class="colon">:</span></dt>
<dd class="field-odd"><p>None</p>
</dd>
<dt class="field-even">Raises<span class="colon">:</span></dt>
<dd class="field-even"><p>Any exceptions raised during the database connection or table export process.</p>
</dd>
</dl>
</dd></dl>

</section>
<section id="module-modules.data_storage.llm_analyse">
<span id="modules-data-storage-llm-analyse-module"></span><h2>modules.data_storage.llm_analyse module<a class="headerlink" href="#module-modules.data_storage.llm_analyse" title="Link to this heading">¶</a></h2>
<p>This module processes CSR (Corporate Social Responsibility) data by interacting with a PostgreSQL database
and an OpenAI API. It performs tasks such as fetching pending CSR data from the database, building prompts
for an LLM (Large Language Model), processing the data, and updating the results in the database.</p>
<p>The workflow involves the following key steps:
1. Establishing a connection to the PostgreSQL database.
2. Fetching pending rows that need processing.
3. Creating prompts for the LLM based on CSR report data and indicators.
4. Sending these prompts to an OpenAI-powered LLM for processing.
5. Extracting and updating relevant values (numeric or goal-related data) in the database.</p>
<p>Configuration:
- PostgreSQL: Used for storing and retrieving CSR data.
- OpenAI API: Used for processing CSR report content.</p>
<p>Dependencies:
- psycopg2: PostgreSQL database adapter.
- dotenv: Used to load environment variables.
- openai: Python client for interacting with the OpenAI API.
- tqdm: For progress bars.
- concurrent.futures: For concurrent processing using threads.</p>
<dl class="py function">
<dt class="sig sig-object py" id="modules.data_storage.llm_analyse.build_prompt">
<span class="sig-prename descclassname"><span class="pre">modules.data_storage.llm_analyse.</span></span><span class="sig-name descname"><span class="pre">build_prompt</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">indicator_name</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">description</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">is_target</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">source_excerpt</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">report_year</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/modules/data_storage/llm_analyse.html#build_prompt"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#modules.data_storage.llm_analyse.build_prompt" title="Link to this definition">¶</a></dt>
<dd><p>Builds a prompt for the LLM based on the CSR report and indicator details.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>indicator_name</strong> (<em>str</em>) – The name of the CSR indicator.</p></li>
<li><p><strong>description</strong> (<em>str</em>) – The description of the CSR indicator.</p></li>
<li><p><strong>is_target</strong> (<em>bool</em>) – Flag indicating whether the indicator is a target indicator.</p></li>
<li><p><strong>source_excerpt</strong> (<em>list</em><em> of </em><em>dict</em>) – List of matched paragraphs from the CSR report.</p></li>
<li><p><strong>report_year</strong> (<em>int</em>) – The year of the CSR report.</p></li>
</ul>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p>The formatted prompt for the LLM.</p>
</dd>
<dt class="field-odd">Return type<span class="colon">:</span></dt>
<dd class="field-odd"><p>str</p>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="modules.data_storage.llm_analyse.call_llm">
<span class="sig-prename descclassname"><span class="pre">modules.data_storage.llm_analyse.</span></span><span class="sig-name descname"><span class="pre">call_llm</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">prompt</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/modules/data_storage/llm_analyse.html#call_llm"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#modules.data_storage.llm_analyse.call_llm" title="Link to this definition">¶</a></dt>
<dd><p>Calls the LLM API with the provided prompt and returns the response.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><p><strong>prompt</strong> (<em>str</em>) – The prompt to be sent to the LLM.</p>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p>The response content from the LLM.</p>
</dd>
<dt class="field-odd">Return type<span class="colon">:</span></dt>
<dd class="field-odd"><p>str</p>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="modules.data_storage.llm_analyse.fetch_pending_rows">
<span class="sig-prename descclassname"><span class="pre">modules.data_storage.llm_analyse.</span></span><span class="sig-name descname"><span class="pre">fetch_pending_rows</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">conn</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/modules/data_storage/llm_analyse.html#fetch_pending_rows"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#modules.data_storage.llm_analyse.fetch_pending_rows" title="Link to this definition">¶</a></dt>
<dd><p>Fetches rows from the database that have a NULL value for ‘value_raw’ and are pending processing.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><p><strong>conn</strong> (<em>psycopg2.extensions.connection</em>) – A psycopg2 connection object.</p>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p>List of tuples representing the pending rows.</p>
</dd>
<dt class="field-odd">Return type<span class="colon">:</span></dt>
<dd class="field-odd"><p>list of tuples</p>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="modules.data_storage.llm_analyse.get_connection">
<span class="sig-prename descclassname"><span class="pre">modules.data_storage.llm_analyse.</span></span><span class="sig-name descname"><span class="pre">get_connection</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="reference internal" href="_modules/modules/data_storage/llm_analyse.html#get_connection"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#modules.data_storage.llm_analyse.get_connection" title="Link to this definition">¶</a></dt>
<dd><p>Establishes a connection to the PostgreSQL database using the provided configuration.</p>
<dl class="field-list simple">
<dt class="field-odd">Returns<span class="colon">:</span></dt>
<dd class="field-odd"><p>psycopg2 connection object.</p>
</dd>
<dt class="field-even">Return type<span class="colon">:</span></dt>
<dd class="field-even"><p>psycopg2.extensions.connection</p>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="modules.data_storage.llm_analyse.is_valid_number">
<span class="sig-prename descclassname"><span class="pre">modules.data_storage.llm_analyse.</span></span><span class="sig-name descname"><span class="pre">is_valid_number</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">value</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/modules/data_storage/llm_analyse.html#is_valid_number"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#modules.data_storage.llm_analyse.is_valid_number" title="Link to this definition">¶</a></dt>
<dd><p>Checks if the given value is a valid number (either integer or float).</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><p><strong>value</strong> (<em>str</em>) – The value to check.</p>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p>True if the value is a valid number, otherwise False.</p>
</dd>
<dt class="field-odd">Return type<span class="colon">:</span></dt>
<dd class="field-odd"><p>bool</p>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="modules.data_storage.llm_analyse.main">
<span class="sig-prename descclassname"><span class="pre">modules.data_storage.llm_analyse.</span></span><span class="sig-name descname"><span class="pre">main</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="reference internal" href="_modules/modules/data_storage/llm_analyse.html#main"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#modules.data_storage.llm_analyse.main" title="Link to this definition">¶</a></dt>
<dd><p>Main function to process all pending rows in the database by calling the process_row function concurrently.</p>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="modules.data_storage.llm_analyse.process_row">
<span class="sig-prename descclassname"><span class="pre">modules.data_storage.llm_analyse.</span></span><span class="sig-name descname"><span class="pre">process_row</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">conn</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">row</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/modules/data_storage/llm_analyse.html#process_row"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#modules.data_storage.llm_analyse.process_row" title="Link to this definition">¶</a></dt>
<dd><p>Processes a single row from the database, including calling the LLM API and updating the result in the database.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>conn</strong> (<em>psycopg2.extensions.connection</em>) – A psycopg2 connection object.</p></li>
<li><p><strong>row</strong> (<em>tuple</em>) – A tuple representing a single row of CSR data to be processed.</p></li>
</ul>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p>The ID of the processed data row.</p>
</dd>
<dt class="field-odd">Return type<span class="colon">:</span></dt>
<dd class="field-odd"><p>int</p>
</dd>
<dt class="field-even">Raises<span class="colon">:</span></dt>
<dd class="field-even"><p><strong>Exception</strong> – If an error occurs during processing.</p>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="modules.data_storage.llm_analyse.update_result">
<span class="sig-prename descclassname"><span class="pre">modules.data_storage.llm_analyse.</span></span><span class="sig-name descname"><span class="pre">update_result</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">conn</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">data_id</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">value_raw</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">unit_raw</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">llm_response_raw</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">pdf_page</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/modules/data_storage/llm_analyse.html#update_result"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#modules.data_storage.llm_analyse.update_result" title="Link to this definition">¶</a></dt>
<dd><p>Updates the processed result in the database for the given data ID.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>conn</strong> (<em>psycopg2.extensions.connection</em>) – A psycopg2 connection object.</p></li>
<li><p><strong>data_id</strong> (<em>int</em>) – The ID of the data to be updated.</p></li>
<li><p><strong>value_raw</strong> (<em>str</em>) – The raw value extracted from the CSR report.</p></li>
<li><p><strong>unit_raw</strong> (<em>str</em>) – The unit of the extracted value.</p></li>
<li><p><strong>llm_response_raw</strong> (<em>str</em>) – The raw response from the LLM.</p></li>
<li><p><strong>pdf_page</strong> (<em>str</em>) – The page number(s) from the CSR report where the data was found.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

</section>
<section id="module-modules.data_storage.llm_standardize">
<span id="modules-data-storage-llm-standardize-module"></span><h2>modules.data_storage.llm_standardize module<a class="headerlink" href="#module-modules.data_storage.llm_standardize" title="Link to this heading">¶</a></h2>
<p>This module processes and standardizes CSR report data by converting indicator units
to a target unit using a machine learning model (LLM). It interacts with a PostgreSQL
database to fetch, process, and update the data.</p>
<p>Key functions:
- Fetch rows from the database that need unit standardization.
- Build prompts for the LLM to convert units based on the CSR indicator.
- Call the LLM API to get the conversion results.
- Parse the response and update the database with standardized values.</p>
<p>It uses <cite>psycopg2</cite> for PostgreSQL interaction, <cite>dotenv</cite> for environment variable management,
<cite>tqdm</cite> for progress tracking, and <cite>concurrent.futures</cite> for concurrent execution of row processing.</p>
<dl class="py function">
<dt class="sig sig-object py" id="modules.data_storage.llm_standardize.build_conversion_prompt">
<span class="sig-prename descclassname"><span class="pre">modules.data_storage.llm_standardize.</span></span><span class="sig-name descname"><span class="pre">build_conversion_prompt</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">indicator_name</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">description</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">value_raw</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">unit_raw</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">target_unit</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/modules/data_storage/llm_standardize.html#build_conversion_prompt"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#modules.data_storage.llm_standardize.build_conversion_prompt" title="Link to this definition">¶</a></dt>
<dd><p>Constructs a prompt for the LLM to convert a unit of measurement from the raw value to the target unit.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>indicator_name</strong> (<em>str</em>) – The name of the CSR indicator.</p></li>
<li><p><strong>description</strong> (<em>str</em>) – The description of the CSR indicator.</p></li>
<li><p><strong>value_raw</strong> (<em>str</em>) – The raw value to be converted.</p></li>
<li><p><strong>unit_raw</strong> (<em>str</em>) – The unit of the raw value.</p></li>
<li><p><strong>target_unit</strong> (<em>str</em>) – The target unit to convert the value to.</p></li>
</ul>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p>The LLM prompt as a formatted string.</p>
</dd>
<dt class="field-odd">Return type<span class="colon">:</span></dt>
<dd class="field-odd"><p>str</p>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="modules.data_storage.llm_standardize.call_llm">
<span class="sig-prename descclassname"><span class="pre">modules.data_storage.llm_standardize.</span></span><span class="sig-name descname"><span class="pre">call_llm</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">prompt</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/modules/data_storage/llm_standardize.html#call_llm"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#modules.data_storage.llm_standardize.call_llm" title="Link to this definition">¶</a></dt>
<dd><p>Sends a request to the LLM (DeepSeek API) to process the unit conversion based on the given prompt.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><p><strong>prompt</strong> (<em>str</em>) – The conversion prompt to send to the LLM.</p>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p>The response content from the LLM.</p>
</dd>
<dt class="field-odd">Return type<span class="colon">:</span></dt>
<dd class="field-odd"><p>str</p>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="modules.data_storage.llm_standardize.fetch_rows_to_standardize">
<span class="sig-prename descclassname"><span class="pre">modules.data_storage.llm_standardize.</span></span><span class="sig-name descname"><span class="pre">fetch_rows_to_standardize</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">conn</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/modules/data_storage/llm_standardize.html#fetch_rows_to_standardize"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#modules.data_storage.llm_standardize.fetch_rows_to_standardize" title="Link to this definition">¶</a></dt>
<dd><p>Fetches rows from the database that require unit standardization.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><p><strong>conn</strong> (<em>psycopg2.extensions.connection</em>) – The psycopg2 connection object to the database.</p>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p>List of rows containing data to be standardized.</p>
</dd>
<dt class="field-odd">Return type<span class="colon">:</span></dt>
<dd class="field-odd"><p>list of tuples</p>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="modules.data_storage.llm_standardize.get_connection">
<span class="sig-prename descclassname"><span class="pre">modules.data_storage.llm_standardize.</span></span><span class="sig-name descname"><span class="pre">get_connection</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="reference internal" href="_modules/modules/data_storage/llm_standardize.html#get_connection"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#modules.data_storage.llm_standardize.get_connection" title="Link to this definition">¶</a></dt>
<dd><p>Establishes and returns a connection to the PostgreSQL database using the specified configuration.</p>
<dl class="field-list simple">
<dt class="field-odd">Returns<span class="colon">:</span></dt>
<dd class="field-odd"><p>psycopg2 connection object</p>
</dd>
<dt class="field-even">Return type<span class="colon">:</span></dt>
<dd class="field-even"><p>psycopg2.extensions.connection</p>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="modules.data_storage.llm_standardize.is_valid_number">
<span class="sig-prename descclassname"><span class="pre">modules.data_storage.llm_standardize.</span></span><span class="sig-name descname"><span class="pre">is_valid_number</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">value</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/modules/data_storage/llm_standardize.html#is_valid_number"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#modules.data_storage.llm_standardize.is_valid_number" title="Link to this definition">¶</a></dt>
<dd><p>Checks if the given value is a valid numeric value (either integer or float).</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><p><strong>value</strong> (<em>str</em>) – The value to check.</p>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p>True if the value is valid, otherwise False.</p>
</dd>
<dt class="field-odd">Return type<span class="colon">:</span></dt>
<dd class="field-odd"><p>bool</p>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="modules.data_storage.llm_standardize.main">
<span class="sig-prename descclassname"><span class="pre">modules.data_storage.llm_standardize.</span></span><span class="sig-name descname"><span class="pre">main</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="reference internal" href="_modules/modules/data_storage/llm_standardize.html#main"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#modules.data_storage.llm_standardize.main" title="Link to this definition">¶</a></dt>
<dd><p>Main function to process all pending rows in the database by calling the process_row function concurrently.</p>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="modules.data_storage.llm_standardize.process_row">
<span class="sig-prename descclassname"><span class="pre">modules.data_storage.llm_standardize.</span></span><span class="sig-name descname"><span class="pre">process_row</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">conn</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">row</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/modules/data_storage/llm_standardize.html#process_row"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#modules.data_storage.llm_standardize.process_row" title="Link to this definition">¶</a></dt>
<dd><p>Processes a single row of CSR data, including calling the LLM API and updating the database.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>conn</strong> (<em>psycopg2.extensions.connection</em>) – The psycopg2 connection object to the database.</p></li>
<li><p><strong>row</strong> (<em>tuple</em>) – A tuple representing the CSR data to process.</p></li>
</ul>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p>The data ID of the processed row, or None if processing failed.</p>
</dd>
<dt class="field-odd">Return type<span class="colon">:</span></dt>
<dd class="field-odd"><p>int or None</p>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="modules.data_storage.llm_standardize.safe_json_parse">
<span class="sig-prename descclassname"><span class="pre">modules.data_storage.llm_standardize.</span></span><span class="sig-name descname"><span class="pre">safe_json_parse</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">response_text</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/modules/data_storage/llm_standardize.html#safe_json_parse"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#modules.data_storage.llm_standardize.safe_json_parse" title="Link to this definition">¶</a></dt>
<dd><p>Cleans and parses the raw response text from the LLM into a structured JSON format.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><p><strong>response_text</strong> (<em>str</em>) – The raw response text from the LLM.</p>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p>The parsed JSON object containing the conversion result.</p>
</dd>
<dt class="field-odd">Return type<span class="colon">:</span></dt>
<dd class="field-odd"><p>dict</p>
</dd>
<dt class="field-even">Raises<span class="colon">:</span></dt>
<dd class="field-even"><p><strong>ValueError</strong> – If the response cannot be parsed into valid JSON.</p>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="modules.data_storage.llm_standardize.update_standardized">
<span class="sig-prename descclassname"><span class="pre">modules.data_storage.llm_standardize.</span></span><span class="sig-name descname"><span class="pre">update_standardized</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">conn</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">data_id</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">value_standardized</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">unit_standardized</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">unit_conversion_note</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/modules/data_storage/llm_standardize.html#update_standardized"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#modules.data_storage.llm_standardize.update_standardized" title="Link to this definition">¶</a></dt>
<dd><p>Updates the database with the standardized value and unit for the given data ID.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>conn</strong> (<em>psycopg2.extensions.connection</em>) – The psycopg2 connection object to the database.</p></li>
<li><p><strong>data_id</strong> (<em>int</em>) – The ID of the data row to update.</p></li>
<li><p><strong>value_standardized</strong> (<em>str</em>) – The standardized value to be saved.</p></li>
<li><p><strong>unit_standardized</strong> (<em>str</em>) – The unit of the standardized value.</p></li>
<li><p><strong>unit_conversion_note</strong> (<em>str</em><em>, </em><em>optional</em>) – Additional notes about the unit conversion (optional).</p></li>
</ul>
</dd>
</dl>
</dd></dl>

</section>
<section id="module-modules.data_storage.main">
<span id="modules-data-storage-main-module"></span><h2>modules.data_storage.main module<a class="headerlink" href="#module-modules.data_storage.main" title="Link to this heading">¶</a></h2>
<p>This module defines and manages the execution of a series of Python scripts in a data processing pipeline.</p>
<p>It includes functions for executing shell commands, logging the results, tracking completed modules,
and executing the pipeline with progress reporting. The pipeline logs progress and execution times
of individual modules, ensuring each module is executed only once.</p>
<p>Modules run by this pipeline:
- <cite>create_table.py</cite>
- <cite>paragraph_extraction.py</cite>
- <cite>retry_failed_reports.py</cite>
- <cite>llm_analyse.py</cite>
- <cite>llm_standardize.py</cite>
- <cite>data_export.py</cite></p>
<p>Functions:
- <cite>read_completed_modules</cite>: Reads a list of completed modules from a file.
- <cite>write_completed_module</cite>: Appends a completed module to a record file.
- <cite>run_command</cite>: Executes a shell command and logs the result.
- <cite>main</cite>: Orchestrates the pipeline execution, including dependency installation, module execution, and logging.</p>
<dl class="py function">
<dt class="sig sig-object py" id="modules.data_storage.main.main">
<span class="sig-prename descclassname"><span class="pre">modules.data_storage.main.</span></span><span class="sig-name descname"><span class="pre">main</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="reference internal" href="_modules/modules/data_storage/main.html#main"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#modules.data_storage.main.main" title="Link to this definition">¶</a></dt>
<dd><p>Orchestrates the execution of the full data processing pipeline.</p>
<p>This function installs the necessary dependencies, loads the list of completed modules,
and iterates over a predefined set of modules to execute. It tracks the execution progress
and logs each step. Each module is only executed once, and the completion is recorded.</p>
<dl class="field-list simple">
<dt class="field-odd">Returns<span class="colon">:</span></dt>
<dd class="field-odd"><p>None</p>
</dd>
<dt class="field-even">Raises<span class="colon">:</span></dt>
<dd class="field-even"><p>Any exceptions raised during the pipeline execution.</p>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="modules.data_storage.main.read_completed_modules">
<span class="sig-prename descclassname"><span class="pre">modules.data_storage.main.</span></span><span class="sig-name descname"><span class="pre">read_completed_modules</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="reference internal" href="_modules/modules/data_storage/main.html#read_completed_modules"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#modules.data_storage.main.read_completed_modules" title="Link to this definition">¶</a></dt>
<dd><p>Reads the list of modules that have already been completed from a file.</p>
<p>This function checks for a file containing the names of completed modules and returns
a set of these module names. If the file does not exist, an empty set is returned.</p>
<dl class="field-list simple">
<dt class="field-odd">Returns<span class="colon">:</span></dt>
<dd class="field-odd"><p>A set of module names that have been completed.</p>
</dd>
<dt class="field-even">Return type<span class="colon">:</span></dt>
<dd class="field-even"><p>set</p>
</dd>
<dt class="field-odd">Raises<span class="colon">:</span></dt>
<dd class="field-odd"><p><strong>FileNotFoundError</strong> – If the completed modules file is not found.</p>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="modules.data_storage.main.run_command">
<span class="sig-prename descclassname"><span class="pre">modules.data_storage.main.</span></span><span class="sig-name descname"><span class="pre">run_command</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">command</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/modules/data_storage/main.html#run_command"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#modules.data_storage.main.run_command" title="Link to this definition">¶</a></dt>
<dd><p>Executes a shell command and logs the result.</p>
<p>This function runs the specified command in the shell, logging the start and success of the execution.
If the command fails, the error is logged, and the script exits with a failure code.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><p><strong>command</strong> (<em>str</em>) – The shell command to execute.</p>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p>None</p>
</dd>
<dt class="field-odd">Raises<span class="colon">:</span></dt>
<dd class="field-odd"><p><strong>subprocess.CalledProcessError</strong> – If the command fails during execution.</p>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="modules.data_storage.main.write_completed_module">
<span class="sig-prename descclassname"><span class="pre">modules.data_storage.main.</span></span><span class="sig-name descname"><span class="pre">write_completed_module</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">module</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/modules/data_storage/main.html#write_completed_module"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#modules.data_storage.main.write_completed_module" title="Link to this definition">¶</a></dt>
<dd><p>Appends the name of a completed module to the record file.</p>
<p>This function writes the provided module name to a file that tracks which modules
have been executed. Each module name is written on a new line.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><p><strong>module</strong> (<em>str</em>) – The name of the module that has been completed.</p>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p>None</p>
</dd>
<dt class="field-odd">Raises<span class="colon">:</span></dt>
<dd class="field-odd"><p>Any exceptions raised during file operations.</p>
</dd>
</dl>
</dd></dl>

</section>
<section id="module-modules.data_storage.paragraph_extraction">
<span id="modules-data-storage-paragraph-extraction-module"></span><h2>modules.data_storage.paragraph_extraction module<a class="headerlink" href="#module-modules.data_storage.paragraph_extraction" title="Link to this heading">¶</a></h2>
<p>PDF Paragraph Extraction and CSR Indicator Matching Tool</p>
<p>This module provides functions to extract paragraphs from CSR reports in PDF format stored in MinIO,
match them against indicators stored in a PostgreSQL database, and store the matched results.</p>
<p>Modules used:
- MinIO for object storage access
- pdfplumber for PDF text extraction
- fuzzywuzzy for keyword similarity matching
- psycopg2 for PostgreSQL interaction
- tqdm for progress display
- multiprocessing for parallel processing</p>
<dl class="py function">
<dt class="sig sig-object py" id="modules.data_storage.paragraph_extraction.check_memory_usage">
<span class="sig-prename descclassname"><span class="pre">modules.data_storage.paragraph_extraction.</span></span><span class="sig-name descname"><span class="pre">check_memory_usage</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">threshold_percent</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">90</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/modules/data_storage/paragraph_extraction.html#check_memory_usage"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#modules.data_storage.paragraph_extraction.check_memory_usage" title="Link to this definition">¶</a></dt>
<dd><p>Check current memory usage and print a warning if it exceeds a given threshold.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><p><strong>threshold_percent</strong> (<em>int</em>) – Memory usage percentage threshold.</p>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p>True if memory usage is below threshold, else False.</p>
</dd>
<dt class="field-odd">Return type<span class="colon">:</span></dt>
<dd class="field-odd"><p>bool</p>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="modules.data_storage.paragraph_extraction.extract_paragraphs_from_pdf">
<span class="sig-prename descclassname"><span class="pre">modules.data_storage.paragraph_extraction.</span></span><span class="sig-name descname"><span class="pre">extract_paragraphs_from_pdf</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">file_path</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/modules/data_storage/paragraph_extraction.html#extract_paragraphs_from_pdf"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#modules.data_storage.paragraph_extraction.extract_paragraphs_from_pdf" title="Link to this definition">¶</a></dt>
<dd><p>Extract paragraphs from a PDF file.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><p><strong>file_path</strong> (<em>str</em>) – Path to the local PDF file.</p>
</dd>
<dt class="field-even">Yield<span class="colon">:</span></dt>
<dd class="field-even"><p>Tuple containing page number and cleaned paragraph text.</p>
</dd>
<dt class="field-odd">Return type<span class="colon">:</span></dt>
<dd class="field-odd"><p>tuple[int, str]</p>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="modules.data_storage.paragraph_extraction.find_matching_paragraphs">
<span class="sig-prename descclassname"><span class="pre">modules.data_storage.paragraph_extraction.</span></span><span class="sig-name descname"><span class="pre">find_matching_paragraphs</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">paragraphs</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">keywords</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">threshold</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">80</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/modules/data_storage/paragraph_extraction.html#find_matching_paragraphs"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#modules.data_storage.paragraph_extraction.find_matching_paragraphs" title="Link to this definition">¶</a></dt>
<dd><p>Find paragraphs that match a set of keywords using fuzzy string matching.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>paragraphs</strong> (<em>list</em><em>[</em><em>tuple</em><em>[</em><em>int</em><em>, </em><em>str</em><em>]</em><em>]</em>) – List of (page number, paragraph) tuples.</p></li>
<li><p><strong>keywords</strong> (<em>list</em><em>[</em><em>str</em><em>]</em>) – List of keyword strings to match.</p></li>
<li><p><strong>threshold</strong> (<em>int</em>) – Matching threshold (0–100), defaults to 80.</p></li>
</ul>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p>List of matched paragraphs with page numbers.</p>
</dd>
<dt class="field-odd">Return type<span class="colon">:</span></dt>
<dd class="field-odd"><p>list[dict]</p>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="modules.data_storage.paragraph_extraction.insert_matched_data">
<span class="sig-prename descclassname"><span class="pre">modules.data_storage.paragraph_extraction.</span></span><span class="sig-name descname"><span class="pre">insert_matched_data</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">conn</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">security</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">report_year</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">indicator_id</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">indicator_name</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">matched</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">extraction_time</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/modules/data_storage/paragraph_extraction.html#insert_matched_data"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#modules.data_storage.paragraph_extraction.insert_matched_data" title="Link to this definition">¶</a></dt>
<dd><p>Insert matched paragraphs into the csr_reporting.CSR_Data table.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>conn</strong> (<em>psycopg2.connection</em>) – PostgreSQL connection object.</p></li>
<li><p><strong>security</strong> (<em>str</em>) – Security identifier.</p></li>
<li><p><strong>report_year</strong> (<em>int</em>) – Year of the report.</p></li>
<li><p><strong>indicator_id</strong> (<em>int</em>) – ID of the matched indicator.</p></li>
<li><p><strong>indicator_name</strong> (<em>str</em>) – Name of the matched indicator.</p></li>
<li><p><strong>matched</strong> (<em>list</em><em>[</em><em>dict</em><em>]</em>) – List of matched paragraph entries.</p></li>
<li><p><strong>extraction_time</strong> (<em>datetime.datetime</em>) – Timestamp of extraction.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="modules.data_storage.paragraph_extraction.load_indicators_from_db">
<span class="sig-prename descclassname"><span class="pre">modules.data_storage.paragraph_extraction.</span></span><span class="sig-name descname"><span class="pre">load_indicators_from_db</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">conn</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/modules/data_storage/paragraph_extraction.html#load_indicators_from_db"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#modules.data_storage.paragraph_extraction.load_indicators_from_db" title="Link to this definition">¶</a></dt>
<dd><p>Load CSR indicators and associated keywords from the database.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><p><strong>conn</strong> (<em>psycopg2.connection</em>) – PostgreSQL database connection.</p>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p>List of tuples (indicator_id, indicator_name, keywords).</p>
</dd>
<dt class="field-odd">Return type<span class="colon">:</span></dt>
<dd class="field-odd"><p>list[tuple[int, str, list[str]]]</p>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="modules.data_storage.paragraph_extraction.parse_security_and_year">
<span class="sig-prename descclassname"><span class="pre">modules.data_storage.paragraph_extraction.</span></span><span class="sig-name descname"><span class="pre">parse_security_and_year</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">object_name</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/modules/data_storage/paragraph_extraction.html#parse_security_and_year"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#modules.data_storage.paragraph_extraction.parse_security_and_year" title="Link to this definition">¶</a></dt>
<dd><p>Parse the security identifier and report year from a given object name.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><p><strong>object_name</strong> (<em>str</em>) – The name of the PDF object in MinIO.</p>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p>Tuple of (security, year) or (None, None) if parsing fails.</p>
</dd>
<dt class="field-odd">Return type<span class="colon">:</span></dt>
<dd class="field-odd"><p>tuple[str, int | None]</p>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="modules.data_storage.paragraph_extraction.process_all_pdfs">
<span class="sig-prename descclassname"><span class="pre">modules.data_storage.paragraph_extraction.</span></span><span class="sig-name descname"><span class="pre">process_all_pdfs</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="reference internal" href="_modules/modules/data_storage/paragraph_extraction.html#process_all_pdfs"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#modules.data_storage.paragraph_extraction.process_all_pdfs" title="Link to this definition">¶</a></dt>
<dd><p>Main pipeline to process all PDF files from MinIO:
- Downloads each file
- Extracts paragraphs
- Matches with indicators
- Saves matched results to the database
- Logs failed files</p>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="modules.data_storage.paragraph_extraction.process_report">
<span class="sig-prename descclassname"><span class="pre">modules.data_storage.paragraph_extraction.</span></span><span class="sig-name descname"><span class="pre">process_report</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">args</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/modules/data_storage/paragraph_extraction.html#process_report"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#modules.data_storage.paragraph_extraction.process_report" title="Link to this definition">¶</a></dt>
<dd><p>Process a single PDF report: download, extract, match indicators, and insert data.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><p><strong>args</strong> (<em>tuple</em>) – Tuple of (conn_config, MinIO object, indicators).</p>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p>Object name if failed, else None.</p>
</dd>
<dt class="field-odd">Return type<span class="colon">:</span></dt>
<dd class="field-odd"><p>str | None</p>
</dd>
</dl>
</dd></dl>

</section>
<section id="module-modules.data_storage.retry_failed_reports">
<span id="modules-data-storage-retry-failed-reports-module"></span><h2>modules.data_storage.retry_failed_reports module<a class="headerlink" href="#module-modules.data_storage.retry_failed_reports" title="Link to this heading">¶</a></h2>
<p>This module is responsible for processing CSR (Corporate Social Responsibility) reports.
It connects to a MinIO server to download the reports, extracts text paragraphs from
PDF files, matches them against CSR indicators loaded from a PostgreSQL database,
and stores the matched data back into the database.</p>
<p>The workflow includes the following key steps:
1. Downloading the CSR report from MinIO.
2. Extracting text paragraphs from the report’s PDF file.
3. Matching the extracted paragraphs with predefined CSR indicators using fuzzy string matching.
4. Inserting matched data into the PostgreSQL database.
5. Supporting retry logic for processing failed reports.</p>
<p>Configuration:
- MinIO: Used for storing and retrieving CSR report PDF files.
- PostgreSQL: Used to store CSR indicators and matched data.</p>
<p>Dependencies:
- psycopg2: PostgreSQL database adapter.
- pdfplumber: PDF text extraction library.
- fuzzywuzzy: Fuzzy string matching library.
- tqdm: For progress bars.
- minio: MinIO Python client for object storage.</p>
<dl class="py function">
<dt class="sig sig-object py" id="modules.data_storage.retry_failed_reports.extract_paragraphs_from_pdf">
<span class="sig-prename descclassname"><span class="pre">modules.data_storage.retry_failed_reports.</span></span><span class="sig-name descname"><span class="pre">extract_paragraphs_from_pdf</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">file_path</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/modules/data_storage/retry_failed_reports.html#extract_paragraphs_from_pdf"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#modules.data_storage.retry_failed_reports.extract_paragraphs_from_pdf" title="Link to this definition">¶</a></dt>
<dd><p>Extracts paragraphs from a PDF file.</p>
<p>This function opens the specified PDF file, extracts the text from each page,
and splits the text into paragraphs based on sentence delimiters. It only retains
paragraphs with more than 20 characters.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><p><strong>file_path</strong> (<em>str</em>) – The path to the PDF file.</p>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p>A list of tuples, each containing the page number and a paragraph.</p>
</dd>
<dt class="field-odd">Return type<span class="colon">:</span></dt>
<dd class="field-odd"><p>list of tuples (int, str)</p>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="modules.data_storage.retry_failed_reports.find_matching_paragraphs">
<span class="sig-prename descclassname"><span class="pre">modules.data_storage.retry_failed_reports.</span></span><span class="sig-name descname"><span class="pre">find_matching_paragraphs</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">paragraphs</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">keywords</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">threshold</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">80</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/modules/data_storage/retry_failed_reports.html#find_matching_paragraphs"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#modules.data_storage.retry_failed_reports.find_matching_paragraphs" title="Link to this definition">¶</a></dt>
<dd><p>Finds paragraphs that match the given keywords based on fuzzy string matching.</p>
<p>This function compares each paragraph with the provided keywords using fuzzy
string matching (via the fuzzywuzzy library) and returns the paragraphs with
matches above a specified threshold.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>paragraphs</strong> (<em>list</em><em> of </em><em>tuples</em><em> (</em><em>int</em><em>, </em><em>str</em><em>)</em>) – A list of paragraphs to search.</p></li>
<li><p><strong>keywords</strong> (<em>list</em><em> of </em><em>str</em>) – A list of keywords to match against.</p></li>
<li><p><strong>threshold</strong> (<em>int</em>) – The minimum fuzzy match score to consider a paragraph as a match.</p></li>
</ul>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p>A list of dictionaries containing the matched paragraphs with their page number.</p>
</dd>
<dt class="field-odd">Return type<span class="colon">:</span></dt>
<dd class="field-odd"><p>list of dict</p>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="modules.data_storage.retry_failed_reports.insert_matched_data">
<span class="sig-prename descclassname"><span class="pre">modules.data_storage.retry_failed_reports.</span></span><span class="sig-name descname"><span class="pre">insert_matched_data</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">conn</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">security</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">report_year</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">indicator_id</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">indicator_name</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">matched</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">extraction_time</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/modules/data_storage/retry_failed_reports.html#insert_matched_data"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#modules.data_storage.retry_failed_reports.insert_matched_data" title="Link to this definition">¶</a></dt>
<dd><p>Inserts the matched CSR data into the database.</p>
<p>This function inserts the matched paragraphs along with metadata into the
PostgreSQL database for later retrieval and reporting.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>conn</strong> (<em>psycopg2.connection</em>) – The database connection object.</p></li>
<li><p><strong>security</strong> (<em>str</em>) – The security identifier of the company.</p></li>
<li><p><strong>report_year</strong> (<em>int</em>) – The year of the CSR report.</p></li>
<li><p><strong>indicator_id</strong> (<em>int</em>) – The ID of the CSR indicator.</p></li>
<li><p><strong>indicator_name</strong> (<em>str</em>) – The name of the CSR indicator.</p></li>
<li><p><strong>matched</strong> (<em>list</em><em> of </em><em>dict</em>) – A list of matched paragraphs.</p></li>
<li><p><strong>extraction_time</strong> (<em>datetime.datetime</em>) – The time when the data was extracted.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="modules.data_storage.retry_failed_reports.load_indicators_from_db">
<span class="sig-prename descclassname"><span class="pre">modules.data_storage.retry_failed_reports.</span></span><span class="sig-name descname"><span class="pre">load_indicators_from_db</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">conn</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/modules/data_storage/retry_failed_reports.html#load_indicators_from_db"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#modules.data_storage.retry_failed_reports.load_indicators_from_db" title="Link to this definition">¶</a></dt>
<dd><p>Loads CSR indicators from the PostgreSQL database.</p>
<p>This function queries the database for CSR indicator data, including indicator
names and keywords, which are used later to match against extracted paragraphs.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><p><strong>conn</strong> (<em>psycopg2.connection</em>) – The database connection object.</p>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p>A list of tuples containing indicator_id, indicator_name, and keywords.</p>
</dd>
<dt class="field-odd">Return type<span class="colon">:</span></dt>
<dd class="field-odd"><p>list of tuples (int, str, list)</p>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="modules.data_storage.retry_failed_reports.parse_security_and_year">
<span class="sig-prename descclassname"><span class="pre">modules.data_storage.retry_failed_reports.</span></span><span class="sig-name descname"><span class="pre">parse_security_and_year</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">object_name</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/modules/data_storage/retry_failed_reports.html#parse_security_and_year"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#modules.data_storage.retry_failed_reports.parse_security_and_year" title="Link to this definition">¶</a></dt>
<dd><p>Parses the security identifier and report year from the given object name.</p>
<p>This function expects the object name to follow a specific naming convention
where the filename contains a security identifier followed by a 4-digit year
(e.g., “ABC_2021.pdf”).</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><p><strong>object_name</strong> (<em>str</em>) – The name of the object (PDF file) stored in MinIO.</p>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p>A tuple containing the security identifier and report year,
or (None, None) if parsing fails.</p>
</dd>
<dt class="field-odd">Return type<span class="colon">:</span></dt>
<dd class="field-odd"><p>tuple or (None, None)</p>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="modules.data_storage.retry_failed_reports.process_single_report">
<span class="sig-prename descclassname"><span class="pre">modules.data_storage.retry_failed_reports.</span></span><span class="sig-name descname"><span class="pre">process_single_report</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">object_name</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">indicators</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">conn_config</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/modules/data_storage/retry_failed_reports.html#process_single_report"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#modules.data_storage.retry_failed_reports.process_single_report" title="Link to this definition">¶</a></dt>
<dd><p>Processes a single report by downloading it from MinIO, extracting paragraphs,
matching them with indicators, and saving the results to the database.</p>
<p>This function downloads the report, extracts its paragraphs, matches them with
CSR indicators, and stores the results in the database.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>object_name</strong> (<em>str</em>) – The name of the object (PDF file) stored in MinIO.</p></li>
<li><p><strong>indicators</strong> (<em>list</em><em> of </em><em>tuples</em><em> (</em><em>int</em><em>, </em><em>str</em><em>, </em><em>list</em><em>)</em>) – A list of CSR indicators to match against.</p></li>
<li><p><strong>conn_config</strong> (<em>dict</em>) – The configuration for connecting to the PostgreSQL database.</p></li>
</ul>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p>True if the report was processed successfully, False otherwise.</p>
</dd>
<dt class="field-odd">Return type<span class="colon">:</span></dt>
<dd class="field-odd"><p>bool</p>
</dd>
<dt class="field-even">Raises<span class="colon">:</span></dt>
<dd class="field-even"><p><strong>Exception</strong> – If any error occurs during the processing of the report.</p>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="modules.data_storage.retry_failed_reports.retry_failed_reports">
<span class="sig-prename descclassname"><span class="pre">modules.data_storage.retry_failed_reports.</span></span><span class="sig-name descname"><span class="pre">retry_failed_reports</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="reference internal" href="_modules/modules/data_storage/retry_failed_reports.html#retry_failed_reports"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#modules.data_storage.retry_failed_reports.retry_failed_reports" title="Link to this definition">¶</a></dt>
<dd><p>Retries processing of reports that failed during a previous attempt.
If retrying fails, the report names are saved in the ‘failed_reports.json’ file.</p>
<p>This function reads a list of failed report names from a JSON file, retries
processing them, and updates the list of failed reports if necessary.</p>
<dl class="field-list simple">
<dt class="field-odd">Raises<span class="colon">:</span></dt>
<dd class="field-odd"><p><strong>Exception</strong> – If any error occurs during the retry process.</p>
</dd>
</dl>
</dd></dl>

</section>
<section id="module-modules.data_storage">
<span id="module-contents"></span><h2>Module contents<a class="headerlink" href="#module-modules.data_storage" title="Link to this heading">¶</a></h2>
</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="index.html">Bigdata_cw2_Jacaranda</a></h1>









<search id="searchbox" style="display: none" role="search">
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" placeholder="Search"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script><h3>Navigation</h3>
<p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="modules.html">modules package</a><ul class="current">
<li class="toctree-l2 current"><a class="reference internal" href="modules.html#subpackages">Subpackages</a></li>
<li class="toctree-l2"><a class="reference internal" href="modules.html#module-modules">Module contents</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="my_fastapi.html">my_fastapi package</a></li>
<li class="toctree-l1"><a class="reference internal" href="test.html">test package</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="index.html">Documentation overview</a><ul>
  <li><a href="modules.html">modules package</a><ul>
      <li>Previous: <a href="modules.html" title="previous chapter">modules package</a></li>
      <li>Next: <a href="modules.frontend.html" title="next chapter">modules.frontend package</a></li>
  </ul></li>
  </ul></li>
</ul>
</div>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &#169;2025, Roger.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 8.2.3</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 1.0.0</a>
      
      |
      <a href="_sources/modules.data_storage.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>